<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°è‚¡æ™ºæ Â· TW Stock Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Space+Mono:wght@400;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --green: #10b981;
    --red: #ef4444;
    --gold: #f59e0b;
    --text: #e2e8f0;
    --text-dim: #64748b;
    --text-muted: #334155;
    --glow: 0 0 20px rgba(0,212,255,0.15);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans TC', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* HEADER */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10,14,26,0.92);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 60px;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    color: var(--accent);
    letter-spacing: 1px;
    text-shadow: 0 0 20px rgba(0,212,255,0.4);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo span { font-family: 'Noto Sans TC', sans-serif; font-size: 13px; color: var(--text-dim); font-weight: 300; }

  .header-right { display: flex; align-items: center; gap: 16px; }

  .market-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-dim);
    font-family: 'Space Mono', monospace;
  }
  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    animation: pulse 2s infinite;
  }
  .status-dot.closed { background: var(--red); box-shadow: 0 0 8px var(--red); animation: none; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .api-key-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--accent);
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .api-key-btn:hover { border-color: var(--accent); box-shadow: var(--glow); }

  /* NAV TABS */
  .nav-tabs {
    display: flex;
    gap: 2px;
    padding: 12px 24px 0;
    border-bottom: 1px solid var(--border);
    position: relative;
    z-index: 1;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .nav-tabs::-webkit-scrollbar { display: none; }
  .tab {
    padding: 10px 20px;
    font-size: 13px;
    color: var(--text-dim);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-badge {
    background: var(--accent2);
    color: white;
    font-size: 10px;
    padding: 1px 5px;
    border-radius: 10px;
    font-family: 'Space Mono', monospace;
  }

  /* MAIN LAYOUT */
  main {
    position: relative;
    z-index: 1;
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px 24px;
  }

  .page { display: none; }
  .page.active { display: block; }

  /* GRID LAYOUTS */
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-left-wide { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
  .grid-right-wide { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    transition: border-color 0.2s;
  }
  .card:hover { border-color: rgba(0,212,255,0.2); }
  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .card-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-title .icon { font-size: 16px; }

  /* INDEX CARDS */
  .index-value {
    font-family: 'Space Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
    margin: 8px 0 4px;
  }
  .index-change {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
  }
  .up { color: var(--green); }
  .down { color: var(--red); }
  .neutral { color: var(--text-dim); }

  .sparkline {
    width: 100%;
    height: 50px;
    margin-top: 12px;
  }

  /* STOCK TABLE */
  .stock-table { width: 100%; border-collapse: collapse; }
  .stock-table th {
    text-align: left;
    font-size: 11px;
    color: var(--text-dim);
    font-weight: 500;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: 'Space Mono', monospace;
  }
  .stock-table td {
    padding: 11px 12px;
    font-size: 13px;
    border-bottom: 1px solid rgba(30,45,69,0.5);
  }
  .stock-table tr:last-child td { border-bottom: none; }
  .stock-table tr:hover td { background: rgba(0,212,255,0.03); }

  .stock-name { font-weight: 500; }
  .stock-code { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-dim); }
  .price { font-family: 'Space Mono', monospace; font-weight: 700; }
  .change { font-family: 'Space Mono', monospace; font-size: 12px; }

  /* WATCHLIST add */
  .add-stock-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .add-stock-bar input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .add-stock-bar input:focus { border-color: var(--accent); }
  .btn {
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .btn:hover { opacity: 0.85; transform: translateY(-1px); }
  .btn-outline {
    background: transparent;
    color: var(--text-dim);
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: transparent; color: var(--red); border: none; cursor: pointer; font-size: 16px; padding: 4px; transition: opacity 0.2s; }
  .btn-danger:hover { opacity: 0.7; }

  /* AI ANALYSIS CARD */
  .ai-score {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--surface2);
    border-radius: 10px;
    margin-bottom: 12px;
    border-left: 3px solid var(--accent);
    transition: border-color 0.2s;
  }
  .ai-score.buy { border-left-color: var(--green); }
  .ai-score.sell { border-left-color: var(--red); }
  .ai-score.hold { border-left-color: var(--gold); }
  
  .score-circle {
    width: 52px; height: 52px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-family: 'Space Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    border: 2px solid;
  }
  .score-circle.buy { color: var(--green); border-color: var(--green); background: rgba(16,185,129,0.1); }
  .score-circle.sell { color: var(--red); border-color: var(--red); background: rgba(239,68,68,0.1); }
  .score-circle.hold { color: var(--gold); border-color: var(--gold); background: rgba(245,158,11,0.1); }

  .ai-rec-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 2px;
  }

  .ai-stock-info { flex: 1; }
  .ai-stock-name { font-weight: 500; font-size: 14px; }
  .ai-stock-code { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-dim); }
  .ai-reason { font-size: 12px; color: var(--text-dim); margin-top: 4px; line-height: 1.5; }

  .ai-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
  .tag {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .tag-green { background: rgba(16,185,129,0.15); color: var(--green); }
  .tag-red { background: rgba(239,68,68,0.15); color: var(--red); }
  .tag-gold { background: rgba(245,158,11,0.15); color: var(--gold); }
  .tag-blue { background: rgba(0,212,255,0.1); color: var(--accent); }
  .tag-purple { background: rgba(124,58,237,0.15); color: #a78bfa; }

  /* NEWS CARD */
  .news-item {
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
  }
  .news-item:last-child { border-bottom: none; }
  .news-item:hover { padding-left: 8px; }
  .news-meta { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
  .news-source { font-size: 10px; color: var(--accent); font-family: 'Space Mono', monospace; text-transform: uppercase; }
  .news-time { font-size: 10px; color: var(--text-muted); font-family: 'Space Mono', monospace; }
  .news-impact { font-size: 10px; padding: 1px 6px; border-radius: 4px; }
  .news-title { font-size: 13px; line-height: 1.5; margin-bottom: 4px; }
  .news-summary { font-size: 12px; color: var(--text-dim); line-height: 1.5; }

  /* SECTOR CHART */
  .sector-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .sector-name { font-size: 12px; width: 80px; flex-shrink: 0; }
  .bar-track { flex: 1; height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; transition: width 1s ease; }
  .bar-fill.up { background: linear-gradient(90deg, var(--green), rgba(16,185,129,0.5)); }
  .bar-fill.down { background: linear-gradient(90deg, var(--red), rgba(239,68,68,0.5)); }
  .sector-pct { font-family: 'Space Mono', monospace; font-size: 12px; width: 55px; text-align: right; }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    width: 90%;
    max-width: 480px;
    animation: slideUp 0.3s ease;
  }
  @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
  .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .modal-desc { font-size: 13px; color: var(--text-dim); margin-bottom: 20px; line-height: 1.6; }
  .modal input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    margin-bottom: 12px;
    font-family: 'Space Mono', monospace;
  }
  .modal input:focus { border-color: var(--accent); }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

  /* STOCK DETAIL */
  .stock-detail-header {
    display: flex;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 20px;
  }
  .detail-price-section { flex: 1; }
  .detail-name { font-size: 22px; font-weight: 700; }
  .detail-code { font-family: 'Space Mono', monospace; font-size: 14px; color: var(--text-dim); }
  .detail-price { font-family: 'Space Mono', monospace; font-size: 40px; font-weight: 700; margin: 8px 0; }
  .detail-change { font-family: 'Space Mono', monospace; font-size: 16px; }

  /* STATS GRID */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 16px 0; }
  .stat-box {
    background: var(--surface2);
    border-radius: 8px;
    padding: 12px;
    text-align: center;
  }
  .stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  .stat-value { font-family: 'Space Mono', monospace; font-size: 15px; font-weight: 700; }

  /* LOADING */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-dim);
    font-size: 13px;
    gap: 10px;
  }
  .spinner {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to{transform:rotate(360deg)} }

  /* AI CHAT */
  .chat-container {
    height: 380px;
    overflow-y: auto;
    padding: 16px;
    background: var(--surface2);
    border-radius: 10px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .chat-msg {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.6;
  }
  .chat-msg.user {
    background: var(--accent2);
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }
  .chat-msg.ai {
    background: var(--surface);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    border: 1px solid var(--border);
  }
  .chat-input-bar {
    display: flex;
    gap: 8px;
  }
  .chat-input-bar input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 13px;
    outline: none;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .chat-input-bar input:focus { border-color: var(--accent); }

  /* ALERTS */
  .alert-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface2);
    border-radius: 8px;
    margin-bottom: 8px;
  }
  .alert-icon { font-size: 20px; flex-shrink: 0; }
  .alert-text { flex: 1; font-size: 13px; }
  .alert-time { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-dim); }

  /* SCORE BAR */
  .score-bar-container { margin: 12px 0; }
  .score-bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; color: var(--text-dim); }
  .score-bar-track { height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .score-bar-fill { height: 100%; border-radius: 3px; transition: width 1s ease; }

  /* PORTFOLIO */
  .portfolio-summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  .portfolio-stat {
    background: var(--surface2);
    border-radius: 10px;
    padding: 16px;
    border-left: 3px solid var(--border);
  }
  .portfolio-stat.profit { border-left-color: var(--green); }
  .portfolio-stat.loss { border-left-color: var(--red); }
  .portfolio-stat.neutral { border-left-color: var(--accent); }
  .portfolio-stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .portfolio-stat-value { font-family: 'Space Mono', monospace; font-size: 20px; font-weight: 700; }

  /* CALENDAR */
  .event-calendar { }
  .event-item {
    display: flex;
    gap: 14px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .event-item:last-child { border-bottom: none; }
  .event-date {
    text-align: center;
    width: 40px;
    flex-shrink: 0;
  }
  .event-day { font-family: 'Space Mono', monospace; font-size: 20px; font-weight: 700; color: var(--accent); }
  .event-month { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
  .event-body { flex: 1; }
  .event-title { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
  .event-desc { font-size: 12px; color: var(--text-dim); }
  .event-importance { display: flex; gap: 3px; }
  .dot-importance { width: 6px; height: 6px; border-radius: 50%; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .grid-3, .grid-2, .grid-left-wide, .grid-right-wide { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .portfolio-summary { grid-template-columns: repeat(2,1fr); }
  }

  /* ANIMATIONS */
  .fade-in { animation: fadeIn 0.5s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  /* TICKER TAPE */
  .ticker-wrap {
    overflow: hidden;
    background: rgba(0,212,255,0.05);
    border-bottom: 1px solid var(--border);
    padding: 6px 0;
    position: relative;
    z-index: 1;
  }
  .ticker-inner {
    display: flex;
    gap: 40px;
    white-space: nowrap;
    animation: ticker 30s linear infinite;
  }
  .ticker-item {
    display: inline-flex;
    gap: 8px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
  }
  .ticker-item .name { color: var(--text); }
  @keyframes ticker { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .section-title {
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title::before {
    content: '';
    width: 3px;
    height: 18px;
    background: var(--accent);
    border-radius: 2px;
  }

  /* Chart placeholder */
  .chart-placeholder {
    width: 100%;
    height: 200px;
    background: var(--surface2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dim);
    font-size: 13px;
    position: relative;
    overflow: hidden;
  }
  .chart-placeholder svg { position: absolute; inset: 0; width: 100%; height: 100%; }

  .notice-bar {
    background: rgba(124,58,237,0.1);
    border: 1px solid rgba(124,58,237,0.3);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 12px;
    color: #a78bfa;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .filter-chip {
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 12px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    background: transparent;
    color: var(--text-dim);
  }
  .filter-chip:hover, .filter-chip.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,212,255,0.05);
  }

  /* HEATMAP */
  .heatmap-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 4px;
    margin-top: 12px;
  }
  .heatmap-cell {
    aspect-ratio: 1.5;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    cursor: pointer;
    transition: transform 0.15s;
    padding: 4px;
    text-align: center;
  }
  .heatmap-cell:hover { transform: scale(1.05); z-index: 2; }
  .heatmap-cell .cell-name { font-weight: 500; font-size: 10px; }
  .heatmap-cell .cell-pct { font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700; }

  /* Progress ring */
  .progress-ring { position: relative; display: inline-flex; }
  .progress-ring svg { transform: rotate(-90deg); }
  .progress-ring-text {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Space Mono', monospace;
  }

  .mb-4 { margin-bottom: 16px; }
  .mb-2 { margin-bottom: 8px; }
  .mt-4 { margin-top: 16px; }
  .text-sm { font-size: 13px; }
  .text-xs { font-size: 11px; }
  .text-dim { color: var(--text-dim); }
  .gap-2 { gap: 8px; }
  .flex { display: flex; }
  .items-center { align-items: center; }
  .justify-between { justify-content: space-between; }

  /* â”€â”€ TREND ANALYSIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .trend-hero {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
  }
  .trend-direction-card {
    border-radius: 14px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border);
  }
  .trend-direction-card::before {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 120px; height: 120px;
    border-radius: 50%;
    opacity: 0.06;
  }
  .trend-direction-card.up   { background: linear-gradient(135deg, rgba(16,185,129,.08), var(--surface)); border-color: rgba(16,185,129,.25); }
  .trend-direction-card.up::before   { background: var(--green); }
  .trend-direction-card.down { background: linear-gradient(135deg, rgba(239,68,68,.08), var(--surface)); border-color: rgba(239,68,68,.25); }
  .trend-direction-card.down::before { background: var(--red); }
  .trend-direction-card.neutral { background: linear-gradient(135deg, rgba(245,158,11,.08), var(--surface)); border-color: rgba(245,158,11,.25); }
  .trend-direction-card.neutral::before { background: var(--gold); }

  .trend-arrow { font-size: 48px; line-height: 1; margin-bottom: 8px; }
  .trend-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim); margin-bottom: 4px; }
  .trend-verdict { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  .trend-stock-name { font-size: 13px; color: var(--text-dim); }

  /* ä¿¡å¿ƒåº¦é‡è¡¨ */
  .confidence-meter {
    margin: 16px 0;
  }
  .confidence-track {
    height: 10px;
    background: var(--surface2);
    border-radius: 5px;
    overflow: hidden;
    position: relative;
  }
  .confidence-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 1.2s cubic-bezier(.4,0,.2,1);
    position: relative;
  }
  .confidence-fill::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 4px; height: 100%;
    background: rgba(255,255,255,.4);
    border-radius: 2px;
  }
  .confidence-90-marker {
    position: absolute;
    top: -4px;
    left: 90%;
    width: 2px;
    height: 18px;
    background: var(--gold);
    opacity: .8;
  }
  .confidence-90-marker::after {
    content: '90%';
    position: absolute;
    top: -18px;
    left: -10px;
    font-size: 9px;
    color: var(--gold);
    font-family: 'Space Mono', monospace;
    white-space: nowrap;
  }
  .confidence-pct {
    font-family: 'Space Mono', monospace;
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
  }
  .confidence-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-top: 4px;
  }
  .confidence-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 8px;
  }
  .confidence-badge.high   { background: rgba(16,185,129,.15);  color: var(--green); }
  .confidence-badge.medium { background: rgba(245,158,11,.15); color: var(--gold); }
  .confidence-badge.low    { background: rgba(239,68,68,.12);   color: var(--red); }
  .confidence-badge::before { content: 'â—'; font-size: 8px; }

  /* åŸå› å¡ */
  .reason-card {
    background: var(--surface2);
    border-radius: 10px;
    padding: 14px 16px;
    margin-bottom: 10px;
    border-left: 3px solid var(--border);
    transition: border-color .2s;
  }
  .reason-card.supporting  { border-left-color: var(--green); }
  .reason-card.opposing    { border-left-color: var(--red); }
  .reason-card.uncertain   { border-left-color: var(--gold); }

  .reason-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .reason-type {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 700;
  }
  .reason-type.supporting { color: var(--green); }
  .reason-type.opposing   { color: var(--red); }
  .reason-type.uncertain  { color: var(--gold); }

  .reason-weight {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
  }
  .reason-text { font-size: 13px; line-height: 1.6; }
  .reason-evidence {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid rgba(255,255,255,.05);
    font-style: italic;
  }

  /* è‚¡ç¥¨é¸æ“‡å™¨ */
  .trend-stock-picker {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  .stock-pick-chip {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all .2s;
    background: var(--surface2);
    color: var(--text-dim);
    font-family: 'Space Mono', monospace;
  }
  .stock-pick-chip:hover,
  .stock-pick-chip.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,212,255,.07);
    box-shadow: 0 0 12px rgba(0,212,255,.1);
  }

  /* è³‡æ–™ä¾†æº badge */
  .data-source-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  .data-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(0,212,255,.08);
    color: var(--accent);
    font-family: 'Space Mono', monospace;
  }

  /* å¸‚å ´ç¸½é«”è¶¨å‹¢æ©«å¹… */
  .market-trend-banner {
    display: grid;
    grid-template-columns: repeat(3,1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  .mtrend-cell {
    background: var(--surface2);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
    border: 1px solid var(--border);
  }
  .mtrend-label { font-size: 11px; color: var(--text-dim); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .5px; }
  .mtrend-value { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700; }
  .mtrend-sub   { font-size: 11px; color: var(--text-dim); margin-top: 3px; }

  @media (max-width:768px) {
    .trend-hero { grid-template-columns: 1fr; }
    .market-trend-banner { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<!-- TICKER TAPE -->
<div class="ticker-wrap">
  <div class="ticker-inner" id="tickerInner">
    <!-- filled by JS -->
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">
    ğŸ“Š å°è‚¡æ™ºæ
    <span>TW Stock Intelligence</span>
  </div>
  <div class="header-right">
    <div class="market-status">
      <div class="status-dot" id="marketStatusDot"></div>
      <span id="marketStatusText">è¼‰å…¥ä¸­...</span>
    </div>
    <div style="font-family:'Space Mono',monospace;font-size:12px;color:var(--text-dim);" id="currentTime"></div>
    <button class="api-key-btn" onclick="openApiModal()">ğŸ”‘ è¨­å®š API Key</button>
  </div>
</header>

<!-- NAV TABS -->
<div class="nav-tabs">
  <div class="tab active" onclick="switchTab('overview')">ğŸ“ˆ å¸‚å ´ç¸½è¦½</div>
  <div class="tab" onclick="switchTab('watchlist')">â­ è‡ªé¸è‚¡</div>
  <div class="tab" onclick="switchTab('portfolio')">ğŸ’¼ æŒè‚¡ç®¡ç†</div>
  <div class="tab" onclick="switchTab('ai-analysis')">ğŸ¤– AI æ¨è–¦ <span class="tab-badge" id="aiCount">5</span></div>
  <div class="tab" onclick="switchTab('news')">ğŸ“° æ–°èç¸½åŒ¯</div>
  <div class="tab" onclick="switchTab('macro')">ğŸŒ ç¸½ç¶“ç’°å¢ƒ</div>
  <div class="tab" onclick="switchTab('calendar')">ğŸ“… è²¡å ±è¡Œäº‹æ›†</div>
  <div class="tab" onclick="switchTab('screener')">ğŸ” é¸è‚¡å™¨</div>
  <div class="tab" onclick="switchTab('chat')">ğŸ’¬ AI å•ç­”</div>
  <div class="tab" onclick="switchTab('institutional')">ğŸ›ï¸ æ³•äººå‹•å‘</div>
  <div class="tab" onclick="switchTab('trend')">ğŸ”¬ è¶¨å‹¢åˆ†æ <span class="tab-badge" style="background:var(--green)" id="trendBadge">NEW</span></div>
</div>

<!-- MAIN -->
<main>

<!-- ===== PAGE: OVERVIEW ===== -->
<div class="page active fade-in" id="page-overview">
  <div class="grid-3 mb-4">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="icon">ğŸ‡¹ğŸ‡¼</span> å°ç£åŠ æ¬ŠæŒ‡æ•¸</div>
      </div>
      <div class="index-value" id="twse-price">--,---</div>
      <div class="index-change" id="twse-change">---</div>
      <svg class="sparkline" id="twse-spark" viewBox="0 0 200 50" preserveAspectRatio="none"></svg>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="icon">ğŸ‡ºğŸ‡¸</span> S&P 500</div>
      </div>
      <div class="index-value" id="sp500-price">--,---</div>
      <div class="index-change" id="sp500-change">---</div>
      <svg class="sparkline" id="sp500-spark" viewBox="0 0 200 50" preserveAspectRatio="none"></svg>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="icon">ğŸ’±</span> USD/TWD</div>
      </div>
      <div class="index-value" id="usdtwd-price">--.-</div>
      <div class="index-change" id="usdtwd-change">---</div>
      <svg class="sparkline" id="usdtwd-spark" viewBox="0 0 200 50" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <div class="grid-left-wide mb-4">
    <!-- SECTOR HEATMAP -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="icon">ğŸ—ºï¸</span> é¡è‚¡ç†±åŠ›åœ–</div>
        <div class="flex gap-2">
          <span class="text-xs text-dim">ä»Šæ—¥æ¼²è·Œ</span>
        </div>
      </div>
      <div class="heatmap-grid" id="heatmapGrid"></div>
    </div>

    <!-- RIGHT COLUMN -->
    <div style="display:flex;flex-direction:column;gap:16px;">
      <!-- Market Sentiment -->
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸŒ¡ï¸</span> å¸‚å ´æƒ…ç·’</div>
        <div style="text-align:center;margin-bottom:16px;">
          <div class="progress-ring">
            <svg width="100" height="100" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="40" fill="none" stroke="var(--surface2)" stroke-width="10"/>
              <circle cx="50" cy="50" r="40" fill="none" stroke="var(--green)" stroke-width="10"
                stroke-dasharray="251.2" stroke-dashoffset="100" id="sentimentRing" style="transition:stroke-dashoffset 1s ease;"/>
            </svg>
            <div class="progress-ring-text">
              <div style="font-size:22px;font-weight:700;font-family:'Space Mono',monospace;" id="sentimentScore">62</div>
              <div style="font-size:10px;color:var(--text-dim);">è²ªå©ª</div>
            </div>
          </div>
        </div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ææ…Œ</span><span>è²ªå©ª</span></div>
          <div class="score-bar-track">
            <div class="score-bar-fill" id="sentimentBar" style="background:linear-gradient(90deg,var(--red),var(--gold),var(--green));width:62%;"></div>
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">âš¡</span> å¿«è¨Š</div>
        <div id="quickAlerts">
          <div class="loading"><div class="spinner"></div> è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <!-- Top Movers -->
    <div class="card">
      <div class="section-header">
        <div class="section-title">æ¼²å¹…æ¦œ</div>
        <div class="filter-bar" style="margin-bottom:0;">
          <button class="filter-chip active" onclick="setMoverType('gain',this)">æ¼²</button>
          <button class="filter-chip" onclick="setMoverType('loss',this)">è·Œ</button>
          <button class="filter-chip" onclick="setMoverType('volume',this)">é‡</button>
        </div>
      </div>
      <table class="stock-table" id="moverTable">
        <thead>
          <tr>
            <th>è‚¡ç¥¨</th>
            <th>ç¾åƒ¹</th>
            <th>æ¼²è·Œå¹…</th>
            <th>æˆäº¤é‡</th>
          </tr>
        </thead>
        <tbody id="moverTableBody"></tbody>
      </table>
    </div>

    <!-- Sector Performance -->
    <div class="card">
      <div class="section-header">
        <div class="section-title">é¡è‚¡è¡¨ç¾</div>
      </div>
      <div id="sectorPerf"></div>
    </div>
  </div>
</div>

<!-- ===== PAGE: WATCHLIST ===== -->
<div class="page fade-in" id="page-watchlist">
  <div class="grid-left-wide">
    <div>
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">â­ è‡ªé¸è‚¡æ¸…å–®</div>
        </div>
        <div class="add-stock-bar">
          <input type="text" id="watchlistInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼Œå¦‚ï¼š2330 æˆ– å°ç©é›»" onkeydown="if(event.key==='Enter')addToWatchlist()">
          <button class="btn" onclick="addToWatchlist()">æ–°å¢</button>
        </div>
        <table class="stock-table">
          <thead>
            <tr>
              <th>è‚¡ç¥¨</th>
              <th>ç¾åƒ¹</th>
              <th>æ¼²è·Œ</th>
              <th>æ¼²è·Œ%</th>
              <th>æˆäº¤é‡</th>
              <th>è©•ç´š</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="watchlistBody"></tbody>
        </table>
        <div class="loading" id="watchlistLoading" style="display:none;"><div class="spinner"></div> æ›´æ–°è³‡æ–™ä¸­...</div>
      </div>
    </div>

    <!-- Right: quick detail -->
    <div>
      <div class="card mb-4" id="watchlistDetail">
        <div class="card-title" style="margin-bottom:16px;"><span class="icon">ğŸ“Š</span> å¿«é€Ÿåˆ†æ</div>
        <div style="text-align:center;color:var(--text-dim);font-size:13px;padding:30px 0;">
          é»æ“Šè‚¡ç¥¨æŸ¥çœ‹å¿«é€Ÿåˆ†æ
        </div>
      </div>
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ””</span> åƒ¹æ ¼è­¦å ±</div>
        <div id="alertsList">
          <div class="alert-item">
            <div class="alert-icon">ğŸŸ¢</div>
            <div class="alert-text">
              <div style="font-weight:500;">å°ç©é›» (2330)</div>
              <div class="text-xs text-dim">çªç ´ 1000 å…ƒæé†’</div>
            </div>
            <button class="btn-danger">âœ•</button>
          </div>
        </div>
        <button class="btn-outline mt-4" onclick="addAlert()" style="width:100%;">+ æ–°å¢è­¦å ±</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: PORTFOLIO ===== -->
<div class="page fade-in" id="page-portfolio">
  <div class="portfolio-summary" id="portfolioSummary">
    <div class="portfolio-stat neutral">
      <div class="portfolio-stat-label">ç¸½è³‡ç”¢</div>
      <div class="portfolio-stat-value" id="totalAsset">$0</div>
    </div>
    <div class="portfolio-stat neutral">
      <div class="portfolio-stat-label">ç¸½æˆæœ¬</div>
      <div class="portfolio-stat-value" id="totalCost">$0</div>
    </div>
    <div class="portfolio-stat profit" id="pnlCard">
      <div class="portfolio-stat-label">æœªå¯¦ç¾æç›Š</div>
      <div class="portfolio-stat-value" id="totalPnl">+$0</div>
    </div>
    <div class="portfolio-stat profit" id="pnlPctCard">
      <div class="portfolio-stat-label">å ±é…¬ç‡</div>
      <div class="portfolio-stat-value" id="totalPnlPct">+0.00%</div>
    </div>
  </div>

  <div class="grid-left-wide">
    <div class="card">
      <div class="section-header">
        <div class="section-title">ğŸ’¼ æŒè‚¡æ˜ç´°</div>
        <button class="btn" onclick="openAddHolding()">+ æ–°å¢æŒè‚¡</button>
      </div>
      <table class="stock-table">
        <thead>
          <tr>
            <th>è‚¡ç¥¨</th>
            <th>å¼µæ•¸</th>
            <th>æˆæœ¬åƒ¹</th>
            <th>ç¾åƒ¹</th>
            <th>å¸‚å€¼</th>
            <th>æç›Š</th>
            <th>æç›Š%</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="portfolioBody"></tbody>
      </table>
    </div>
    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ©</span> æŒè‚¡æ¯”ä¾‹</div>
        <div id="pieChartContainer" style="display:flex;flex-direction:column;gap:8px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: AI ANALYSIS ===== -->
<div class="page fade-in" id="page-ai-analysis">
  <div class="notice-bar">
    ğŸ’¡ AI åˆ†ææ•´åˆï¼šå°ç£è²¡å ±ã€æŠ€è¡“æŒ‡æ¨™ã€ç¾è‚¡å½±éŸ¿ã€ç¸½é«”ç¶“æ¿Ÿã€é—œç¨…æ”¿ç­–ç­‰å¤šç¶­åº¦è©•åˆ†ã€‚éœ€è¨­å®š Claude API Key ä»¥å•Ÿç”¨å®Œæ•´åˆ†æã€‚
  </div>
  <div class="grid-left-wide">
    <div>
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">ğŸ¤– AI æ¨è–¦è‚¡ç¥¨</div>
          <button class="btn" onclick="runAiAnalysis()">ğŸ”„ é‡æ–°åˆ†æ</button>
        </div>
        <div class="filter-bar">
          <button class="filter-chip active">å…¨éƒ¨</button>
          <button class="filter-chip" onclick="filterAiRec('buy',this)">å¼·åŠ›è²·é€²</button>
          <button class="filter-chip" onclick="filterAiRec('hold',this)">è§€å¯Ÿ</button>
          <button class="filter-chip" onclick="filterAiRec('sell',this)">æ³¨æ„é¢¨éšª</button>
        </div>
        <div id="aiRecList">
          <div class="loading"><div class="spinner"></div> AI åˆ†æä¸­...</div>
        </div>
      </div>
    </div>

    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">âš™ï¸</span> åˆ†æè¨­å®š</div>
        <div style="font-size:13px;color:var(--text-dim);margin-bottom:14px;">å‹¾é¸è¦ç´å…¥åˆ†æçš„å› ç´ ï¼š</div>
        <div id="analysisFactors" style="display:flex;flex-direction:column;gap:10px;">
          <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;">
            <input type="checkbox" checked style="accent-color:var(--accent);"> æŠ€è¡“æŒ‡æ¨™ (RSI, MACD, KD)
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;">
            <input type="checkbox" checked> è²¡å ±åˆ†æ (EPS, æœ¬ç›Šæ¯”)
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;">
            <input type="checkbox" checked> ç¾è‚¡ç›¸é—œæ€§
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;">
            <input type="checkbox" checked> é—œç¨…é¢¨éšªè©•ä¼°
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;">
            <input type="checkbox" checked> å¤–è³‡ç±Œç¢¼
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;">
            <input type="checkbox"> æ³•äººè²·è³£è¶…
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;">
            <input type="checkbox"> æ–°èæƒ…ç·’åˆ†æ
          </label>
        </div>
        <div style="margin-top:16px;">
          <div style="font-size:13px;color:var(--text-dim);margin-bottom:8px;">é¢¨éšªåå¥½</div>
          <input type="range" min="1" max="5" value="3" style="width:100%;accent-color:var(--accent);" oninput="updateRisk(this.value)">
          <div class="flex justify-between text-xs text-dim mt-4">
            <span>ä¿å®ˆ</span><span id="riskLabel">ä¸­æ€§</span><span>ç©æ¥µ</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ“Š</span> å¤šå› å­è©•åˆ†</div>
        <div id="factorScores">
          <div class="score-bar-container">
            <div class="score-bar-label"><span>æŠ€è¡“é¢</span><span>78/100</span></div>
            <div class="score-bar-track"><div class="score-bar-fill" style="width:78%;background:var(--green);"></div></div>
          </div>
          <div class="score-bar-container">
            <div class="score-bar-label"><span>åŸºæœ¬é¢</span><span>65/100</span></div>
            <div class="score-bar-track"><div class="score-bar-fill" style="width:65%;background:var(--accent);"></div></div>
          </div>
          <div class="score-bar-container">
            <div class="score-bar-label"><span>ç±Œç¢¼é¢</span><span>55/100</span></div>
            <div class="score-bar-track"><div class="score-bar-fill" style="width:55%;background:var(--gold);"></div></div>
          </div>
          <div class="score-bar-container">
            <div class="score-bar-label"><span>ç¸½ç¶“/é—œç¨…</span><span>42/100</span></div>
            <div class="score-bar-track"><div class="score-bar-fill" style="width:42%;background:var(--red);"></div></div>
          </div>
          <div class="score-bar-container">
            <div class="score-bar-label"><span>æƒ…ç·’/æ–°è</span><span>70/100</span></div>
            <div class="score-bar-track"><div class="score-bar-fill" style="width:70%;background:var(--accent2);"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: NEWS ===== -->
<div class="page fade-in" id="page-news">
  <div class="grid-left-wide">
    <div>
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">ğŸ“° æœ€æ–°æ–°è</div>
          <button class="btn-outline" onclick="refreshNews()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="filter-bar">
          <button class="filter-chip active" onclick="filterNews('all',this)">å…¨éƒ¨</button>
          <button class="filter-chip" onclick="filterNews('tw',this)">ğŸ‡¹ğŸ‡¼ å°ç£</button>
          <button class="filter-chip" onclick="filterNews('us',this)">ğŸ‡ºğŸ‡¸ ç¾åœ‹</button>
          <button class="filter-chip" onclick="filterNews('tech',this)">ğŸ’» ç§‘æŠ€</button>
          <button class="filter-chip" onclick="filterNews('tariff',this)">ğŸ“¦ é—œç¨…</button>
          <button class="filter-chip" onclick="filterNews('macro',this)">ğŸŒ ç¸½ç¶“</button>
        </div>
        <div id="newsList"></div>
        <div class="loading" id="newsLoading"><div class="spinner"></div> è¼‰å…¥æ–°èä¸­...</div>
      </div>
    </div>
    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ¯</span> å€‹è‚¡æ–°è</div>
        <div class="add-stock-bar">
          <input type="text" id="newsStockSearch" placeholder="æœå°‹å€‹è‚¡æ–°è...">
          <button class="btn" onclick="searchStockNews()">æœ</button>
        </div>
        <div id="stockNewsList">
          <div style="text-align:center;color:var(--text-dim);font-size:13px;padding:20px 0;">è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æœå°‹ç›¸é—œæ–°è</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ“¡</span> å½±éŸ¿æŒ‡æ•¸</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">ä»Šæ—¥ä¸»è¦æ–°èå°å°è‚¡çš„é ä¼°å½±éŸ¿</div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ğŸ‡ºğŸ‡¸ ç¾è‚¡æ”¶ç›¤</span><span style="color:var(--green)">æ­£é¢ +0.8%</span></div>
          <div class="score-bar-track"><div class="score-bar-fill" style="width:70%;background:var(--green);"></div></div>
        </div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ğŸ“¦ é—œç¨…æ¶ˆæ¯</span><span style="color:var(--red)">è² é¢ -0.5%</span></div>
          <div class="score-bar-track"><div class="score-bar-fill" style="width:40%;background:var(--red);"></div></div>
        </div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ğŸ’» AI/ç§‘æŠ€</span><span style="color:var(--green)">æ­£é¢ +1.2%</span></div>
          <div class="score-bar-track"><div class="score-bar-fill" style="width:80%;background:var(--green);"></div></div>
        </div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ğŸ’° Fed æ”¿ç­–</span><span style="color:var(--gold)">ä¸­æ€§ 0%</span></div>
          <div class="score-bar-track"><div class="score-bar-fill" style="width:50%;background:var(--gold);"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: MACRO ===== -->
<div class="notice-bar" id="macroNote" style="display:none;margin-bottom:12px;"></div>
<div class="page fade-in" id="page-macro">
  <div class="grid-3 mb-4">
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;"><span class="icon">ğŸ‡ºğŸ‡¸</span> ç¾è‚¡æŒ‡æ•¸</div>
      <table class="stock-table" id="usIndexTable">
        <tbody>
          <tr><td>é“ç“Šå·¥æ¥­</td><td class="price" id="dji">--</td><td class="change" id="dji-ch">--</td></tr>
          <tr><td>ç´æ–¯é”å…‹</td><td class="price" id="ixic">--</td><td class="change" id="ixic-ch">--</td></tr>
          <tr><td>S&P 500</td><td class="price" id="spx">--</td><td class="change" id="spx-ch">--</td></tr>
          <tr><td>è²»åŸåŠå°é«”</td><td class="price" id="sox">--</td><td class="change" id="sox-ch">--</td></tr>
        </tbody>
      </table>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;"><span class="icon">ğŸ’±</span> åŒ¯ç‡ & å•†å“</div>
      <table class="stock-table">
        <tbody>
          <tr><td>USD/TWD</td><td class="price" id="usdtwd2">--</td><td class="change" id="usdtwd2-ch">--</td></tr>
          <tr><td>USD/JPY</td><td class="price" id="usdjpy">--</td><td class="change" id="usdjpy-ch">--</td></tr>
          <tr><td>åŸæ²¹ (WTI)</td><td class="price" id="wti">--</td><td class="change" id="wti-ch">--</td></tr>
          <tr><td>é»ƒé‡‘</td><td class="price" id="gold">--</td><td class="change" id="gold-ch">--</td></tr>
        </tbody>
      </table>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;"><span class="icon">ğŸ“Š</span> ææ…ŒæŒ‡æ•¸</div>
      <table class="stock-table">
        <tbody>
          <tr><td>VIX</td><td class="price" id="vix">--</td><td class="change" id="vix-ch">--</td></tr>
          <tr><td>10Y ç¾å‚µæ®–åˆ©ç‡</td><td class="price" id="ust10y">--</td><td class="change" id="ust10y-ch">--</td></tr>
          <tr><td>2Y ç¾å‚µæ®–åˆ©ç‡</td><td class="price" id="ust2y">--</td><td class="change" id="ust2y-ch">--</td></tr>
          <tr><td>DXY ç¾å…ƒæŒ‡æ•¸</td><td class="price" id="dxy">--</td><td class="change" id="dxy-ch">--</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="grid-2 mb-4">
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸ“¦ é—œç¨…æ”¿ç­–è¿½è¹¤</div>
      <div id="tariffList">
        <div class="news-item">
          <div class="news-meta">
            <span class="news-source">é—œç¨…</span>
            <span class="news-time">2025-01-15</span>
            <span class="news-impact tag tag-red">é«˜å½±éŸ¿</span>
          </div>
          <div class="news-title">ç¾åœ‹å°ä¸­åœ‹é›»å­ç”¢å“åŠ å¾µ25%é—œç¨…ï¼ŒåŠå°é«”ä¾›æ‡‰éˆé‡çµ„</div>
          <div class="news-summary">å°å» å—æƒ è¨‚å–®è½‰ç§»ï¼Œå°ç©é›»ã€è¯ç™¼ç§‘ç­‰å¯èƒ½å—ç›Šã€‚é ä¼°å°è‚¡é›»å­é¡è‚¡çŸ­æœŸæ­£é¢å½±éŸ¿ã€‚</div>
          <div class="ai-tags mt-4">
            <span class="tag tag-green">å°ç©é›»+</span>
            <span class="tag tag-green">è¯ç™¼ç§‘+</span>
            <span class="tag tag-red">PCBå» -</span>
          </div>
        </div>
        <div class="news-item">
          <div class="news-meta">
            <span class="news-source">é—œç¨…</span>
            <span class="news-time">2025-01-10</span>
            <span class="news-impact tag tag-gold">ä¸­å½±éŸ¿</span>
          </div>
          <div class="news-title">ç¾æ­è²¿æ˜“å”è­°é‡è«‡ï¼Œç§‘æŠ€ç”¢å“é—œç¨…å¯èƒ½è±å…</div>
          <div class="news-summary">è‹¥å”è­°é”æˆï¼Œæœ‰åˆ©å°ç£é›»å­å‡ºå£å•†ï¼Œç‰¹åˆ¥æ˜¯ä¼ºæœå™¨åŠç¶²é€šè¨­å‚™å» å•†ã€‚</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸŒ ç¸½ç¶“æŒ‡æ¨™</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">å°ç£ GDP</div>
          <div class="stat-value up">+3.1%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">CPI é€šè†¨</div>
          <div class="stat-value">2.1%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Fed åˆ©ç‡</div>
          <div class="stat-value">4.25%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å°ç£åˆ©ç‡</div>
          <div class="stat-value">2.00%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å¤±æ¥­ç‡</div>
          <div class="stat-value">3.4%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">PMI</div>
          <div class="stat-value up">51.2</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å¤–åŒ¯å­˜åº•</div>
          <div class="stat-value">5,780å„„</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">M1B å¹´å¢ç‡</div>
          <div class="stat-value down">+5.2%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: CALENDAR ===== -->
<div class="page fade-in" id="page-calendar">
  <div class="grid-2">
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸ“… æœ¬é€±è²¡å ±è¡Œäº‹æ›†</div>
      <div class="event-calendar" id="earningsCalendar"></div>
    </div>
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸŒ ç¸½ç¶“äº‹ä»¶</div>
      <div class="event-calendar" id="macroCalendar"></div>
    </div>
  </div>
</div>

<!-- ===== PAGE: SCREENER ===== -->
<div class="page fade-in" id="page-screener">
  <!-- å¿«é€Ÿç¯©é¸ Tag -->
  <div class="card mb-4">
    <div class="section-header">
      <div class="section-title">ğŸ” æ¢ä»¶é¸è‚¡</div>
      <div style="font-size:12px;color:var(--text-dim);">å¿«é€Ÿæ¢ä»¶ï¼š</div>
    </div>
    <div class="filter-bar" style="margin-bottom:16px;">
      <button class="filter-chip" onclick="applyPreset('high_div')">ğŸ’° é«˜æ®–åˆ©ç‡ â‰¥5%</button>
      <button class="filter-chip" onclick="applyPreset('low_pe')">ğŸ“‰ ä½æœ¬ç›Šæ¯” â‰¤12</button>
      <button class="filter-chip" onclick="applyPreset('ai')">ğŸ¤– AIæ¦‚å¿µè‚¡</button>
      <button class="filter-chip" onclick="applyPreset('semicon')">ğŸ”¬ åŠå°é«”</button>
      <button class="filter-chip" onclick="applyPreset('finance')">ğŸ¦ é‡‘èè‚¡</button>
      <button class="filter-chip" onclick="applyPreset('up_today')">ğŸ“ˆ ä»Šæ—¥ä¸Šæ¼²</button>
      <button class="filter-chip" onclick="applyPreset('down_today')">ğŸ“‰ ä»Šæ—¥ä¸‹è·Œ</button>
      <button class="filter-chip" onclick="applyPreset('high_vol')">ğŸ”¥ é‡èƒ½æ”¾å¤§</button>
    </div>

    <!-- è©³ç´°æ¢ä»¶ -->
    <div class="grid-3" style="gap:12px;margin-bottom:16px;">
      <div>
        <div class="stat-label" style="margin-bottom:6px;">ç”¢æ¥­é¡åˆ¥</div>
        <select id="sc-sector" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-family:'Noto Sans TC',sans-serif;font-size:13px;outline:none;">
          <option value="">å…¨éƒ¨é¡è‚¡</option>
          <option value="åŠå°é«”">ğŸ”¬ åŠå°é«”</option>
          <option value="AIä¼ºæœå™¨">ğŸ¤– AIä¼ºæœå™¨</option>
          <option value="é›»å­é›¶çµ„ä»¶">ğŸ”§ é›»å­é›¶çµ„ä»¶</option>
          <option value="é‡‘èä¿éšª">ğŸ¦ é‡‘èä¿éšª</option>
          <option value="é›»ä¿¡">ğŸ“¡ é›»ä¿¡</option>
          <option value="å‚³ç”¢">ğŸ­ å‚³ç”¢</option>
          <option value="é¢æ¿">ğŸ–¥ï¸ é¢æ¿</option>
          <option value="ç”ŸæŠ€">ğŸ’Š ç”ŸæŠ€</option>
          <option value="ç¶²é€š">ğŸŒ ç¶²é€š</option>
          <option value="é›»å‹•è»Š">âš¡ é›»å‹•è»Š</option>
        </select>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">æœ¬ç›Šæ¯” P/E</div>
        <div class="flex gap-2">
          <input id="sc-pe-min" type="number" placeholder="æœ€ä½" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
          <input id="sc-pe-max" type="number" placeholder="æœ€é«˜" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
        </div>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">æ®–åˆ©ç‡ %</div>
        <div class="flex gap-2">
          <input id="sc-yield-min" type="number" placeholder="æœ€ä½%" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
          <input id="sc-yield-max" type="number" placeholder="æœ€é«˜%" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
        </div>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">ä»Šæ—¥æ¼²è·Œå¹… %</div>
        <div class="flex gap-2">
          <input id="sc-chg-min" type="number" placeholder="æœ€ä½%" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
          <input id="sc-chg-max" type="number" placeholder="æœ€é«˜%" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
        </div>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">è‚¡åƒ¹å€é–“ (å…ƒ)</div>
        <div class="flex gap-2">
          <input id="sc-price-min" type="number" placeholder="æœ€ä½" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
          <input id="sc-price-max" type="number" placeholder="æœ€é«˜" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
        </div>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">æ¼²è·Œæ–¹å‘</div>
        <select id="sc-dir" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-family:'Noto Sans TC',sans-serif;font-size:13px;outline:none;">
          <option value="">ä¸é™</option>
          <option value="up">â†‘ ä»Šæ—¥ä¸Šæ¼²</option>
          <option value="down">â†“ ä»Šæ—¥ä¸‹è·Œ</option>
          <option value="strong">ğŸ”¥ å¼·å‹¢ â‰¥+2%</option>
          <option value="weak">ğŸ’§ å¼±å‹¢ â‰¤-2%</option>
        </select>
      </div>
    </div>
    <div class="flex gap-2">
      <button class="btn" onclick="runScreener()">ğŸ” é–‹å§‹ç¯©é¸</button>
      <button class="btn-outline" onclick="resetScreener()">é‡ç½®æ¢ä»¶</button>
    </div>
  </div>
  <div class="card" id="screenerResults">
    <div style="text-align:center;color:var(--text-dim);font-size:13px;padding:30px;">è¨­å®šæ¢ä»¶å¾Œé»é¸ã€Œé–‹å§‹ç¯©é¸ã€</div>
  </div>
</div>

<!-- ===== PAGE: AI CHAT ===== -->
<div class="page fade-in" id="page-chat">
  <div class="grid-left-wide">
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸ’¬ AI è‚¡å¸‚åˆ†æåŠ©ç†</div>
      <div class="notice-bar">éœ€è¨­å®š Claude API Key æ‰èƒ½ä½¿ç”¨å®Œæ•´ AI å°è©±åŠŸèƒ½</div>
      <div class="chat-container" id="chatContainer">
        <div class="chat-msg ai">
          ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯å°è‚¡ AI åˆ†æåŠ©ç†ã€‚<br><br>
          æˆ‘å¯ä»¥å¹«æ‚¨ï¼š<br>
          â€¢ åˆ†æç‰¹å®šè‚¡ç¥¨çš„æŠ€è¡“é¢ã€åŸºæœ¬é¢<br>
          â€¢ è§£è®€ç¾è‚¡å°å°è‚¡çš„å½±éŸ¿<br>
          â€¢ è©•ä¼°é—œç¨…æ”¿ç­–çš„ç”¢æ¥­å½±éŸ¿<br>
          â€¢ æ¯”è¼ƒå€‹è‚¡è²¡å ±æ•¸æ“š<br>
          â€¢ æä¾›è²·è³£å»ºè­°èˆ‡é¢¨éšªè©•ä¼°<br><br>
          è«‹å•æ‚¨æƒ³äº†è§£å“ªæ”¯è‚¡ç¥¨ï¼Ÿ
        </div>
      </div>
      <div class="chat-input-bar">
        <input type="text" id="chatInput" placeholder="è©¢å•å°è‚¡åˆ†æï¼Œä¾‹å¦‚ï¼šå°ç©é›»ä»Šå¤©èƒ½è²·å—ï¼Ÿ" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn" onclick="sendChat()">é€å‡º</button>
      </div>
      <div class="flex gap-2" style="margin-top:10px;flex-wrap:wrap;">
        <button class="filter-chip" onclick="quickChat('å°ç©é›»è¿‘æœŸèµ°å‹¢åˆ†æ')">å°ç©é›»åˆ†æ</button>
        <button class="filter-chip" onclick="quickChat('ä»Šæ—¥ç¾è‚¡æ”¶ç›¤å°æ˜æ—¥å°è‚¡çš„å½±éŸ¿')">ç¾è‚¡å½±éŸ¿</button>
        <button class="filter-chip" onclick="quickChat('ç›®å‰é—œç¨…æ”¿ç­–å°å°å» å½±éŸ¿')">é—œç¨…å½±éŸ¿</button>
        <button class="filter-chip" onclick="quickChat('AIæ¦‚å¿µè‚¡æ¨è–¦')">AI æ¦‚å¿µè‚¡</button>
        <button class="filter-chip" onclick="quickChat('é«˜æ®–åˆ©ç‡è‚¡ç¥¨æ¨è–¦')">é«˜æ®–åˆ©ç‡è‚¡</button>
      </div>
    </div>
    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ“š</span> å¸¸è¦‹å•é¡Œ</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div class="btn-outline" style="text-align:left;cursor:pointer;" onclick="quickChat('å°ç£åŠ æ¬ŠæŒ‡æ•¸ç›®å‰ä½ç½®åˆ†æ')">å°ç£åŠ æ¬ŠæŒ‡æ•¸ç›®å‰ä½ç½®ï¼Ÿ</div>
          <div class="btn-outline" style="text-align:left;cursor:pointer;" onclick="quickChat('Fedé™æ¯å°å°è‚¡çš„å½±éŸ¿')">Fed é™æ¯å°å°è‚¡çš„å½±éŸ¿ï¼Ÿ</div>
          <div class="btn-outline" style="text-align:left;cursor:pointer;" onclick="quickChat('å°ç©é›»vsä¸‰æ˜Ÿç«¶çˆ­åˆ†æ')">å°ç©é›» vs ä¸‰æ˜Ÿåˆ†æ</div>
          <div class="btn-outline" style="text-align:left;cursor:pointer;" onclick="quickChat('2025å¹´å°è‚¡å±•æœ›')">2025 å¹´å°è‚¡å±•æœ›</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ”‘</span> API è¨­å®š</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">è¨­å®š Claude API Key ä»¥å•Ÿç”¨ AI åˆ†æåŠŸèƒ½</div>
        <button class="btn" style="width:100%;" onclick="openApiModal()">è¨­å®š API Key</button>
        <div style="font-size:11px;color:var(--text-muted);margin-top:10px;">API Key åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³ä¼ºæœå™¨</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: INSTITUTIONAL ===== -->
<div class="page fade-in" id="page-institutional">
  <div class="notice-bar" id="instNote">
    ğŸ“Š è³‡æ–™ä¾†æºï¼šå°ç£è­‰äº¤æ‰€ T86 ä¸‰å¤§æ³•äººè²·è³£è¶…å ±è¡¨ï¼ˆç›¤å¾Œæ›´æ–°ï¼‰
  </div>

  <!-- ç¸½è¨ˆæ©«å¹… -->
  <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:16px;" id="instSummary">
    <div class="stat-box">
      <div class="stat-label">å¤–è³‡ä»Šæ—¥åˆè¨ˆæ·¨è²·è¶…</div>
      <div class="stat-value up" id="inst-total-buy">è¼‰å…¥ä¸­...</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">å¤–è³‡ä»Šæ—¥åˆè¨ˆæ·¨è³£è¶…</div>
      <div class="stat-value down" id="inst-total-sell">è¼‰å…¥ä¸­...</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">è³‡æ–™æ—¥æœŸ</div>
      <div class="stat-value" id="inst-date" style="font-size:14px;">--</div>
    </div>
  </div>

  <div class="grid-left-wide">
    <div>
      <!-- å¤–è³‡è²·è¶… Top 5 -->
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title" style="color:var(--green);">ğŸŸ¢ å¤–è³‡è²·è¶… Top 10</div>
          <span class="tag tag-green">æ·¨è²·å…¥ï¼ˆå¼µï¼‰</span>
        </div>
        <div id="instBuyTable">
          <div class="loading"><div class="spinner"></div> è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- å¤–è³‡è³£è¶… Top 5 -->
      <div class="card">
        <div class="section-header">
          <div class="section-title" style="color:var(--red);">ğŸ”´ å¤–è³‡è³£è¶… Top 10</div>
          <span class="tag tag-red">æ·¨è³£å‡ºï¼ˆå¼µï¼‰</span>
        </div>
        <div id="instSellTable">
          <div class="loading"><div class="spinner"></div> è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>

    <div>
      <!-- ä¸‰å¤§æ³•äººåˆè¨ˆ Top 10 -->
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">ğŸ›ï¸ ä¸‰å¤§æ³•äººåˆè¨ˆè²·è¶…</div>
          <span class="tag">å¤–è³‡+æŠ•ä¿¡+è‡ªç‡Ÿ</span>
        </div>
        <div id="instTotalTable">
          <div class="loading"><div class="spinner"></div> è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- èªªæ˜ -->
      <div class="card">
        <div class="card-title" style="margin-bottom:12px;"><span class="icon">ğŸ“–</span> æ³•äººèªªæ˜</div>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.9;">
          <div><span style="color:var(--accent);">å¤–è³‡</span>ï¼šå¤–åœ‹æ©Ÿæ§‹æŠ•è³‡äººï¼ˆQFIIï¼‰ï¼Œæœ€å…·å¸‚å ´æŒ‡æ¨™æ€§</div>
          <div><span style="color:var(--green);">æŠ•ä¿¡</span>ï¼šåœ‹å…§å…±åŒåŸºé‡‘ï¼Œä»£è¡¨æœ¬åœŸæ³•äººå‹•å‘</div>
          <div><span style="color:var(--gold);">è‡ªç‡Ÿå•†</span>ï¼šè­‰åˆ¸å•†è‡ªæœ‰è³‡é‡‘æ“ä½œ</div>
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">
            å–®ä½ç‚ºã€Œå¼µã€ï¼ˆ1å¼µ=1000è‚¡ï¼‰ï¼Œæ­£æ•¸ç‚ºè²·è¶…ï¼Œè² æ•¸ç‚ºè³£è¶…ã€‚<br>
            è³‡æ–™ç‚ºç›¤å¾Œå…¬å‘Šï¼Œé€šå¸¸ä¸‹åˆ 4:00 å¾Œæ›´æ–°ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ===== PAGE: TREND ANALYSIS ===== -->
<div class="page fade-in" id="page-trend">

  <!-- å¸‚å ´æ•´é«”è¶¨å‹¢æ©«å¹… -->
  <div class="market-trend-banner" id="marketTrendBanner">
    <div class="mtrend-cell">
      <div class="mtrend-label">å¤§ç›¤è¶¨å‹¢</div>
      <div class="mtrend-value neutral" id="mtrend-twse">--</div>
      <div class="mtrend-sub" id="mtrend-twse-sub">ç­‰å¾…è³‡æ–™</div>
    </div>
    <div class="mtrend-cell">
      <div class="mtrend-label">ç¾è‚¡å½±éŸ¿</div>
      <div class="mtrend-value neutral" id="mtrend-us">--</div>
      <div class="mtrend-sub" id="mtrend-us-sub">ç­‰å¾…è³‡æ–™</div>
    </div>
    <div class="mtrend-cell">
      <div class="mtrend-label">å¸‚å ´æƒ…ç·’</div>
      <div class="mtrend-value neutral" id="mtrend-sentiment">--</div>
      <div class="mtrend-sub" id="mtrend-sentiment-sub">ç­‰å¾…åˆ†æ</div>
    </div>
  </div>

  <div class="grid-left-wide">
    <!-- å·¦å´ï¼šåˆ†æä¸»å€ -->
    <div>
      <!-- è‚¡ç¥¨é¸æ“‡ -->
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">ğŸ”¬ å€‹è‚¡è¶¨å‹¢åˆ†æ</div>
          <div style="font-size:12px;color:var(--text-dim);">AI åƒ…åœ¨ä¿¡å¿ƒåº¦ â‰¥ 90% æ™‚æ¨™ç¤ºé«˜ä¿¡å¿ƒ</div>
        </div>

        <div class="trend-stock-picker" id="trendStockPicker">
          <!-- è‡ªé¸è‚¡è‡ªå‹•ç”Ÿæˆ -->
        </div>

        <div class="add-stock-bar">
          <input type="text" id="trendStockInput" placeholder="è¼¸å…¥å…¶ä»–è‚¡ç¥¨ä»£ç¢¼åˆ†æï¼Œå¦‚ï¼š2330">
          <button class="btn" onclick="analyzeTrend(document.getElementById('trendStockInput').value)">åˆ†æ</button>
        </div>
      </div>

      <!-- åˆ†æçµæœ -->
      <div id="trendResult">
        <div style="text-align:center;color:var(--text-dim);padding:60px 20px;">
          <div style="font-size:48px;margin-bottom:16px;">ğŸ”¬</div>
          <div style="font-size:15px;font-weight:500;margin-bottom:8px;">é¸æ“‡è‚¡ç¥¨é–‹å§‹åˆ†æ</div>
          <div style="font-size:13px;">AI æœƒæ ¹æ“šçœŸå¯¦å¸‚å ´è³‡æ–™åˆ¤æ–·è¶¨å‹¢æ–¹å‘<br>ä¸¦èªªæ˜æ”¯æŒè©²åˆ¤æ–·çš„å…·é«”åŸå› </div>
        </div>
      </div>
    </div>

    <!-- å³å´ï¼šè¨­å®šèˆ‡èªªæ˜ -->
    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">âš™ï¸</span> åˆ†æåƒæ•¸</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">ç´å…¥åˆ†æçš„è³‡æ–™ä¾†æºï¼š</div>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-price" checked style="accent-color:var(--accent);">
            <span>ğŸ“ˆ å³æ™‚åƒ¹æ ¼ & æ¼²è·Œå¹…ï¼ˆTWSEï¼‰</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-volume" checked style="accent-color:var(--accent);">
            <span>ğŸ“Š æˆäº¤é‡ç•°å¸¸åµæ¸¬</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-us" checked style="accent-color:var(--accent);">
            <span>ğŸ‡ºğŸ‡¸ ç¾è‚¡ & è²»åŸåŠå°é«”æŒ‡æ•¸</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-fx" checked style="accent-color:var(--accent);">
            <span>ğŸ’± USD/TWD åŒ¯ç‡èµ°å‘</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-news" checked style="accent-color:var(--accent);">
            <span>ğŸ“° è¿‘æœŸç›¸é—œæ–°èæƒ…ç·’</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-sector" checked style="accent-color:var(--accent);">
            <span>ğŸ—‚ï¸ é¡è‚¡æ•´é«”èµ°å‘</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-pe" style="accent-color:var(--accent);">
            <span>ğŸ’¹ æœ¬ç›Šæ¯” & æ®–åˆ©ç‡è©•ä¼°</span>
          </label>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ“–</span> ä¿¡å¿ƒåº¦èªªæ˜</div>
        <div style="font-size:12px;line-height:1.8;color:var(--text-dim);">
          <div style="margin-bottom:8px;">
            <span class="confidence-badge high" style="margin-bottom:4px;">é«˜ä¿¡å¿ƒ â‰¥ 90%</span><br>
            å¤šå€‹ç¨ç«‹æŒ‡æ¨™æ–¹å‘ä¸€è‡´ï¼Œä¸”ç„¡æ˜é¡¯åå‘è¨Šè™Ÿã€‚AI æœ‰å……åˆ†ä¾æ“šæ”¯æŒåˆ¤æ–·ã€‚
          </div>
          <div style="margin-bottom:8px;">
            <span class="confidence-badge medium">ä¸­ä¿¡å¿ƒ 70â€“89%</span><br>
            ä¸»è¦æŒ‡æ¨™æ”¯æŒï¼Œä½†å­˜åœ¨éƒ¨åˆ†ä¸ç¢ºå®šå› ç´ æˆ–çŸ›ç›¾è¨Šè™Ÿã€‚
          </div>
          <div>
            <span class="confidence-badge low">ä½ä¿¡å¿ƒ &lt; 70%</span><br>
            æŒ‡æ¨™è¨Šè™Ÿæ··é›œæˆ–è³‡æ–™ä¸è¶³ï¼Œè¶¨å‹¢æ–¹å‘ä¸æ˜ç¢ºï¼Œä¸å®œæ“šæ­¤æ“ä½œã€‚
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:10px;"><span class="icon">âš ï¸</span> é‡è¦è²æ˜</div>
        <div style="font-size:11px;color:var(--text-dim);line-height:1.7;">
          æœ¬åˆ†æåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚å³ä½¿ä¿¡å¿ƒåº¦é«˜ï¼Œè‚¡å¸‚ä»å­˜åœ¨ç„¡æ³•é æ¸¬çš„é¢¨éšªã€‚æ‰€æœ‰æŠ•è³‡æ±ºç­–è«‹è‡ªè¡Œåˆ¤æ–·ä¸¦æ‰¿æ“”é¢¨éšªã€‚
        </div>
      </div>
    </div>
  </div>
</div>


</main>

<!-- API KEY MODAL -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <div class="modal-title">âš™ï¸ API è¨­å®š</div>
    <div class="modal-desc">æ‰€æœ‰é‡‘é‘°åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•ä¼ºæœå™¨ã€‚</div>
    
    <div style="font-size:12px;color:var(--accent);margin-bottom:6px;font-weight:500;">
      ğŸ”‘ Claude API Keyï¼ˆAI åˆ†æå•ç­”ï¼‰
    </div>
    <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-...">
    
    <div style="font-size:12px;color:var(--accent);margin-top:14px;margin-bottom:6px;font-weight:500;">
      â˜ï¸ Cloudflare Worker ç¶²å€ï¼ˆç¾è‚¡/åŒ¯ç‡/RSS æ–°èï¼‰
    </div>
    <input type="text" id="workerUrlInput" placeholder="https://twstock-proxy.yourname.workers.dev"
      style="font-family:'Space Mono',monospace;font-size:12px;">
    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">
      æœªè¨­å®šæ™‚ä»å¯ä½¿ç”¨å°è‚¡åŸºæœ¬åŠŸèƒ½ï¼ˆé€€å›å‚™æ´ proxyï¼‰
    </div>
    <div style="font-size:11px;margin-bottom:14px;">
      <a href="#" onclick="openWorkerGuide()" style="color:var(--accent);">ğŸ“– å¦‚ä½•éƒ¨ç½² Cloudflare Workerï¼Ÿ</a>
    </div>
    <div class="modal-actions">
      <button class="btn-outline" onclick="closeApiModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="saveApiKey()">å„²å­˜è¨­å®š</button>
    </div>
  </div>
</div>

<!-- ADD HOLDING MODAL -->
<div class="modal-overlay" id="holdingModal">
  <div class="modal">
    <div class="modal-title">+ æ–°å¢æŒè‚¡</div>
    <input type="text" id="holdingCode" placeholder="è‚¡ç¥¨ä»£ç¢¼ï¼Œå¦‚ï¼š2330">
    <input type="number" id="holdingLots" placeholder="å¼µæ•¸">
    <input type="number" id="holdingCost" placeholder="å¹³å‡æˆæœ¬ (å…ƒ)">
    <div class="modal-actions">
      <button class="btn-outline" onclick="closeHoldingModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="addHolding()">æ–°å¢</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const state = {
  apiKey: localStorage.getItem('claudeApiKey') || '',
  watchlist: JSON.parse(localStorage.getItem('watchlist') || '["2330","2317","2454","2382","2412"]'),
  portfolio: JSON.parse(localStorage.getItem('portfolio') || '[]'),
  stockCache: {},       // { code: { name, price, change, changePct, volume, ... } }
  twseIndex: null,      // å¤§ç›¤å³æ™‚è³‡æ–™
  yahooData: {},        // Yahoo Finance è³‡æ–™ï¼ˆç¾è‚¡ã€åŒ¯ç‡ã€å•†å“ï¼‰
  rssNews: [],          // RSS æ–°è
  lastFetch: 0,
  isMarketOpen: false,
};

// ============================================================
// è‚¡ç¥¨åç¨±å°ç…§è¡¨ï¼ˆTWSE API æœ‰æ™‚ä¸å›åç¨±ï¼Œé å…ˆå‚™ç”¨ï¼‰
// ============================================================
const STOCK_NAMES = {
  '2330':'å°ç©é›»','2317':'é´»æµ·','2454':'è¯ç™¼ç§‘','2382':'å»£é”','2412':'ä¸­è¯é›»',
  '2881':'å¯Œé‚¦é‡‘','2886':'å…†è±é‡‘','2308':'å°é”é›»','2303':'è¯é›»','3034':'è¯è© ',
  '2002':'ä¸­é‹¼','2891':'ä¸­ä¿¡é‡‘','2884':'ç‰å±±é‡‘','2885':'å…ƒå¤§é‡‘','2892':'ç¬¬ä¸€é‡‘',
  '2357':'è¯ç¢©','2356':'è‹±æ¥­é”','2379':'ç‘æ˜±','2327':'åœ‹å·¨','3008':'å¤§ç«‹å…‰',
  '2395':'ç ”è¯','6505':'å°å¡‘åŒ–','1301':'å°å¡‘','1303':'å—äº','2207':'å’Œæ³°è»Š',
  '2801':'å½°éŠ€','5880':'åˆåº«é‡‘','2912':'çµ±ä¸€è¶…','2823':'ä¸­å£½','2887':'å°æ–°é‡‘',
  '2409':'å‹é”','3481':'ç¾¤å‰µ','2474':'å¯æˆ','4938':'å’Œç¢©','6547':'è¯ç‰¹',
  '1789':'ç¥éš†','4726':'æ°¸æ—¥','2345':'æ™ºé‚¦','4977':'çœ¾é”','6239':'åŠ›æˆ',
  '2301':'å…‰å¯¶ç§‘','2353':'å®ç¢','1326':'å°åŒ–','3045':'å°ç£å¤§','4904':'é å‚³',
  '6781':'AES-KY','1537':'å»£éš†','3231':'ç·¯å‰µ','6509':'èšç´¡',
};

// é¡è‚¡å°ç…§ï¼ˆå„é¡ä»£è¡¨è‚¡ï¼‰
const SECTOR_STOCKS = {
  'åŠå°é«”'    :['2330','2303','2454','3034','2379'],
  'AIä¼ºæœå™¨'  :['2382','2356','3231','2353','3008'],
  'é›»å­é›¶çµ„ä»¶' :['2317','2308','2327','6239','2301'],
  'é‡‘èä¿éšª'  :['2881','2886','2891','2884','2892','2885','5880'],
  'é›»ä¿¡'      :['2412','3045','4904'],
  'å‚³ç”¢'      :['2002','1301','1303','1326','2207'],
  'é¢æ¿'      :['2409','3481','2474'],
  'ç”ŸæŠ€'      :['4938','6547','1789','4726'],
  'ç¶²é€š'      :['2345','3è€ƒ','6509','4977'],
  'é›»å‹•è»Š'    :['2207','1537','6781'],
};
// é¡è‚¡åœ–ç¤º
const SECTOR_ICONS = {
  'åŠå°é«”':'ğŸ”¬','AIä¼ºæœå™¨':'ğŸ¤–','é›»å­é›¶çµ„ä»¶':'ğŸ”§','é‡‘èä¿éšª':'ğŸ¦',
  'é›»ä¿¡':'ğŸ“¡','å‚³ç”¢':'ğŸ­','é¢æ¿':'ğŸ–¥ï¸','ç”ŸæŠ€':'ğŸ’Š','ç¶²é€š':'ğŸŒ','é›»å‹•è»Š':'âš¡',
};

// å›ºå®šçš„éœæ…‹è£œå……è³‡æ–™ï¼ˆTWSE ä¸æä¾› PE/æ®–åˆ©ç‡å³æ™‚å€¼ï¼‰
const STOCK_STATIC = {
  '2330':{ pe:24.5, yield:1.8, sector:'åŠå°é«”' },
  '2317':{ pe:11.2, yield:4.2, sector:'é›»å­é›¶çµ„ä»¶' },
  '2454':{ pe:18.7, yield:2.9, sector:'åŠå°é«”' },
  '2382':{ pe:14.3, yield:3.5, sector:'AIä¼ºæœå™¨' },
  '2412':{ pe:22.1, yield:4.8, sector:'é›»ä¿¡' },
  '2881':{ pe:9.8,  yield:5.2, sector:'é‡‘èä¿éšª' },
  '2886':{ pe:10.5, yield:5.6, sector:'é‡‘èä¿éšª' },
  '2308':{ pe:21.4, yield:2.3, sector:'é›»å­é›¶çµ„ä»¶' },
  '2303':{ pe:13.2, yield:5.3, sector:'åŠå°é«”' },
  '3034':{ pe:16.8, yield:3.8, sector:'åŠå°é«”' },
  '2002':{ pe:12.1, yield:5.1, sector:'å‚³ç”¢' },
  '1301':{ pe:14.5, yield:4.8, sector:'å‚³ç”¢' },
  '1303':{ pe:13.8, yield:5.0, sector:'å‚³ç”¢' },
  '1326':{ pe:15.2, yield:4.5, sector:'å‚³ç”¢' },
  '2409':{ pe:18.2, yield:1.2, sector:'é¢æ¿' },
  '3481':{ pe:22.4, yield:0.8, sector:'é¢æ¿' },
  '2474':{ pe:11.5, yield:3.2, sector:'é¢æ¿' },
  '4938':{ pe:16.3, yield:2.1, sector:'ç”ŸæŠ€' },
  '6547':{ pe:28.5, yield:0.5, sector:'ç”ŸæŠ€' },
  '1789':{ pe:32.1, yield:1.8, sector:'ç”ŸæŠ€' },
  '2891':{ pe:10.2, yield:5.5, sector:'é‡‘èä¿éšª' },
  '2884':{ pe:11.5, yield:5.8, sector:'é‡‘èä¿éšª' },
  '2892':{ pe:9.8,  yield:5.4, sector:'é‡‘èä¿éšª' },
  '2885':{ pe:12.1, yield:5.1, sector:'é‡‘èä¿éšª' },
  '5880':{ pe:10.8, yield:5.9, sector:'é‡‘èä¿éšª' },
  '2379':{ pe:19.2, yield:3.1, sector:'åŠå°é«”' },
  '2327':{ pe:14.5, yield:3.6, sector:'é›»å­é›¶çµ„ä»¶' },
  '3008':{ pe:35.2, yield:1.2, sector:'AIä¼ºæœå™¨' },
  '2356':{ pe:13.1, yield:3.8, sector:'AIä¼ºæœå™¨' },
  '2345':{ pe:16.8, yield:3.2, sector:'ç¶²é€š' },
  '3045':{ pe:21.5, yield:4.2, sector:'é›»ä¿¡' },
  '4904':{ pe:18.9, yield:4.5, sector:'é›»ä¿¡' },
  '2207':{ pe:15.2, yield:3.8, sector:'å‚³ç”¢' },
};

const NEWS_DATA = [
  { source:'å·¥å•†æ™‚å ±', time:'2å°æ™‚å‰', title:'å°ç©é›»3å¥ˆç±³è‰¯ç‡æŒçºŒæå‡ï¼Œå¤§å®¢æˆ¶è¨‚å–®æ»¿è¼‰', summary:'æ³•äººèªç‚ºå°ç©é›»å…ˆé€²è£½ç¨‹ç«¶çˆ­å„ªå‹¢æŒçºŒæ“´å¤§ï¼ŒCoWoSå°è£éœ€æ±‚å¼·å‹ã€‚', tags:['tw','tech'], stocks:['2330'], impact:'high', positive:true },
  { source:'Reuters', time:'3å°æ™‚å‰', title:'Fedå®˜å“¡æš—ç¤ºä»Šå¹´é™æ¯è·¯å¾‘æ˜æœ—ï¼Œé‚£æ–¯é”å…‹èµ°å¼·', summary:'è¯æº–æœƒå®˜å“¡ç™¼è¡¨é´¿æ´¾è¨€è«–ï¼Œç§‘æŠ€è‚¡å…¨é¢ä¸Šæ¼²ï¼Œå°è‚¡ADRæ™®æ¼²ã€‚', tags:['us','macro'], stocks:[], impact:'high', positive:true },
  { source:'å½­åš', time:'4å°æ™‚å‰', title:'ç¾åœ‹æ“¬å°ç‰¹å®šAIæ™¶ç‰‡å‡ºå£é€²ä¸€æ­¥ç®¡åˆ¶', summary:'ç¾å•†å‹™éƒ¨è€ƒæ…®æ“´å¤§æ™¶ç‰‡å‡ºå£ç®¡åˆ¶ï¼Œå¯èƒ½å½±éŸ¿è¼é”èˆ‡å°å» åˆä½œè¨‚å–®ã€‚éœ€å¯†åˆ‡è§€å¯Ÿæ”¿ç­–èµ°å‘ã€‚', tags:['us','tariff','tech'], stocks:['2330','2454'], impact:'medium', positive:false },
  { source:'ç¶“æ¿Ÿæ—¥å ±', time:'5å°æ™‚å‰', title:'å¤–è³‡é€£çºŒè²·è¶…å°è‚¡ï¼Œå–®æ—¥æ·¨è²·å…¥é€¾ç™¾å„„', summary:'å¤–è³‡çœ‹å¥½å°ç£ç§‘æŠ€è‚¡å¾Œå¸‚ï¼Œé›†ä¸­è²·é€²åŠå°é«”èˆ‡AIä¼ºæœå™¨æ¦‚å¿µè‚¡ã€‚', tags:['tw'], stocks:[], impact:'medium', positive:true },
  { source:'WSJ', time:'6å°æ™‚å‰', title:'ç¾ä¸­é—œç¨…è«‡åˆ¤å‚³å‡ºé€²å±•ï¼Œå°å» è½‰å–®æ•ˆæ‡‰æè¶¨ç·©', summary:'è‹¥è²¿æ˜“æ‘©æ“¦é™æº«ï¼Œéƒ¨åˆ†è½‰ç§»è‡³å°å» è¨‚å–®æˆ–èª¿æ•´ï¼Œä½†é•·æœŸä¾›æ‡‰éˆé‡çµ„è¶¨å‹¢ä¸è®Šã€‚', tags:['us','tariff'], stocks:[], impact:'medium', positive:false },
  { source:'MoneyDJ', time:'8å°æ™‚å‰', title:'å»£é”AIä¼ºæœå™¨å‡ºè²¨é‡å‰µé«˜ï¼ŒQ1å±•æœ›æ¨‚è§€', summary:'AIåŸºç¤å»ºè¨­éœ€æ±‚æŒçºŒå¼·å‹ï¼Œå°ç£ODMå» å•†å—æƒ ï¼Œé æœŸæœ¬å­£EPSå…©ä½æ•¸å¢é•·ã€‚', tags:['tw','tech'], stocks:['2382'], impact:'medium', positive:true },
];

const AI_RECS = [
  { code:'2330', name:'å°ç©é›»', rec:'buy', score:87, reason:'å…ˆé€²è£½ç¨‹è¨‚å–®å¼·å‹ï¼ŒCoWoSå°è£ç”¢èƒ½æŒçºŒæ“´å……ï¼ŒAIæ™¶ç‰‡éœ€æ±‚å¸¶å‹•é«˜æ¯›åˆ©ç‡ã€‚å¤–è³‡æŒçºŒå¢æŒã€‚', tags:['AIéœ€æ±‚+','æŠ€è¡“çªç ´','å¤–è³‡å¢æŒ'] },
  { code:'2382', name:'å»£é”', rec:'buy', score:81, reason:'è¼é”GB200ä¼ºæœå™¨ä¸»è¦ä»£å·¥å•†ï¼ŒAIä¼ºæœå™¨å‡ºè²¨é‡QoQå¢é•·è¶…é40%ï¼Œæœ¬ç›Šæ¯”ç›¸å°åˆç†ã€‚', tags:['AIä¼ºæœå™¨','è¼é”æ¦‚å¿µ','Q1è²¡å ±ä½³'] },
  { code:'3034', name:'è¯è© ', rec:'buy', score:76, reason:'OLEDé©…å‹•ICéœ€æ±‚å›å‡ï¼Œè˜‹æœä¾›æ‡‰éˆå—æƒ ï¼Œä¼°å€¼åä½ï¼Œé€¢ä½å¸ƒå±€æ™‚æ©Ÿã€‚', tags:['OLED+','ä½ä¼°å€¼','æŠ€è¡“è¶…è³£'] },
  { code:'2303', name:'è¯é›»', rec:'hold', score:52, reason:'æˆç†Ÿè£½ç¨‹ç«¶çˆ­æ¿€çƒˆï¼Œä¸­åœ‹å» å•†æŒçºŒæ“´ç”¢å½¢æˆå£“åŠ›ã€‚ä½†æ®–åˆ©ç‡é€¾5%æä¾›ä¸‹æª”æ”¯æ’ã€‚', tags:['æ®–åˆ©ç‡æ”¯æ’','ç«¶çˆ­å£“åŠ›','è§€å¯Ÿ'] },
  { code:'2881', name:'å¯Œé‚¦é‡‘', rec:'hold', score:58, reason:'Fedé™æ¯é æœŸå¢å¼·ï¼Œä½†å°ç£åˆ©ç‡èµ°å‘ä¸æ˜ç¢ºã€‚å£½éšªè³‡ç”¢è©•åƒ¹é¢¨éšªå­˜åœ¨ï¼Œæš«åˆ—è§€å¯Ÿã€‚', tags:['é™æ¯å—æƒ ','æ®–åˆ©ç‡5%+','è§€å¯Ÿ'] },
];

// ============================================================
// TWSE API â€” æ ¸å¿ƒè³‡æ–™æŠ“å–
// ============================================================

// ============================================================
// è¨­å®š â”€â”€ æŠŠä½ çš„ Cloudflare Worker ç¶²å€å¡«åœ¨é€™è£¡
// ============================================================
// éƒ¨ç½² worker.js åˆ° Cloudflare Workers å¾Œï¼Œå°‡ç¶²å€è²¼åˆ°ä¸‹æ–¹
// ç¯„ä¾‹: 'https://twstock-proxy.yourname.workers.dev'
// è‹¥å°šæœªéƒ¨ç½²ï¼Œç³»çµ±æœƒè‡ªå‹•é€€å› allorigins.win å‚™æ´
const WORKER_URL = localStorage.getItem('workerUrl') || '';
const FALLBACK   = 'https://api.allorigins.win/get?url=';

// â”€â”€ åº•å±¤ fetch å·¥å…·ï¼šå„ªå…ˆèµ° Workerï¼Œå¦å‰‡èµ° allorigins â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function proxyFetch(workerPath, fallbackUrl) {
  // å…ˆè©¦ Workerï¼ˆè‹¥å·²è¨­å®šï¼‰
  if (WORKER_URL) {
    try {
      const r = await fetch(WORKER_URL + workerPath, { signal: AbortSignal.timeout(6000) });
      if (r.ok) return r.json();
    } catch(e) { console.warn('Worker failed, falling back:', e.message); }
  }
  // é€€å› allorigins proxy
  const r = await fetch(FALLBACK + encodeURIComponent(fallbackUrl), { signal: AbortSignal.timeout(8000) });
  const w = await r.json();
  return JSON.parse(w.contents);
}

// â”€â”€ TWSE å€‹è‚¡å³æ™‚è¡Œæƒ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchStockPrices(codes) {
  const codesStr = codes.join(',');
  const exCh     = codes.map(c => `tse_${c}.tw`).join('|');

  let rawStocks = null;
  try {
    // Worker è·¯å¾‘
    const workerPath = `?type=twse_stock&codes=${codesStr}`;
    // Fallback ç›´æ¥æ‰“ TWSE MIS
    const fallbackUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${encodeURIComponent(exCh)}&json=1&delay=0`;

    if (WORKER_URL) {
      const data = await proxyFetch(workerPath, fallbackUrl);
      rawStocks = data.stocks;   // Worker å·²æ•´ç†å¥½æ ¼å¼
    } else {
      // allorigins fallback â†’ éœ€è‡ªå·±è§£æ TWSE åŸå§‹æ ¼å¼
      const data = await proxyFetch(null, fallbackUrl);
      rawStocks = {};
      (data.msgArray || []).forEach(item => {
        const code     = item.c;
        const price    = parseFloat(item.z) || parseFloat(item.y) || 0;
        const prev     = parseFloat(item.y) || 0;
        const change   = +(price - prev).toFixed(2);
        const changePct= prev > 0 ? +((change / prev) * 100).toFixed(2) : 0;
        rawStocks[code] = {
          name: item.n || code, price, change, changePct,
          open: parseFloat(item.o)||0, high: parseFloat(item.h)||0,
          low: parseFloat(item.l)||0, prev, volume: parseInt(item.v)||0, time: item.t||''
        };
      });
    }
  } catch(e) {
    console.warn('fetchStockPrices failed:', e.message);
    return;
  }

  // åˆä½µé€² cacheï¼Œè£œéœæ…‹è³‡æ–™
  Object.entries(rawStocks || {}).forEach(([code, s]) => {
    state.stockCache[code] = {
      ...s,
      ...(STOCK_STATIC[code] || { pe:'-', yield:'-', sector:'å…¶ä»–' }),
      name: s.name || STOCK_NAMES[code] || code,
      updatedAt: new Date(),
    };
  });
}

// â”€â”€ TWSE å¤§ç›¤åŠ æ¬ŠæŒ‡æ•¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTWSEIndex() {
  try {
    const workerPath = '?type=twse_index';
    const fallbackUrl = 'https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=tse_t00.tw&json=1&delay=0';

    let idx;
    if (WORKER_URL) {
      idx = await proxyFetch(workerPath, fallbackUrl);
    } else {
      const raw  = await proxyFetch(null, fallbackUrl);
      const item = raw.msgArray?.[0];
      if (!item) return;
      const price = parseFloat(item.z) || parseFloat(item.y) || 0;
      const prev  = parseFloat(item.y) || 0;
      idx = { price, prev, change: +(price-prev).toFixed(2),
              changePct: prev>0 ? +((price-prev)/prev*100).toFixed(2) : 0 };
    }
    state.twseIndex = idx;
    updateIndexCard();
  } catch(e) { console.warn('fetchTWSEIndex failed:', e.message); }
}

// â”€â”€ Yahoo Financeï¼ˆç¾è‚¡ + åŒ¯ç‡ + å•†å“ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// åªæœ‰ Worker æ¨¡å¼æ‰èƒ½ç©©å®šæŠ“ï¼Œallorigins æ‰“ Yahoo é€šå¸¸è¢«æ“‹
const YAHOO_SYMBOLS = '^GSPC,^IXIC,^DJI,^SOX,USDTWD=X,USDJPY=X,CL=F,GC=F,^VIX,^TNX,^TYX,DX-Y.NYB';

async function fetchYahooData() {
  if (!WORKER_URL) {
    showMacroNote('ğŸ’¡ è¨­å®š Cloudflare Worker å¾Œå¯è‡ªå‹•è¼‰å…¥ç¾è‚¡ã€åŒ¯ç‡ã€å•†å“å³æ™‚è³‡æ–™');
    return;
  }
  try {
    const res  = await fetch(`${WORKER_URL}?type=yahoo&symbols=${encodeURIComponent(YAHOO_SYMBOLS)}`,
      { signal: AbortSignal.timeout(12000) });
    if (!res.ok) throw new Error(`Worker å›æ‡‰ ${res.status}`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    state.yahooData = data.result || {};
    if (Object.keys(state.yahooData).length === 0) throw new Error('No quote data returned');
    updateMacroCards();
    updateOverviewCards();
    // éš±è—ã€Œè¦‹é™„è¨»ã€æ–‡å­—
    document.getElementById('sp500-price').style.fontSize  = '';
    document.getElementById('usdtwd-price').style.fontSize = '';
  } catch(e) {
    console.warn('Yahoo fetch failed:', e.message);
    // è®“ä½¿ç”¨è€…çœ‹åˆ°å…·é«”éŒ¯èª¤è€Œéåªæ˜¯ç©ºç™½
    const errMsg = `âš ï¸ ç¾è‚¡è³‡æ–™æš«æ™‚ç„¡æ³•è¼‰å…¥ï¼ˆ${e.message}ï¼‰`;
    document.getElementById('sp500-change').innerHTML  = `<span style="font-size:11px;color:var(--gold);">${errMsg}</span>`;
    document.getElementById('usdtwd-change').innerHTML = `<span style="font-size:11px;color:var(--gold);">è«‹ç¨å¾Œé‡è©¦æˆ–é‡æ•´é é¢</span>`;
    document.getElementById('sp500-price').textContent  = '--';
    document.getElementById('usdtwd-price').textContent = '--';
  }
}

// â”€â”€ RSS æ–°è â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchRSSNews() {
  if (!WORKER_URL) return; // éœ€è¦ Worker æ‰èƒ½æŠ“ RSS
  try {
    // åŒæ™‚æŠ“å¤šå€‹ä¾†æº
    const [cnyes, udn] = await Promise.allSettled([
      fetch(`${WORKER_URL}?type=rss&feed=cnyes`).then(r=>r.json()),
      fetch(`${WORKER_URL}?type=rss&feed=udn`).then(r=>r.json()),
    ]);
    const items = [
      ...(cnyes.value?.items || []),
      ...(udn.value?.items   || []),
    ].slice(0, 12);
    if (items.length) renderRealNews(items);
  } catch(e) { console.warn('RSS fetch failed:', e.message); }
}

// â”€â”€ TWSE ç›¤å¾Œæ¼²è·Œå¹…æ’è¡Œï¼ˆè£œå……ç”¨ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTWSEMovers() {
  try {
    const today = getTWSEDateStr();
    const workerPath = `?type=twse_movers&date=${today}`;
    const fallbackUrl = `https://www.twse.com.tw/rwd/zh/afterTrading/STOCK_DAY_ALL?date=${today}&response=json`;

    let stocks;
    if (WORKER_URL) {
      const data = await proxyFetch(workerPath, fallbackUrl);
      stocks = data.stocks;
    } else {
      const raw = await proxyFetch(null, fallbackUrl);
      if (!raw.data) return;
      stocks = raw.data.map(row => {
        const code = row[0]?.trim();
        const close = parseFloat(row[7]?.replace(/,/g,''))||0;
        const sign  = row[8]?.trim();
        const pts   = parseFloat(row[9]?.replace(/,/g,''))||0;
        const change = sign==='-' ? -pts : pts;
        const prev  = close - change;
        return {
          code, name: row[1]?.trim(),
          volume: parseInt(row[2]?.replace(/,/g,''))||0,
          close, change: +change.toFixed(2),
          changePct: prev>0 ? +((change/prev)*100).toFixed(2) : 0
        };
      }).filter(s => s.code && s.close > 0);
    }

    // åˆä½µé€² cacheï¼ˆä¸è¦†è“‹ç›¤ä¸­å³æ™‚è³‡æ–™ï¼‰
    (stocks||[]).forEach(s => {
      if (!state.stockCache[s.code]) {
        state.stockCache[s.code] = {
          name: s.name || STOCK_NAMES[s.code] || s.code,
          price: s.close, change: s.change, changePct: s.changePct,
          volume: s.volume,
          ...(STOCK_STATIC[s.code] || { pe:'-', yield:'-', sector:'å…¶ä»–' }),
          updatedAt: new Date(),
        };
      }
    });
  } catch(e) { console.warn('fetchTWSEMovers failed:', e.message); }
}

function getTWSEDateStr() {
  const d = new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
}

// â”€â”€ ä¸»è¦è³‡æ–™è¼‰å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAllData() {
  // æ”¶é›†æ‰€æœ‰é¡è‚¡ä»£ç¢¼ï¼Œç¢ºä¿ç†±åŠ›åœ–æœ‰å®Œæ•´è³‡æ–™
  const sectorCodes = Object.values(SECTOR_STOCKS).flat();
  const allCodes = [...new Set([...state.watchlist, ...sectorCodes,
    '2330','2317','2454','2382','2412','2881','2886','2308','2303','3034'])];

  // åŒæ™‚ç™¼èµ·æ‰€æœ‰è«‹æ±‚
  await Promise.allSettled([
    fetchStockPrices(allCodes),
    fetchTWSEIndex(),
    fetchYahooData(),
  ]);

  // ç›¤å¾Œè£œå……æˆäº¤æ’è¡Œ
  if (!state.isMarketOpen) {
    await fetchTWSEMovers();
  }

  // RSS æ–°èï¼ˆéé˜»å¡ï¼‰
  fetchRSSNews();
  // è¶¨å‹¢åˆ†æé åˆå§‹åŒ–
  setTimeout(initTrendPage, 500);
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
  updateClock();
  setInterval(updateClock, 1000);
  checkMarketStatus();

  // å…ˆé¡¯ç¤ºéª¨æ¶ï¼Œè®“ UI ç«‹åˆ»å‡ºç¾
  renderWatchlistSkeleton();
  renderNews();
  renderAiRecs();
  renderMacro();
  renderCalendar();
  animateSentiment(62);

  // æŠ“ TWSE çœŸå¯¦è³‡æ–™
  await loadAllData();

  // ç”¨çœŸå¯¦è³‡æ–™æ›´æ–°ç•«é¢
  const cacheSize = Object.keys(state.stockCache).length;
  if (cacheSize === 0) {
    // CORS proxy å¯èƒ½æš«æ™‚ä¸å¯ç”¨ï¼Œé¡¯ç¤ºæç¤º
    document.getElementById('quickAlerts').innerHTML = `
      <div class="alert-item">
        <div class="alert-icon">âš ï¸</div>
        <div class="alert-text" style="color:var(--gold);">
          <strong>è³‡æ–™è¼‰å…¥ä¸­...</strong><br>
          <span class="text-xs">è‹¥æŒçºŒç„¡æ³•è¼‰å…¥ï¼Œå¯èƒ½æ˜¯ CORS proxy æš«æ™‚é™æµã€‚<br>è«‹ç¨å¾Œé‡æ–°æ•´ç†ï¼Œæˆ–æ”¹ç”¨æœ¬æ©Ÿé–‹ç™¼ä¼ºæœå™¨ã€‚</span>
        </div>
      </div>`;
  }
  renderTicker();
  renderOverview();
  renderWatchlist();
  renderPortfolio();

  // ç›¤ä¸­æ¯60ç§’è‡ªå‹•æ›´æ–°
  if (state.isMarketOpen) {
    setInterval(async () => {
      const allCodes = [...new Set([...state.watchlist,'2330','2317','2454','2382','2412'])];
      await Promise.all([fetchStockPrices(allCodes), fetchTWSEIndex()]);
      renderTicker();
      renderWatchlist();
      updateIndexCard();
      renderMovers(moverFilter);
    }, 60000);
  }
});

function updateClock() {
  const now = new Date();
  const tw = new Intl.DateTimeFormat('zh-TW', {
    timeZone:'Asia/Taipei', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
  }).format(now);
  document.getElementById('currentTime').textContent = tw + ' (å°åŒ—)';
}

function checkMarketStatus() {
  const now = new Date();
  const twnow = new Date(now.toLocaleString('en-US', { timeZone:'Asia/Taipei' }));
  const hour = twnow.getHours();
  const min  = twnow.getMinutes();
  const day  = twnow.getDay();
  const open = day >= 1 && day <= 5
    && ((hour === 9 && min >= 0) || hour === 10 || hour === 11 || hour === 12)
    && !(hour === 13 && min >= 31);
  state.isMarketOpen = open;
  const dot = document.getElementById('marketStatusDot');
  const txt = document.getElementById('marketStatusText');
  if (open) { dot.className = 'status-dot'; txt.textContent = 'å°è‚¡äº¤æ˜“ä¸­'; }
  else       { dot.className = 'status-dot closed'; txt.textContent = 'ç›¤å¾Œ'; }
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('page-' + tab).classList.add('active');
  // åˆ‡åˆ°æ³•äººé è‡ªå‹•è¼‰å…¥
  if (tab === 'institutional') loadInstitutional();
  // åˆ‡åˆ°è¶¨å‹¢é åˆå§‹åŒ–
  if (tab === 'trend') initTrendPage();
}

// ============================================================
// INDEX CARD æ›´æ–°ï¼ˆå¤§ç›¤ï¼‰
// ============================================================
function updateIndexCard() {
  const idx = state.twseIndex;
  if (!idx || !idx.price) return;
  const isUp = idx.change >= 0;
  const cls  = isUp ? 'up' : 'down';
  const sign = isUp ? '+' : '';
  const priceStr = idx.price.toLocaleString('zh-TW', { minimumFractionDigits:2, maximumFractionDigits:2 });
  document.getElementById('twse-price').textContent = priceStr;
  document.getElementById('twse-change').innerHTML =
    `<span class="${cls}">${sign}${idx.change.toFixed(2)} (${sign}${idx.changePct.toFixed(2)}%)</span>`;
  // sparkline ç”¨éš¨æ©Ÿæ¨¡æ“¬èµ°å‹¢ï¼ˆTWSE å…è²»ç«¯é»ç„¡åˆ†æ™‚è³‡æ–™ï¼‰
  renderSparkline('twse-spark', randomWalkData(20, idx.price * 0.985, idx.price * 1.015), isUp);
}

// ============================================================
// TICKERï¼ˆç”¨çœŸå¯¦å¿«å–è³‡æ–™ï¼‰
// ============================================================
function renderTicker() {
  const codes = Object.keys(state.stockCache).slice(0, 12);
  if (!codes.length) return;
  const items = codes.map(code => {
    const s = state.stockCache[code];
    const cls  = s.changePct >= 0 ? 'up' : 'down';
    const sign = s.changePct >= 0 ? '+' : '';
    return `<div class="ticker-item"><span class="name">${s.name}(${code})</span><span class="${cls}">${s.price.toFixed(1)}</span><span class="${cls}">${sign}${s.changePct.toFixed(2)}%</span></div>`;
  });
  const doubled = [...items, ...items];
  document.getElementById('tickerInner').innerHTML = doubled.join('');
}

// ============================================================
// OVERVIEW
// ============================================================
function renderOverview() {
  // å¤§ç›¤
  updateIndexCard();

  // S&P500ã€USD/TWD ç›®å‰ç„¡å…è²»å³æ™‚ APIï¼Œé¡¯ç¤ºæç¤º
  document.getElementById('sp500-price').textContent = 'è¦‹é™„è¨»';
  document.getElementById('sp500-change').innerHTML = '<span class="text-dim" style="font-size:12px;">éœ€å¦è¨­ API</span>';
  renderSparkline('sp500-spark', randomWalkData(20, 5700, 5900), true);
  document.getElementById('usdtwd-price').textContent = 'è¦‹é™„è¨»';
  document.getElementById('usdtwd-change').innerHTML = '<span class="text-dim" style="font-size:12px;">éœ€å¦è¨­ API</span>';
  renderSparkline('usdtwd-spark', randomWalkData(20, 31.8, 32.4), false);

  renderHeatmap();
  animateSentiment(62);
  renderMovers('gain');
  renderSectors();
  renderQuickAlerts();
}

function randomWalkData(n, min, max) {
  const data = [];
  let v = (min + max) / 2;
  for (let i = 0; i < n; i++) {
    v += (Math.random() - 0.48) * (max - min) / 8;
    v = Math.min(max, Math.max(min, v));
    data.push(v);
  }
  return data;
}

function renderSparkline(id, data, up) {
  const svg = document.getElementById(id);
  if (!svg) return;
  const w = 200, h = 50;
  const minV = Math.min(...data), maxV = Math.max(...data);
  const range = maxV - minV || 1;
  const pts = data.map((v, i) => {
    const x = (i / (data.length - 1)) * w;
    const y = h - ((v - minV) / range) * (h - 8) - 4;
    return `${x},${y}`;
  });
  const color = up ? 'var(--green)' : 'var(--red)';
  svg.innerHTML = `<polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="2" stroke-linejoin="round"/>`;
}

function renderHeatmap() {
  const container = document.getElementById('heatmapGrid');
  // ç”¨å¿«å–è³‡æ–™è¨ˆç®—å„é¡è‚¡å¹³å‡æ¼²è·Œ
  const sectorPcts = Object.entries(SECTOR_STOCKS).map(([name, stocks]) => {
    const cached = stocks.map(c => state.stockCache[c]).filter(Boolean);
    const avg = cached.length
      ? cached.reduce((a,b) => a + b.changePct, 0) / cached.length
      : 0;
    return { name, pct: parseFloat(avg.toFixed(2)), dataCount: cached.length };
  });
  container.innerHTML = sectorPcts
    .filter(s => s.dataCount > 0)   // åªé¡¯ç¤ºæœ‰çœŸå¯¦è³‡æ–™çš„é¡è‚¡
    .map(s => {
      const abs     = Math.abs(s.pct);
      const opacity = 0.2 + Math.min(abs * 0.2, 0.6);
      const bg   = s.pct >= 0 ? `rgba(16,185,129,${opacity})` : `rgba(239,68,68,${opacity})`;
      const txt  = s.pct >= 0 ? 'var(--green)' : 'var(--red)';
      const sign = s.pct >= 0 ? '+' : '';
      const icon = (typeof SECTOR_ICONS !== 'undefined' ? SECTOR_ICONS[s.name] : '') || 'ğŸ“Š';
      return `<div class="heatmap-cell" style="background:${bg};" onclick="quickChat('åˆ†æå°ç£${s.name}é¡è‚¡ä»Šæ—¥èµ°å‹¢åŸå› ')">
        <div class="cell-name">${icon} ${s.name}</div>
        <div class="cell-pct" style="color:${txt}">${sign}${s.pct}%</div>
        <div style="font-size:10px;color:rgba(255,255,255,.35);">${s.dataCount}æ”¯</div>
      </div>`;
    }).join('') || '<div style="color:var(--text-dim);padding:20px;text-align:center;">è³‡æ–™è¼‰å…¥ä¸­...</div>';
}

function animateSentiment(score) {
  const circumference = 251.2;
  const offset = circumference - (score / 100) * circumference;
  const ring  = document.getElementById('sentimentRing');
  const color = score > 60 ? 'var(--green)' : score > 40 ? 'var(--gold)' : 'var(--red)';
  ring.style.strokeDashoffset = offset;
  ring.style.stroke = color;
}

function renderQuickAlerts() {
  // å¾çœŸå¯¦å¿«å–æŠ“å‡ºä»Šæ—¥æœ€å¤§æ¼²å¹…è‚¡
  const sorted = Object.entries(state.stockCache).sort((a,b) => b[1].changePct - a[1].changePct);
  const top    = sorted[0]?.[1];
  const bottom = sorted[sorted.length-1]?.[1];
  document.getElementById('quickAlerts').innerHTML = `
    ${top ? `<div class="alert-item"><div class="alert-icon">ğŸ”¥</div>
      <div class="alert-text">ä»Šæ—¥å¼·å‹¢è‚¡ï¼š<strong>${top.name}</strong> ${top.changePct >= 0 ? '+' : ''}${top.changePct.toFixed(2)}%</div></div>` : ''}
    ${bottom ? `<div class="alert-item"><div class="alert-icon">ğŸ“‰</div>
      <div class="alert-text">ä»Šæ—¥å¼±å‹¢è‚¡ï¼š<strong>${bottom.name}</strong> ${bottom.changePct.toFixed(2)}%</div></div>` : ''}
    <div class="alert-item"><div class="alert-icon">ğŸ”„</div>
      <div class="alert-text">è³‡æ–™ä¾†æºï¼šTWSE å®˜æ–¹ APIãƒ»${state.isMarketOpen ? 'ç›¤ä¸­æ¯60ç§’è‡ªå‹•æ›´æ–°' : 'ç›¤å¾Œæ”¶ç›¤è³‡æ–™'}</div>
    </div>`;
}

let moverFilter = 'gain';
function setMoverType(type, el) {
  document.querySelectorAll('#page-overview .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  moverFilter = type;
  renderMovers(type);
}

function renderMovers(type) {
  const stocks = Object.entries(state.stockCache);
  if (!stocks.length) {
    document.getElementById('moverTableBody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-dim);padding:20px;">è¼‰å…¥ä¸­...</td></tr>';
    return;
  }
  let sorted;
  if (type === 'gain')   sorted = [...stocks].sort((a,b) => b[1].changePct - a[1].changePct);
  else if (type === 'loss') sorted = [...stocks].sort((a,b) => a[1].changePct - b[1].changePct);
  else sorted = [...stocks].sort((a,b) => b[1].volume - a[1].volume);

  document.getElementById('moverTableBody').innerHTML = sorted.slice(0,8).map(([code, s]) => {
    const cls  = s.changePct >= 0 ? 'up' : 'down';
    const sign = s.changePct >= 0 ? '+' : '';
    const vol  = s.volume >= 1000 ? (s.volume/1000).toFixed(0)+'K' : s.volume;
    return `<tr onclick="showStockDetail('${code}')">
      <td><div class="stock-name">${s.name}</div><div class="stock-code">${code}</div></td>
      <td class="price">${s.price.toFixed(1)}</td>
      <td class="change ${cls}">${sign}${s.changePct.toFixed(2)}%</td>
      <td class="text-dim text-xs">${vol}</td>
    </tr>`;
  }).join('');
}

function renderSectors() {
  const sectorPcts = Object.entries(SECTOR_STOCKS).map(([name, stocks]) => {
    const cached = stocks.map(c => state.stockCache[c]).filter(Boolean);
    const avg = cached.length
      ? cached.reduce((a,b) => a + b.changePct, 0) / cached.length : 0;
    return { name, pct: parseFloat(avg.toFixed(2)), dataCount: cached.length };
  }).filter(s => s.dataCount > 0).sort((a,b) => b.pct - a.pct);

  document.getElementById('sectorPerf').innerHTML = sectorPcts.map(s => {
    const cls  = s.pct >= 0 ? 'up' : 'down';
    const sign = s.pct >= 0 ? '+' : '';
    const width = Math.min(Math.abs(s.pct) / 4 * 100, 100);
    return `<div class="sector-bar">
      <div class="sector-name text-sm">${s.name}</div>
      <div class="bar-track"><div class="bar-fill ${cls}" style="width:${width}%"></div></div>
      <div class="sector-pct ${cls}">${sign}${s.pct}%</div>
    </div>`;
  }).join('');
}

// ============================================================
// WATCHLISTï¼ˆç”¨çœŸå¯¦ TWSE è³‡æ–™ï¼‰
// ============================================================
function renderWatchlistSkeleton() {
  document.getElementById('watchlistBody').innerHTML =
    Array(5).fill('<tr>' + Array(7).fill('<td><div style="background:var(--surface2);border-radius:4px;height:16px;width:80%;"></div></td>').join('') + '</tr>').join('');
}

async function renderWatchlist() {
  // ç¢ºä¿è‡ªé¸è‚¡éƒ½æœ‰è³‡æ–™
  const missing = state.watchlist.filter(c => !state.stockCache[c]);
  if (missing.length) await fetchStockPrices(missing);

  const body = document.getElementById('watchlistBody');
  if (!state.watchlist.length) {
    body.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);padding:30px;">å°šç„¡è‡ªé¸è‚¡ï¼Œè«‹æ–°å¢</td></tr>';
    return;
  }
  body.innerHTML = state.watchlist.map(code => {
    const s    = state.stockCache[code];
    if (!s) return `<tr><td colspan="7" class="text-dim text-xs" style="padding:12px;">${code} è³‡æ–™è¼‰å…¥ä¸­...</td></tr>`;
    const cls  = s.changePct >= 0 ? 'up' : 'down';
    const sign = s.changePct >= 0 ? '+' : '';
    const rec  = getSimpleRec(s);
    const vol  = s.volume >= 1000 ? (s.volume/1000).toFixed(0)+'K' : s.volume;
    return `<tr onclick="showWatchlistDetail('${code}')">
      <td><div class="stock-name">${s.name}</div><div class="stock-code">${code}</div></td>
      <td class="price">${s.price.toFixed(1)}</td>
      <td class="change ${cls}">${sign}${s.change.toFixed(1)}</td>
      <td class="change ${cls}">${sign}${s.changePct.toFixed(2)}%</td>
      <td class="text-dim text-xs">${vol}</td>
      <td><span class="tag ${rec.cls}">${rec.label}</span></td>
      <td><button class="btn-danger" onclick="event.stopPropagation();removeFromWatchlist('${code}')">âœ•</button></td>
    </tr>`;
  }).join('');
}

function getSimpleRec(s) {
  if (s.changePct > 1.5)  return { cls:'tag-green', label:'çœ‹æ¼²' };
  if (s.changePct < -1.5) return { cls:'tag-red',   label:'æ³¨æ„' };
  return { cls:'tag-gold', label:'è§€å¯Ÿ' };
}

async function addToWatchlist() {
  const input = document.getElementById('watchlistInput');
  const code  = input.value.trim().replace(/\D/g,''); // åªå–æ•¸å­—
  if (!code) return;
  if (state.watchlist.includes(code)) { alert('å·²åœ¨è‡ªé¸è‚¡æ¸…å–®ä¸­'); return; }
  state.watchlist.push(code);
  localStorage.setItem('watchlist', JSON.stringify(state.watchlist));
  input.value = '';
  renderWatchlistSkeleton();
  await fetchStockPrices([code]);
  renderWatchlist();
  renderTicker();
}

function removeFromWatchlist(code) {
  state.watchlist = state.watchlist.filter(c => c !== code);
  localStorage.setItem('watchlist', JSON.stringify(state.watchlist));
  renderWatchlist();
}

function showWatchlistDetail(code) {
  const s = state.stockCache[code];
  if (!s) return;
  const cls  = s.changePct >= 0 ? 'up' : 'down';
  const sign = s.changePct >= 0 ? '+' : '';
  const updatedStr = s.updatedAt
    ? new Intl.DateTimeFormat('zh-TW',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Asia/Taipei'}).format(s.updatedAt)
    : '--';
  document.getElementById('watchlistDetail').innerHTML = `
    <div class="card-title" style="margin-bottom:16px;">ğŸ“Š ${s.name} <span class="stock-code">${code}</span></div>
    <div class="price ${cls}" style="font-size:28px;font-family:'Space Mono',monospace;">${s.price.toFixed(1)}</div>
    <div class="change ${cls}" style="font-size:14px;margin-bottom:4px;">${sign}${s.change.toFixed(1)} (${sign}${s.changePct.toFixed(2)}%)</div>
    <div class="text-xs text-dim" style="margin-bottom:16px;">æ›´æ–°æ™‚é–“ ${updatedStr}</div>
    <div class="stats-grid" style="grid-template-columns:1fr 1fr;">
      <div class="stat-box"><div class="stat-label">ä»Šé–‹</div><div class="stat-value">${s.open || '--'}</div></div>
      <div class="stat-box"><div class="stat-label">æ˜¨æ”¶</div><div class="stat-value">${s.prev || '--'}</div></div>
      <div class="stat-box"><div class="stat-label">ä»Šé«˜</div><div class="stat-value up">${s.high || '--'}</div></div>
      <div class="stat-box"><div class="stat-label">ä»Šä½</div><div class="stat-value down">${s.low || '--'}</div></div>
      <div class="stat-box"><div class="stat-label">æœ¬ç›Šæ¯”</div><div class="stat-value">${s.pe}</div></div>
      <div class="stat-box"><div class="stat-label">æ®–åˆ©ç‡</div><div class="stat-value">${s.yield}%</div></div>
    </div>
    <button class="btn mt-4" style="width:100%;margin-top:12px;" onclick="quickChat('å¹«æˆ‘åˆ†æ ${s.name} (${code}) é€™æ”¯è‚¡ç¥¨ï¼Œç¾åƒ¹ ${s.price.toFixed(1)} å…ƒï¼Œä»Šæ—¥æ¼²è·Œ ${sign}${s.changePct.toFixed(2)}%ï¼Œè«‹çµ¦æˆ‘æ“ä½œå»ºè­°ã€‚')">ğŸ¤– AI æ·±åº¦åˆ†æ</button>
    <button class="btn-outline" style="width:100%;margin-top:8px;" onclick="openAddHolding('${code}')">+ åŠ å…¥æŒè‚¡</button>
  `;
}

// ============================================================
// PORTFOLIO
// ============================================================
async function renderPortfolio() {
  if (state.portfolio.length === 0) {
    document.getElementById('portfolioBody').innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--text-dim);padding:30px;">é»é¸å³ä¸Šè§’ã€Œæ–°å¢æŒè‚¡ã€é–‹å§‹è¨˜éŒ„æ‚¨çš„æŒè‚¡</td></tr>`;
    ['totalAsset','totalCost','totalPnl','totalPnlPct'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent='--';});
    const pie=document.getElementById('pieChartContainer');if(pie)pie.innerHTML='';
    return;
  }
  const missing = state.portfolio.map(h=>h.code).filter(c => !state.stockCache[c]);
  if (missing.length) await fetchStockPrices(missing);

  let totalAsset = 0, totalCost = 0;
  const rows = state.portfolio.map(h => {
    const cached = state.stockCache[h.code];
    const price  = cached?.price || h.cost;
    const name   = cached?.name || STOCK_NAMES[h.code] || h.code;
    const marketVal = price * h.lots * 1000;
    const costVal   = h.cost * h.lots * 1000;
    const pnl    = marketVal - costVal;
    const pnlPct = costVal > 0 ? (pnl / costVal) * 100 : 0;
    totalAsset  += marketVal;
    totalCost   += costVal;
    const cls = pnl >= 0 ? 'up' : 'down';
    return `<tr>
      <td><div class="stock-name">${name}</div><div class="stock-code">${h.code}</div></td>
      <td>${h.lots}</td>
      <td class="price">${h.cost.toFixed(1)}</td>
      <td class="price">${price.toFixed(1)}</td>
      <td class="price">${(marketVal/10000).toFixed(1)}è¬</td>
      <td class="change ${cls}">${pnl >= 0 ? '+' : ''}${(pnl/10000).toFixed(1)}è¬</td>
      <td class="change ${cls}">${pnl >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</td>
      <td><button class="btn-danger" onclick="removeHolding('${h.code}')">âœ•</button></td>
    </tr>`;
  });
  document.getElementById('portfolioBody').innerHTML = rows.join('');
  const totalPnl = totalAsset - totalCost;
  const totalPnlPct = totalCost > 0 ? (totalPnl / totalCost) * 100 : 0;
  document.getElementById('totalAsset').textContent = `${(totalAsset/10000).toFixed(0)}è¬`;
  document.getElementById('totalCost').textContent  = `${(totalCost/10000).toFixed(0)}è¬`;
  document.getElementById('totalPnl').textContent   = `${totalPnl >= 0 ? '+' : ''}${(totalPnl/10000).toFixed(1)}è¬`;
  document.getElementById('totalPnlPct').textContent= `${totalPnl >= 0 ? '+' : ''}${totalPnlPct.toFixed(2)}%`;
  document.getElementById('pnlCard').className      = `portfolio-stat ${totalPnl >= 0 ? 'profit' : 'loss'}`;
  document.getElementById('pnlPctCard').className   = `portfolio-stat ${totalPnl >= 0 ? 'profit' : 'loss'}`;
  const pieContainer = document.getElementById('pieChartContainer');
  const colors = ['var(--accent)','var(--green)','var(--gold)','var(--accent2)','var(--red)'];
  pieContainer.innerHTML = state.portfolio.map((h, i) => {
    const cached = state.stockCache[h.code];
    const price  = cached?.price || h.cost;
    const name   = cached?.name  || STOCK_NAMES[h.code] || h.code;
    const val  = price * h.lots * 1000;
    const pct  = totalAsset > 0 ? (val / totalAsset) * 100 : 0;
    return `<div class="sector-bar">
      <div class="sector-name text-sm">${name}</div>
      <div class="bar-track"><div class="bar-fill up" style="width:${pct}%;background:${colors[i%colors.length]};"></div></div>
      <div class="sector-pct">${pct.toFixed(1)}%</div>
    </div>`;
  }).join('');
}

function openAddHolding(code) {
  if (code) document.getElementById('holdingCode').value = code;
  document.getElementById('holdingModal').classList.add('open');
}
function closeHoldingModal() { document.getElementById('holdingModal').classList.remove('open'); }
function addHolding() {
  const code = document.getElementById('holdingCode').value.trim();
  const lots = parseFloat(document.getElementById('holdingLots').value);
  const cost = parseFloat(document.getElementById('holdingCost').value);
  if (!code || !lots || !cost) { alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }
  state.portfolio.push({ code, lots, cost });
  localStorage.setItem('portfolio', JSON.stringify(state.portfolio));
  closeHoldingModal();
  renderPortfolio();
}
function removeHolding(code) {
  state.portfolio = state.portfolio.filter(h => h.code !== code);
  localStorage.setItem('portfolio', JSON.stringify(state.portfolio));
  renderPortfolio();
}

// ============================================================
// AI RECS
// ============================================================
function renderAiRecs(filter) {
  const recs = filter ? AI_RECS.filter(r => r.rec === filter) : AI_RECS;
  document.getElementById('aiRecList').innerHTML = recs.map(r => {
    const sign = r.rec === 'buy' ? 'è²·' : r.rec === 'sell' ? 'è³£' : 'ç•™';
    return `<div class="ai-score ${r.rec}">
      <div class="score-circle ${r.rec}">
        <div>${r.score}</div>
        <div class="ai-rec-label" style="font-size:9px;">${sign}</div>
      </div>
      <div class="ai-stock-info">
        <div class="ai-stock-name">${r.name} <span class="stock-code">${r.code}</span></div>
        <div class="ai-reason">${r.reason}</div>
        <div class="ai-tags">
          ${r.tags.map(t => `<span class="tag ${r.rec==='buy'?'tag-green':r.rec==='sell'?'tag-red':'tag-gold'}">${t}</span>`).join('')}
        </div>
      </div>
      <button class="btn-outline" onclick="quickChat('æ·±åº¦åˆ†æ ${r.name} (${r.code}) å€¼å¾—${r.rec==='buy'?'è²·é€²':'è§€å¯Ÿ'}å—ï¼Ÿ')">åˆ†æ</button>
    </div>`;
  }).join('');
}

function filterAiRec(type, el) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderAiRecs(type);
}

function runAiAnalysis() {
  document.getElementById('aiRecList').innerHTML = '<div class="loading"><div class="spinner"></div> AI é‡æ–°åˆ†æä¸­...</div>';
  setTimeout(renderAiRecs, 2000);
}

// ============================================================
// NEWS
// ============================================================
function renderNews(filter) {
  const list = filter && filter !== 'all' ? NEWS_DATA.filter(n => n.tags.includes(filter)) : NEWS_DATA;
  document.getElementById('newsLoading').style.display = 'none';
  document.getElementById('newsList').innerHTML = list.map(n => {
    const impactCls = n.impact === 'high' ? 'tag-red' : n.impact === 'medium' ? 'tag-gold' : 'tag-blue';
    const impactLabel = n.impact === 'high' ? 'é«˜å½±éŸ¿' : n.impact === 'medium' ? 'ä¸­å½±éŸ¿' : 'ä½å½±éŸ¿';
    const stockTags = n.stocks.map(code => {
      const s = state.stockCache[code];
      const sName = s?.name || STOCK_NAMES[code] || code;
      return `<span class="tag ${n.positive?'tag-green':'tag-red'}">${sName}${n.positive?'â†‘':'â†“'}</span>`;
    }).join('');
    return `<div class="news-item">
      <div class="news-meta">
        <span class="news-source">${n.source}</span>
        <span class="news-time">${n.time}</span>
        <span class="tag ${impactCls} news-impact">${impactLabel}</span>
        ${n.positive ? '<span class="tag tag-green">æ­£é¢</span>' : '<span class="tag tag-red">è² é¢</span>'}
      </div>
      <div class="news-title">${n.title}</div>
      <div class="news-summary">${n.summary}</div>
      ${stockTags ? `<div class="ai-tags" style="margin-top:8px;">${stockTags}</div>` : ''}
    </div>`;
  }).join('');
}

function filterNews(type, el) {
  document.querySelectorAll('.filter-bar .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderNews(type === 'all' ? null : type);
}

function refreshNews() {
  document.getElementById('newsLoading').style.display = 'flex';
  document.getElementById('newsList').innerHTML = '';
  if (WORKER_URL) {
    fetchRSSNews().then(() => {
      document.getElementById('newsLoading').style.display = 'none';
    });
  } else {
    setTimeout(() => renderNews(), 800);
  }
}

function renderRealNews(items) {
  document.getElementById('newsLoading').style.display = 'none';
  const sourceLabel = { cnyes:'é‰…äº¨ç¶²', udn:'è¯åˆè²¡ç¶“', chinatimes:'ä¸­æ™‚', moneydj:'MoneyDJ' };
  document.getElementById('newsList').innerHTML = items.map(n => {
    const src     = sourceLabel[n.source] || n.source;
    const tStr    = n.pubDate ? relativeTime(new Date(n.pubDate)) : '';
    const hasLink = n.link && n.link.startsWith('http');
    // æœ‰é€£çµï¼šé»æ¨™é¡Œé–‹æ–°åˆ†é ï¼›æ²’é€£çµï¼šæ•´å¼µå¡ä»å¯çœ‹æ‘˜è¦
    return `<div class="news-item" style="${hasLink ? 'cursor:pointer;' : ''}" ${hasLink ? `onclick="window.open('${n.link}','_blank')"` : ''}>
      <div class="news-meta">
        <span class="news-source">${src}</span>
        <span class="news-time">${tStr}</span>
        <span class="tag tag-blue">å³æ™‚</span>
        ${hasLink ? '<span class="tag" style="background:rgba(0,212,255,.1);color:var(--accent);font-size:10px;">ğŸ”— é»æ“Šé–‹å•Ÿ</span>' : ''}
      </div>
      <div class="news-title" style="${hasLink ? 'color:var(--text);' : ''}">${n.title}</div>
      ${n.desc ? `<div class="news-summary">${n.desc}...</div>` : ''}
    </div>`;
  }).join('');
  state.rssNews = items;
}

function relativeTime(d) {
  const mins = Math.floor((Date.now() - d) / 60000);
  if (mins < 1)   return 'å‰›å‰›';
  if (mins < 60)  return `${mins}åˆ†é˜å‰`;
  if (mins < 1440) return `${Math.floor(mins/60)}å°æ™‚å‰`;
  return `${Math.floor(mins/1440)}å¤©å‰`;
}

function searchStockNews() {
  const q = document.getElementById('newsStockSearch').value.trim();
  const s = state.stockCache[q];
  const name = s?.name || STOCK_NAMES[q] || q;
  const related = NEWS_DATA.filter(n => n.stocks.includes(q) || n.title.includes(name));
  document.getElementById('stockNewsList').innerHTML = related.length ? related.map(n => `
    <div class="news-item">
      <div class="news-meta"><span class="news-source">${n.source}</span><span class="news-time">${n.time}</span></div>
      <div class="news-title">${n.title}</div>
    </div>`).join('') : `<div style="text-align:center;color:var(--text-dim);font-size:13px;padding:20px;">æ‰¾ä¸åˆ° ${q} ç›¸é—œæ–°è</div>`;
}

// ============================================================
// MACRO
// ============================================================
function renderMacro() {
  // å…ˆç”¨é è¨­å€¼ä½”ä½ï¼Œç­‰ Yahoo è³‡æ–™å›ä¾†å†æ›´æ–°
  const defaults = {
    'dji':['--','--',true],'ixic':['--','--',true],'spx':['--','--',true],'sox':['--','--',true],
    'usdtwd2':['--','--',false],'usdjpy':['--','--',true],
    'wti':['--','--',true],'gold':['--','--',false],
    'vix':['--','--',false],'ust10y':['--','--',true],'ust2y':['--','--',false],'dxy':['--','--',true],
  };
  Object.entries(defaults).forEach(([id,[val,ch,up]])=>{
    const el=document.getElementById(id);
    const ch_el=document.getElementById(id+'-ch');
    if(el) el.textContent=val;
    if(ch_el){ch_el.textContent=ch;ch_el.className=`change ${up?'up':'down'}`;}
  });
  if (Object.keys(state.yahooData).length) updateMacroCards();
}

// Yahoo è³‡æ–™æ˜ å°„åˆ°é é¢å…ƒç´ 
const YAHOO_MAP = {
  '^DJI'    :['dji','dji-ch'],
  '^IXIC'   :['ixic','ixic-ch'],
  '^GSPC'   :['spx','spx-ch'],
  '^SOX'    :['sox','sox-ch'],
  'USDTWD=X':['usdtwd2','usdtwd2-ch'],
  'USDJPY=X':['usdjpy','usdjpy-ch'],
  'CL=F'    :['wti','wti-ch'],
  'GC=F'    :['gold','gold-ch'],
  '^VIX'    :['vix','vix-ch'],
  '^TNX'    :['ust10y','ust10y-ch'],
  '^TYX'    :['ust2y','ust2y-ch'],
  'DX-Y.NYB':['dxy','dxy-ch'],
};

function updateMacroCards() {
  Object.entries(YAHOO_MAP).forEach(([sym,[valId,chId]])=>{
    const d = state.yahooData[sym];
    if (!d) return;
    const isUp = d.changePct >= 0;
    const sign = isUp ? '+' : '';
    const el   = document.getElementById(valId);
    const chEl = document.getElementById(chId);
    if(el)   el.textContent  = d.price.toLocaleString();
    if(chEl){chEl.textContent= `${sign}${d.changePct.toFixed(2)}%`;
             chEl.className  = `change ${isUp?'up':'down'}`;}
  });
}

function updateOverviewCards() {
  // åŒæ™‚æ›´æ–°è¶¨å‹¢é æ©«å¹…ï¼ˆè‹¥å·²è¼‰å…¥ï¼‰
  if (document.getElementById('mtrend-twse')) setTimeout(updateMarketTrendBanner, 100);
  // S&P 500
  const sp = state.yahooData['^GSPC'];
  if(sp){
    const isUp=sp.changePct>=0; const sign=isUp?'+':'';
    document.getElementById('sp500-price').textContent = sp.price.toLocaleString();
    document.getElementById('sp500-change').innerHTML  =
      `<span class="${isUp?'up':'down'}">${sign}${sp.change.toFixed(2)} (${sign}${sp.changePct.toFixed(2)}%)</span>`;
    renderSparkline('sp500-spark', randomWalkData(20, sp.price*0.985, sp.price*1.015), isUp);
  }
  // USD/TWD
  const twd = state.yahooData['USDTWD=X'];
  if(twd){
    const isUp=twd.changePct>=0; const sign=isUp?'+':'';
    document.getElementById('usdtwd-price').textContent = twd.price.toFixed(2);
    document.getElementById('usdtwd-change').innerHTML  =
      `<span class="${isUp?'up':'down'}">${sign}${twd.change.toFixed(2)} (${sign}${twd.changePct.toFixed(2)}%)</span>`;
    renderSparkline('usdtwd-spark', randomWalkData(20, twd.price*0.996, twd.price*1.004), isUp);
  }
}

function showMacroNote(msg) {
  const el = document.getElementById('macroNote');
  if (el) { el.textContent = msg; el.style.display = 'flex'; }
}

// ============================================================
// CALENDAR
// ============================================================
function renderCalendar() {
  const earnings = [
    { day:24, month:'äºŒæœˆ', name:'å°ç©é›»æ³•èªªæœƒ', desc:'Q4è²¡å ±èªªæ˜æš¨2025å±•æœ›', importance:3 },
    { day:25, month:'äºŒæœˆ', name:'é´»æµ·è‘£äº‹æœƒ', desc:'AIä¼ºæœå™¨æ¥­å‹™èªªæ˜', importance:2 },
    { day:26, month:'äºŒæœˆ', name:'å»£é”è²¡å ±', desc:'Q4 EPSé ä¼° 6.5å…ƒ', importance:2 },
    { day:28, month:'äºŒæœˆ', name:'è¯ç™¼ç§‘è²¡å ±', desc:'AIæ‰‹æ©Ÿæ™¶ç‰‡éœ€æ±‚èªªæ˜', importance:3 },
  ];
  const macroEvents = [
    { day:23, month:'äºŒæœˆ', name:'Fed æœƒè­°ç´€è¦', desc:'è§€å¯Ÿé™æ¯è·¯å¾‘ç·šç´¢', importance:3 },
    { day:24, month:'äºŒæœˆ', name:'å°ç£ CPI', desc:'1æœˆä»½æ¶ˆè²»è€…ç‰©åƒ¹æŒ‡æ•¸', importance:2 },
    { day:26, month:'äºŒæœˆ', name:'ç¾åœ‹ PCE', desc:'Fedæœ€é‡è¦–çš„é€šè†¨æŒ‡æ¨™', importance:3 },
    { day:28, month:'äºŒæœˆ', name:'ç¾åœ‹ GDP ä¿®è¨‚å€¼', desc:'Q4 GDP ç¬¬äºŒæ¬¡ä¼°è¨ˆ', importance:2 },
  ];

  const renderEvents = (events, containerId) => {
    document.getElementById(containerId).innerHTML = events.map(e => `
      <div class="event-item">
        <div class="event-date">
          <div class="event-day">${e.day}</div>
          <div class="event-month">${e.month}</div>
        </div>
        <div class="event-body">
          <div class="event-title">${e.name}</div>
          <div class="event-desc">${e.desc}</div>
          <div class="event-importance">
            ${Array.from({length:3}).map((_,i) => `<div class="dot-importance" style="background:${i<e.importance?'var(--gold)':'var(--text-muted)'}"></div>`).join('')}
          </div>
        </div>
      </div>
    `).join('');
  };
  renderEvents(earnings, 'earningsCalendar');
  renderEvents(macroEvents, 'macroCalendar');
}

// ============================================================
// SCREENER
// ============================================================
function runScreener() {
  document.getElementById('screenerResults').innerHTML = '<div class="loading"><div class="spinner"></div> ç¯©é¸ä¸­...</div>';
  setTimeout(() => {
    const stocks = Object.entries(state.stockCache).length ? Object.entries(state.stockCache) : Object.entries(STOCK_NAMES).map(([code,name])=>[code,{name,price:0,changePct:0,pe:STOCK_STATIC[code]?.pe||'-',yield:STOCK_STATIC[code]?.yield||'-',sector:STOCK_STATIC[code]?.sector||'å…¶ä»–'}]);
    document.getElementById('screenerResults').innerHTML = `
      <div class="section-header">
        <div class="section-title">ç¯©é¸çµæœ (${stocks.length} æª”)</div>
      </div>
      <table class="stock-table">
        <thead><tr><th>è‚¡ç¥¨</th><th>ç¾åƒ¹</th><th>æ¼²è·Œ%</th><th>æœ¬ç›Šæ¯”</th><th>æ®–åˆ©ç‡</th><th>é¡è‚¡</th><th>è©•ç´š</th></tr></thead>
        <tbody>${stocks.map(([code,s]) => {
          const cls = s.changePct >= 0 ? 'up' : 'down';
          const rec = getSimpleRec(s);
          return `<tr>
            <td><div class="stock-name">${s.name}</div><div class="stock-code">${code}</div></td>
            <td class="price">${s.price.toFixed(1)}</td>
            <td class="change ${cls}">${s.changePct >= 0 ? '+' : ''}${s.changePct.toFixed(2)}%</td>
            <td>${s.pe}</td>
            <td>${s.yield}%</td>
            <td class="text-dim text-xs">${s.sector}</td>
            <td><span class="tag ${rec.cls}">${rec.label}</span></td>
          </tr>`;
        }).join('')}</tbody>
      </table>`;
  }, 800);
}

function resetScreener() {
  ['sc-sector','sc-dir'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  ['sc-pe-min','sc-pe-max','sc-yield-min','sc-yield-max',
   'sc-chg-min','sc-chg-max','sc-price-min','sc-price-max'].forEach(id => {
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('screenerResults').innerHTML = '<div style="text-align:center;color:var(--text-dim);font-size:13px;padding:30px;">è¨­å®šæ¢ä»¶å¾Œé»é¸ã€Œé–‹å§‹ç¯©é¸ã€</div>';
}

// ============================================================
// AI CHAT
// ============================================================
function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  appendChat(msg, 'user');
  
  if (!state.apiKey) {
    setTimeout(() => appendChat('âš ï¸ è«‹å…ˆè¨­å®š Claude API Key æ‰èƒ½ä½¿ç”¨ AI åˆ†æåŠŸèƒ½ã€‚é»é¸å³ä¸Šè§’ã€ŒğŸ”‘ è¨­å®š API Keyã€æŒ‰éˆ•ã€‚', 'ai'), 500);
    return;
  }
  
  appendChat('åˆ†æä¸­...', 'ai', 'thinking');
  callClaudeAPI(msg);
}

function quickChat(msg) {
  document.getElementById('chatInput').value = msg;
  switchTabById('chat');
  sendChat();
}

function switchTabById(id) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    const tabs = ['overview','watchlist','portfolio','ai-analysis','news','macro','calendar','screener','chat','institutional','trend'];
    if (tabs[i] === id) { t.click(); }
  });
  document.querySelectorAll('.tab').forEach(t => {
    if (t.textContent.includes('AI å•ç­”') || t.textContent.includes('ğŸ’¬')) {
      t.click();
    }
  });
}

function appendChat(msg, role, id) {
  const container = document.getElementById('chatContainer');
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  if (id) div.id = id;
  div.innerHTML = msg;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

async function callClaudeAPI(userMsg) {
  const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å°ç£è‚¡å¸‚åˆ†æå¸«ï¼Œç²¾é€šï¼š
- å°ç£è‚¡å¸‚æŠ€è¡“åˆ†æï¼ˆKDã€RSIã€MACDã€å¸ƒæ—é€šé“ï¼‰
- å°ç£ä¸Šå¸‚å…¬å¸è²¡å ±åˆ†æ
- ç¾è‚¡å°å°è‚¡çš„å½±éŸ¿åˆ†æ
- é—œç¨…æ”¿ç­–å°å°å» çš„å½±éŸ¿
- ç¸½é«”ç¶“æ¿ŸæŒ‡æ¨™è§£è®€
- å¤–è³‡ç±Œç¢¼åˆ†æ

ç›®å‰å¸‚å ´è³‡æ–™ï¼š
- å°ç£åŠ æ¬ŠæŒ‡æ•¸ï¼š21,583ï¼ˆ+1.33%ï¼‰
- USD/TWDï¼š32.18
- VIXææ…ŒæŒ‡æ•¸ï¼š16.8
- ä»Šæ—¥å¤–è³‡è²·è¶…ï¼š132å„„å…ƒ

è«‹ç”¨ç¹é«”ä¸­æ–‡å›è¦†ï¼Œèªè¨€è¦ªåˆ‡å°ˆæ¥­ï¼Œæ¯æ¬¡åˆ†æè¦åŒ…å«ï¼šé‡åŒ–æŒ‡æ¨™ã€é¢¨éšªæç¤ºã€æ“ä½œå»ºè­°ã€‚`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': state.apiKey,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        system: systemPrompt,
        messages: [{ role: 'user', content: userMsg }]
      })
    });
    const data = await response.json();
    const thinking = document.getElementById('thinking');
    if (thinking) thinking.remove();
    if (data.content && data.content[0]) {
      appendChat(data.content[0].text.replace(/\n/g, '<br>'), 'ai');
    } else {
      appendChat('âŒ API å›æ‡‰ç•°å¸¸ï¼Œè«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢º', 'ai');
    }
  } catch (err) {
    const thinking = document.getElementById('thinking');
    if (thinking) thinking.remove();
    appendChat(`âŒ é€£ç·šå¤±æ•—ï¼š${err.message}ã€‚è«‹ç¢ºèª API Key è¨­å®šã€‚`, 'ai');
  }
}



// ============================================================
// INSTITUTIONAL â€” ä¸‰å¤§æ³•äººè²·è³£è¶…
// ============================================================
async function loadInstitutional() {
  if (!WORKER_URL) {
    document.getElementById('instNote').textContent =
      'âš ï¸ éœ€è¨­å®š Cloudflare Worker æ‰èƒ½è¼‰å…¥æ³•äººè³‡æ–™ï¼ˆWorker æœ‰ TWSE T86 endpointï¼‰';
    document.getElementById('instBuyTable').innerHTML =
      '<div class="notice-bar">è«‹å…ˆè¨­å®š Worker ç¶²å€</div>';
    document.getElementById('instSellTable').innerHTML = '';
    document.getElementById('instTotalTable').innerHTML = '';
    return;
  }
  try {
    const today = getTWSEDateStr();
    const res   = await fetch(`${WORKER_URL}?type=institutional&date=${today}`,
      { signal: AbortSignal.timeout(12000) });
    if (!res.ok) throw new Error(`Worker å›æ‡‰ ${res.status}`);
    const data  = await res.json();
    if (data.error) throw new Error(data.error);
    renderInstitutional(data);
  } catch(e) {
    const msg = `<div style="color:var(--gold);padding:20px;text-align:center;font-size:13px;">âš ï¸ è¼‰å…¥å¤±æ•—ï¼š${e.message}<br><button class="btn-outline" style="margin-top:8px;" onclick="loadInstitutional()">é‡è©¦</button></div>`;
    document.getElementById('instBuyTable').innerHTML  = msg;
    document.getElementById('instSellTable').innerHTML = '';
    document.getElementById('instTotalTable').innerHTML= '';
  }
}

function renderInstitutional(data) {
  // ç¸½è¨ˆ
  const buySum  = (data.totalNetBuy  / 1000).toFixed(0);
  const sellSum = (data.totalNetSell / 1000).toFixed(0);
  document.getElementById('inst-total-buy').textContent  = `+${Number(buySum).toLocaleString()} åƒå¼µ`;
  document.getElementById('inst-total-sell').textContent = `${Number(sellSum).toLocaleString()} åƒå¼µ`;
  document.getElementById('inst-date').textContent =
    data.date ? `${data.date.slice(0,4)}/${data.date.slice(4,6)}/${data.date.slice(6,8)}` : '--';

  // è¡¨æ ¼æ¸²æŸ“
  const makeTable = (rows, isPositive) => {
    if (!rows?.length) return '<div style="color:var(--text-dim);padding:20px;text-align:center;">ç„¡è³‡æ–™</div>';
    const max = Math.abs(rows[0]?.foreignNet || 1);
    return `<table class="data-table" style="width:100%;">
      <thead><tr>
        <th style="text-align:left;">è‚¡ç¥¨</th>
        <th style="text-align:right;">å¤–è³‡æ·¨è²·è¶…(å¼µ)</th>
        <th style="text-align:right;">æŠ•ä¿¡</th>
        <th style="text-align:right;">ä¸‰å¤§åˆè¨ˆ</th>
        <th style="width:100px;"></th>
      </tr></thead>
      <tbody>
      ${rows.map((s,i) => {
        const fNet  = s.foreignNet;
        const cls   = fNet >= 0 ? 'up' : 'down';
        const barW  = Math.min(Math.abs(fNet) / max * 100, 100).toFixed(0);
        const barC  = fNet >= 0 ? 'var(--green)' : 'var(--red)';
        const cached= state.stockCache[s.code];
        const price = cached ? `<span style="font-size:11px;color:var(--text-dim);">${cached.price.toFixed(1)}</span>` : '';
        return `<tr onclick="showStockDetail('${s.code}')" style="cursor:pointer;">
          <td>
            <div style="font-weight:500;">${s.name}</div>
            <div style="font-size:11px;color:var(--text-dim);">${s.code} ${price}</div>
          </td>
          <td class="${cls}" style="text-align:right;font-family:'Space Mono',monospace;font-size:13px;">
            ${fNet >= 0 ? '+' : ''}${fNet.toLocaleString()}
          </td>
          <td style="text-align:right;font-size:12px;color:var(--text-dim);">
            ${s.trustNet >= 0 ? '+' : ''}${s.trustNet.toLocaleString()}
          </td>
          <td style="text-align:right;font-size:12px;color:${s.totalNet>=0?'var(--green)':'var(--red)'};">
            ${s.totalNet >= 0 ? '+' : ''}${s.totalNet.toLocaleString()}
          </td>
          <td>
            <div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;">
              <div style="height:100%;width:${barW}%;background:${barC};border-radius:3px;"></div>
            </div>
          </td>
        </tr>`;
      }).join('')}
      </tbody>
    </table>`;
  };

  document.getElementById('instBuyTable').innerHTML   = makeTable(data.topBuy,   true);
  document.getElementById('instSellTable').innerHTML  = makeTable(data.topSell,  false);
  document.getElementById('instTotalTable').innerHTML = makeTable(data.topTotal,  true);
}

// ============================================================
// TREND ANALYSIS â€” æ ¸å¿ƒå¼•æ“
// ============================================================

// è¶¨å‹¢åˆ†æç‹€æ…‹
const trendState = {
  currentCode: null,
  analyzing: false,
  lastResult: null,
};

// åˆå§‹åŒ–è¶¨å‹¢é é¢ï¼ˆåœ¨ loadAllData å®Œæˆå¾Œå‘¼å«ï¼‰
function initTrendPage() {
  // ç”¨è‡ªé¸è‚¡ç”Ÿæˆå¿«é€Ÿé¸æ“‡æ™¶ç‰‡
  const picker = document.getElementById('trendStockPicker');
  if (!picker) return;
  const codes = state.watchlist.slice(0, 8);
  picker.innerHTML = codes.map(code => {
    const name = state.stockCache[code]?.name || STOCK_NAMES[code] || code;
    return `<div class="stock-pick-chip" onclick="selectTrendStock('${code}', this)">
      ${code} Â· ${name}
    </div>`;
  }).join('');
  // æ›´æ–°å¸‚å ´æ©«å¹…
  updateMarketTrendBanner();
}

// æ›´æ–°å¸‚å ´ç¸½é«”è¶¨å‹¢æ©«å¹…
function updateMarketTrendBanner() {
  const idx = state.twseIndex;
  if (idx) {
    const isUp = idx.changePct >= 0;
    const el = document.getElementById('mtrend-twse');
    el.textContent = (isUp ? 'â†‘ åå¤š' : 'â†“ åç©º');
    el.className = `mtrend-value ${isUp ? 'up' : 'down'}`;
    document.getElementById('mtrend-twse-sub').textContent =
      `${isUp ? '+' : ''}${idx.changePct.toFixed(2)}% ä»Šæ—¥`;
  }
  const sp = state.yahooData['^GSPC'];
  const sox = state.yahooData['^SOX'];
  if (sp) {
    const isUp = sp.changePct >= 0;
    const el = document.getElementById('mtrend-us');
    el.textContent = (isUp ? 'â†‘ æ­£é¢' : 'â†“ è² é¢');
    el.className = `mtrend-value ${isUp ? 'up' : 'down'}`;
    const soxStr = sox ? ` / SOX ${sox.changePct >= 0 ? '+' : ''}${sox.changePct.toFixed(1)}%` : '';
    document.getElementById('mtrend-us-sub').textContent = `S&P ${sp.changePct >= 0 ? '+' : ''}${sp.changePct.toFixed(2)}%${soxStr}`;
  }
}

function selectTrendStock(code, el) {
  document.querySelectorAll('.stock-pick-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  analyzeTrend(code);
}

// â”€â”€ ä¸»åˆ†æå‡½å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyzeTrend(code) {
  code = code.trim().replace(/\D/g, '');
  if (!code) return;
  if (trendState.analyzing) return;

  if (!state.apiKey) {
    document.getElementById('trendResult').innerHTML = `
      <div class="notice-bar" style="margin:0;">
        âš ï¸ éœ€å…ˆè¨­å®š Claude API Key æ‰èƒ½ä½¿ç”¨è¶¨å‹¢åˆ†æåŠŸèƒ½ã€‚
        <button class="btn-outline" style="margin-left:12px;" onclick="openApiModal()">ç«‹å³è¨­å®š</button>
      </div>`;
    return;
  }

  trendState.analyzing = true;
  trendState.currentCode = code;

  // ç¢ºä¿æœ‰è©²è‚¡ç¥¨è³‡æ–™
  if (!state.stockCache[code]) {
    await fetchStockPrices([code]);
  }

  showTrendLoading(code);

  try {
    // â‘  çµ„è£å¸‚å ´äº‹å¯¦è³‡æ–™
    const facts = buildFactSheet(code);
    // â‘¡ å»ºæ§‹åš´è¬¹ prompt
    const prompt = buildTrendPrompt(code, facts);
    // â‘¢ å‘¼å« Claude API
    const raw = await callClaudeForTrend(prompt);
    // â‘£ è§£æçµæ§‹åŒ–å›æ‡‰
    const result = parseTrendResponse(raw);
    // â‘¤ æ¸²æŸ“
    renderTrendResult(code, result, facts);
    trendState.lastResult = result;
  } catch(e) {
    document.getElementById('trendResult').innerHTML = `
      <div class="card">
        <div style="color:var(--red);font-size:13px;">âŒ åˆ†æå¤±æ•—ï¼š${e.message}</div>
      </div>`;
  }
  trendState.analyzing = false;
}

// â”€â”€ çµ„è£äº‹å¯¦è³‡æ–™è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFactSheet(code) {
  const s       = state.stockCache[code] || {};
  const idx     = state.twseIndex || {};
  const sp500   = state.yahooData['^GSPC']   || {};
  const nasdaq  = state.yahooData['^IXIC']   || {};
  const sox     = state.yahooData['^SOX']    || {};
  const vix     = state.yahooData['^VIX']    || {};
  const twd     = state.yahooData['USDTWD=X']|| {};
  const tnx     = state.yahooData['^TNX']    || {};

  // é¡è‚¡åŒä¼´å¹³å‡
  const sectorStocks = Object.entries(SECTOR_STOCKS)
    .find(([, codes]) => codes.includes(code))?.[1] || [];
  const peers = sectorStocks
    .filter(c => c !== code && state.stockCache[c])
    .map(c => ({ code:c, name:state.stockCache[c].name, changePct:state.stockCache[c].changePct }));
  const sectorAvg = peers.length
    ? peers.reduce((a,b) => a + b.changePct, 0) / peers.length : null;

  // æˆäº¤é‡ç•°å¸¸ï¼ˆä»Šæ—¥ vs æ­£å¸¸æ°´æº–ä¼°ç®—ï¼‰
  const volumeNote = s.volume > 0
    ? (s.volume > 50000 ? 'æˆäº¤é‡é¡¯è‘—æ”¾å¤§' : s.volume < 5000 ? 'æˆäº¤é‡èç¸®' : 'æˆäº¤é‡æ­£å¸¸')
    : 'æˆäº¤é‡æœªçŸ¥';

  // è¿‘æœŸæ–°è
  const relNews = (state.rssNews || [])
    .filter(n => n.title && (
      n.title.includes(s.name) ||
      n.title.includes(code) ||
      (STOCK_NAMES[code] && n.title.includes(STOCK_NAMES[code]))
    ))
    .slice(0, 3)
    .map(n => n.title);

  return {
    // å€‹è‚¡
    code,
    name         : s.name || STOCK_NAMES[code] || code,
    price        : s.price || 0,
    change       : s.change || 0,
    changePct    : s.changePct || 0,
    open         : s.open || 0,
    high         : s.high || 0,
    low          : s.low || 0,
    prev         : s.prev || 0,
    volume       : s.volume || 0,
    volumeNote,
    pe           : s.pe || '-',
    dividendYield: s.yield || '-',
    sector       : s.sector || 'æœªåˆ†é¡',
    // å¤§ç›¤
    twseChangePct: idx.changePct || 0,
    twseChange   : idx.change || 0,
    // ç¾è‚¡
    sp500Pct     : sp500.changePct || 0,
    nasdaqPct    : nasdaq.changePct || 0,
    soxPct       : sox.changePct || 0,
    vix          : vix.price || 0,
    usdtwd       : twd.price || 0,
    usdtwdPct    : twd.changePct || 0,
    tnx          : tnx.price || 0,
    // é¡è‚¡
    sectorAvg,
    peers        : peers.slice(0, 4),
    // æ–°è
    relatedNews  : relNews,
    // æ™‚é–“
    analysisTime : new Date().toLocaleString('zh-TW', { timeZone:'Asia/Taipei' }),
  };
}

// â”€â”€ å»ºæ§‹ Promptï¼ˆæ ¸å¿ƒï¼šè¦æ±‚çµæ§‹åŒ– JSON + 90% ä¿¡å¿ƒæ¨™æº–ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€
function buildTrendPrompt(code, f) {
  const usePrice   = document.getElementById('ta-price')?.checked;
  const useVolume  = document.getElementById('ta-volume')?.checked;
  const useUS      = document.getElementById('ta-us')?.checked;
  const useFX      = document.getElementById('ta-fx')?.checked;
  const useNews    = document.getElementById('ta-news')?.checked;
  const useSector  = document.getElementById('ta-sector')?.checked;
  const usePE      = document.getElementById('ta-pe')?.checked;

  const dataBlocks = [];

  if (usePrice) dataBlocks.push(`ã€å€‹è‚¡å³æ™‚è³‡æ–™ - ä¾†æºï¼šå°ç£è­‰äº¤æ‰€å®˜æ–¹APIã€‘
è‚¡ç¥¨ï¼š${f.name}ï¼ˆ${f.code}ï¼‰
ç¾åƒ¹ï¼š${f.price} å…ƒ
ä»Šæ—¥æ¼²è·Œï¼š${f.change >= 0 ? '+' : ''}${f.change} å…ƒ (${f.changePct >= 0 ? '+' : ''}${f.changePct}%)
é–‹ç›¤ï¼š${f.open} / æœ€é«˜ï¼š${f.high} / æœ€ä½ï¼š${f.low} / æ˜¨æ”¶ï¼š${f.prev}
åƒ¹æ ¼ç›¸å°æ˜¨æ”¶ï¼š${f.changePct > 0 ? 'æ”¶æ¼²' : f.changePct < 0 ? 'æ”¶è·Œ' : 'å¹³ç›¤'}`);

  if (useVolume) dataBlocks.push(`ã€æˆäº¤é‡è³‡æ–™ - ä¾†æºï¼šå°ç£è­‰äº¤æ‰€å®˜æ–¹APIã€‘
ä»Šæ—¥æˆäº¤å¼µæ•¸ï¼š${f.volume.toLocaleString()}
é‡èƒ½è©•ä¼°ï¼š${f.volumeNote}`);

  if (useUS) dataBlocks.push(`ã€ç¾è‚¡æŒ‡æ•¸ - ä¾†æºï¼šYahoo Financeã€‘
S&P 500ï¼š${f.sp500Pct >= 0 ? '+' : ''}${f.sp500Pct}%
NASDAQï¼š${f.nasdaqPct >= 0 ? '+' : ''}${f.nasdaqPct}%
è²»åŸåŠå°é«”æŒ‡æ•¸(SOX)ï¼š${f.soxPct >= 0 ? '+' : ''}${f.soxPct}%
VIX ææ…ŒæŒ‡æ•¸ï¼š${f.vix}ï¼ˆ${f.vix > 25 ? 'é«˜ææ…Œ' : f.vix > 18 ? 'ä¸­ç­‰' : 'å¸‚å ´å¹³éœ'}ï¼‰
ç¾åœ‹10å¹´æœŸå…¬å‚µæ®–åˆ©ç‡ï¼š${f.tnx}%`);

  if (useFX) dataBlocks.push(`ã€åŒ¯ç‡ - ä¾†æºï¼šYahoo Financeã€‘
USD/TWDï¼š${f.usdtwd}ï¼ˆä»Šæ—¥${f.usdtwdPct >= 0 ? '+' : ''}${f.usdtwdPct}%ï¼‰
åŒ¯ç‡èµ°å‹¢å°å‡ºå£å» å½±éŸ¿ï¼š${f.usdtwdPct > 0.3 ? 'å°å¹£è²¶å€¼ï¼Œæœ‰åˆ©å‡ºå£' : f.usdtwdPct < -0.3 ? 'å°å¹£å‡å€¼ï¼Œä¸åˆ©å‡ºå£' : 'åŒ¯ç‡å½±éŸ¿ä¸­æ€§'}`);

  if (useSector) {
    let sectorTxt = `æœ¬è‚¡é¡åˆ¥ï¼š${f.sector}
å¤§ç›¤åŠ æ¬ŠæŒ‡æ•¸ä»Šæ—¥ï¼š${f.twseChangePct >= 0 ? '+' : ''}${f.twseChangePct}%
`;
    if (f.sectorAvg !== null) sectorTxt += `${f.sector}é¡è‚¡å¹³å‡ï¼š${f.sectorAvg >= 0 ? '+' : ''}${f.sectorAvg.toFixed(2)}%
`;
    if (f.peers.length) sectorTxt += `åŒé¡è‚¡è¡¨ç¾ï¼š${f.peers.map(p => `${p.name}${p.changePct >= 0 ? '+' : ''}${p.changePct}%`).join('ã€')}`;
    dataBlocks.push(`ã€é¡è‚¡è³‡æ–™ - ä¾†æºï¼šå°ç£è­‰äº¤æ‰€å®˜æ–¹APIã€‘
` + sectorTxt);
  }

  if (usePE && f.pe !== '-') dataBlocks.push(`ã€åŸºæœ¬é¢è³‡æ–™ï¼ˆéœæ…‹åƒè€ƒå€¼ï¼‰ã€‘
æœ¬ç›Šæ¯”ï¼š${f.pe}
æ®–åˆ©ç‡ï¼š${f.dividendYield}%`);

  if (useNews && f.relatedNews.length) dataBlocks.push(`ã€è¿‘æœŸç›¸é—œæ–°è - ä¾†æºï¼šRSSå³æ™‚Feedã€‘
${f.relatedNews.map((n,i) => `${i+1}. ${n}`).join('\n')}`);

  return `ä½ æ˜¯ä¸€ä½åš´è¬¹çš„å°è‚¡é‡åŒ–åˆ†æå¸«ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä»¥ä¸‹ã€Œå¯é©—è­‰çš„å¸‚å ´äº‹å¯¦è³‡æ–™ã€ï¼Œå° ${f.name}ï¼ˆ${f.code}ï¼‰çš„çŸ­æœŸè¶¨å‹¢åšå‡ºåˆ¤æ–·ã€‚

åˆ†ææ™‚é–“ï¼š${f.analysisTime}

=== å¯é©—è­‰çš„å¸‚å ´äº‹å¯¦è³‡æ–™ ===
${dataBlocks.join('\n\n')}
=== è³‡æ–™çµæŸ ===

ã€åˆ†æè¦æ±‚èˆ‡ä¿¡å¿ƒåº¦æ¨™æº–ã€‘
1. ã€Œä¿¡å¿ƒåº¦ã€ä»£è¡¨ä½ æ ¹æ“šä»¥ä¸Šäº‹å¯¦è³‡æ–™ï¼Œå°è¶¨å‹¢æ–¹å‘åˆ¤æ–·çš„ç¢ºä¿¡ç¨‹åº¦ï¼ˆ0â€“100%ï¼‰
2. åªæœ‰ç•¶ã€Œå¤šå€‹ç¨ç«‹è³‡æ–™ä¾†æºæŒ‡å‘åŒä¸€æ–¹å‘ï¼Œä¸”ç„¡æ˜é¡¯åå‘è¨Šè™Ÿã€æ™‚ï¼Œæ‰èƒ½çµ¦å‡º â‰¥90% çš„ä¿¡å¿ƒåº¦
3. å¦‚æœè³‡æ–™ä¸è¶³ã€äº’ç›¸çŸ›ç›¾ã€æˆ–å­˜åœ¨é‡å¤§ä¸ç¢ºå®šå› ç´ ï¼Œä¿¡å¿ƒåº¦æ‡‰ä½æ–¼ 70%ï¼Œä¸¦èªªæ˜åŸå› 
4. æ‰€æœ‰åˆ¤æ–·åŸå› å¿…é ˆç›´æ¥å¼•ç”¨ä¸Šæ–¹æä¾›çš„å…·é«”æ•¸å­—è³‡æ–™ï¼Œç¦æ­¢æ†‘ç©ºæ¨æ¸¬
5. è¶¨å‹¢æ–¹å‘åªèƒ½æ˜¯ï¼šã€Œä¸Šæ¼²ã€ã€ã€Œä¸‹è·Œã€æˆ–ã€Œç›¤æ•´ã€

ã€å›æ‡‰æ ¼å¼ã€‘
å¿…é ˆåš´æ ¼ä»¥ä»¥ä¸‹ JSON æ ¼å¼å›æ‡‰ï¼Œä¸è¦æœ‰ä»»ä½•é¡å¤–æ–‡å­—ï¼š

{
  "direction": "ä¸Šæ¼²|ä¸‹è·Œ|ç›¤æ•´",
  "confidence": æ•¸å­—(0-100),
  "verdict": "ä¸€å¥è©±ç¸½çµï¼ˆ20å­—ä»¥å…§ï¼‰",
  "timeframe": "åˆ†æé©ç”¨çš„æ™‚é–“æ¡†æ¶ï¼Œå¦‚ï¼šä»Šæ—¥ç›¤ä¸­ã€æœ¬é€±ã€çŸ­æœŸ1-3æ—¥",
  "reasons": [
    {
      "type": "supporting|opposing|uncertain",
      "weight": "é«˜|ä¸­|ä½",
      "title": "åŸå› æ¨™é¡Œï¼ˆ10å­—ä»¥å…§ï¼‰",
      "content": "å…·é«”èªªæ˜ï¼Œå¿…é ˆå¼•ç”¨å¯¦éš›æ•¸å­—ï¼ˆ30-60å­—ï¼‰",
      "evidence": "å¼•ç”¨çš„å…·é«”æ•¸æ“šæˆ–è³‡æ–™ä¾†æº"
    }
  ],
  "keyRisk": "æœ€ä¸»è¦çš„é¢¨éšªå› ç´ ï¼ˆ30å­—ä»¥å…§ï¼‰",
  "dataSources": ["åˆ—å‡ºå¯¦éš›ä½¿ç”¨çš„è³‡æ–™ä¾†æº"],
  "insufficientDataNote": "å¦‚æœè³‡æ–™ä¸è¶³å°è‡´ä¿¡å¿ƒåº¦ä½ï¼Œåœ¨æ­¤èªªæ˜ç¼ºå°‘å“ªäº›è³‡æ–™ï¼ˆå¦å‰‡å¡«nullï¼‰"
}`;
}

// â”€â”€ å‘¼å« Claude API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callClaudeForTrend(prompt) {
  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': state.apiKey,
      'anthropic-version': '2023-06-01',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1200,
      messages: [{ role: 'user', content: prompt }],
    }),
  });
  if (!res.ok) throw new Error(`API éŒ¯èª¤ ${res.status}`);
  const data = await res.json();
  const text = data.content?.[0]?.text || '';
  return text;
}

// â”€â”€ è§£æ Claude å›æ‡‰ JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseTrendResponse(raw) {
  // å˜—è©¦æå– JSON
  const jsonMatch = raw.match(/\{[\s\S]*\}/);
  if (!jsonMatch) throw new Error('AI å›æ‡‰æ ¼å¼ç•°å¸¸ï¼Œç„¡æ³•è§£æ');
  try {
    return JSON.parse(jsonMatch[0]);
  } catch(e) {
    throw new Error('JSON è§£æå¤±æ•—ï¼š' + e.message);
  }
}

// â”€â”€ æ¸²æŸ“çµæœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTrendResult(code, r, facts) {
  const dirMap = {
    'ä¸Šæ¼²': { cls:'up',      arrow:'â†‘', color:'var(--green)', label:'çœ‹æ¼²' },
    'ä¸‹è·Œ': { cls:'down',    arrow:'â†“', color:'var(--red)',   label:'çœ‹è·Œ' },
    'ç›¤æ•´': { cls:'neutral', arrow:'â†’', color:'var(--gold)',  label:'ç›¤æ•´' },
  };
  const dir = dirMap[r.direction] || dirMap['ç›¤æ•´'];

  const conf = r.confidence || 0;
  const confCls  = conf >= 90 ? 'high' : conf >= 70 ? 'medium' : 'low';
  const confLabel= conf >= 90 ? 'é«˜ä¿¡å¿ƒ Â· å¤šæŒ‡æ¨™ä¸€è‡´' : conf >= 70 ? 'ä¸­ä¿¡å¿ƒ Â· éƒ¨åˆ†ä¸ç¢ºå®š' : 'ä½ä¿¡å¿ƒ Â· è³‡æ–™ä¸è¶³';
  const confColor= conf >= 90 ? 'var(--green)' : conf >= 70 ? 'var(--gold)' : 'var(--red)';
  const fillWidth= Math.min(conf, 100);

  const supporting = (r.reasons || []).filter(r => r.type === 'supporting');
  const opposing   = (r.reasons || []).filter(r => r.type === 'opposing');
  const uncertain  = (r.reasons || []).filter(r => r.type === 'uncertain');

  const renderReasons = (arr) => arr.map(reason => `
    <div class="reason-card ${reason.type}">
      <div class="reason-header">
        <span class="reason-type ${reason.type}">${
          reason.type === 'supporting' ? 'âœ… æ”¯æŒå› ç´ ' :
          reason.type === 'opposing'   ? 'âš ï¸ åå‘è¨Šè™Ÿ' : 'â“ ä¸ç¢ºå®šå› ç´ '
        } Â· ${reason.title}</span>
        <span class="reason-weight">${reason.weight || 'ä¸­'} æ¬Šé‡</span>
      </div>
      <div class="reason-text">${reason.content}</div>
      ${reason.evidence ? `<div class="reason-evidence">ğŸ“Š è³‡æ–™ä¾æ“šï¼š${reason.evidence}</div>` : ''}
    </div>`).join('');

  const sourceBadges = (r.dataSources || []).map(s =>
    `<span class="data-badge">${s}</span>`).join('');

  document.getElementById('trendResult').innerHTML = `
    <!-- æ–¹å‘ + ä¿¡å¿ƒåº¦ é›™æ¬„ -->
    <div class="trend-hero mb-4">
      <div class="trend-direction-card ${dir.cls}">
        <div class="trend-arrow">${dir.arrow}</div>
        <div class="trend-label">è¶¨å‹¢æ–¹å‘åˆ¤æ–·</div>
        <div class="trend-verdict" style="color:${dir.color}">${r.direction}è¶¨å‹¢</div>
        <div class="trend-stock-name">${facts.name}ï¼ˆ${code}ï¼‰Â· ${r.timeframe || 'çŸ­æœŸ'}</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:8px;">${r.verdict || ''}</div>
        <div class="data-source-row">${sourceBadges}</div>
      </div>

      <div class="card" style="margin:0;">
        <div class="confidence-label">AI ä¿¡å¿ƒåº¦</div>
        <div class="confidence-pct" style="color:${confColor};margin:8px 0 4px;">
          ${conf}%
        </div>
        <div class="confidence-badge ${confCls}">${confLabel}</div>
        <div class="confidence-meter" style="margin-top:16px;">
          <div class="confidence-track">
            <div class="confidence-fill"
              style="width:${fillWidth}%;background:${confColor};"
              id="confFill"></div>
            <div class="confidence-90-marker"></div>
          </div>
        </div>
        ${conf < 70 && r.insufficientDataNote ? `
        <div style="font-size:11px;color:var(--gold);margin-top:10px;line-height:1.6;">
          âš ï¸ è³‡æ–™ä¸è¶³èªªæ˜ï¼š${r.insufficientDataNote}
        </div>` : ''}
        <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border);">
          <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ä¸»è¦é¢¨éšª</div>
          <div style="font-size:12px;color:var(--red);">âš ï¸ ${r.keyRisk || 'è³‡æ–™ä¸è¶³ï¼Œè«‹è¬¹æ…'}</div>
        </div>
      </div>
    </div>

    <!-- æ”¯æŒå› ç´  -->
    ${supporting.length ? `
    <div class="card mb-4">
      <div class="section-title" style="margin-bottom:14px;color:var(--green);">
        âœ… æ”¯æŒã€Œ${r.direction}ã€çš„åŸå› ï¼ˆ${supporting.length} é …ï¼‰
      </div>
      ${renderReasons(supporting)}
    </div>` : ''}

    <!-- åå‘è¨Šè™Ÿ -->
    ${opposing.length ? `
    <div class="card mb-4">
      <div class="section-title" style="margin-bottom:14px;color:var(--red);">
        âš ï¸ åå‘è¨Šè™Ÿï¼ˆ${opposing.length} é …ï¼‰
      </div>
      ${renderReasons(opposing)}
    </div>` : ''}

    <!-- ä¸ç¢ºå®šå› ç´  -->
    ${uncertain.length ? `
    <div class="card mb-4">
      <div class="section-title" style="margin-bottom:14px;color:var(--gold);">
        â“ ä¸ç¢ºå®šå› ç´ ï¼ˆ${uncertain.length} é …ï¼‰
      </div>
      ${renderReasons(uncertain)}
    </div>` : ''}

    <!-- é‡æ–°åˆ†ææŒ‰éˆ• -->
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn" onclick="analyzeTrend('${code}')">ğŸ”„ é‡æ–°åˆ†æ</button>
      <button class="btn-outline" onclick="quickChat('æ ¹æ“šä»¥ä¸‹è¶¨å‹¢åˆ†æçµæœï¼Œè«‹çµ¦æˆ‘æ›´è©³ç´°çš„æ“ä½œå»ºè­°ï¼š${facts.name}(${code}) ${r.direction}è¶¨å‹¢ï¼Œä¿¡å¿ƒåº¦${conf}%ã€‚æ”¯æŒåŸå› ï¼š${supporting.map(s=>s.title).join('ã€')}')">ğŸ’¬ æ·±å…¥è¨è«–</button>
    </div>
  `;

  // å‹•ç•«ä¿¡å¿ƒæ¢
  setTimeout(() => {
    const fill = document.getElementById('confFill');
    if (fill) fill.style.width = fillWidth + '%';
  }, 100);
}

// è¼‰å…¥æç¤º
function showTrendLoading(code) {
  const name = state.stockCache[code]?.name || STOCK_NAMES[code] || code;
  document.getElementById('trendResult').innerHTML = `
    <div class="card">
      <div style="text-align:center;padding:40px 20px;">
        <div class="spinner" style="width:32px;height:32px;border-width:3px;margin:0 auto 20px;"></div>
        <div style="font-size:14px;font-weight:500;margin-bottom:8px;">æ­£åœ¨åˆ†æ ${name}ï¼ˆ${code}ï¼‰</div>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
          â‘  æ”¶é›† TWSE å³æ™‚åƒ¹æ ¼èˆ‡æˆäº¤é‡è³‡æ–™<br>
          â‘¡ æ•´åˆç¾è‚¡ã€åŒ¯ç‡ã€é¡è‚¡èµ°å‹¢<br>
          â‘¢ é€äº¤ Claude AI é€²è¡Œå¤šç¶­åº¦åˆ¤æ–·<br>
          â‘£ ä¾ 90% ä¿¡å¿ƒé–€æª»åš´æ ¼è©•ä¼°
        </div>
      </div>
    </div>`;
}


// ============================================================
// MODALS
// ============================================================
function openApiModal() {
  document.getElementById('apiKeyInput').value = state.apiKey;
  document.getElementById('workerUrlInput').value = localStorage.getItem('workerUrl') || '';
  document.getElementById('apiModal').classList.add('open');
}
function closeApiModal() { document.getElementById('apiModal').classList.remove('open'); }
function saveApiKey() {
  const key       = document.getElementById('apiKeyInput').value.trim();
  const workerUrl = document.getElementById('workerUrlInput').value.trim().replace(/\/$/, '');
  state.apiKey = key;
  localStorage.setItem('claudeApiKey', key);
  if (workerUrl) {
    localStorage.setItem('workerUrl', workerUrl);
    // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥ç”¨æ–°çš„ Worker
    location.reload();
  } else {
    localStorage.removeItem('workerUrl');
    closeApiModal();
    if (key) alert('âœ… Claude API Key å·²å„²å­˜ï¼');
  }
}

function openWorkerGuide() {
  closeApiModal();
  const guide = `ğŸ“‹ Cloudflare Worker éƒ¨ç½²æ­¥é©Ÿï¼ˆå…è²»ï¼‰ï¼š

1. å‰å¾€ https://workers.cloudflare.com è¨»å†Šå¸³è™Ÿ
2. é»é¸ã€ŒCreate Workerã€
3. å°‡ worker.js çš„ç¨‹å¼ç¢¼å®Œæ•´è²¼å…¥ç·¨è¼¯å™¨
4. é»é¸ã€ŒSave and Deployã€
5. è¤‡è£½ä½ çš„ Worker ç¶²å€ï¼ˆæ ¼å¼ï¼šhttps://xxx.workers.devï¼‰
6. è²¼å›é€™è£¡çš„ã€ŒCloudflare Worker ç¶²å€ã€æ¬„ä½

âœ… å…è²»é¡åº¦ï¼šæ¯å¤© 100,000 æ¬¡è«‹æ±‚ï¼Œå€‹äººä½¿ç”¨å®Œå…¨å¤ ç”¨
âœ… å•Ÿç”¨å¾Œå¯ç²å¾—ï¼šç¾è‚¡æŒ‡æ•¸ã€USD/TWD åŒ¯ç‡ã€RSS å³æ™‚æ–°è`;
  alert(guide);
  setTimeout(openApiModal, 100);
}

function addAlert() {
  const code = prompt('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ï¼š2330ï¼‰');
  const price = prompt('è«‹è¼¸å…¥æé†’åƒ¹æ ¼');
  if (!code || !price) return;
  const s = state.stockCache[code];
  const dir = parseFloat(price) > (s?.price || 0) ? 'çªç ´' : 'è·Œç ´';
  document.getElementById('alertsList').insertAdjacentHTML('beforeend', `
    <div class="alert-item">
      <div class="alert-icon">ğŸ””</div>
      <div class="alert-text">
        <div style="font-weight:500;">${s?.name || STOCK_NAMES[code] || code} (${code})</div>
        <div class="text-xs text-dim">${dir} ${price} å…ƒæé†’</div>
      </div>
      <button class="btn-danger" onclick="this.parentElement.remove()">âœ•</button>
    </div>`);
}

function updateRisk(val) {
  const labels = ['','ä¿å®ˆ','åä¿å®ˆ','ä¸­æ€§','åç©æ¥µ','ç©æ¥µ'];
  document.getElementById('riskLabel').textContent = labels[val];
}

function showStockDetail(code) {
  const s = state.stockCache[code];
  if (!s) return;
  quickChat(`è«‹å¹«æˆ‘åˆ†æ ${s.name} (${code}) è‚¡ç¥¨ï¼ŒåŒ…å«æŠ€è¡“é¢ã€åŸºæœ¬é¢ã€è¿‘æœŸæ–°èã€æ˜¯å¦å€¼å¾—è²·é€²ï¼Ÿ`);
  document.querySelectorAll('.tab').forEach(t => { if (t.textContent.includes('ğŸ’¬')) t.click(); });
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('open');
  });
});
</script>
</body>
</html>
