<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°è‚¡æ™ºæ Â· TW Stock Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Space+Mono:wght@400;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --green: #10b981;
    --red: #ef4444;
    --gold: #f59e0b;
    --text: #e2e8f0;
    --text-dim: #64748b;
    --text-muted: #334155;
    --glow: 0 0 20px rgba(0,212,255,0.15);
    --header-bg: rgba(10,14,26,0.92);
    --grid-line: rgba(0,212,255,0.03);
    --card-shadow: 0 2px 12px rgba(0,0,0,0.3);
  }


  /* â”€â”€ åŸºæœ¬é¢é é¢ â”€â”€ */
  .fund-val-card {
    background: var(--surface2); border-radius: 12px; padding: 16px;
    position: relative; transition: transform 0.15s, box-shadow 0.15s;
  }
  .fund-val-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
  .fund-val-label { font-size: 11px; color: var(--text-dim); margin-bottom: 6px; }
  .fund-val-number {
    font-size: 28px; font-weight: 700; font-family: 'Space Mono', monospace;
    line-height: 1; margin-bottom: 4px;
  }
  .fund-val-tag { font-size: 10px; font-weight: 700; }

  /* â”€â”€ é…æ¯æ©«æ¢åœ– â”€â”€ */
  .div-bar-wrap {
    display: flex; gap: 6px; align-items: flex-end;
    height: 100px; padding: 0 4px 0; margin-bottom: 24px;
  }
  .div-bar-col {
    flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; min-width: 0;
  }
  .div-bar-amt { font-size: 9px; color: var(--text-dim); white-space: nowrap; }
  .div-bar-body {
    width: 100%; border-radius: 3px 3px 0 0;
    transition: height 0.6s cubic-bezier(.4,0,.2,1);
  }
  .div-bar-year {
    font-size: 9px; color: var(--text-dim); transform: rotate(-40deg);
    white-space: nowrap; margin-top: 4px;
  }

  /* â”€â”€ 52é€±é€²åº¦æ¢ â”€â”€ */
  .week52-bar {
    height: 6px; background: var(--surface2); border-radius: 3px;
    position: relative; margin: 8px 0 4px; overflow: visible;
  }
  .week52-fill {
    position: absolute; top: 0; left: 0; height: 100%;
    background: linear-gradient(90deg, var(--green), var(--gold));
    border-radius: 3px; transition: width 0.8s ease;
  }
  .week52-dot {
    position: absolute; top: -4px; width: 14px; height: 14px; background: white;
    border-radius: 50%; transform: translateX(-50%);
    border: 2.5px solid var(--accent); box-shadow: 0 0 8px rgba(0,212,255,.4);
  }

  /* â”€â”€ åœ‹éš›è‚¡å¸‚ â”€â”€ */
  .global-idx-card {
    cursor: pointer; transition: transform 0.15s, border-color 0.15s;
    border: 1px solid var(--border);
  }
  .global-idx-card:hover { transform: translateY(-2px); border-color: var(--accent); }
  .global-price {
    font-size: 20px; font-weight: 700; font-family: 'Space Mono', monospace;
    margin: 6px 0 2px;
  }
  .global-change { font-size: 12px; margin-bottom: 6px; }

  /* â”€â”€ æ—¥é–“æ¨¡å¼ â”€â”€ */
  [data-theme="light"] {
    --bg: #f0f4f8;
    --surface: #ffffff;
    --surface2: #e8edf2;
    --border: #c8d5e0;
    --accent: #0077aa;
    --accent2: #6d28d9;
    --green: #059669;
    --red: #dc2626;
    --gold: #d97706;
    --text: #1e293b;
    --text-dim: #64748b;
    --text-muted: #94a3b8;
    --glow: 0 0 20px rgba(0,119,170,0.15);
    --header-bg: rgba(240,244,248,0.95);
    --grid-line: rgba(0,119,170,0.05);
    --card-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  [data-theme="light"] body::before {
    background-image:
      linear-gradient(var(--grid-line) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
  }
  [data-theme="light"] header { background: var(--header-bg); }
  [data-theme="light"] .card { box-shadow: var(--card-shadow); }
  [data-theme="light"] .nav-tabs { background: rgba(240,244,248,0.95); }
  [data-theme="light"] .modal { background: var(--surface); }
  [data-theme="light"] .ticker-wrap { background: rgba(240,244,248,0.9); }
  [data-theme="light"] .stock-table th { background: var(--surface2); }
  [data-theme="light"] .chat-msg.ai { background: var(--surface2); }
  [data-theme="light"] .chat-msg.user { background: var(--accent); }

  /* API è²»ç”¨æé†’å¾½ç«  */
  .api-cost-badge {
    display:inline-flex; align-items:center; gap:4px;
    font-size:10px; padding:2px 7px; border-radius:10px;
    background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.3);
    color:var(--gold); cursor:default; white-space:nowrap;
  }
  .api-cost-badge:hover::after {
    content: attr(data-tip);
    position:absolute; bottom:calc(100% + 6px); left:50%; transform:translateX(-50%);
    background:var(--surface); border:1px solid var(--border);
    padding:6px 10px; border-radius:8px; font-size:11px; color:var(--text);
    white-space:nowrap; z-index:999; box-shadow:0 4px 12px rgba(0,0,0,.3);
  }
  /* ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• */
  .theme-toggle {
    width: 36px; height: 20px; border-radius: 10px; position: relative; cursor: pointer;
    background: var(--surface2); border: 1px solid var(--border);
    display: flex; align-items: center; padding: 2px;
    transition: background 0.3s;
  }
  .theme-toggle::after {
    content: ''; width: 14px; height: 14px; border-radius: 50%;
    background: var(--accent); transition: transform 0.3s;
    transform: translateX(0);
  }
  [data-theme="light"] .theme-toggle::after { transform: translateX(16px); }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans TC', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* HEADER */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10,14,26,0.92);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 60px;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    color: var(--accent);
    letter-spacing: 1px;
    text-shadow: 0 0 20px rgba(0,212,255,0.4);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo span { font-family: 'Noto Sans TC', sans-serif; font-size: 13px; color: var(--text-dim); font-weight: 300; }

  .header-right { display: flex; align-items: center; gap: 16px; }

  .market-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-dim);
    font-family: 'Space Mono', monospace;
  }
  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    animation: pulse 2s infinite;
  }
  .status-dot.closed { background: var(--red); box-shadow: 0 0 8px var(--red); animation: none; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .api-key-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--accent);
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .api-key-btn:hover { border-color: var(--accent); box-shadow: var(--glow); }

  /* NAV TABS */
  .nav-tabs {
    display: flex;
    gap: 2px;
    padding: 12px 24px 0;
    border-bottom: 1px solid var(--border);
    position: relative;
    z-index: 1;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .nav-tabs::-webkit-scrollbar { display: none; }
  .tab {
    padding: 10px 20px;
    font-size: 13px;
    color: var(--text-dim);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-badge {
    background: var(--accent2);
    color: white;
    font-size: 10px;
    padding: 1px 5px;
    border-radius: 10px;
    font-family: 'Space Mono', monospace;
  }

  /* MAIN LAYOUT */
  main {
    position: relative;
    z-index: 1;
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px 24px;
  }

  .page { display: none; }
  .page.active { display: block; }

  /* GRID LAYOUTS */
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-left-wide { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
  .grid-right-wide { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    transition: border-color 0.2s;
  }
  .card:hover { border-color: rgba(0,212,255,0.2); }
  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .card-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-title .icon { font-size: 16px; }

  /* INDEX CARDS */
  .index-value {
    font-family: 'Space Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
    margin: 8px 0 4px;
  }
  .index-change {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
  }
  .up { color: var(--green); }
  .down { color: var(--red); }
  .neutral { color: var(--text-dim); }

  .sparkline {
    width: 100%;
    height: 50px;
    margin-top: 12px;
  }

  /* STOCK TABLE */
  .stock-table { width: 100%; border-collapse: collapse; }
  .stock-table th {
    text-align: left;
    font-size: 11px;
    color: var(--text-dim);
    font-weight: 500;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: 'Space Mono', monospace;
  }
  .stock-table td {
    padding: 11px 12px;
    font-size: 13px;
    border-bottom: 1px solid rgba(30,45,69,0.5);
  }
  .stock-table tr:last-child td { border-bottom: none; }
  .stock-table tr:hover td { background: rgba(0,212,255,0.03); }

  .stock-name { font-weight: 500; }
  .stock-code { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-dim); }
  .price { font-family: 'Space Mono', monospace; font-weight: 700; }
  .change { font-family: 'Space Mono', monospace; font-size: 12px; }

  /* WATCHLIST add */
  .add-stock-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .add-stock-bar input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .add-stock-bar input:focus { border-color: var(--accent); }
  .btn {
    background: var(--accent);
    color: var(--bg);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .btn:hover { opacity: 0.85; transform: translateY(-1px); }
  .btn-outline {
    background: transparent;
    color: var(--text-dim);
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: transparent; color: var(--red); border: none; cursor: pointer; font-size: 16px; padding: 4px; transition: opacity 0.2s; }
  .btn-danger:hover { opacity: 0.7; }

  /* AI ANALYSIS CARD */
  .ai-score {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--surface2);
    border-radius: 10px;
    margin-bottom: 12px;
    border-left: 3px solid var(--accent);
    transition: border-color 0.2s;
  }
  .ai-score.buy { border-left-color: var(--green); }
  .ai-score.sell { border-left-color: var(--red); }
  .ai-score.hold { border-left-color: var(--gold); }
  
  .score-circle {
    width: 52px; height: 52px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-family: 'Space Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    border: 2px solid;
  }
  .score-circle.buy { color: var(--green); border-color: var(--green); background: rgba(16,185,129,0.1); }
  .score-circle.sell { color: var(--red); border-color: var(--red); background: rgba(239,68,68,0.1); }
  .score-circle.hold { color: var(--gold); border-color: var(--gold); background: rgba(245,158,11,0.1); }

  .ai-rec-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 2px;
  }

  .ai-stock-info { flex: 1; }
  .ai-stock-name { font-weight: 500; font-size: 14px; }
  .ai-stock-code { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-dim); }
  .ai-reason { font-size: 12px; color: var(--text-dim); margin-top: 4px; line-height: 1.5; }

  .ai-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
  .tag {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .tag-green { background: rgba(16,185,129,0.15); color: var(--green); }
  .tag-red { background: rgba(239,68,68,0.15); color: var(--red); }
  .tag-gold { background: rgba(245,158,11,0.15); color: var(--gold); }
  .tag-blue { background: rgba(0,212,255,0.1); color: var(--accent); }
  .tag-purple { background: rgba(124,58,237,0.15); color: #a78bfa; }

  /* NEWS CARD */
  .news-item {
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
  }
  .news-item:last-child { border-bottom: none; }
  .news-item:hover { padding-left: 8px; }
  .news-meta { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
  .news-source { font-size: 10px; color: var(--accent); font-family: 'Space Mono', monospace; text-transform: uppercase; }
  .news-time { font-size: 10px; color: var(--text-muted); font-family: 'Space Mono', monospace; }
  .news-impact { font-size: 10px; padding: 1px 6px; border-radius: 4px; }
  .news-title { font-size: 13px; line-height: 1.5; margin-bottom: 4px; }
  .news-summary { font-size: 12px; color: var(--text-dim); line-height: 1.5; }

  /* SECTOR CHART */
  .sector-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .sector-name { font-size: 12px; width: 80px; flex-shrink: 0; }
  .bar-track { flex: 1; height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; transition: width 1s ease; }
  .bar-fill.up { background: linear-gradient(90deg, var(--green), rgba(16,185,129,0.5)); }
  .bar-fill.down { background: linear-gradient(90deg, var(--red), rgba(239,68,68,0.5)); }
  .sector-pct { font-family: 'Space Mono', monospace; font-size: 12px; width: 55px; text-align: right; }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    width: 90%;
    max-width: 480px;
    animation: slideUp 0.3s ease;
  }
  @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
  .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .modal-desc { font-size: 13px; color: var(--text-dim); margin-bottom: 20px; line-height: 1.6; }
  .modal input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    margin-bottom: 12px;
    font-family: 'Space Mono', monospace;
  }
  .modal input:focus { border-color: var(--accent); }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

  /* STOCK DETAIL */
  .stock-detail-header {
    display: flex;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 20px;
  }
  .detail-price-section { flex: 1; }
  .detail-name { font-size: 22px; font-weight: 700; }
  .detail-code { font-family: 'Space Mono', monospace; font-size: 14px; color: var(--text-dim); }
  .detail-price { font-family: 'Space Mono', monospace; font-size: 40px; font-weight: 700; margin: 8px 0; }
  .detail-change { font-family: 'Space Mono', monospace; font-size: 16px; }

  /* STATS GRID */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 16px 0; }
  .stat-box {
    background: var(--surface2);
    border-radius: 8px;
    padding: 12px;
    text-align: center;
  }
  .stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  .stat-value { font-family: 'Space Mono', monospace; font-size: 15px; font-weight: 700; }

  /* LOADING */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-dim);
    font-size: 13px;
    gap: 10px;
  }
  .spinner {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to{transform:rotate(360deg)} }

  /* AI CHAT */
  .chat-container {
    height: 380px;
    overflow-y: auto;
    padding: 16px;
    background: var(--surface2);
    border-radius: 10px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .chat-msg {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.6;
  }
  .chat-msg.user {
    background: var(--accent2);
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }
  .chat-msg.ai {
    background: var(--surface);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    border: 1px solid var(--border);
  }
  .chat-input-bar {
    display: flex;
    gap: 8px;
  }
  .chat-input-bar input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 13px;
    outline: none;
    font-family: 'Noto Sans TC', sans-serif;
  }
  .chat-input-bar input:focus { border-color: var(--accent); }

  /* ALERTS */
  .alert-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface2);
    border-radius: 8px;
    margin-bottom: 8px;
  }
  .alert-icon { font-size: 20px; flex-shrink: 0; }
  .alert-text { flex: 1; font-size: 13px; }
  .alert-time { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-dim); }

  /* SCORE BAR */
  .score-bar-container { margin: 12px 0; }
  .score-bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; color: var(--text-dim); }
  .score-bar-track { height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .score-bar-fill { height: 100%; border-radius: 3px; transition: width 1s ease; }

  /* PORTFOLIO */
  .portfolio-summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  .portfolio-stat {
    background: var(--surface2);
    border-radius: 10px;
    padding: 16px;
    border-left: 3px solid var(--border);
  }
  .portfolio-stat.profit { border-left-color: var(--green); }
  .portfolio-stat.loss { border-left-color: var(--red); }
  .portfolio-stat.neutral { border-left-color: var(--accent); }
  .portfolio-stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .portfolio-stat-value { font-family: 'Space Mono', monospace; font-size: 20px; font-weight: 700; }

  /* CALENDAR */
  .event-calendar { }
  .event-item {
    display: flex;
    gap: 14px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .event-item:last-child { border-bottom: none; }
  .event-date {
    text-align: center;
    width: 40px;
    flex-shrink: 0;
  }
  .event-day { font-family: 'Space Mono', monospace; font-size: 20px; font-weight: 700; color: var(--accent); }
  .event-month { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
  .event-body { flex: 1; }
  .event-title { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
  .event-desc { font-size: 12px; color: var(--text-dim); }
  .event-importance { display: flex; gap: 3px; }
  .dot-importance { width: 6px; height: 6px; border-radius: 50%; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .grid-3, .grid-2, .grid-left-wide, .grid-right-wide { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .portfolio-summary { grid-template-columns: repeat(2,1fr); }
  }

  /* ANIMATIONS */
  .fade-in { animation: fadeIn 0.5s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  /* TICKER TAPE */
  .ticker-wrap {
    overflow: hidden;
    background: rgba(0,212,255,0.05);
    border-bottom: 1px solid var(--border);
    padding: 6px 0;
    position: relative;
    z-index: 1;
  }
  .ticker-inner {
    display: flex;
    gap: 40px;
    white-space: nowrap;
    animation: ticker 30s linear infinite;
  }
  .ticker-item {
    display: inline-flex;
    gap: 8px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
  }
  .ticker-item .name { color: var(--text); }
  @keyframes ticker { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .section-title {
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title::before {
    content: '';
    width: 3px;
    height: 18px;
    background: var(--accent);
    border-radius: 2px;
  }

  /* Chart placeholder */
  .chart-placeholder {
    width: 100%;
    height: 200px;
    background: var(--surface2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dim);
    font-size: 13px;
    position: relative;
    overflow: hidden;
  }
  .chart-placeholder svg { position: absolute; inset: 0; width: 100%; height: 100%; }

  .notice-bar {
    background: rgba(124,58,237,0.1);
    border: 1px solid rgba(124,58,237,0.3);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 12px;
    color: #a78bfa;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .filter-chip {
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 12px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    background: transparent;
    color: var(--text-dim);
  }
  .filter-chip:hover, .filter-chip.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,212,255,0.05);
  }

  /* HEATMAP */
  .heatmap-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 4px;
    margin-top: 12px;
  }
  .heatmap-cell {
    aspect-ratio: 1.5;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    cursor: pointer;
    transition: transform 0.15s;
    padding: 4px;
    text-align: center;
  }
  .heatmap-cell:hover { transform: scale(1.05); z-index: 2; }
  .heatmap-cell .cell-name { font-weight: 500; font-size: 10px; }
  .heatmap-cell .cell-pct { font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700; }

  /* Progress ring */
  .progress-ring { position: relative; display: inline-flex; }
  .progress-ring svg { transform: rotate(-90deg); }
  .progress-ring-text {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Space Mono', monospace;
  }

  .mb-4 { margin-bottom: 16px; }
  .mb-2 { margin-bottom: 8px; }
  .mt-4 { margin-top: 16px; }
  .text-sm { font-size: 13px; }
  .text-xs { font-size: 11px; }
  .text-dim { color: var(--text-dim); }
  .gap-2 { gap: 8px; }
  .flex { display: flex; }
  .items-center { align-items: center; }
  .justify-between { justify-content: space-between; }

  /* â”€â”€ TREND ANALYSIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .trend-hero {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
  }
  .trend-direction-card {
    border-radius: 14px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border);
  }
  .trend-direction-card::before {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 120px; height: 120px;
    border-radius: 50%;
    opacity: 0.06;
  }
  .trend-direction-card.up   { background: linear-gradient(135deg, rgba(16,185,129,.08), var(--surface)); border-color: rgba(16,185,129,.25); }
  .trend-direction-card.up::before   { background: var(--green); }
  .trend-direction-card.down { background: linear-gradient(135deg, rgba(239,68,68,.08), var(--surface)); border-color: rgba(239,68,68,.25); }
  .trend-direction-card.down::before { background: var(--red); }
  .trend-direction-card.neutral { background: linear-gradient(135deg, rgba(245,158,11,.08), var(--surface)); border-color: rgba(245,158,11,.25); }
  .trend-direction-card.neutral::before { background: var(--gold); }

  .trend-arrow { font-size: 48px; line-height: 1; margin-bottom: 8px; }
  .trend-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim); margin-bottom: 4px; }
  .trend-verdict { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  .trend-stock-name { font-size: 13px; color: var(--text-dim); }

  /* ä¿¡å¿ƒåº¦é‡è¡¨ */
  .confidence-meter {
    margin: 16px 0;
  }
  .confidence-track {
    height: 10px;
    background: var(--surface2);
    border-radius: 5px;
    overflow: hidden;
    position: relative;
  }
  .confidence-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 1.2s cubic-bezier(.4,0,.2,1);
    position: relative;
  }
  .confidence-fill::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 4px; height: 100%;
    background: rgba(255,255,255,.4);
    border-radius: 2px;
  }
  .confidence-90-marker {
    position: absolute;
    top: -4px;
    left: 90%;
    width: 2px;
    height: 18px;
    background: var(--gold);
    opacity: .8;
  }
  .confidence-90-marker::after {
    content: '90%';
    position: absolute;
    top: -18px;
    left: -10px;
    font-size: 9px;
    color: var(--gold);
    font-family: 'Space Mono', monospace;
    white-space: nowrap;
  }
  .confidence-pct {
    font-family: 'Space Mono', monospace;
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
  }
  .confidence-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-top: 4px;
  }
  .confidence-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 8px;
  }
  .confidence-badge.high   { background: rgba(16,185,129,.15);  color: var(--green); }
  .confidence-badge.medium { background: rgba(245,158,11,.15); color: var(--gold); }
  .confidence-badge.low    { background: rgba(239,68,68,.12);   color: var(--red); }
  .confidence-badge::before { content: 'â—'; font-size: 8px; }

  /* åŸå› å¡ */
  .reason-card {
    background: var(--surface2);
    border-radius: 10px;
    padding: 14px 16px;
    margin-bottom: 10px;
    border-left: 3px solid var(--border);
    transition: border-color .2s;
  }
  .reason-card.supporting  { border-left-color: var(--green); }
  .reason-card.opposing    { border-left-color: var(--red); }
  .reason-card.uncertain   { border-left-color: var(--gold); }

  .reason-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .reason-type {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 700;
  }
  .reason-type.supporting { color: var(--green); }
  .reason-type.opposing   { color: var(--red); }
  .reason-type.uncertain  { color: var(--gold); }

  .reason-weight {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
  }
  .reason-text { font-size: 13px; line-height: 1.6; }
  .reason-evidence {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid rgba(255,255,255,.05);
    font-style: italic;
  }

  /* è‚¡ç¥¨é¸æ“‡å™¨ */
  .trend-stock-picker {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  .stock-pick-chip {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all .2s;
    background: var(--surface2);
    color: var(--text-dim);
    font-family: 'Space Mono', monospace;
  }
  .stock-pick-chip:hover,
  .stock-pick-chip.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,212,255,.07);
    box-shadow: 0 0 12px rgba(0,212,255,.1);
  }

  /* è³‡æ–™ä¾†æº badge */
  .data-source-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  .data-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(0,212,255,.08);
    color: var(--accent);
    font-family: 'Space Mono', monospace;
  }

  /* å¸‚å ´ç¸½é«”è¶¨å‹¢æ©«å¹… */
  .market-trend-banner {
    display: grid;
    grid-template-columns: repeat(3,1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  .mtrend-cell {
    background: var(--surface2);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
    border: 1px solid var(--border);
  }
  .mtrend-label { font-size: 11px; color: var(--text-dim); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .5px; }
  .mtrend-value { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700; }
  .mtrend-sub   { font-size: 11px; color: var(--text-dim); margin-top: 3px; }

  @media (max-width:768px) {
    .trend-hero { grid-template-columns: 1fr; }
    .market-trend-banner { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<!-- TICKER TAPE -->
<div class="ticker-wrap">
  <div class="ticker-inner" id="tickerInner">
    <!-- filled by JS -->
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">
    ğŸ“Š å°è‚¡æ™ºæ
    <span>TW Stock Intelligence</span>
  </div>
  <div class="header-right">
    <div class="market-status">
      <div class="status-dot" id="marketStatusDot"></div>
      <span id="marketStatusText">è¼‰å…¥ä¸­...</span>
    </div>
    <div style="font-family:'Space Mono',monospace;font-size:12px;color:var(--text-dim);" id="currentTime"></div>
    <span id="apiUsageCounter" style="font-size:11px;color:var(--text-dim);cursor:pointer;white-space:nowrap;" onclick="openApiModal()"></span>
    <!-- ä¸»é¡Œåˆ‡æ› -->
    <div style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-dim);">
      <span>ğŸŒ™</span>
      <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="åˆ‡æ›æ—¥/å¤œé–“æ¨¡å¼"></div>
      <span>â˜€ï¸</span>
    </div>
    <button class="api-key-btn" onclick="openApiModal()">âš™ï¸ è¨­å®š</button>
  </div>
</header>

<!-- NAV TABS -->
<div class="nav-tabs">
  <div class="tab active" onclick="switchTab('overview')">ğŸ“ˆ å¸‚å ´ç¸½è¦½</div>
  <div class="tab" onclick="switchTab('watchlist')">â­ è‡ªé¸è‚¡</div>
  <div class="tab" onclick="switchTab('portfolio')">ğŸ’¼ æŒè‚¡ç®¡ç†</div>
  <div class="tab" onclick="switchTab('ai-analysis')">ğŸ¤– AI æ¨è–¦ <span class="tab-badge" id="aiCount">5</span></div>
  <div class="tab" onclick="switchTab('news')">ğŸ“° æ–°èç¸½åŒ¯</div>
  <div class="tab" onclick="switchTab('macro')">ğŸŒ ç¸½ç¶“ç’°å¢ƒ</div>
  <div class="tab" onclick="switchTab('calendar')">ğŸ“… è²¡å ±è¡Œäº‹æ›†</div>
  <div class="tab" onclick="switchTab('screener')">ğŸ” é¸è‚¡å™¨</div>
  <div class="tab" onclick="switchTab('chat')">ğŸ’¬ AI å•ç­”</div>
  <div class="tab" onclick="switchTab('institutional')">ğŸ›ï¸ æ³•äººå‹•å‘</div>
  <div class="tab" onclick="switchTab('potential')">ğŸ’ æ½›åŠ›è‚¡</div>
  <div class="tab" onclick="switchTab('trend')">ğŸ”¬ è¶¨å‹¢åˆ†æ <span class="tab-badge" style="background:var(--green)" id="trendBadge">NEW</span></div>
  <div class="tab" onclick="switchTab('fundamentals')">ğŸ’° åŸºæœ¬é¢</div>
  <div class="tab" onclick="switchTab('global')">ğŸŒ åœ‹éš›è‚¡å¸‚ <span class="tab-badge" style="background:var(--accent2)">NEW</span></div>
</div>

<!-- MAIN -->
<main>

<!-- ===== PAGE: OVERVIEW ===== -->
<div class="page active fade-in" id="page-overview">
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;" id="overviewIndexGrid">
    <div class="card" style="cursor:pointer;" onclick="switchTab('global')">
      <div class="card-header">
        <div class="card-title"><span class="icon">ğŸ‡¹ğŸ‡¼</span> å°ç£åŠ æ¬ŠæŒ‡æ•¸</div>
      </div>
      <div class="index-value" id="twse-price">--,---</div>
      <div class="index-change" id="twse-change">---</div>
      <svg class="sparkline" id="twse-spark" viewBox="0 0 200 50" preserveAspectRatio="none"></svg>
    </div>
    <div class="card" style="cursor:pointer;" onclick="switchTab('global')">
      <div class="card-header">
        <div class="card-title"><span class="icon">ğŸ’±</span> USD/TWD</div>
      </div>
      <div class="index-value" id="usdtwd-price">--.-</div>
      <div class="index-change" id="usdtwd-change">---</div>
      <svg class="sparkline" id="usdtwd-spark" viewBox="0 0 200 50" preserveAspectRatio="none"></svg>
    </div>
    <div class="card" style="cursor:pointer;" onclick="switchTab('global')">
      <div class="card-header">
        <div class="card-title"><span class="icon">ğŸ˜±</span> VIX ææ…ŒæŒ‡æ•¸</div>
      </div>
      <div class="index-value" id="vix-price" style="font-size:28px;">--</div>
      <div class="index-change" id="vix-change">---</div>
      <svg class="sparkline" id="vix-spark" viewBox="0 0 200 50" preserveAspectRatio="none"></svg>
    </div>
    <div class="card" style="cursor:pointer;" onclick="switchTab('global')">
      <div class="card-header">
        <div class="card-title"><span class="icon">ğŸŒ</span> åœ‹éš›æŒ‡æ•¸</div>
        <span style="font-size:10px;color:var(--accent);">â†’ é»æ“ŠæŸ¥çœ‹</span>
      </div>
      <div id="miniGlobalSummary" style="display:flex;flex-direction:column;gap:4px;margin-top:8px;font-size:12px;">
        <div style="color:var(--text-dim);">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>

  <div class="grid-left-wide mb-4">
    <!-- SECTOR HEATMAP -->
    <div class="card" id="overviewHeatmap">
      <div class="card-header">
        <div class="card-title"><span class="icon">ğŸ—ºï¸</span> é¡è‚¡ç†±åŠ›åœ–</div>
        <div class="flex gap-2">
          <span class="text-xs text-dim">ä»Šæ—¥æ¼²è·Œ</span>
          <button class="btn-outline" style="font-size:11px;padding:3px 10px;" onclick="openDashboardSettings()">âš™ï¸ è‡ªè¨‚</button>
        </div>
      </div>
      <div class="heatmap-grid" id="heatmapGrid"></div>
    </div>

    <!-- RIGHT COLUMN -->
    <div style="display:flex;flex-direction:column;gap:16px;">
      <!-- Market Sentiment -->
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸŒ¡ï¸</span> å¸‚å ´æƒ…ç·’</div>
        <div style="text-align:center;margin-bottom:16px;">
          <div class="progress-ring">
            <svg width="100" height="100" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="40" fill="none" stroke="var(--surface2)" stroke-width="10"/>
              <circle cx="50" cy="50" r="40" fill="none" stroke="var(--green)" stroke-width="10"
                stroke-dasharray="251.2" stroke-dashoffset="100" id="sentimentRing" style="transition:stroke-dashoffset 1s ease;"/>
            </svg>
            <div class="progress-ring-text">
              <div style="font-size:22px;font-weight:700;font-family:'Space Mono',monospace;" id="sentimentScore">62</div>
              <div style="font-size:10px;color:var(--text-dim);">è²ªå©ª</div>
            </div>
          </div>
        </div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ææ…Œ</span><span>è²ªå©ª</span></div>
          <div class="score-bar-track">
            <div class="score-bar-fill" id="sentimentBar" style="background:linear-gradient(90deg,var(--red),var(--gold),var(--green));width:62%;"></div>
          </div>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">âš¡</span> å¿«è¨Š</div>
        <div id="quickAlerts">
          <div class="loading"><div class="spinner"></div> è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <!-- Top Movers -->
    <div class="card" id="overviewMovers">
      <div class="section-header">
        <div class="section-title">æ¼²å¹…æ¦œ</div>
        <div class="filter-bar" style="margin-bottom:0;">
          <button class="filter-chip active" onclick="setMoverType('gain',this)">æ¼²</button>
          <button class="filter-chip" onclick="setMoverType('loss',this)">è·Œ</button>
          <button class="filter-chip" onclick="setMoverType('volume',this)">é‡</button>
        </div>
      </div>
      <table class="stock-table" id="moverTable">
        <thead>
          <tr>
            <th>è‚¡ç¥¨</th>
            <th>ç¾åƒ¹</th>
            <th>æ¼²è·Œå¹…</th>
            <th>æˆäº¤é‡</th>
          </tr>
        </thead>
        <tbody id="moverTableBody"></tbody>
      </table>
    </div>

    <!-- Sector Performance -->
    <div class="card" id="overviewSectors">
      <div class="section-header">
        <div class="section-title">é¡è‚¡è¡¨ç¾</div>
      </div>
      <div id="sectorPerf"></div>
    </div>
  </div>
</div>

<!-- ===== PAGE: WATCHLIST ===== -->
<div class="page fade-in" id="page-watchlist">
  <div class="grid-left-wide">
    <div>
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">â­ è‡ªé¸è‚¡æ¸…å–®</div>
        </div>
        <div class="add-stock-bar">
          <div style="display:flex;gap:6px;width:100%;">
            <input type="text" id="watchlistInput" placeholder="ä»£ç¢¼ï¼Œå¤šç­†é€—è™Ÿåˆ†éš”ï¼š2330,2317,2454" 
              onkeydown="if(event.key==='Enter')addToWatchlist()" style="flex:1;">
            <button class="btn" onclick="addToWatchlist()">æ–°å¢</button>
            <button class="btn-outline" onclick="openBulkWatchlistModal()" title="æ‰¹é‡è¼¸å…¥">ğŸ“‹</button>
          </div>
          <button class="btn-outline" onclick="openBulkWatchlistModal()" style="white-space:nowrap;">æ‰¹é‡+</button>
        </div>
        <table class="stock-table">
          <thead>
            <tr>
              <th>è‚¡ç¥¨</th>
              <th>ç¾åƒ¹</th>
              <th>æ¼²è·Œ</th>
              <th>æ¼²è·Œ%</th>
              <th>æˆäº¤é‡</th>
              <th>è©•ç´š</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="watchlistBody"></tbody>
        </table>
        <div class="loading" id="watchlistLoading" style="display:none;"><div class="spinner"></div> æ›´æ–°è³‡æ–™ä¸­...</div>
      </div>
    </div>

    <!-- Right: quick detail -->
    <div>
      <div class="card mb-4" id="watchlistDetail">
        <div class="card-title" style="margin-bottom:16px;"><span class="icon">ğŸ“Š</span> å¿«é€Ÿåˆ†æ</div>
        <div style="text-align:center;color:var(--text-dim);font-size:13px;padding:30px 0;">
          é»æ“Šè‚¡ç¥¨æŸ¥çœ‹å¿«é€Ÿåˆ†æ
        </div>
      </div>
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ””</span> åƒ¹æ ¼è­¦å ±</div>
        <div id="alertsList">
          <div class="alert-item">
            <div class="alert-icon">ğŸŸ¢</div>
            <div class="alert-text">
              <div style="font-weight:500;">å°ç©é›» (2330)</div>
              <div class="text-xs text-dim">çªç ´ 1000 å…ƒæé†’</div>
            </div>
            <button class="btn-danger">âœ•</button>
          </div>
        </div>
        <button class="btn-outline mt-4" onclick="addAlert()" style="width:100%;">+ æ–°å¢è­¦å ±</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: PORTFOLIO ===== -->
<div class="page fade-in" id="page-portfolio">
  <div class="portfolio-summary" id="portfolioSummary">
    <div class="portfolio-stat neutral">
      <div class="portfolio-stat-label">ç¸½è³‡ç”¢</div>
      <div class="portfolio-stat-value" id="totalAsset">$0</div>
    </div>
    <div class="portfolio-stat neutral">
      <div class="portfolio-stat-label">ç¸½æˆæœ¬</div>
      <div class="portfolio-stat-value" id="totalCost">$0</div>
    </div>
    <div class="portfolio-stat profit" id="pnlCard">
      <div class="portfolio-stat-label">æœªå¯¦ç¾æç›Š</div>
      <div class="portfolio-stat-value" id="totalPnl">+$0</div>
    </div>
    <div class="portfolio-stat profit" id="pnlPctCard">
      <div class="portfolio-stat-label">å ±é…¬ç‡</div>
      <div class="portfolio-stat-value" id="totalPnlPct">+0.00%</div>
    </div>
  </div>

  <div class="grid-left-wide">
    <div class="card">
      <div class="section-header">
        <div class="section-title">ğŸ’¼ æŒè‚¡æ˜ç´°</div>
        <button class="btn" onclick="openAddHolding()">+ æ–°å¢æŒè‚¡</button>
      </div>
      <table class="stock-table">
        <thead>
          <tr>
            <th>è‚¡ç¥¨</th>
            <th>è‚¡æ•¸</th>
            <th>æˆæœ¬åƒ¹</th>
            <th>ç¾åƒ¹</th>
            <th>å¸‚å€¼</th>
            <th>æç›Š</th>
            <th>æç›Š%</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="portfolioBody"></tbody>
      </table>
    </div>
    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ©</span> æŒè‚¡æ¯”ä¾‹</div>
        <div id="pieChartContainer" style="display:flex;flex-direction:column;gap:8px;"></div>
      </div>

      <!-- æƒ…å¢ƒæ¨¡æ“¬ -->
      <div class="card mb-4" style="border:1px solid var(--accent2);">
        <div class="section-header" style="margin-bottom:12px;">
          <div class="card-title" style="margin:0;font-size:13px;"><span class="icon">ğŸ¯</span> æƒ…å¢ƒæ¨¡æ“¬</div>
          <span class="api-cost-badge" style="border-color:rgba(124,58,237,.4);background:rgba(124,58,237,.1);color:var(--accent2);">ğŸ¤– â‰ˆ0.08â‚®</span>
        </div>
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:10px;">æ¨¡æ“¬ç‰¹å®šäº‹ä»¶å°æŒè‚¡çµ„åˆçš„å½±éŸ¿</div>
        <select id="scenarioSelect" style="width:100%;margin-bottom:8px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px;border-radius:6px;font-size:12px;">
          <option value="">é¸æ“‡æƒ…å¢ƒ...</option>
          <option value="fed_cut">Fed é™æ¯ 1ç¢¼</option>
          <option value="usd_drop">ç¾å…ƒèµ°å¼± 5%</option>
          <option value="china_risk">ä¸­åœ‹åœ°ç·£é¢¨éšªå‡æº«</option>
          <option value="ai_boom">AIéœ€æ±‚è¶…é æœŸçˆ†ç™¼</option>
          <option value="recession">å…¨çƒè¡°é€€ç–‘æ…®å‡æº«</option>
          <option value="tariff">ç¾åœ‹å°å°åŠ é—œç¨…</option>
        </select>
        <button class="btn" style="width:100%;background:var(--accent2);border-color:var(--accent2);" onclick="runScenario()">â–¶ æ¨¡æ“¬åˆ†æ</button>
        <div id="scenarioResult" style="margin-top:10px;display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: AI ANALYSIS ===== -->
<div class="page fade-in" id="page-ai-analysis">
  <div class="notice-bar" id="aiNoticeBar">
    ğŸ’¡ é»æ“Šã€Œé‡æ–°åˆ†æã€è®“ AI æ ¹æ“šä»Šæ—¥çœŸå¯¦å¸‚å ´è³‡æ–™å‹•æ…‹è©•åˆ†ã€‚éœ€è¨­å®š Cloudflare Workerï¼ˆä¸¦åŠ å…¥ CLAUDE_API_KEY Secretï¼‰ã€‚
  </div>
  <div class="grid-left-wide">
    <div>
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">ğŸ¤– AI å‹•æ…‹æ¨è–¦</div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <button class="btn" onclick="runAiAnalysis()">ğŸ”„ é–‹å§‹åˆ†æ</button>
            <span class="api-cost-badge" data-tip="åˆ†æè‡ªé¸è‚¡ç´„æ¶ˆè€— 1500 tokensï¼Œâ‰ˆ0.15 TWD">ğŸ¤– â‰ˆ0.15 TWD/æ¬¡</span>
          </div>
        </div>
        <div class="filter-bar">
          <button class="filter-chip active" onclick="filterAiRec('',this)">å…¨éƒ¨</button>
          <button class="filter-chip" onclick="filterAiRec('buy',this)">ğŸ’š å¼·åŠ›è²·é€²</button>
          <button class="filter-chip" onclick="filterAiRec('hold',this)">ğŸŸ¡ è§€å¯Ÿ</button>
          <button class="filter-chip" onclick="filterAiRec('sell',this)">ğŸ”´ æ³¨æ„é¢¨éšª</button>
        </div>
        <div id="aiRecList">
          <div style="text-align:center;padding:40px 20px;color:var(--text-dim);">
            <div style="font-size:32px;margin-bottom:12px;">ğŸ¤–</div>
            <div style="font-size:13px;">é»æ“Šã€Œé–‹å§‹åˆ†æã€è®“ AI æ ¹æ“šä»Šæ—¥å¸‚å ´è³‡æ–™è©•ä¼°è‡ªé¸è‚¡</div>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">âš™ï¸</span> åˆ†æè¨­å®š</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">å‹¾é¸ç´å…¥åˆ†æçš„å› ç´ ï¼š</div>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="af-price"  checked style="accent-color:var(--accent);"><span>ğŸ“ˆ ä»Šæ—¥æ¼²è·Œå¹…èˆ‡é‡èƒ½</span></label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="af-pe"     checked style="accent-color:var(--accent);"><span>ğŸ’¹ æœ¬ç›Šæ¯” & æ®–åˆ©ç‡è©•ä¼°</span></label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="af-us"     checked style="accent-color:var(--accent);"><span>ğŸ‡ºğŸ‡¸ ç¾è‚¡ & è²»åŠæŒ‡æ•¸å½±éŸ¿</span></label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="af-fx"     checked style="accent-color:var(--accent);"><span>ğŸ’± åŒ¯ç‡èµ°å‘ï¼ˆUSD/TWDï¼‰</span></label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="af-sector" checked style="accent-color:var(--accent);"><span>ğŸ—‚ï¸ é¡è‚¡åŒä¼´è¡¨ç¾</span></label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="af-news"   checked style="accent-color:var(--accent);"><span>ğŸ“° è¿‘æœŸæ–°èæƒ…ç·’</span></label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="af-tariff" checked style="accent-color:var(--accent);"><span>âš–ï¸ é—œç¨… & åœ°ç·£æ”¿æ²»é¢¨éšª</span></label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="af-inst"         style="accent-color:var(--accent);"><span>ğŸ›ï¸ æ³•äººè²·è³£è¶…ï¼ˆè‹¥å·²è¼‰å…¥ï¼‰</span></label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="af-macro"        style="accent-color:var(--accent);"><span>ğŸŒ VIX & ç¾å‚µæ®–åˆ©ç‡</span></label>
        </div>
        <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border);">
          <div style="font-size:12px;color:var(--text-dim);margin-bottom:6px;">åˆ†æè‚¡ç¥¨æ± </div>
          <select id="af-pool" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
            <option value="watchlist">â­ æˆ‘çš„è‡ªé¸è‚¡</option>
            <option value="all">ğŸ“‹ æ‰€æœ‰å·²è¼‰å…¥è‚¡ç¥¨</option>
            <option value="sector_semi">ğŸ”¬ åŠå°é«”é¡</option>
            <option value="sector_ai">ğŸ¤– AIä¼ºæœå™¨é¡</option>
            <option value="sector_fin">ğŸ¦ é‡‘èé¡</option>
          </select>
        </div>
        <div style="margin-top:12px;">
          <div style="font-size:12px;color:var(--text-dim);margin-bottom:6px;">é¢¨éšªåå¥½</div>
          <input type="range" id="af-risk" min="1" max="5" value="3" style="width:100%;accent-color:var(--accent);" oninput="document.getElementById('riskLabel').textContent=['','ä¿å®ˆ','ç•¥ä¿å®ˆ','ä¸­æ€§','ç•¥ç©æ¥µ','ç©æ¥µ'][this.value]">
          <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-dim);margin-top:4px;">
            <span>ä¿å®ˆ</span><span id="riskLabel">ä¸­æ€§</span><span>ç©æ¥µ</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:10px;"><span class="icon">ğŸ“Š</span> æœ¬æ¬¡åˆ†ææ‘˜è¦</div>
        <div id="aiSummaryPanel" style="font-size:12px;color:var(--text-dim);line-height:1.8;">
          åˆ†æå¾Œé¡¯ç¤º
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: NEWS ===== -->
<div class="page fade-in" id="page-news">
  <div class="grid-left-wide">
    <div>
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">ğŸ“° æœ€æ–°æ–°è</div>
          <button class="btn-outline" onclick="refreshNews()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="filter-bar">
          <button class="filter-chip active" onclick="filterNews('all',this)">å…¨éƒ¨</button>
          <button class="filter-chip" onclick="filterNews('tw',this)">ğŸ‡¹ğŸ‡¼ å°ç£</button>
          <button class="filter-chip" onclick="filterNews('us',this)">ğŸ‡ºğŸ‡¸ ç¾åœ‹</button>
          <button class="filter-chip" onclick="filterNews('tech',this)">ğŸ’» ç§‘æŠ€</button>
          <button class="filter-chip" onclick="filterNews('tariff',this)">ğŸ“¦ é—œç¨…</button>
          <button class="filter-chip" onclick="filterNews('macro',this)">ğŸŒ ç¸½ç¶“</button>
        </div>
        <div id="newsList"></div>
        <div class="loading" id="newsLoading"><div class="spinner"></div> è¼‰å…¥æ–°èä¸­...</div>
      </div>
    </div>
    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ¯</span> å€‹è‚¡æ–°è</div>
        <div class="add-stock-bar">
          <input type="text" id="newsStockSearch" placeholder="æœå°‹å€‹è‚¡æ–°è...">
          <button class="btn" onclick="searchStockNews()">æœ</button>
        </div>
        <div id="stockNewsList">
          <div style="text-align:center;color:var(--text-dim);font-size:13px;padding:20px 0;">è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æœå°‹ç›¸é—œæ–°è</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ“¡</span> å½±éŸ¿æŒ‡æ•¸</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">ä»Šæ—¥ä¸»è¦æ–°èå°å°è‚¡çš„é ä¼°å½±éŸ¿</div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ğŸ‡ºğŸ‡¸ ç¾è‚¡æ”¶ç›¤</span><span style="color:var(--green)">æ­£é¢ +0.8%</span></div>
          <div class="score-bar-track"><div class="score-bar-fill" style="width:70%;background:var(--green);"></div></div>
        </div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ğŸ“¦ é—œç¨…æ¶ˆæ¯</span><span style="color:var(--red)">è² é¢ -0.5%</span></div>
          <div class="score-bar-track"><div class="score-bar-fill" style="width:40%;background:var(--red);"></div></div>
        </div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ğŸ’» AI/ç§‘æŠ€</span><span style="color:var(--green)">æ­£é¢ +1.2%</span></div>
          <div class="score-bar-track"><div class="score-bar-fill" style="width:80%;background:var(--green);"></div></div>
        </div>
        <div class="score-bar-container">
          <div class="score-bar-label"><span>ğŸ’° Fed æ”¿ç­–</span><span style="color:var(--gold)">ä¸­æ€§ 0%</span></div>
          <div class="score-bar-track"><div class="score-bar-fill" style="width:50%;background:var(--gold);"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: MACRO ===== -->
<div class="notice-bar" id="macroNote" style="display:none;margin-bottom:12px;"></div>
<div class="page fade-in" id="page-macro">
  <div class="grid-3 mb-4">
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;"><span class="icon">ğŸ‡ºğŸ‡¸</span> ç¾è‚¡æŒ‡æ•¸</div>
      <table class="stock-table" id="usIndexTable">
        <tbody>
          <tr><td>é“ç“Šå·¥æ¥­</td><td class="price" id="dji">--</td><td class="change" id="dji-ch">--</td></tr>
          <tr><td>ç´æ–¯é”å…‹</td><td class="price" id="ixic">--</td><td class="change" id="ixic-ch">--</td></tr>
          <tr><td>S&P 500</td><td class="price" id="spx">--</td><td class="change" id="spx-ch">--</td></tr>
          <tr><td>è²»åŸåŠå°é«”</td><td class="price" id="sox">--</td><td class="change" id="sox-ch">--</td></tr>
        </tbody>
      </table>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;"><span class="icon">ğŸ’±</span> åŒ¯ç‡ & å•†å“</div>
      <table class="stock-table">
        <tbody>
          <tr><td>USD/TWD</td><td class="price" id="usdtwd2">--</td><td class="change" id="usdtwd2-ch">--</td></tr>
          <tr><td>USD/JPY</td><td class="price" id="usdjpy">--</td><td class="change" id="usdjpy-ch">--</td></tr>
          <tr><td>åŸæ²¹ (WTI)</td><td class="price" id="wti">--</td><td class="change" id="wti-ch">--</td></tr>
          <tr><td>é»ƒé‡‘</td><td class="price" id="gold">--</td><td class="change" id="gold-ch">--</td></tr>
        </tbody>
      </table>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;"><span class="icon">ğŸ“Š</span> ææ…ŒæŒ‡æ•¸</div>
      <table class="stock-table">
        <tbody>
          <tr><td>VIX</td><td class="price" id="vix">--</td><td class="change" id="vix-ch">--</td></tr>
          <tr><td>10Y ç¾å‚µæ®–åˆ©ç‡</td><td class="price" id="ust10y">--</td><td class="change" id="ust10y-ch">--</td></tr>
          <tr><td>2Y ç¾å‚µæ®–åˆ©ç‡</td><td class="price" id="ust2y">--</td><td class="change" id="ust2y-ch">--</td></tr>
          <tr><td>DXY ç¾å…ƒæŒ‡æ•¸</td><td class="price" id="dxy">--</td><td class="change" id="dxy-ch">--</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="grid-2 mb-4">
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸ“¦ é—œç¨…æ”¿ç­–è¿½è¹¤</div>
      <div id="tariffList">
        <div class="news-item">
          <div class="news-meta">
            <span class="news-source">é—œç¨…</span>
            <span class="news-time">2025-01-15</span>
            <span class="news-impact tag tag-red">é«˜å½±éŸ¿</span>
          </div>
          <div class="news-title">ç¾åœ‹å°ä¸­åœ‹é›»å­ç”¢å“åŠ å¾µ25%é—œç¨…ï¼ŒåŠå°é«”ä¾›æ‡‰éˆé‡çµ„</div>
          <div class="news-summary">å°å» å—æƒ è¨‚å–®è½‰ç§»ï¼Œå°ç©é›»ã€è¯ç™¼ç§‘ç­‰å¯èƒ½å—ç›Šã€‚é ä¼°å°è‚¡é›»å­é¡è‚¡çŸ­æœŸæ­£é¢å½±éŸ¿ã€‚</div>
          <div class="ai-tags mt-4">
            <span class="tag tag-green">å°ç©é›»+</span>
            <span class="tag tag-green">è¯ç™¼ç§‘+</span>
            <span class="tag tag-red">PCBå» -</span>
          </div>
        </div>
        <div class="news-item">
          <div class="news-meta">
            <span class="news-source">é—œç¨…</span>
            <span class="news-time">2025-01-10</span>
            <span class="news-impact tag tag-gold">ä¸­å½±éŸ¿</span>
          </div>
          <div class="news-title">ç¾æ­è²¿æ˜“å”è­°é‡è«‡ï¼Œç§‘æŠ€ç”¢å“é—œç¨…å¯èƒ½è±å…</div>
          <div class="news-summary">è‹¥å”è­°é”æˆï¼Œæœ‰åˆ©å°ç£é›»å­å‡ºå£å•†ï¼Œç‰¹åˆ¥æ˜¯ä¼ºæœå™¨åŠç¶²é€šè¨­å‚™å» å•†ã€‚</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸŒ ç¸½ç¶“æŒ‡æ¨™</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">å°ç£ GDP</div>
          <div class="stat-value up">+3.1%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">CPI é€šè†¨</div>
          <div class="stat-value">2.1%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Fed åˆ©ç‡</div>
          <div class="stat-value">4.25%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å°ç£åˆ©ç‡</div>
          <div class="stat-value">2.00%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å¤±æ¥­ç‡</div>
          <div class="stat-value">3.4%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">PMI</div>
          <div class="stat-value up">51.2</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å¤–åŒ¯å­˜åº•</div>
          <div class="stat-value">5,780å„„</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">M1B å¹´å¢ç‡</div>
          <div class="stat-value down">+5.2%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PAGE: CALENDAR ===== -->
<div class="page fade-in" id="page-calendar">
  <div class="grid-2">
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸ“… æœ¬é€±è²¡å ±è¡Œäº‹æ›†</div>
      <div class="event-calendar" id="earningsCalendar"></div>
    </div>
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸŒ ç¸½ç¶“äº‹ä»¶</div>
      <div class="event-calendar" id="macroCalendar"></div>
    </div>
  </div>
</div>

<!-- ===== PAGE: SCREENER ===== -->
<div class="page fade-in" id="page-screener">
  <!-- âœ¨ AI è‡ªç„¶èªè¨€é¸è‚¡ -->
  <div class="card mb-4" style="border:1px solid var(--accent2);background:linear-gradient(135deg,var(--surface) 0%,rgba(124,58,237,0.06) 100%);">
    <div class="section-header">
      <div class="section-title" style="color:var(--accent2);">ğŸ”® AI è‡ªç„¶èªè¨€é¸è‚¡</div>
      <span class="api-cost-badge" style="border-color:rgba(124,58,237,.4);background:rgba(124,58,237,.1);color:var(--accent2);">ğŸ¤– â‰ˆ0.10 TWD/æ¬¡</span>
    </div>
    <div style="font-size:12px;color:var(--text-dim);margin:8px 0 12px;">ç”¨ä¸­æ–‡æè¿°ä½ çš„é¸è‚¡æ¢ä»¶ï¼ŒAI è‡ªå‹•å¾è‡ªé¸è‚¡å’Œå¿«å–è‚¡ç¥¨ä¸­ç¯©é¸</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
      <input type="text" id="nlScreenerInput" placeholder="ä¾‹å¦‚ï¼šæ®–åˆ©ç‡å¤§æ–¼5%ä¸”æœ¬ç›Šæ¯”åˆç†çš„é‡‘èè‚¡ã€AIæ¦‚å¿µçš„åŠå°é«”å¤–è³‡è²·è¶…..."
        style="flex:1;min-width:200px;" onkeydown="if(event.key==='Enter')runNLScreener()">
      <button class="btn" style="background:var(--accent2);" onclick="runNLScreener()">ğŸ”® AIç¯©é¸</button>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button class="filter-chip" onclick="setNLScreener('é«˜æ®–åˆ©ç‡ä¸”æœ¬ç›Šæ¯”ä½çš„é‡‘èè‚¡')">é«˜æ¯é‡‘è</button>
      <button class="filter-chip" onclick="setNLScreener('AIåŠå°é«”ä¸”å¤–è³‡æŒçºŒè²·è¶…')">AIåŠå°å¤–è³‡è²·</button>
      <button class="filter-chip" onclick="setNLScreener('ä»Šæ—¥å¼·å‹¢ä¸Šæ¼²ä¸”æˆäº¤é‡æ”¾å¤§')">å¼·å‹¢é‡å¢</button>
      <button class="filter-chip" onclick="setNLScreener('ä½æœ¬ç›Šæ¯”é«˜æ®–åˆ©ç‡å‚³ç”¢è‚¡')">ä½PEå‚³ç”¢</button>
      <button class="filter-chip" onclick="setNLScreener('æ®–åˆ©ç‡è¶…é6%çš„é›»ä¿¡æˆ–å…¬ç”¨äº‹æ¥­')">è¶…é«˜æ¯å…¬ç”¨</button>
    </div>
    <div id="nlScreenerResult" style="margin-top:12px;display:none;"></div>
  </div>

  <!-- å¿«é€Ÿç¯©é¸ Tag -->
  <div class="card mb-4">
    <div class="section-header">
      <div class="section-title">ğŸ” æ¢ä»¶é¸è‚¡</div>
      <div style="font-size:12px;color:var(--text-dim);">å¿«é€Ÿæ¢ä»¶ï¼š</div>
    </div>
    <div class="filter-bar" style="margin-bottom:16px;">
      <button class="filter-chip" onclick="applyPreset('high_div')">ğŸ’° é«˜æ®–åˆ©ç‡ â‰¥5%</button>
      <button class="filter-chip" onclick="applyPreset('low_pe')">ğŸ“‰ ä½æœ¬ç›Šæ¯” â‰¤12</button>
      <button class="filter-chip" onclick="applyPreset('ai')">ğŸ¤– AIæ¦‚å¿µè‚¡</button>
      <button class="filter-chip" onclick="applyPreset('semicon')">ğŸ”¬ åŠå°é«”</button>
      <button class="filter-chip" onclick="applyPreset('finance')">ğŸ¦ é‡‘èè‚¡</button>
      <button class="filter-chip" onclick="applyPreset('up_today')">ğŸ“ˆ ä»Šæ—¥ä¸Šæ¼²</button>
      <button class="filter-chip" onclick="applyPreset('down_today')">ğŸ“‰ ä»Šæ—¥ä¸‹è·Œ</button>
      <button class="filter-chip" onclick="applyPreset('high_vol')">ğŸ”¥ é‡èƒ½æ”¾å¤§</button>
    </div>

    <!-- è©³ç´°æ¢ä»¶ -->
    <div class="grid-3" style="gap:12px;margin-bottom:16px;">
      <div>
        <div class="stat-label" style="margin-bottom:6px;">ç”¢æ¥­é¡åˆ¥</div>
        <select id="sc-sector" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-family:'Noto Sans TC',sans-serif;font-size:13px;outline:none;">
          <option value="">å…¨éƒ¨é¡è‚¡</option>
          <option value="åŠå°é«”">ğŸ”¬ åŠå°é«”</option>
          <option value="AIä¼ºæœå™¨">ğŸ¤– AIä¼ºæœå™¨</option>
          <option value="é›»å­é›¶çµ„ä»¶">ğŸ”§ é›»å­é›¶çµ„ä»¶</option>
          <option value="é‡‘èä¿éšª">ğŸ¦ é‡‘èä¿éšª</option>
          <option value="é›»ä¿¡">ğŸ“¡ é›»ä¿¡</option>
          <option value="å‚³ç”¢">ğŸ­ å‚³ç”¢</option>
          <option value="é¢æ¿">ğŸ–¥ï¸ é¢æ¿</option>
          <option value="ç”ŸæŠ€">ğŸ’Š ç”ŸæŠ€</option>
          <option value="ç¶²é€š">ğŸŒ ç¶²é€š</option>
          <option value="é›»å‹•è»Š">âš¡ é›»å‹•è»Š</option>
        </select>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">æœ¬ç›Šæ¯” P/E</div>
        <div class="flex gap-2">
          <input id="sc-pe-min" type="number" placeholder="æœ€ä½" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
          <input id="sc-pe-max" type="number" placeholder="æœ€é«˜" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
        </div>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">æ®–åˆ©ç‡ %</div>
        <div class="flex gap-2">
          <input id="sc-yield-min" type="number" placeholder="æœ€ä½%" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
          <input id="sc-yield-max" type="number" placeholder="æœ€é«˜%" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
        </div>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">ä»Šæ—¥æ¼²è·Œå¹… %</div>
        <div class="flex gap-2">
          <input id="sc-chg-min" type="number" placeholder="æœ€ä½%" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
          <input id="sc-chg-max" type="number" placeholder="æœ€é«˜%" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
        </div>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">è‚¡åƒ¹å€é–“ (å…ƒ)</div>
        <div class="flex gap-2">
          <input id="sc-price-min" type="number" placeholder="æœ€ä½" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
          <input id="sc-price-max" type="number" placeholder="æœ€é«˜" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
        </div>
      </div>
      <div>
        <div class="stat-label" style="margin-bottom:6px;">æ¼²è·Œæ–¹å‘</div>
        <select id="sc-dir" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-family:'Noto Sans TC',sans-serif;font-size:13px;outline:none;">
          <option value="">ä¸é™</option>
          <option value="up">â†‘ ä»Šæ—¥ä¸Šæ¼²</option>
          <option value="down">â†“ ä»Šæ—¥ä¸‹è·Œ</option>
          <option value="strong">ğŸ”¥ å¼·å‹¢ â‰¥+2%</option>
          <option value="weak">ğŸ’§ å¼±å‹¢ â‰¤-2%</option>
        </select>
      </div>
    </div>
    <div class="flex gap-2">
      <button class="btn" onclick="runScreener()">ğŸ” é–‹å§‹ç¯©é¸</button>
      <button class="btn-outline" onclick="resetScreener()">é‡ç½®æ¢ä»¶</button>
    </div>
  </div>
  <div class="card" id="screenerResults">
    <div style="text-align:center;color:var(--text-dim);font-size:13px;padding:30px;">è¨­å®šæ¢ä»¶å¾Œé»é¸ã€Œé–‹å§‹ç¯©é¸ã€</div>
  </div>
</div>

<!-- ===== PAGE: AI CHAT ===== -->
<div class="page fade-in" id="page-chat">
  <div class="grid-left-wide">
    <div class="card">
      <div class="section-title" style="margin-bottom:16px;">ğŸ’¬ AI è‚¡å¸‚åˆ†æåŠ©ç†</div>
      <div class="notice-bar" id="chatNoticeBar">ğŸ’¡ AI å•ç­”æ¯æ¬¡ç´„æ¶ˆè€— 800 tokensï¼ˆâ‰ˆ0.08 TWDï¼‰ã€‚<span id="aiUsageBadge" style="float:right;font-size:11px;background:rgba(0,212,255,.15);padding:2px 8px;border-radius:10px;cursor:pointer;" onclick="showAiUsage()">ğŸ“Š ç”¨é‡ 0æ¬¡</span></div>
      <div class="chat-container" id="chatContainer">
        <div class="chat-msg ai">
          ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯å°è‚¡ AI åˆ†æåŠ©ç†ã€‚<br><br>
          æˆ‘å¯ä»¥å¹«æ‚¨ï¼š<br>
          â€¢ åˆ†æç‰¹å®šè‚¡ç¥¨çš„æŠ€è¡“é¢ã€åŸºæœ¬é¢<br>
          â€¢ è§£è®€ç¾è‚¡å°å°è‚¡çš„å½±éŸ¿<br>
          â€¢ è©•ä¼°é—œç¨…æ”¿ç­–çš„ç”¢æ¥­å½±éŸ¿<br>
          â€¢ æ¯”è¼ƒå€‹è‚¡è²¡å ±æ•¸æ“š<br>
          â€¢ æä¾›è²·è³£å»ºè­°èˆ‡é¢¨éšªè©•ä¼°<br><br>
          è«‹å•æ‚¨æƒ³äº†è§£å“ªæ”¯è‚¡ç¥¨ï¼Ÿ
        </div>
      </div>
      <div class="chat-input-bar">
        <input type="text" id="chatInput" placeholder="è©¢å•å°è‚¡åˆ†æï¼Œä¾‹å¦‚ï¼šå°ç©é›»ä»Šå¤©èƒ½è²·å—ï¼Ÿ" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn" onclick="sendChat()">é€å‡º</button>
      </div>
      <div class="flex gap-2" style="margin-top:10px;flex-wrap:wrap;">
        <button class="filter-chip" onclick="quickChat('å°ç©é›»è¿‘æœŸèµ°å‹¢åˆ†æ')">å°ç©é›»åˆ†æ</button>
        <button class="filter-chip" onclick="quickChat('ä»Šæ—¥ç¾è‚¡æ”¶ç›¤å°æ˜æ—¥å°è‚¡çš„å½±éŸ¿')">ç¾è‚¡å½±éŸ¿</button>
        <button class="filter-chip" onclick="quickChat('ç›®å‰é—œç¨…æ”¿ç­–å°å°å» å½±éŸ¿')">é—œç¨…å½±éŸ¿</button>
        <button class="filter-chip" onclick="quickChat('AIæ¦‚å¿µè‚¡æ¨è–¦')">AI æ¦‚å¿µè‚¡</button>
        <button class="filter-chip" onclick="quickChat('é«˜æ®–åˆ©ç‡è‚¡ç¥¨æ¨è–¦')">é«˜æ®–åˆ©ç‡è‚¡</button>
      </div>
    </div>
    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ“š</span> å¸¸è¦‹å•é¡Œ</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div class="btn-outline" style="text-align:left;cursor:pointer;" onclick="quickChat('å°ç£åŠ æ¬ŠæŒ‡æ•¸ç›®å‰ä½ç½®åˆ†æ')">å°ç£åŠ æ¬ŠæŒ‡æ•¸ç›®å‰ä½ç½®ï¼Ÿ</div>
          <div class="btn-outline" style="text-align:left;cursor:pointer;" onclick="quickChat('Fedé™æ¯å°å°è‚¡çš„å½±éŸ¿')">Fed é™æ¯å°å°è‚¡çš„å½±éŸ¿ï¼Ÿ</div>
          <div class="btn-outline" style="text-align:left;cursor:pointer;" onclick="quickChat('å°ç©é›»vsä¸‰æ˜Ÿç«¶çˆ­åˆ†æ')">å°ç©é›» vs ä¸‰æ˜Ÿåˆ†æ</div>
          <div class="btn-outline" style="text-align:left;cursor:pointer;" onclick="quickChat('2025å¹´å°è‚¡å±•æœ›')">2025 å¹´å°è‚¡å±•æœ›</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ”’</span> API è¨­å®šèªªæ˜</div>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.7;margin-bottom:12px;">
          Claude API Key å­˜æ”¾æ–¼ Cloudflare Worker Secretï¼Œä¸éœ€åœ¨ç€è¦½å™¨è¨­å®šã€‚<br>
          åªéœ€è¨­å®š Worker ç¶²å€å³å¯ä½¿ç”¨æ‰€æœ‰ AI åŠŸèƒ½ã€‚
        </div>
        <button class="btn" style="width:100%;" onclick="openApiModal()">âš™ï¸ è¨­å®š Worker ç¶²å€</button>
        <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border);">
          <div style="font-size:12px;color:var(--text-dim);margin-bottom:6px;">ğŸ“Š ä»Šæ—¥ AI ä½¿ç”¨é‡</div>
          <div id="aiUsageDetail" style="font-size:12px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>




<!-- ===== PAGE: GLOBAL MARKETS ===== -->
<div class="page fade-in" id="page-global">
  <!-- åœ‹éš›è‚¡å¸‚æ©«å¹… -->
  <div class="notice-bar">ğŸŒ åœ‹éš›è‚¡å¸‚å³æ™‚è³‡æ–™ï¼Œé€éå¤šé‡å‚™æ´ï¼ˆYahoo Finance + Stooqï¼‰è‡ªå‹•æ›´æ–°ã€‚é»æ“Šå„æŒ‡æ•¸å¡ç‰‡å¯æŸ¥çœ‹è©³æƒ…ã€‚</div>

  <!-- ä¸»è¦æŒ‡æ•¸ -->
  <div style="font-size:13px;font-weight:700;color:var(--accent);margin:0 0 10px;">ğŸ‡ºğŸ‡¸ ç¾è‚¡</div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px;" id="usIndicesGrid">
    <div class="card global-idx-card" data-sym="^GSPC" onclick="showGlobalDetail('^GSPC')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ‡ºğŸ‡¸ S&P 500</div>
      <div class="global-price" id="g-^GSPC-price">--</div>
      <div class="global-change" id="g-^GSPC-change">--</div>
      <svg class="sparkline" id="g-^GSPC-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="^IXIC" onclick="showGlobalDetail('^IXIC')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ’» NASDAQ</div>
      <div class="global-price" id="g-^IXIC-price">--</div>
      <div class="global-change" id="g-^IXIC-change">--</div>
      <svg class="sparkline" id="g-^IXIC-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="^DJI" onclick="showGlobalDetail('^DJI')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ­ é“ç“Š DJI</div>
      <div class="global-price" id="g-^DJI-price">--</div>
      <div class="global-change" id="g-^DJI-change">--</div>
      <svg class="sparkline" id="g-^DJI-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="^SOX" onclick="showGlobalDetail('^SOX')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ”¬ è²»åŠ SOX</div>
      <div class="global-price" id="g-^SOX-price">--</div>
      <div class="global-change" id="g-^SOX-change">--</div>
      <svg class="sparkline" id="g-^SOX-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <div style="font-size:13px;font-weight:700;color:var(--accent);margin:0 0 10px;">ğŸŒ äºå¤ªè‚¡å¸‚</div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px;" id="asiaIndicesGrid">
    <div class="card global-idx-card" data-sym="^N225" onclick="showGlobalDetail('^N225')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ‡¯ğŸ‡µ æ—¥ç¶“ 225</div>
      <div class="global-price" id="g-^N225-price">--</div>
      <div class="global-change" id="g-^N225-change">--</div>
      <svg class="sparkline" id="g-^N225-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="^HSI" onclick="showGlobalDetail('^HSI')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ‡­ğŸ‡° æ†ç”ŸæŒ‡æ•¸</div>
      <div class="global-price" id="g-^HSI-price">--</div>
      <div class="global-change" id="g-^HSI-change">--</div>
      <svg class="sparkline" id="g-^HSI-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="000001.SS" onclick="showGlobalDetail('000001.SS')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ‡¨ğŸ‡³ ä¸Šè¨¼æŒ‡æ•¸</div>
      <div class="global-price" id="g-000001.SS-price">--</div>
      <div class="global-change" id="g-000001.SS-change">--</div>
      <svg class="sparkline" id="g-000001.SS-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="^KS11" onclick="showGlobalDetail('^KS11')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ‡°ğŸ‡· éŸ“åœ‹ KOSPI</div>
      <div class="global-price" id="g-^KS11-price">--</div>
      <div class="global-change" id="g-^KS11-change">--</div>
      <svg class="sparkline" id="g-^KS11-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <div style="font-size:13px;font-weight:700;color:var(--accent);margin:0 0 10px;">ğŸŒ æ­æ´² & å•†å“</div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px;">
    <div class="card global-idx-card" data-sym="^GDAXI" onclick="showGlobalDetail('^GDAXI')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ‡©ğŸ‡ª å¾·DAX</div>
      <div class="global-price" id="g-^GDAXI-price">--</div>
      <div class="global-change" id="g-^GDAXI-change">--</div>
      <svg class="sparkline" id="g-^GDAXI-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="^FTSE" onclick="showGlobalDetail('^FTSE')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ‡¬ğŸ‡§ è‹±FTSE 100</div>
      <div class="global-price" id="g-^FTSE-price">--</div>
      <div class="global-change" id="g-^FTSE-change">--</div>
      <svg class="sparkline" id="g-^FTSE-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="GC=F" onclick="showGlobalDetail('GC=F')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ¥‡ é»ƒé‡‘ (USD/oz)</div>
      <div class="global-price" id="g-GC=F-price">--</div>
      <div class="global-change" id="g-GC=F-change">--</div>
      <svg class="sparkline" id="g-GC=F-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="CL=F" onclick="showGlobalDetail('CL=F')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ›¢ï¸ åŸæ²¹ WTI</div>
      <div class="global-price" id="g-CL=F-price">--</div>
      <div class="global-change" id="g-CL=F-change">--</div>
      <svg class="sparkline" id="g-CL=F-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <!-- ææ…Œ/åˆ©ç‡ -->
  <div style="font-size:13px;font-weight:700;color:var(--accent);margin:0 0 10px;">ğŸ“Š å¸‚å ´æƒ…ç·’ & åˆ©ç‡</div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px;">
    <div class="card global-idx-card" data-sym="^VIX" onclick="showGlobalDetail('^VIX')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ˜± VIX ææ…Œ</div>
      <div class="global-price" id="g-^VIX-price">--</div>
      <div class="global-change" id="g-^VIX-change">--</div>
      <svg class="sparkline" id="g-^VIX-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="^TNX" onclick="showGlobalDetail('^TNX')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ¦ ç¾10å¹´å‚µæ®–åˆ©ç‡</div>
      <div class="global-price" id="g-^TNX-price">--</div>
      <div class="global-change" id="g-^TNX-change">--</div>
      <svg class="sparkline" id="g-^TNX-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="DX-Y.NYB" onclick="showGlobalDetail('DX-Y.NYB')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ’µ ç¾å…ƒæŒ‡æ•¸ DXY</div>
      <div class="global-price" id="g-DX-Y.NYB-price">--</div>
      <div class="global-change" id="g-DX-Y.NYB-change">--</div>
      <svg class="sparkline" id="g-DX-Y.NYB-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
    <div class="card global-idx-card" data-sym="USDJPY=X" onclick="showGlobalDetail('USDJPY=X')">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ğŸ’´ USD/JPY æ—¥åœ“</div>
      <div class="global-price" id="g-USDJPY=X-price">--</div>
      <div class="global-change" id="g-USDJPY=X-change">--</div>
      <svg class="sparkline" id="g-USDJPY=X-spark" viewBox="0 0 200 40" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <!-- AI å¸‚å ´è§£è®€ -->
  <div class="card">
    <div class="section-header">
      <div class="section-title">ğŸ¤– AI å…¨çƒå¸‚å ´è§£è®€</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="api-cost-badge" data-tip="ç´„æ¶ˆè€— 800 tokensï¼Œâ‰ˆ0.08 TWD">ğŸ¤– â‰ˆ0.08 TWD/æ¬¡</span>
        <button class="btn" onclick="runGlobalAI()">åˆ†æå¸‚å ´</button>
      </div>
    </div>
    <div id="globalAIResult" style="padding:16px;color:var(--text-dim);font-size:13px;text-align:center;">
      é»æ“Šã€Œåˆ†æå¸‚å ´ã€è®“ AI è§£è®€ç•¶å‰å…¨çƒè‚¡å¸‚èµ°å‘åŠå°å°è‚¡çš„å½±éŸ¿
    </div>
  </div>
</div>


<!-- ===== PAGE: FUNDAMENTALS ===== -->
<div class="page fade-in" id="page-fundamentals">
  <!-- æœå°‹åˆ— -->
  <div class="card mb-4">
    <div class="section-header">
      <div class="section-title">ğŸ’° å€‹è‚¡åŸºæœ¬é¢ & é…æ¯åˆ†æ</div>
      <span style="font-size:12px;color:var(--text-dim);">è³‡æ–™ä¾†æºï¼šå°ç£è­‰äº¤æ‰€ & Yahoo Finance</span>
    </div>
    <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
      <input type="text" id="fundStockInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼Œå¦‚ï¼š2330"
        style="flex:1;min-width:160px;" onkeydown="if(event.key==='Enter')loadFundamentals()">
      <button class="btn" onclick="loadFundamentals()">ğŸ” æŸ¥è©¢</button>
      <!-- å¿«æ·æŒ‰éˆ• -->
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="filter-chip" onclick="loadFundamentals('2330')">å°ç©é›»</button>
        <button class="filter-chip" onclick="loadFundamentals('2317')">é´»æµ·</button>
        <button class="filter-chip" onclick="loadFundamentals('2454')">è¯ç™¼ç§‘</button>
        <button class="filter-chip" onclick="loadFundamentals('2412')">ä¸­è¯é›»</button>
        <button class="filter-chip" onclick="loadFundamentals('2882')">åœ‹æ³°é‡‘</button>
      </div>
    </div>
  </div>

  <!-- çµæœå€ -->
  <div id="fundResult">
    <div style="text-align:center;padding:60px 20px;color:var(--text-dim);">
      <div style="font-size:48px;margin-bottom:12px;">ğŸ’°</div>
      <div style="font-size:15px;font-weight:500;margin-bottom:8px;">æŸ¥è©¢è‚¡ç¥¨åŸºæœ¬é¢è³‡æ–™</div>
      <div style="font-size:13px;">è¼¸å…¥ä»£ç¢¼å¾ŒæŸ¥çœ‹é…æ¯æ­·å²ã€æœ¬ç›Šæ¯”ã€æ®–åˆ©ç‡ã€è‚¡åƒ¹æ·¨å€¼æ¯”ç­‰è³‡è¨Š</div>
    </div>
  </div>
</div>

<!-- ===== PAGE: POTENTIAL STOCKS ===== -->
<div class="page fade-in" id="page-potential">
  <div class="notice-bar">
    ğŸ’ AI æ ¹æ“šä»Šæ—¥å¸‚å ´è³‡æ–™ã€ä¼°å€¼ã€ç±Œç¢¼ã€ç”¢æ¥­è¶¨å‹¢ï¼Œç¯©é¸å‡º Top 10 æ½›åŠ›è‚¡ã€‚æ¯æ¬¡é»æ“Šåˆ†æéƒ½æœƒé‡æ–°è©•ä¼°ã€‚
  </div>

  <div class="grid-left-wide">
    <div>
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">ğŸ’ Top 10 æ½›åŠ›è‚¡</div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <button class="btn" onclick="runPotentialAnalysis()">ğŸ” é–‹å§‹åˆ†æ</button>
            <span class="api-cost-badge" data-tip="åˆ†ææ‰€æœ‰è‚¡ç¥¨ç´„æ¶ˆè€— 2000 tokensï¼Œâ‰ˆ0.2 TWD">ğŸ¤– â‰ˆ0.2 TWD/æ¬¡</span>
          </div>
        </div>
        <div id="potentialList">
          <div style="text-align:center;padding:50px 20px;color:var(--text-dim);">
            <div style="font-size:40px;margin-bottom:12px;">ğŸ’</div>
            <div style="font-size:14px;font-weight:500;margin-bottom:6px;">é»æ“Šã€Œé–‹å§‹åˆ†æã€</div>
            <div style="font-size:12px;">AI å°‡å¾æ‰€æœ‰å·²è¼‰å…¥è‚¡ç¥¨ä¸­ï¼Œä¾å¤šå› å­è©•ä¼°æ‰¾å‡ºæœ€å…·æ½›åŠ›çš„10æ”¯</div>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">âš™ï¸</span> æ½›åŠ›è©•ä¼°æ¢ä»¶</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:10px;">AI è©•ä¼°æ™‚è€ƒæ…®çš„ç¶­åº¦ï¼š</div>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="pt-val" checked style="accent-color:var(--accent);">
            <span>ğŸ’¹ ä¼°å€¼å¸å¼•åŠ›ï¼ˆPEã€æ®–åˆ©ç‡ï¼‰</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="pt-mom" checked style="accent-color:var(--accent);">
            <span>ğŸ“ˆ è¿‘æœŸå‹•èƒ½ï¼ˆæ¼²è·Œå¹…ã€é‡èƒ½ï¼‰</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="pt-sec" checked style="accent-color:var(--accent);">
            <span>ğŸ—‚ï¸ é¡è‚¡æ™¯æ°£åº¦</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="pt-us"  checked style="accent-color:var(--accent);">
            <span>ğŸ‡ºğŸ‡¸ ç¾è‚¡å¸¶å‹•æ•ˆæ‡‰</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="pt-inst" style="accent-color:var(--accent);">
            <span>ğŸ›ï¸ æ³•äººå‹•å‘ï¼ˆè‹¥å·²è¼‰å…¥ï¼‰</span>
          </label>
        </div>
        <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border);">
          <div style="font-size:12px;color:var(--text-dim);margin-bottom:6px;">ç¯©é¸ç¯„åœ</div>
          <select id="pt-pool" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;outline:none;">
            <option value="all">ğŸ“‹ æ‰€æœ‰å·²è¼‰å…¥è‚¡ç¥¨</option>
            <option value="semi">ğŸ”¬ åŠå°é«” + AIé¡</option>
            <option value="finance">ğŸ¦ é‡‘èé¡</option>
            <option value="trad">ğŸ­ å‚³ç”¢é¡</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:10px;"><span class="icon">ğŸ“–</span> è©•åˆ†èªªæ˜</div>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
          <div>ğŸ† <span style="color:var(--green);">80â€“100åˆ†</span> é«˜æ½›åŠ›ï¼Œå¤šæŒ‡æ¨™å‘å¥½</div>
          <div>â­ <span style="color:var(--accent);">60â€“79åˆ†</span> ä¸­æ½›åŠ›ï¼Œæœ‰éƒ¨åˆ†äº®é»</div>
          <div>ğŸ“Š <span style="color:var(--gold);">40â€“59åˆ†</span> ä¸€èˆ¬ï¼Œç­‰å¾…æ›´å¥½æ™‚æ©Ÿ</div>
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:11px;">
            âš ï¸ è©•åˆ†åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ===== PAGE: INSTITUTIONAL ===== -->
<div class="page fade-in" id="page-institutional">
  <div class="notice-bar" id="instNote">
    ğŸ“Š è³‡æ–™ä¾†æºï¼šå°ç£è­‰äº¤æ‰€ T86 ä¸‰å¤§æ³•äººè²·è³£è¶…å ±è¡¨ï¼ˆç›¤å¾Œæ›´æ–°ï¼‰
  </div>

  <!-- ç¸½è¨ˆæ©«å¹… -->
  <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:16px;" id="instSummary">
    <div class="stat-box">
      <div class="stat-label">å¤–è³‡ä»Šæ—¥åˆè¨ˆæ·¨è²·è¶…</div>
      <div class="stat-value up" id="inst-total-buy">è¼‰å…¥ä¸­...</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">å¤–è³‡ä»Šæ—¥åˆè¨ˆæ·¨è³£è¶…</div>
      <div class="stat-value down" id="inst-total-sell">è¼‰å…¥ä¸­...</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">è³‡æ–™æ—¥æœŸ</div>
      <div class="stat-value" id="inst-date" style="font-size:14px;">--</div>
    </div>
  </div>

  <div class="grid-left-wide">
    <div>
      <!-- å¤–è³‡è²·è¶… Top 5 -->
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title" style="color:var(--green);">ğŸŸ¢ å¤–è³‡è²·è¶… Top 10</div>
          <span class="tag tag-green">æ·¨è²·å…¥ï¼ˆå¼µï¼‰</span>
        </div>
        <div id="instBuyTable">
          <div class="loading"><div class="spinner"></div> è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- å¤–è³‡è³£è¶… Top 5 -->
      <div class="card">
        <div class="section-header">
          <div class="section-title" style="color:var(--red);">ğŸ”´ å¤–è³‡è³£è¶… Top 10</div>
          <span class="tag tag-red">æ·¨è³£å‡ºï¼ˆå¼µï¼‰</span>
        </div>
        <div id="instSellTable">
          <div class="loading"><div class="spinner"></div> è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>

    <div>
      <!-- ä¸‰å¤§æ³•äººåˆè¨ˆ Top 10 -->
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">ğŸ›ï¸ ä¸‰å¤§æ³•äººåˆè¨ˆè²·è¶…</div>
          <span class="tag">å¤–è³‡+æŠ•ä¿¡+è‡ªç‡Ÿ</span>
        </div>
        <div id="instTotalTable">
          <div class="loading"><div class="spinner"></div> è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- èªªæ˜ -->
      <div class="card">
        <div class="card-title" style="margin-bottom:12px;"><span class="icon">ğŸ“–</span> æ³•äººèªªæ˜</div>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.9;">
          <div><span style="color:var(--accent);">å¤–è³‡</span>ï¼šå¤–åœ‹æ©Ÿæ§‹æŠ•è³‡äººï¼ˆQFIIï¼‰ï¼Œæœ€å…·å¸‚å ´æŒ‡æ¨™æ€§</div>
          <div><span style="color:var(--green);">æŠ•ä¿¡</span>ï¼šåœ‹å…§å…±åŒåŸºé‡‘ï¼Œä»£è¡¨æœ¬åœŸæ³•äººå‹•å‘</div>
          <div><span style="color:var(--gold);">è‡ªç‡Ÿå•†</span>ï¼šè­‰åˆ¸å•†è‡ªæœ‰è³‡é‡‘æ“ä½œ</div>
          <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">
            å–®ä½ç‚ºã€Œå¼µã€ï¼ˆ1å¼µ=1000è‚¡ï¼‰ï¼Œæ­£æ•¸ç‚ºè²·è¶…ï¼Œè² æ•¸ç‚ºè³£è¶…ã€‚<br>
            è³‡æ–™ç‚ºç›¤å¾Œå…¬å‘Šï¼Œé€šå¸¸ä¸‹åˆ 4:00 å¾Œæ›´æ–°ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ===== PAGE: TREND ANALYSIS ===== -->
<div class="page fade-in" id="page-trend">

  <!-- å¸‚å ´æ•´é«”è¶¨å‹¢æ©«å¹… -->
  <div class="market-trend-banner" id="marketTrendBanner">
    <div class="mtrend-cell">
      <div class="mtrend-label">å¤§ç›¤è¶¨å‹¢</div>
      <div class="mtrend-value neutral" id="mtrend-twse">--</div>
      <div class="mtrend-sub" id="mtrend-twse-sub">ç­‰å¾…è³‡æ–™</div>
    </div>
    <div class="mtrend-cell">
      <div class="mtrend-label">ç¾è‚¡å½±éŸ¿</div>
      <div class="mtrend-value neutral" id="mtrend-us">--</div>
      <div class="mtrend-sub" id="mtrend-us-sub">ç­‰å¾…è³‡æ–™</div>
    </div>
    <div class="mtrend-cell">
      <div class="mtrend-label">å¸‚å ´æƒ…ç·’</div>
      <div class="mtrend-value neutral" id="mtrend-sentiment">--</div>
      <div class="mtrend-sub" id="mtrend-sentiment-sub">ç­‰å¾…åˆ†æ</div>
    </div>
  </div>

  <div class="grid-left-wide">
    <!-- å·¦å´ï¼šåˆ†æä¸»å€ -->
    <div>
      <!-- è‚¡ç¥¨é¸æ“‡ -->
      <div class="card mb-4">
        <div class="section-header">
          <div class="section-title">ğŸ”¬ å€‹è‚¡è¶¨å‹¢åˆ†æ</div>
          <div style="font-size:12px;color:var(--text-dim);">AI åƒ…åœ¨ä¿¡å¿ƒåº¦ â‰¥ 90% æ™‚æ¨™ç¤ºé«˜ä¿¡å¿ƒ</div>
        </div>

        <div class="trend-stock-picker" id="trendStockPicker">
          <!-- è‡ªé¸è‚¡è‡ªå‹•ç”Ÿæˆ -->
        </div>

        <div class="add-stock-bar">
          <input type="text" id="trendStockInput" placeholder="è¼¸å…¥å…¶ä»–è‚¡ç¥¨ä»£ç¢¼åˆ†æï¼Œå¦‚ï¼š2330">
<button class="btn" onclick="analyzeTrend(document.getElementById('trendStockInput').value)">åˆ†æ</button>
          <span class="api-cost-badge" data-tip="å€‹è‚¡è¶¨å‹¢åˆ†æç´„æ¶ˆè€— 1400 tokensï¼Œâ‰ˆ0.14 TWD">ğŸ¤– â‰ˆ0.14 TWD/æ¬¡</span>
        </div>
      </div>

      <!-- AIè¶¨å‹¢åˆ†æçµæœ -->
      <div id="trendResult">
        <div style="text-align:center;color:var(--text-dim);padding:60px 20px;">
          <div style="font-size:48px;margin-bottom:16px;">ğŸ”¬</div>
          <div style="font-size:15px;font-weight:500;margin-bottom:8px;">é¸æ“‡è‚¡ç¥¨é–‹å§‹åˆ†æ</div>
          <div style="font-size:13px;">AI æœƒæ ¹æ“šçœŸå¯¦å¸‚å ´è³‡æ–™åˆ¤æ–·è¶¨å‹¢æ–¹å‘<br>ä¸¦èªªæ˜æ”¯æŒè©²åˆ¤æ–·çš„å…·é«”åŸå› </div>
        </div>
      </div>


    </div>

    <!-- å³å´ï¼šè¨­å®šã€èªªæ˜ã€ç›¸é—œæ€§åˆ†æ -->
    <div>
      <!-- AI ç›¸é—œæ€§åˆ†æ -->
      <div class="card mb-4" style="border-color:var(--accent2);">
        <div class="section-header">
          <div class="card-title" style="margin:0;"><span class="icon">ğŸ”—</span> AI é—œè¯è‚¡ç¥¨åˆ†æ</div>
          <span class="api-cost-badge">ğŸ¤– â‰ˆ0.10â‚®</span>
        </div>
        <div style="font-size:12px;color:var(--text-dim);margin:8px 0;">æ‰¾å‡ºèˆ‡æ­¤è‚¡ç¥¨èµ°å‹¢æœ€ç›¸é—œçš„å°è‚¡å’Œç¾è‚¡</div>
        <button class="btn" style="width:100%;" onclick="runCorrelationAnalysis()">ğŸ”— åˆ†æé—œè¯æ€§</button>
        <div id="correlationResult" style="margin-top:12px;"></div>
      </div>

      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">âš™ï¸</span> åˆ†æåƒæ•¸</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">ç´å…¥åˆ†æçš„è³‡æ–™ä¾†æºï¼š</div>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-price" checked style="accent-color:var(--accent);">
            <span>ğŸ“ˆ å³æ™‚åƒ¹æ ¼ & æ¼²è·Œå¹…ï¼ˆTWSEï¼‰</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-volume" checked style="accent-color:var(--accent);">
            <span>ğŸ“Š æˆäº¤é‡ç•°å¸¸åµæ¸¬</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-us" checked style="accent-color:var(--accent);">
            <span>ğŸ‡ºğŸ‡¸ ç¾è‚¡ & è²»åŸåŠå°é«”æŒ‡æ•¸</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-fx" checked style="accent-color:var(--accent);">
            <span>ğŸ’± USD/TWD åŒ¯ç‡èµ°å‘</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-news" checked style="accent-color:var(--accent);">
            <span>ğŸ“° è¿‘æœŸç›¸é—œæ–°èæƒ…ç·’</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-sector" checked style="accent-color:var(--accent);">
            <span>ğŸ—‚ï¸ é¡è‚¡æ•´é«”èµ°å‘</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="ta-pe" style="accent-color:var(--accent);">
            <span>ğŸ’¹ æœ¬ç›Šæ¯” & æ®–åˆ©ç‡è©•ä¼°</span>
          </label>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-title" style="margin-bottom:14px;"><span class="icon">ğŸ“–</span> ä¿¡å¿ƒåº¦èªªæ˜</div>
        <div style="font-size:12px;line-height:1.8;color:var(--text-dim);">
          <div style="margin-bottom:8px;">
            <span class="confidence-badge high" style="margin-bottom:4px;">é«˜ä¿¡å¿ƒ â‰¥ 90%</span><br>
            å¤šå€‹ç¨ç«‹æŒ‡æ¨™æ–¹å‘ä¸€è‡´ï¼Œä¸”ç„¡æ˜é¡¯åå‘è¨Šè™Ÿã€‚AI æœ‰å……åˆ†ä¾æ“šæ”¯æŒåˆ¤æ–·ã€‚
          </div>
          <div style="margin-bottom:8px;">
            <span class="confidence-badge medium">ä¸­ä¿¡å¿ƒ 70â€“89%</span><br>
            ä¸»è¦æŒ‡æ¨™æ”¯æŒï¼Œä½†å­˜åœ¨éƒ¨åˆ†ä¸ç¢ºå®šå› ç´ æˆ–çŸ›ç›¾è¨Šè™Ÿã€‚
          </div>
          <div>
            <span class="confidence-badge low">ä½ä¿¡å¿ƒ &lt; 70%</span><br>
            æŒ‡æ¨™è¨Šè™Ÿæ··é›œæˆ–è³‡æ–™ä¸è¶³ï¼Œè¶¨å‹¢æ–¹å‘ä¸æ˜ç¢ºï¼Œä¸å®œæ“šæ­¤æ“ä½œã€‚
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title" style="margin-bottom:10px;"><span class="icon">âš ï¸</span> é‡è¦è²æ˜</div>
        <div style="font-size:11px;color:var(--text-dim);line-height:1.7;">
          æœ¬åˆ†æåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚å³ä½¿ä¿¡å¿ƒåº¦é«˜ï¼Œè‚¡å¸‚ä»å­˜åœ¨ç„¡æ³•é æ¸¬çš„é¢¨éšªã€‚æ‰€æœ‰æŠ•è³‡æ±ºç­–è«‹è‡ªè¡Œåˆ¤æ–·ä¸¦æ‰¿æ“”é¢¨éšªã€‚
        </div>
      </div>
    </div>
  </div>
</div>


</main>

<!-- API KEY MODAL -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <div class="modal-title">âš™ï¸ API è¨­å®š</div>
    <div class="modal-desc">æ‰€æœ‰é‡‘é‘°åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•ä¼ºæœå™¨ã€‚</div>
    
    <div style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:8px;padding:12px;margin-bottom:14px;">
      <div style="font-size:12px;color:var(--green);font-weight:700;margin-bottom:6px;">ğŸ”’ è³‡å®‰å‡ç´šï¼šAPI Key å·²ç§»è‡³ Worker Secret</div>
      <div style="font-size:11px;color:var(--text-dim);line-height:1.7;">
        Claude API Key ä¸å†å­˜åœ¨ç€è¦½å™¨ï¼Œæ”¹ç”± Cloudflare Worker ä¿ç®¡ã€‚<br>
        è¨­å®šæ–¹å¼ï¼šCloudflare Dashboard â†’ ä½ çš„ Worker â†’ Settings â†’ Variables â†’ Add Secret<br>
        <span style="color:var(--accent);">åç¨±ï¼šCLAUDE_API_KEYã€€å€¼ï¼šsk-ant-api03-...</span>
      </div>
    </div>
    
    <div style="font-size:12px;color:var(--accent);margin-bottom:6px;font-weight:500;">
      â˜ï¸ Cloudflare Worker ç¶²å€ï¼ˆæ‰€æœ‰åŠŸèƒ½çš„ä¸­ç¹¼ç«™ï¼‰
    </div>
    <div style="position:relative;">
      <input type="password" id="workerUrlInput" placeholder="https://twstock-proxy.yourname.workers.dev"
        style="font-family:'Space Mono',monospace;font-size:11px;padding-right:40px;">
      <button onclick="toggleWorkerVis()" id="workerVisBtn"
        style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;">ğŸ‘</button>
    </div>
    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">
      æœªè¨­å®šæ™‚ä»å¯ä½¿ç”¨å°è‚¡åŸºæœ¬åŠŸèƒ½ï¼ˆé€€å›å‚™æ´ proxyï¼‰
    </div>
    <div style="font-size:11px;margin-bottom:14px;">
      <a href="#" onclick="openWorkerGuide()" style="color:var(--accent);">ğŸ“– å¦‚ä½•éƒ¨ç½² Cloudflare Workerï¼Ÿ</a>
    </div>
    <div class="modal-actions">
      <button class="btn-outline" onclick="closeApiModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="saveApiKey()">å„²å­˜è¨­å®š</button>
    </div>
  </div>
</div>


<!-- DASHBOARD SETTINGS PANEL -->
<div class="modal-overlay" id="dashboardSettingsPanel" style="display:none;align-items:flex-end;">
  <div class="modal" style="max-width:600px;width:95%;max-height:85vh;overflow-y:auto;border-radius:16px 16px 0 0;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div class="modal-title" style="margin:0;">âš™ï¸ è‡ªè¨‚å„€è¡¨æ¿</div>
      <button onclick="closeDashboardSettings()" style="background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;">âœ•</button>
    </div>

    <div style="font-size:13px;font-weight:600;color:var(--accent);margin-bottom:10px;">ğŸ“¦ é¡¯ç¤ºå…ƒä»¶</div>
    <div id="dashWidgetToggles" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;"></div>

    <div style="font-size:13px;font-weight:600;color:var(--accent);margin-bottom:10px;">ğŸ—ºï¸ ç†±åŠ›åœ–é¡è‚¡ï¼ˆå‹¾é¸é¡¯ç¤ºï¼‰</div>
    <div id="heatmapSectorToggles" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;"></div>

    <div class="modal-actions">
      <button class="btn-outline" onclick="resetDashConfig()">æ¢å¾©é è¨­</button>
      <button class="btn" onclick="closeDashboardSettings()">å¥—ç”¨ä¸¦é—œé–‰</button>
    </div>
  </div>
</div>

<!-- ADD HOLDING MODAL -->
<div class="modal-overlay" id="holdingModal">
  <div class="modal" style="max-width:480px;width:95%;">
    <div class="modal-title">+ æ–°å¢æŒè‚¡</div>
    <div id="holdingModeSwitch" style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="filter-chip active" id="holdingSingle" onclick="switchHoldingMode('single')">å–®ç­†</button>
      <button class="filter-chip" id="holdingBulk" onclick="switchHoldingMode('bulk')">æ‰¹é‡è¼¸å…¥</button>
    </div>

    <!-- å–®ç­† -->
    <div id="holdingSingleForm">
      <input type="text" id="holdingCode" placeholder="è‚¡ç¥¨ä»£ç¢¼ï¼Œå¦‚ï¼š2330">
      <input type="number" id="holdingLots" placeholder="è‚¡æ•¸ï¼ˆä¾‹ï¼š1000ï¼‰">
      <input type="number" id="holdingCost" placeholder="å¹³å‡æˆæœ¬ (å…ƒ)">
    </div>

    <!-- æ‰¹é‡ -->
    <div id="holdingBulkForm" style="display:none;">
      <div style="font-size:12px;color:var(--text-dim);margin-bottom:6px;">æ¯è¡Œä¸€ç­†ï¼Œæ ¼å¼ï¼šä»£ç¢¼ è‚¡æ•¸ æˆæœ¬</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">ä¾‹ï¼š<br>2330 1000 950<br>2317 2000 145<br>2454 500 1200</div>
      <textarea id="holdingBulkInput" placeholder="2330 1000 950&#10;2317 2000 145&#10;2454 500 1200"
        style="width:100%;height:140px;background:var(--surface2);border:1px solid var(--border);color:var(--text);
        padding:10px;border-radius:8px;font-size:13px;font-family:'Space Mono',monospace;resize:vertical;outline:none;"></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn-outline" onclick="closeHoldingModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="addHolding()">æ–°å¢</button>
    </div>
  </div>
</div>

<!-- æ‰¹é‡è‡ªé¸è‚¡ Modal -->
<div class="modal-overlay" id="bulkWatchlistModal">
  <div class="modal" style="max-width:440px;width:95%;">
    <div class="modal-title">â­ æ‰¹é‡æ–°å¢è‡ªé¸è‚¡</div>
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:8px;">æ¯è¡Œä¸€å€‹è‚¡ç¥¨ä»£ç¢¼ï¼Œæˆ–ç”¨é€—è™Ÿåˆ†éš”</div>
    <textarea id="bulkWatchlistInput" placeholder="2330&#10;2317&#10;2454&#10;2382&#10;2412"
      style="width:100%;height:160px;background:var(--surface2);border:1px solid var(--border);color:var(--text);
      padding:10px;border-radius:8px;font-size:14px;font-family:'Space Mono',monospace;resize:vertical;outline:none;"></textarea>
    <div class="modal-actions">
      <button class="btn-outline" onclick="document.getElementById('bulkWatchlistModal').classList.remove('open')">å–æ¶ˆ</button>
      <button class="btn" onclick="addBulkWatchlist()">æ–°å¢å…¨éƒ¨</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const state = {
  // apiKey å·²ç§»è‡³ Worker Secretï¼Œä¸å†å­˜æ–¼ç€è¦½å™¨
  watchlist: JSON.parse(localStorage.getItem('watchlist') || '["2330","2317","2454","2382","2412"]'),
  portfolio: JSON.parse(localStorage.getItem('portfolio') || '[]'),
  stockCache: {},
  twseIndex: null,
  yahooData: {},
  rssNews: [],
  // API ä½¿ç”¨é‡è¿½è¹¤
  apiUsage: JSON.parse(localStorage.getItem('apiUsage') || '{"date":"","calls":0,"estTokens":0}'),
  lastFetch: 0,
  isMarketOpen: false,
};

// ============================================================
// è‚¡ç¥¨åç¨±å°ç…§è¡¨ï¼ˆTWSE API æœ‰æ™‚ä¸å›åç¨±ï¼Œé å…ˆå‚™ç”¨ï¼‰
// ============================================================
const STOCK_NAMES = {
  '2330':'å°ç©é›»','2317':'é´»æµ·','2454':'è¯ç™¼ç§‘','2382':'å»£é”','2412':'ä¸­è¯é›»',
  '2881':'å¯Œé‚¦é‡‘','2886':'å…†è±é‡‘','2308':'å°é”é›»','2303':'è¯é›»','3034':'è¯è© ',
  '2002':'ä¸­é‹¼','2891':'ä¸­ä¿¡é‡‘','2884':'ç‰å±±é‡‘','2885':'å…ƒå¤§é‡‘','2892':'ç¬¬ä¸€é‡‘',
  '2357':'è¯ç¢©','2356':'è‹±æ¥­é”','2379':'ç‘æ˜±','2327':'åœ‹å·¨','3008':'å¤§ç«‹å…‰',
  '2395':'ç ”è¯','6505':'å°å¡‘åŒ–','1301':'å°å¡‘','1303':'å—äº','2207':'å’Œæ³°è»Š',
  '2801':'å½°éŠ€','5880':'åˆåº«é‡‘','2912':'çµ±ä¸€è¶…','2823':'ä¸­å£½','2887':'å°æ–°é‡‘',
  '2409':'å‹é”','3481':'ç¾¤å‰µ','2474':'å¯æˆ','4938':'å’Œç¢©','6547':'è¯ç‰¹',
  '1789':'ç¥éš†','4726':'æ°¸æ—¥','2345':'æ™ºé‚¦','4977':'çœ¾é”','6239':'åŠ›æˆ',
  '2301':'å…‰å¯¶ç§‘','2353':'å®ç¢','1326':'å°åŒ–','3045':'å°ç£å¤§','4904':'é å‚³',
  '6781':'AES-KY','1537':'å»£éš†','3231':'ç·¯å‰µ','6509':'èšç´¡',
};

// é¡è‚¡å°ç…§ï¼ˆå„é¡ä»£è¡¨è‚¡ï¼‰
const SECTOR_STOCKS = {
  'åŠå°é«”'    :['2330','2303','2454','3034','2379'],
  'AIä¼ºæœå™¨'  :['2382','2356','3231','2353','3008'],
  'é›»å­é›¶çµ„ä»¶' :['2317','2308','2327','6239','2301'],
  'é‡‘èä¿éšª'  :['2881','2886','2891','2884','2892','2885','5880'],
  'é›»ä¿¡'      :['2412','3045','4904'],
  'å‚³ç”¢'      :['2002','1301','1303','1326','2207'],
  'é¢æ¿'      :['2409','3481','2474'],
  'ç”ŸæŠ€'      :['4938','6547','1789','4726'],
  'ç¶²é€š'      :['2345','3è€ƒ','6509','4977'],
  'é›»å‹•è»Š'    :['2207','1537','6781'],
};
// é¡è‚¡åœ–ç¤º
const SECTOR_ICONS = {
  'åŠå°é«”':'ğŸ”¬','AIä¼ºæœå™¨':'ğŸ¤–','é›»å­é›¶çµ„ä»¶':'ğŸ”§','é‡‘èä¿éšª':'ğŸ¦',
  'é›»ä¿¡':'ğŸ“¡','å‚³ç”¢':'ğŸ­','é¢æ¿':'ğŸ–¥ï¸','ç”ŸæŠ€':'ğŸ’Š','ç¶²é€š':'ğŸŒ','é›»å‹•è»Š':'âš¡',
};

// å›ºå®šçš„éœæ…‹è£œå……è³‡æ–™ï¼ˆTWSE ä¸æä¾› PE/æ®–åˆ©ç‡å³æ™‚å€¼ï¼‰
const STOCK_STATIC = {
  '2330':{ pe:24.5, yield:1.8, sector:'åŠå°é«”' },
  '2317':{ pe:11.2, yield:4.2, sector:'é›»å­é›¶çµ„ä»¶' },
  '2454':{ pe:18.7, yield:2.9, sector:'åŠå°é«”' },
  '2382':{ pe:14.3, yield:3.5, sector:'AIä¼ºæœå™¨' },
  '2412':{ pe:22.1, yield:4.8, sector:'é›»ä¿¡' },
  '2881':{ pe:9.8,  yield:5.2, sector:'é‡‘èä¿éšª' },
  '2886':{ pe:10.5, yield:5.6, sector:'é‡‘èä¿éšª' },
  '2308':{ pe:21.4, yield:2.3, sector:'é›»å­é›¶çµ„ä»¶' },
  '2303':{ pe:13.2, yield:5.3, sector:'åŠå°é«”' },
  '3034':{ pe:16.8, yield:3.8, sector:'åŠå°é«”' },
  '2002':{ pe:12.1, yield:5.1, sector:'å‚³ç”¢' },
  '1301':{ pe:14.5, yield:4.8, sector:'å‚³ç”¢' },
  '1303':{ pe:13.8, yield:5.0, sector:'å‚³ç”¢' },
  '1326':{ pe:15.2, yield:4.5, sector:'å‚³ç”¢' },
  '2409':{ pe:18.2, yield:1.2, sector:'é¢æ¿' },
  '3481':{ pe:22.4, yield:0.8, sector:'é¢æ¿' },
  '2474':{ pe:11.5, yield:3.2, sector:'é¢æ¿' },
  '4938':{ pe:16.3, yield:2.1, sector:'ç”ŸæŠ€' },
  '6547':{ pe:28.5, yield:0.5, sector:'ç”ŸæŠ€' },
  '1789':{ pe:32.1, yield:1.8, sector:'ç”ŸæŠ€' },
  '2891':{ pe:10.2, yield:5.5, sector:'é‡‘èä¿éšª' },
  '2884':{ pe:11.5, yield:5.8, sector:'é‡‘èä¿éšª' },
  '2892':{ pe:9.8,  yield:5.4, sector:'é‡‘èä¿éšª' },
  '2885':{ pe:12.1, yield:5.1, sector:'é‡‘èä¿éšª' },
  '5880':{ pe:10.8, yield:5.9, sector:'é‡‘èä¿éšª' },
  '2379':{ pe:19.2, yield:3.1, sector:'åŠå°é«”' },
  '2327':{ pe:14.5, yield:3.6, sector:'é›»å­é›¶çµ„ä»¶' },
  '3008':{ pe:35.2, yield:1.2, sector:'AIä¼ºæœå™¨' },
  '2356':{ pe:13.1, yield:3.8, sector:'AIä¼ºæœå™¨' },
  '2345':{ pe:16.8, yield:3.2, sector:'ç¶²é€š' },
  '3045':{ pe:21.5, yield:4.2, sector:'é›»ä¿¡' },
  '4904':{ pe:18.9, yield:4.5, sector:'é›»ä¿¡' },
  '2207':{ pe:15.2, yield:3.8, sector:'å‚³ç”¢' },
};

const NEWS_DATA = [
  { source:'å·¥å•†æ™‚å ±', time:'2å°æ™‚å‰', title:'å°ç©é›»3å¥ˆç±³è‰¯ç‡æŒçºŒæå‡ï¼Œå¤§å®¢æˆ¶è¨‚å–®æ»¿è¼‰', summary:'æ³•äººèªç‚ºå°ç©é›»å…ˆé€²è£½ç¨‹ç«¶çˆ­å„ªå‹¢æŒçºŒæ“´å¤§ï¼ŒCoWoSå°è£éœ€æ±‚å¼·å‹ã€‚', tags:['tw','tech'], stocks:['2330'], impact:'high', positive:true },
  { source:'Reuters', time:'3å°æ™‚å‰', title:'Fedå®˜å“¡æš—ç¤ºä»Šå¹´é™æ¯è·¯å¾‘æ˜æœ—ï¼Œé‚£æ–¯é”å…‹èµ°å¼·', summary:'è¯æº–æœƒå®˜å“¡ç™¼è¡¨é´¿æ´¾è¨€è«–ï¼Œç§‘æŠ€è‚¡å…¨é¢ä¸Šæ¼²ï¼Œå°è‚¡ADRæ™®æ¼²ã€‚', tags:['us','macro'], stocks:[], impact:'high', positive:true },
  { source:'å½­åš', time:'4å°æ™‚å‰', title:'ç¾åœ‹æ“¬å°ç‰¹å®šAIæ™¶ç‰‡å‡ºå£é€²ä¸€æ­¥ç®¡åˆ¶', summary:'ç¾å•†å‹™éƒ¨è€ƒæ…®æ“´å¤§æ™¶ç‰‡å‡ºå£ç®¡åˆ¶ï¼Œå¯èƒ½å½±éŸ¿è¼é”èˆ‡å°å» åˆä½œè¨‚å–®ã€‚éœ€å¯†åˆ‡è§€å¯Ÿæ”¿ç­–èµ°å‘ã€‚', tags:['us','tariff','tech'], stocks:['2330','2454'], impact:'medium', positive:false },
  { source:'ç¶“æ¿Ÿæ—¥å ±', time:'5å°æ™‚å‰', title:'å¤–è³‡é€£çºŒè²·è¶…å°è‚¡ï¼Œå–®æ—¥æ·¨è²·å…¥é€¾ç™¾å„„', summary:'å¤–è³‡çœ‹å¥½å°ç£ç§‘æŠ€è‚¡å¾Œå¸‚ï¼Œé›†ä¸­è²·é€²åŠå°é«”èˆ‡AIä¼ºæœå™¨æ¦‚å¿µè‚¡ã€‚', tags:['tw'], stocks:[], impact:'medium', positive:true },
  { source:'WSJ', time:'6å°æ™‚å‰', title:'ç¾ä¸­é—œç¨…è«‡åˆ¤å‚³å‡ºé€²å±•ï¼Œå°å» è½‰å–®æ•ˆæ‡‰æè¶¨ç·©', summary:'è‹¥è²¿æ˜“æ‘©æ“¦é™æº«ï¼Œéƒ¨åˆ†è½‰ç§»è‡³å°å» è¨‚å–®æˆ–èª¿æ•´ï¼Œä½†é•·æœŸä¾›æ‡‰éˆé‡çµ„è¶¨å‹¢ä¸è®Šã€‚', tags:['us','tariff'], stocks:[], impact:'medium', positive:false },
  { source:'MoneyDJ', time:'8å°æ™‚å‰', title:'å»£é”AIä¼ºæœå™¨å‡ºè²¨é‡å‰µé«˜ï¼ŒQ1å±•æœ›æ¨‚è§€', summary:'AIåŸºç¤å»ºè¨­éœ€æ±‚æŒçºŒå¼·å‹ï¼Œå°ç£ODMå» å•†å—æƒ ï¼Œé æœŸæœ¬å­£EPSå…©ä½æ•¸å¢é•·ã€‚', tags:['tw','tech'], stocks:['2382'], impact:'medium', positive:true },
];

// AI_RECS æ”¹ç‚ºå‹•æ…‹ï¼Œæ¯æ¬¡é»ã€Œé–‹å§‹åˆ†æã€æ‰ç”¢ç”Ÿ
let AI_RECS = [];
let aiRecFilter = '';

// ============================================================
// TWSE API â€” æ ¸å¿ƒè³‡æ–™æŠ“å–
// ============================================================

// ============================================================
// è¨­å®š â”€â”€ æŠŠä½ çš„ Cloudflare Worker ç¶²å€å¡«åœ¨é€™è£¡
// ============================================================
// éƒ¨ç½² worker.js åˆ° Cloudflare Workers å¾Œï¼Œå°‡ç¶²å€è²¼åˆ°ä¸‹æ–¹
// ç¯„ä¾‹: 'https://twstock-proxy.yourname.workers.dev'
// è‹¥å°šæœªéƒ¨ç½²ï¼Œç³»çµ±æœƒè‡ªå‹•é€€å› allorigins.win å‚™æ´
const WORKER_URL = localStorage.getItem('workerUrl') || '';
const FALLBACK   = 'https://api.allorigins.win/get?url=';

// â”€â”€ åº•å±¤ fetch å·¥å…·ï¼šå„ªå…ˆèµ° Workerï¼Œå¦å‰‡èµ° allorigins â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function proxyFetch(workerPath, fallbackUrl) {
  // å…ˆè©¦ Workerï¼ˆè‹¥å·²è¨­å®šï¼‰
  if (WORKER_URL) {
    try {
      const r = await fetch(WORKER_URL + workerPath, { signal: AbortSignal.timeout(6000) });
      if (r.ok) return r.json();
    } catch(e) { console.warn('Worker failed, falling back:', e.message); }
  }
  // é€€å› allorigins proxy
  const r = await fetch(FALLBACK + encodeURIComponent(fallbackUrl), { signal: AbortSignal.timeout(8000) });
  const w = await r.json();
  return JSON.parse(w.contents);
}

// â”€â”€ TWSE å€‹è‚¡å³æ™‚è¡Œæƒ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchStockPrices(codes) {
  const codesStr = codes.join(',');
  const exCh     = codes.map(c => `tse_${c}.tw`).join('|');

  let rawStocks = null;
  try {
    // Worker è·¯å¾‘
    const workerPath = `?type=twse_stock&codes=${codesStr}`;
    // Fallback ç›´æ¥æ‰“ TWSE MIS
    const fallbackUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${encodeURIComponent(exCh)}&json=1&delay=0`;

    if (WORKER_URL) {
      const data = await proxyFetch(workerPath, fallbackUrl);
      rawStocks = data.stocks;   // Worker å·²æ•´ç†å¥½æ ¼å¼
    } else {
      // allorigins fallback â†’ éœ€è‡ªå·±è§£æ TWSE åŸå§‹æ ¼å¼
      const data = await proxyFetch(null, fallbackUrl);
      rawStocks = {};
      (data.msgArray || []).forEach(item => {
        const code     = item.c;
        const price    = parseFloat(item.z) || parseFloat(item.y) || 0;
        const prev     = parseFloat(item.y) || 0;
        const change   = +(price - prev).toFixed(2);
        const changePct= prev > 0 ? +((change / prev) * 100).toFixed(2) : 0;
        rawStocks[code] = {
          name: item.n || code, price, change, changePct,
          open: parseFloat(item.o)||0, high: parseFloat(item.h)||0,
          low: parseFloat(item.l)||0, prev, volume: parseInt(item.v)||0, time: item.t||''
        };
      });
    }
  } catch(e) {
    console.warn('fetchStockPrices failed:', e.message);
    return;
  }

  // åˆä½µé€² cacheï¼Œè£œéœæ…‹è³‡æ–™
  Object.entries(rawStocks || {}).forEach(([code, s]) => {
    state.stockCache[code] = {
      ...s,
      ...(STOCK_STATIC[code] || { pe:'-', yield:'-', sector:'å…¶ä»–' }),
      name: s.name || STOCK_NAMES[code] || code,
      updatedAt: new Date(),
    };
  });
}

// â”€â”€ TWSE å¤§ç›¤åŠ æ¬ŠæŒ‡æ•¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTWSEIndex() {
  try {
    const workerPath = '?type=twse_index';
    const fallbackUrl = 'https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=tse_t00.tw&json=1&delay=0';

    let idx;
    if (WORKER_URL) {
      idx = await proxyFetch(workerPath, fallbackUrl);
    } else {
      const raw  = await proxyFetch(null, fallbackUrl);
      const item = raw.msgArray?.[0];
      if (!item) return;
      const price = parseFloat(item.z) || parseFloat(item.y) || 0;
      const prev  = parseFloat(item.y) || 0;
      idx = { price, prev, change: +(price-prev).toFixed(2),
              changePct: prev>0 ? +((price-prev)/prev*100).toFixed(2) : 0 };
    }
    state.twseIndex = idx;
    updateIndexCard();
  } catch(e) { console.warn('fetchTWSEIndex failed:', e.message); }
}

// â”€â”€ Yahoo Financeï¼ˆç¾è‚¡ + åŒ¯ç‡ + å•†å“ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// åªæœ‰ Worker æ¨¡å¼æ‰èƒ½ç©©å®šæŠ“ï¼Œallorigins æ‰“ Yahoo é€šå¸¸è¢«æ“‹
const YAHOO_SYMBOLS = '^GSPC,^IXIC,^DJI,^SOX,USDTWD=X,USDJPY=X,CL=F,GC=F,^VIX,^TNX,^TYX,DX-Y.NYB';

async function fetchYahooData() {
  if (!WORKER_URL) {
    showMacroNote('ğŸ’¡ è¨­å®š Cloudflare Worker å¾Œå¯è‡ªå‹•è¼‰å…¥ç¾è‚¡ã€åŒ¯ç‡ã€å•†å“å³æ™‚è³‡æ–™');
    return;
  }
  // å…ˆè©¦ Workerï¼ˆå¸¶å¤šé‡å‚™æ´ï¼‰ï¼Œå¤±æ•—å‰‡é™ç´šåˆ° allorigins proxy
  const tryWorker = async () => {
    const res = await fetch(`${WORKER_URL}?type=yahoo&symbols=${encodeURIComponent(YAHOO_SYMBOLS)}`,
      { signal: AbortSignal.timeout(15000) });
    if (!res.ok) throw new Error(`Worker å›æ‡‰ ${res.status}`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    if (!data.result || Object.keys(data.result).length === 0) throw new Error('empty result');
    return data.result;
  };

  // å‚™æ´ï¼šç›´æ¥å¾ allorigins å– Yahoo v7ï¼ˆç„¡ Workerï¼‰
  const tryFallback = async () => {
    const sym = encodeURIComponent('^IXIC,USDTWD=X,^SOX,^VIX,^TNX,GC=F,CL=F,DX-Y.NYB');
    const url  = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${sym}`;
    const res  = await fetch(
      `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
      { signal: AbortSignal.timeout(12000) }
    );
    const outer = await res.json();
    const data  = JSON.parse(outer.contents || '{}');
    const result = {};
    (data.quoteResponse?.result || []).forEach(q => {
      result[q.symbol] = {
        name: q.shortName || q.symbol,
        price: +(q.regularMarketPrice||0).toFixed(2),
        change: +(q.regularMarketChange||0).toFixed(2),
        changePct: +(q.regularMarketChangePercent||0).toFixed(2),
        prev: +(q.regularMarketPreviousClose||0).toFixed(2),
      };
    });
    if (Object.keys(result).length === 0) throw new Error('fallback empty');
    return result;
  };

  try {
    let result;
    try { result = await tryWorker(); }
    catch(e1) {
      console.warn('Worker Yahoo failed, trying fallback:', e1.message);
      try { result = await tryFallback(); }
      catch(e2) { result = {}; }
    }
    // SP500 å·²ç§»è‡³åœ‹éš›è‚¡å¸‚é ï¼Œæ­¤è™•ä¸éœ€å‚™æ´
    state.yahooData = result;
    updateMacroCards();
    updateOverviewCards();
  } catch(e) {
    console.warn('All Yahoo sources failed:', e.message);
    const uEl = document.getElementById('usdtwd-price');
    const ucEl = document.getElementById('usdtwd-change');
    if (uEl) uEl.textContent = '--.-';
    if (ucEl) ucEl.innerHTML = `<span style="font-size:10px;color:var(--gold);">è«‹ç¢ºèª Worker è¨­å®š</span>`;
    console.warn('Yahoo data failed:', e.message);
  }
}

// â”€â”€ RSS æ–°è â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchRSSNews() {
  if (!WORKER_URL) return; // éœ€è¦ Worker æ‰èƒ½æŠ“ RSS
  try {
    // åŒæ™‚æŠ“å¤šå€‹ä¾†æº
    const [cnyes, udn] = await Promise.allSettled([
      fetch(`${WORKER_URL}?type=rss&feed=cnyes`).then(r=>r.json()),
      fetch(`${WORKER_URL}?type=rss&feed=udn`).then(r=>r.json()),
    ]);
    const items = [
      ...(cnyes.value?.items || []),
      ...(udn.value?.items   || []),
    ].slice(0, 12);
    if (items.length) renderRealNews(items);
  } catch(e) { console.warn('RSS fetch failed:', e.message); }
}

// â”€â”€ TWSE ç›¤å¾Œæ¼²è·Œå¹…æ’è¡Œï¼ˆè£œå……ç”¨ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTWSEMovers() {
  try {
    const today = getTWSEDateStr();
    const workerPath = `?type=twse_movers&date=${today}`;
    const fallbackUrl = `https://www.twse.com.tw/rwd/zh/afterTrading/STOCK_DAY_ALL?date=${today}&response=json`;

    let stocks;
    if (WORKER_URL) {
      const data = await proxyFetch(workerPath, fallbackUrl);
      stocks = data.stocks;
    } else {
      const raw = await proxyFetch(null, fallbackUrl);
      if (!raw.data) return;
      stocks = raw.data.map(row => {
        const code = row[0]?.trim();
        const close = parseFloat(row[7]?.replace(/,/g,''))||0;
        const sign  = row[8]?.trim();
        const pts   = parseFloat(row[9]?.replace(/,/g,''))||0;
        const change = sign==='-' ? -pts : pts;
        const prev  = close - change;
        return {
          code, name: row[1]?.trim(),
          volume: parseInt(row[2]?.replace(/,/g,''))||0,
          close, change: +change.toFixed(2),
          changePct: prev>0 ? +((change/prev)*100).toFixed(2) : 0
        };
      }).filter(s => s.code && s.close > 0);
    }

    // åˆä½µé€² cacheï¼ˆä¸è¦†è“‹ç›¤ä¸­å³æ™‚è³‡æ–™ï¼‰
    (stocks||[]).forEach(s => {
      if (!state.stockCache[s.code]) {
        state.stockCache[s.code] = {
          name: s.name || STOCK_NAMES[s.code] || s.code,
          price: s.close, change: s.change, changePct: s.changePct,
          volume: s.volume,
          ...(STOCK_STATIC[s.code] || { pe:'-', yield:'-', sector:'å…¶ä»–' }),
          updatedAt: new Date(),
        };
      }
    });
  } catch(e) { console.warn('fetchTWSEMovers failed:', e.message); }
}

function getTWSEDateStr() {
  const d = new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
}

// â”€â”€ ä¸»è¦è³‡æ–™è¼‰å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAllData() {
  // æ”¶é›†æ‰€æœ‰é¡è‚¡ä»£ç¢¼ï¼Œç¢ºä¿ç†±åŠ›åœ–æœ‰å®Œæ•´è³‡æ–™
  const sectorCodes = Object.values(SECTOR_STOCKS).flat();
  const allCodes = [...new Set([...state.watchlist, ...sectorCodes,
    '2330','2317','2454','2382','2412','2881','2886','2308','2303','3034'])];

  // åŒæ™‚ç™¼èµ·æ‰€æœ‰è«‹æ±‚
  await Promise.allSettled([
    fetchStockPrices(allCodes),
    fetchTWSEIndex(),
    fetchYahooData(),
  ]);

  // ç›¤å¾Œè£œå……æˆäº¤æ’è¡Œ
  if (!state.isMarketOpen) {
    await fetchTWSEMovers();
  }

  // RSS æ–°èï¼ˆéé˜»å¡ï¼‰
  fetchRSSNews();
  // è¶¨å‹¢åˆ†æé åˆå§‹åŒ–
  setTimeout(initTrendPage, 500);
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
  updateClock();
  setInterval(updateClock, 1000);
  checkMarketStatus();

  // å…ˆé¡¯ç¤ºéª¨æ¶ï¼Œè®“ UI ç«‹åˆ»å‡ºç¾
  renderWatchlistSkeleton();
  renderNews();
  renderAiRecs();
  renderMacro();
  renderCalendar();
  animateSentiment(62);

  // æŠ“ TWSE çœŸå¯¦è³‡æ–™
  await loadAllData();

  // ç”¨çœŸå¯¦è³‡æ–™æ›´æ–°ç•«é¢
  const cacheSize = Object.keys(state.stockCache).length;
  if (cacheSize === 0) {
    // CORS proxy å¯èƒ½æš«æ™‚ä¸å¯ç”¨ï¼Œé¡¯ç¤ºæç¤º
    document.getElementById('quickAlerts').innerHTML = `
      <div class="alert-item">
        <div class="alert-icon">âš ï¸</div>
        <div class="alert-text" style="color:var(--gold);">
          <strong>è³‡æ–™è¼‰å…¥ä¸­...</strong><br>
          <span class="text-xs">è‹¥æŒçºŒç„¡æ³•è¼‰å…¥ï¼Œå¯èƒ½æ˜¯ CORS proxy æš«æ™‚é™æµã€‚<br>è«‹ç¨å¾Œé‡æ–°æ•´ç†ï¼Œæˆ–æ”¹ç”¨æœ¬æ©Ÿé–‹ç™¼ä¼ºæœå™¨ã€‚</span>
        </div>
      </div>`;
  }
  renderTicker();
  renderOverview();
  renderWatchlist();
  renderPortfolio();

  // ç›¤ä¸­æ¯60ç§’è‡ªå‹•æ›´æ–°
  if (state.isMarketOpen) {
    setInterval(async () => {
      const allCodes = [...new Set([...state.watchlist,'2330','2317','2454','2382','2412'])];
      await Promise.all([fetchStockPrices(allCodes), fetchTWSEIndex()]);
      renderTicker();
      renderWatchlist();
      updateIndexCard();
      renderMovers(moverFilter);
    }, 60000);
  }
});

function updateClock() {
  const now = new Date();
  const tw = new Intl.DateTimeFormat('zh-TW', {
    timeZone:'Asia/Taipei', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
  }).format(now);
  document.getElementById('currentTime').textContent = tw + ' (å°åŒ—)';
}

function checkMarketStatus() {
  const now = new Date();
  const twnow = new Date(now.toLocaleString('en-US', { timeZone:'Asia/Taipei' }));
  const hour = twnow.getHours();
  const min  = twnow.getMinutes();
  const day  = twnow.getDay();
  const open = day >= 1 && day <= 5
    && ((hour === 9 && min >= 0) || hour === 10 || hour === 11 || hour === 12)
    && !(hour === 13 && min >= 31);
  state.isMarketOpen = open;
  const dot = document.getElementById('marketStatusDot');
  const txt = document.getElementById('marketStatusText');
  if (open) { dot.className = 'status-dot'; txt.textContent = 'å°è‚¡äº¤æ˜“ä¸­'; }
  else       { dot.className = 'status-dot closed'; txt.textContent = 'ç›¤å¾Œ'; }
}


// ============================================================
// æ—¥/å¤œé–“æ¨¡å¼
// ============================================================
function toggleTheme() {
  const html = document.documentElement;
  const isLight = html.getAttribute('data-theme') === 'light';
  const next = isLight ? 'dark' : 'light';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  // header èƒŒæ™¯åŒæ­¥
  const header = document.querySelector('header');
  if (header) header.style.background = next === 'light'
    ? 'rgba(240,244,248,0.95)' : 'rgba(10,14,26,0.92)';
}

function initTheme() {
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  const header = document.querySelector('header');
  if (header && saved === 'light') header.style.background = 'rgba(240,244,248,0.95)';
}


// ============================================================
// åœ‹éš›è‚¡å¸‚é é¢
// ============================================================
const GLOBAL_SYMBOLS = [
  '^GSPC','^IXIC','^DJI','^SOX','^N225','^HSI','000001.SS','^KS11',
  '^GDAXI','^FTSE','GC=F','CL=F','^VIX','^TNX','DX-Y.NYB','USDJPY=X',
  'USDTWD=X',
];

const GLOBAL_SYM_EXTRA = '^N225,^HSI,000001.SS,^KS11,^GDAXI,^FTSE';

let _globalLoaded = false;
async function ensureGlobalData() {
  if (_globalLoaded) return;
  // é¡å¤–æŠ“äºå¤ª+æ­æ´² (ä¸åœ¨é è¨­ YAHOO_SYMBOLS è£¡)
  if (!WORKER_URL) return;
  try {
    const all = GLOBAL_SYMBOLS.join(',');
    const res = await fetch(`${WORKER_URL}?type=yahoo&symbols=${encodeURIComponent(all)}`,
      { signal: AbortSignal.timeout(15000) });
    if (!res.ok) return;
    const data = await res.json();
    if (data.result) {
      Object.assign(state.yahooData, data.result);
      _globalLoaded = true;
    }
  } catch(e) { console.warn('Global data fetch failed:', e.message); }
}

function renderGlobalPage() {
  GLOBAL_SYMBOLS.forEach(sym => {
    const d  = state.yahooData[sym];
    const pfx = 'g-' + sym + '-';
    const pEl = document.getElementById(pfx + 'price');
    const cEl = document.getElementById(pfx + 'change');
    const sEl = document.getElementById(pfx + 'spark');
    if (!pEl || !d || !d.price) return;
    const up   = d.changePct >= 0;
    const sign = up ? '+' : '';
    const col  = up ? 'var(--green)' : 'var(--red)';

    // è‡ªå‹•æ ¼å¼ï¼šå¤§æ•¸å­—åŠ é€—è™Ÿï¼Œå°æ•¸å­—ä¿ç•™å°æ•¸é»
    let priceStr;
    if (d.price >= 1000) priceStr = d.price.toLocaleString('zh-TW', {maximumFractionDigits:2});
    else if (d.price >= 100) priceStr = d.price.toFixed(2);
    else priceStr = d.price.toFixed(3);

    pEl.textContent  = priceStr;
    pEl.style.color  = col;
    cEl.innerHTML    = `<span style="color:${col};">${sign}${d.changePct.toFixed(2)}% <span style="color:var(--text-dim);font-size:10px;">(${sign}${d.change?.toFixed(2)||'--'})</span></span>`;
    if (sEl) {
      const lo = d.price * (1 - Math.abs(d.changePct)/100 * 3);
      const hi = d.price * (1 + Math.abs(d.changePct)/100 * 3);
      renderSparkline(pfx + 'spark', randomWalkData(20, lo, hi), up);
    }
  });
  // æ›´æ–° miniGlobal
  updateMiniGlobal();
}

function showGlobalDetail(sym) {
  const d = state.yahooData[sym];
  const names = {
    '^GSPC':'S&P 500','^IXIC':'NASDAQ','^DJI':'é“ç“Šå·¥æ¥­','^SOX':'è²»åŸåŠå°é«”',
    '^N225':'æ—¥ç¶“225','^HSI':'æ†ç”ŸæŒ‡æ•¸','000001.SS':'ä¸Šè¨¼æŒ‡æ•¸','^KS11':'éŸ“åœ‹KOSPI',
    '^GDAXI':'å¾·åœ‹DAX','^FTSE':'è‹±FTSE 100','GC=F':'é»ƒé‡‘æœŸè²¨','CL=F':'åŸæ²¹WTI',
    '^VIX':'VIXææ…ŒæŒ‡æ•¸','^TNX':'ç¾10å¹´å‚µæ®–åˆ©ç‡','DX-Y.NYB':'ç¾å…ƒæŒ‡æ•¸DXY',
    'USDJPY=X':'ç¾å…ƒ/æ—¥åœ“','USDTWD=X':'ç¾å…ƒ/å°å¹£',
  };
  if (!d) { showToast('è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œ'); return; }
  quickChat(`åˆ†æ ${names[sym]||sym} ç›®å‰èµ°å‹¢ï¼Œç¾åƒ¹ ${d.price?.toFixed(2)} æ¼²è·Œ ${d.changePct?.toFixed(2)}%ï¼Œå°å°è‚¡æœ‰ä½•å½±éŸ¿ï¼Ÿ`);
}

async function runGlobalAI() {
  const result = document.getElementById('globalAIResult');
  result.innerHTML = '<div class="loading"><div class="spinner"></div> AI åˆ†æä¸­...</div>';
  trackApiUsage('global', 800);
  trackAiUsage('global');

  const indices = [
    ['^GSPC','S&P500'],['^IXIC','NASDAQ'],['^DJI','é“ç“Š'],['^SOX','è²»åŠ'],
    ['^N225','æ—¥ç¶“'],['^HSI','æ†ç”Ÿ'],['^VIX','VIX'],['^TNX','ç¾å‚µåˆ©ç‡'],
    ['GC=F','é»ƒé‡‘'],['CL=F','åŸæ²¹'],['USDTWD=X','ç¾å…ƒå°å¹£'],
  ].map(([sym,label])=>{
    const d = state.yahooData[sym];
    if (!d || !d.price) return null;
    const sign = d.changePct>=0?'+':'';
    return `${label}:${d.price.toFixed(1)}(${sign}${d.changePct.toFixed(2)}%)`;
  }).filter(Boolean).join(' | ');

  const prompt = `ä½ æ˜¯å°ç£è‚¡å¸‚AIåˆ†æå¸«ï¼Œæ ¹æ“šä»¥ä¸‹åœ‹éš›å¸‚å ´æ•¸æ“šï¼Œç”¨ç¹é«”ä¸­æ–‡æ’°å¯«300å­—ä»¥å…§çš„åˆ†æï¼š
å¸‚å ´æ•¸æ“šï¼š${indices}
è«‹åŒ…å«ï¼š1)ç¾è‚¡èµ°å‹¢ 2)äºå¤ªå¸‚å ´ 3)å•†å“/åŒ¯ç‡ä¿¡è™Ÿ 4)å°å°è‚¡æ˜æ—¥èµ°å‹¢çš„é æ¸¬èˆ‡å»ºè­°`;

  try {
    const reply = await callClaude([{ role:'user', content:prompt }], 800);
    result.innerHTML = `<div style="line-height:1.8;font-size:13px;">${reply.replace(/\n/g,'<br>')}</div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:8px;text-align:right;">
        åˆ†ææ™‚é–“ï¼š${new Date().toLocaleString('zh-TW',{timeZone:'Asia/Taipei'})}
      </div>`;
  } catch(e) {
    result.innerHTML = `<div style="color:var(--red);">âŒ åˆ†æå¤±æ•—ï¼š${e.message}</div>`;
  }
}


// ============================================================
// TAB åˆ‡æ›
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const tabEl = document.querySelector(`.tab[onclick*="${tab}"]`);
  if (tabEl) tabEl.classList.add('active');
  const pageEl = document.getElementById('page-' + tab);
  if (pageEl) pageEl.classList.add('active');
  // å„é é¢åˆå§‹åŒ–
  if (tab === 'institutional') loadInstitutional();
  if (tab === 'trend') initTrendPage();
  if (tab === 'global') ensureGlobalData().then(() => setTimeout(renderGlobalPage, 200));
}

// ============================================================
// INDEX CARD æ›´æ–°ï¼ˆå¤§ç›¤ï¼‰
// ============================================================
function updateIndexCard() {
  const idx = state.twseIndex;
  if (!idx || !idx.price) return;
  const isUp = idx.change >= 0;
  const cls  = isUp ? 'up' : 'down';
  const sign = isUp ? '+' : '';
  const priceStr = idx.price.toLocaleString('zh-TW', { minimumFractionDigits:2, maximumFractionDigits:2 });
  document.getElementById('twse-price').textContent = priceStr;
  document.getElementById('twse-change').innerHTML =
    `<span class="${cls}">${sign}${idx.change.toFixed(2)} (${sign}${idx.changePct.toFixed(2)}%)</span>`;
  // sparkline ç”¨éš¨æ©Ÿæ¨¡æ“¬èµ°å‹¢ï¼ˆTWSE å…è²»ç«¯é»ç„¡åˆ†æ™‚è³‡æ–™ï¼‰
  renderSparkline('twse-spark', randomWalkData(20, idx.price * 0.985, idx.price * 1.015), isUp);
}

// ============================================================
// TICKERï¼ˆç”¨çœŸå¯¦å¿«å–è³‡æ–™ï¼‰
// ============================================================
function renderTicker() {
  // è·‘é¦¬ç‡ˆ = è‡ªé¸è‚¡ï¼ˆå„ªå…ˆï¼‰+ ä»Šæ—¥æ¼²è·Œæœ€å¤§çš„è£œåˆ°12æ”¯
  const watchCodes = state.watchlist.filter(c => state.stockCache[c]);
  const topMovers  = Object.entries(state.stockCache)
    .filter(([c]) => !state.watchlist.includes(c) && state.stockCache[c]?.price > 0)
    .sort((a,b) => Math.abs(b[1].changePct) - Math.abs(a[1].changePct))
    .slice(0, 12 - watchCodes.length)
    .map(([c]) => c);
  const codes = [...watchCodes, ...topMovers].slice(0, 16);
  if (!codes.length) return;
  const items = codes.map(code => {
    const s    = state.stockCache[code];
    const cls  = s.changePct >= 0 ? 'up' : 'down';
    const sign = s.changePct >= 0 ? '+' : '';
    const star = state.watchlist.includes(code) ? 'â­ ' : '';
    return `<div class="ticker-item">
      <span class="name">${star}${s.name}(${code})</span>
      <span class="${cls}">${s.price.toFixed(1)}</span>
      <span class="${cls}">${sign}${s.changePct.toFixed(2)}%</span>
    </div>`;
  });
  const doubled = [...items, ...items];
  document.getElementById('tickerInner').innerHTML = doubled.join('');
}

// ============================================================
// OVERVIEW
// ============================================================
function renderOverview() {
  updateIndexCard();
  // è‹¥ Yahoo è³‡æ–™å·²è¼‰å…¥å°±ç›´æ¥é¡¯ç¤ºï¼Œå¦å‰‡æ‰é¡¯ç¤ºä½”ä½ç¬¦
  if (Object.keys(state.yahooData).length > 0) {
    updateOverviewCards();
  } else {
    document.getElementById('usdtwd-price').textContent = '--';
    document.getElementById('usdtwd-change').innerHTML  = '<span class="text-dim" style="font-size:12px;">è¼‰å…¥ä¸­â€¦</span>';
    renderSparkline('usdtwd-spark', randomWalkData(20, 31.8, 32.4), false);
  }
  renderHeatmap();
  animateSentiment(62);
  renderMovers('gain');
  renderSectors();
  renderQuickAlerts();
}

function randomWalkData(n, min, max) {
  const data = [];
  let v = (min + max) / 2;
  for (let i = 0; i < n; i++) {
    v += (Math.random() - 0.48) * (max - min) / 8;
    v = Math.min(max, Math.max(min, v));
    data.push(v);
  }
  return data;
}

function renderSparkline(id, data, up) {
  const svg = document.getElementById(id);
  if (!svg) return;
  const w = 200, h = 50;
  const minV = Math.min(...data), maxV = Math.max(...data);
  const range = maxV - minV || 1;
  const pts = data.map((v, i) => {
    const x = (i / (data.length - 1)) * w;
    const y = h - ((v - minV) / range) * (h - 8) - 4;
    return `${x},${y}`;
  });
  const color = up ? 'var(--green)' : 'var(--red)';
  svg.innerHTML = `<polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="2" stroke-linejoin="round"/>`;
}

function animateSentiment(score) {
  const circumference = 251.2;
  const offset = circumference - (score / 100) * circumference;
  const ring  = document.getElementById('sentimentRing');
  const color = score > 60 ? 'var(--green)' : score > 40 ? 'var(--gold)' : 'var(--red)';
  ring.style.strokeDashoffset = offset;
  ring.style.stroke = color;
}

function renderQuickAlerts() {
  // å¾çœŸå¯¦å¿«å–æŠ“å‡ºä»Šæ—¥æœ€å¤§æ¼²å¹…è‚¡
  const sorted = Object.entries(state.stockCache).sort((a,b) => b[1].changePct - a[1].changePct);
  const top    = sorted[0]?.[1];
  const bottom = sorted[sorted.length-1]?.[1];
  document.getElementById('quickAlerts').innerHTML = `
    ${top ? `<div class="alert-item"><div class="alert-icon">ğŸ”¥</div>
      <div class="alert-text">ä»Šæ—¥å¼·å‹¢è‚¡ï¼š<strong>${top.name}</strong> ${top.changePct >= 0 ? '+' : ''}${top.changePct.toFixed(2)}%</div></div>` : ''}
    ${bottom ? `<div class="alert-item"><div class="alert-icon">ğŸ“‰</div>
      <div class="alert-text">ä»Šæ—¥å¼±å‹¢è‚¡ï¼š<strong>${bottom.name}</strong> ${bottom.changePct.toFixed(2)}%</div></div>` : ''}
    <div class="alert-item"><div class="alert-icon">ğŸ”„</div>
      <div class="alert-text">è³‡æ–™ä¾†æºï¼šTWSE å®˜æ–¹ APIãƒ»${state.isMarketOpen ? 'ç›¤ä¸­æ¯60ç§’è‡ªå‹•æ›´æ–°' : 'ç›¤å¾Œæ”¶ç›¤è³‡æ–™'}</div>
    </div>`;
}

let moverFilter = 'gain';
function setMoverType(type, el) {
  document.querySelectorAll('#page-overview .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  moverFilter = type;
  renderMovers(type);
}

function renderMovers(type) {
  const stocks = Object.entries(state.stockCache);
  if (!stocks.length) {
    document.getElementById('moverTableBody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-dim);padding:20px;">è¼‰å…¥ä¸­...</td></tr>';
    return;
  }
  let sorted;
  if (type === 'gain')   sorted = [...stocks].sort((a,b) => b[1].changePct - a[1].changePct);
  else if (type === 'loss') sorted = [...stocks].sort((a,b) => a[1].changePct - b[1].changePct);
  else sorted = [...stocks].sort((a,b) => b[1].volume - a[1].volume);

  document.getElementById('moverTableBody').innerHTML = sorted.slice(0,8).map(([code, s]) => {
    const cls  = s.changePct >= 0 ? 'up' : 'down';
    const sign = s.changePct >= 0 ? '+' : '';
    const vol  = s.volume >= 1000 ? (s.volume/1000).toFixed(0)+'K' : s.volume;
    return `<tr onclick="showStockDetail('${code}')">
      <td><div class="stock-name">${s.name}</div><div class="stock-code">${code}</div></td>
      <td class="price">${s.price.toFixed(1)}</td>
      <td class="change ${cls}">${sign}${s.changePct.toFixed(2)}%</td>
      <td class="text-dim text-xs">${vol}</td>
    </tr>`;
  }).join('');
}

function renderSectors() {
  const sectorPcts = Object.entries(SECTOR_STOCKS).map(([name, stocks]) => {
    const cached = stocks.map(c => state.stockCache[c]).filter(Boolean);
    const avg = cached.length
      ? cached.reduce((a,b) => a + b.changePct, 0) / cached.length : 0;
    return { name, pct: parseFloat(avg.toFixed(2)), dataCount: cached.length };
  }).filter(s => s.dataCount > 0).sort((a,b) => b.pct - a.pct);

  document.getElementById('sectorPerf').innerHTML = sectorPcts.map(s => {
    const cls  = s.pct >= 0 ? 'up' : 'down';
    const sign = s.pct >= 0 ? '+' : '';
    const width = Math.min(Math.abs(s.pct) / 4 * 100, 100);
    return `<div class="sector-bar">
      <div class="sector-name text-sm">${s.name}</div>
      <div class="bar-track"><div class="bar-fill ${cls}" style="width:${width}%"></div></div>
      <div class="sector-pct ${cls}">${sign}${s.pct}%</div>
    </div>`;
  }).join('');
}

// ============================================================
// WATCHLISTï¼ˆç”¨çœŸå¯¦ TWSE è³‡æ–™ï¼‰
// ============================================================
function renderWatchlistSkeleton() {
  document.getElementById('watchlistBody').innerHTML =
    Array(5).fill('<tr>' + Array(7).fill('<td><div style="background:var(--surface2);border-radius:4px;height:16px;width:80%;"></div></td>').join('') + '</tr>').join('');
}

async function renderWatchlist() {
  // ç¢ºä¿è‡ªé¸è‚¡éƒ½æœ‰è³‡æ–™
  const missing = state.watchlist.filter(c => !state.stockCache[c]);
  if (missing.length) await fetchStockPrices(missing);

  const body = document.getElementById('watchlistBody');
  if (!state.watchlist.length) {
    body.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);padding:30px;">å°šç„¡è‡ªé¸è‚¡ï¼Œè«‹æ–°å¢</td></tr>';
    return;
  }
  body.innerHTML = state.watchlist.map(code => {
    const s    = state.stockCache[code];
    if (!s) return `<tr><td colspan="7" class="text-dim text-xs" style="padding:12px;">${code} è³‡æ–™è¼‰å…¥ä¸­...</td></tr>`;
    const cls  = s.changePct >= 0 ? 'up' : 'down';
    const sign = s.changePct >= 0 ? '+' : '';
    const rec  = getSimpleRec(s);
    const vol  = s.volume >= 1000 ? (s.volume/1000).toFixed(0)+'K' : s.volume;
    return `<tr onclick="showWatchlistDetail('${code}')">
      <td><div class="stock-name">${s.name}</div><div class="stock-code">${code}</div></td>
      <td class="price">${s.price.toFixed(1)}</td>
      <td class="change ${cls}">${sign}${s.change.toFixed(1)}</td>
      <td class="change ${cls}">${sign}${s.changePct.toFixed(2)}%</td>
      <td class="text-dim text-xs">${vol}</td>
      <td><span class="tag ${rec.cls}">${rec.label}</span></td>
      <td><button class="btn-danger" onclick="event.stopPropagation();removeFromWatchlist('${code}')">âœ•</button></td>
    </tr>`;
  }).join('');
}

function getSimpleRec(s) {
  if (s.changePct > 1.5)  return { cls:'tag-green', label:'çœ‹æ¼²' };
  if (s.changePct < -1.5) return { cls:'tag-red',   label:'æ³¨æ„' };
  return { cls:'tag-gold', label:'è§€å¯Ÿ' };
}

async function addToWatchlist() {
  const input = document.getElementById('watchlistInput');
  const raw   = input.value.trim();
  if (!raw) return;
  // æ”¯æ´é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”å¤šå€‹ä»£ç¢¼
  const codes = raw.split(/[,ï¼Œ\n\r\s]+/).map(s=>s.trim().replace(/\D/g,'')).filter(Boolean);
  const added = [];
  for (const code of codes) {
    if (!code || state.watchlist.includes(code)) continue;
    state.watchlist.push(code);
    added.push(code);
  }
  if (!added.length) { alert('ä»£ç¢¼å·²å­˜åœ¨æˆ–æ ¼å¼éŒ¯èª¤'); return; }
  localStorage.setItem('watchlist', JSON.stringify(state.watchlist));
  input.value = '';
  renderWatchlistSkeleton();
  await fetchStockPrices(added);
  renderWatchlist();
  renderTicker();
  setTimeout(checkPriceAlerts, 500);
  if (added.length > 1) showToast(`âœ… å·²æ–°å¢ ${added.length} æ”¯ï¼š${added.join(', ')}`);
}

function openBulkWatchlistModal() {
  document.getElementById('bulkWatchlistModal').classList.add('open');
}

async function addBulkWatchlist() {
  const raw = document.getElementById('bulkWatchlistInput').value.trim();
  if (!raw) return;
  const codes = raw.split(/[,ï¼Œ\n\r\s]+/).map(s=>s.trim().replace(/\D/g,'')).filter(Boolean);
  const added = [];
  for (const code of codes) {
    if (!code || state.watchlist.includes(code)) continue;
    state.watchlist.push(code);
    added.push(code);
  }
  document.getElementById('bulkWatchlistModal').classList.remove('open');
  document.getElementById('bulkWatchlistInput').value = '';
  if (!added.length) { showToast('âš ï¸ ç„¡æ–°ä»£ç¢¼å¯æ–°å¢'); return; }
  localStorage.setItem('watchlist', JSON.stringify(state.watchlist));
  renderWatchlistSkeleton();
  await fetchStockPrices(added);
  renderWatchlist();
  renderTicker();
  showToast(`âœ… æ‰¹é‡æ–°å¢ ${added.length} æ”¯ï¼š${added.slice(0,5).join(', ')}${added.length>5?'â€¦':''}`);
}

function removeFromWatchlist(code) {
  state.watchlist = state.watchlist.filter(c => c !== code);
  localStorage.setItem('watchlist', JSON.stringify(state.watchlist));
  renderWatchlist();
}

function showWatchlistDetail(code) {
  const s = state.stockCache[code];
  if (!s) return;
  const cls  = s.changePct >= 0 ? 'up' : 'down';
  const sign = s.changePct >= 0 ? '+' : '';
  const updatedStr = s.updatedAt
    ? new Intl.DateTimeFormat('zh-TW',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Asia/Taipei'}).format(s.updatedAt)
    : '--';
  document.getElementById('watchlistDetail').innerHTML = `
    <div class="card-title" style="margin-bottom:16px;">ğŸ“Š ${s.name} <span class="stock-code">${code}</span></div>
    <div class="price ${cls}" style="font-size:28px;font-family:'Space Mono',monospace;">${s.price.toFixed(1)}</div>
    <div class="change ${cls}" style="font-size:14px;margin-bottom:4px;">${sign}${s.change.toFixed(1)} (${sign}${s.changePct.toFixed(2)}%)</div>
    <div class="text-xs text-dim" style="margin-bottom:16px;">æ›´æ–°æ™‚é–“ ${updatedStr}</div>
    <div class="stats-grid" style="grid-template-columns:1fr 1fr;">
      <div class="stat-box"><div class="stat-label">ä»Šé–‹</div><div class="stat-value">${s.open || '--'}</div></div>
      <div class="stat-box"><div class="stat-label">æ˜¨æ”¶</div><div class="stat-value">${s.prev || '--'}</div></div>
      <div class="stat-box"><div class="stat-label">ä»Šé«˜</div><div class="stat-value up">${s.high || '--'}</div></div>
      <div class="stat-box"><div class="stat-label">ä»Šä½</div><div class="stat-value down">${s.low || '--'}</div></div>
      <div class="stat-box"><div class="stat-label">æœ¬ç›Šæ¯”</div><div class="stat-value">${s.pe}</div></div>
      <div class="stat-box"><div class="stat-label">æ®–åˆ©ç‡</div><div class="stat-value">${s.yield}%</div></div>
    </div>
    <button class="btn mt-4" style="width:100%;margin-top:12px;" onclick="quickChat('å¹«æˆ‘åˆ†æ ${s.name} (${code}) é€™æ”¯è‚¡ç¥¨ï¼Œç¾åƒ¹ ${s.price.toFixed(1)} å…ƒï¼Œä»Šæ—¥æ¼²è·Œ ${sign}${s.changePct.toFixed(2)}%ï¼Œè«‹çµ¦æˆ‘æ“ä½œå»ºè­°ã€‚')">ğŸ¤– AI æ·±åº¦åˆ†æ</button>
    <button class="btn-outline" style="width:100%;margin-top:8px;" onclick="openAddHolding('${code}')">+ åŠ å…¥æŒè‚¡</button>
    <button class="btn-outline" style="width:100%;margin-top:8px;" onclick="setStockAlert('${code}', ${s.price.toFixed(1)})">ğŸ”” è¨­åƒ¹æ ¼è­¦ç¤º</button>
    <button class="btn-outline" style="width:100%;margin-top:8px;" onclick="switchTab('fundamentals');setTimeout(()=>loadFundamentals('${code}'),200)">ğŸ’° æŸ¥çœ‹é…æ¯è³‡æ–™</button>
  `;
}

// ============================================================
// PORTFOLIO
// ============================================================
async function renderPortfolio() {
  if (state.portfolio.length === 0) {
    document.getElementById('portfolioBody').innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--text-dim);padding:30px;">é»é¸å³ä¸Šè§’ã€Œæ–°å¢æŒè‚¡ã€é–‹å§‹è¨˜éŒ„æ‚¨çš„æŒè‚¡</td></tr>`;
    ['totalAsset','totalCost','totalPnl','totalPnlPct'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent='--';});
    const pie=document.getElementById('pieChartContainer');if(pie)pie.innerHTML='';
    return;
  }
  const missing = state.portfolio.map(h=>h.code).filter(c => !state.stockCache[c]);
  if (missing.length) await fetchStockPrices(missing);

  let totalAsset = 0, totalCost = 0;
  const rows = state.portfolio.map(h => {
    const cached = state.stockCache[h.code];
    const price  = cached?.price || h.cost;
    const name   = cached?.name || STOCK_NAMES[h.code] || h.code;
    const marketVal = price * h.lots;  // lots ç¾åœ¨æ˜¯ç›´æ¥è‚¡æ•¸
    const costVal   = h.cost * h.lots;
    const pnl    = marketVal - costVal;
    const pnlPct = costVal > 0 ? (pnl / costVal) * 100 : 0;
    totalAsset  += marketVal;
    totalCost   += costVal;
    const cls = pnl >= 0 ? 'up' : 'down';
    return `<tr>
      <td><div class="stock-name">${name}</div><div class="stock-code">${h.code}</div></td>
      <td>${h.lots.toLocaleString()} è‚¡</td>
      <td class="price">${h.cost.toFixed(1)}</td>
      <td class="price">${price.toFixed(1)}</td>
      <td class="price">${(marketVal/10000).toFixed(1)}è¬</td>
      <td class="change ${cls}">${pnl >= 0 ? '+' : ''}${(pnl/10000).toFixed(1)}è¬</td>
      <td class="change ${cls}">${pnl >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</td>
      <td style="display:flex;gap:4px;">
        <button class="btn-outline" style="font-size:11px;padding:3px 8px;" onclick="analyzeHolding('${h.code}')">ğŸ“Š åˆ†æ <span style="font-size:9px;color:var(--gold);">â‰ˆ0.08â‚®</span></button>
        <button class="btn-danger" onclick="removeHolding('${h.code}')">âœ•</button>
      </td>
    </tr>`;
  });
  document.getElementById('portfolioBody').innerHTML = rows.join('');
  const totalPnl = totalAsset - totalCost;
  const totalPnlPct = totalCost > 0 ? (totalPnl / totalCost) * 100 : 0;
  document.getElementById('totalAsset').textContent = `${(totalAsset/10000).toFixed(0)}è¬`;
  document.getElementById('totalCost').textContent  = `${(totalCost/10000).toFixed(0)}è¬`;
  document.getElementById('totalPnl').textContent   = `${totalPnl >= 0 ? '+' : ''}${(totalPnl/10000).toFixed(1)}è¬`;
  document.getElementById('totalPnlPct').textContent= `${totalPnl >= 0 ? '+' : ''}${totalPnlPct.toFixed(2)}%`;
  document.getElementById('pnlCard').className      = `portfolio-stat ${totalPnl >= 0 ? 'profit' : 'loss'}`;
  document.getElementById('pnlPctCard').className   = `portfolio-stat ${totalPnl >= 0 ? 'profit' : 'loss'}`;
  const pieContainer = document.getElementById('pieChartContainer');
  const colors = ['var(--accent)','var(--green)','var(--gold)','var(--accent2)','var(--red)'];
  pieContainer.innerHTML = state.portfolio.map((h, i) => {
    const cached = state.stockCache[h.code];
    const price  = cached?.price || h.cost;
    const name   = cached?.name  || STOCK_NAMES[h.code] || h.code;
    const val  = price * h.lots;
    const pct  = totalAsset > 0 ? (val / totalAsset) * 100 : 0;
    return `<div class="sector-bar">
      <div class="sector-name text-sm">${name}</div>
      <div class="bar-track"><div class="bar-fill up" style="width:${pct}%;background:${colors[i%colors.length]};"></div></div>
      <div class="sector-pct">${pct.toFixed(1)}%</div>
    </div>`;
  }).join('');
}

function openAddHolding(code) {
  if (code) document.getElementById('holdingCode').value = code;
  document.getElementById('holdingModal').classList.add('open');
}
function closeHoldingModal() { document.getElementById('holdingModal').classList.remove('open'); }
function switchHoldingMode(mode) {
  document.getElementById('holdingSingleForm').style.display = mode==='single' ? '' : 'none';
  document.getElementById('holdingBulkForm').style.display   = mode==='bulk'   ? '' : 'none';
  document.getElementById('holdingSingle').classList.toggle('active', mode==='single');
  document.getElementById('holdingBulk').classList.toggle('active', mode==='bulk');
}

function addHolding() {
  // åˆ¤æ–·ç›®å‰æ¨¡å¼
  const bulkVisible = document.getElementById('holdingBulkForm').style.display !== 'none';
  if (bulkVisible) {
    // æ‰¹é‡æ¨¡å¼
    const raw   = document.getElementById('holdingBulkInput').value.trim();
    const lines = raw.split('\n').map(l=>l.trim()).filter(Boolean);
    const added = [];
    const errors= [];
    for (const line of lines) {
      const parts = line.split(/[\s,ï¼Œ]+/);
      const code  = parts[0]?.replace(/\D/g,'');
      const lots  = parseFloat(parts[1]);
      const cost  = parseFloat(parts[2]);
      if (!code || !lots || !cost) { errors.push(line); continue; }
      // è‹¥å·²æœ‰ç›¸åŒä»£ç¢¼å°±æ›´æ–°
      const existing = state.portfolio.findIndex(h=>h.code===code);
      if (existing>=0) state.portfolio[existing] = { code, lots, cost };
      else state.portfolio.push({ code, lots, cost });
      added.push(code);
    }
    localStorage.setItem('portfolio', JSON.stringify(state.portfolio));
    closeHoldingModal();
    renderPortfolio();
    if (errors.length) showToast(`âš ï¸ æ–°å¢ ${added.length} ç­†ï¼Œ${errors.length} ç­†æ ¼å¼éŒ¯èª¤`);
    else showToast(`âœ… æˆåŠŸæ–°å¢ ${added.length} ç­†æŒè‚¡`);
  } else {
    // å–®ç­†æ¨¡å¼
    const code = document.getElementById('holdingCode').value.trim();
    const lots = parseFloat(document.getElementById('holdingLots').value);
    const cost = parseFloat(document.getElementById('holdingCost').value);
    if (!code || !lots || !cost) { alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }
    const existing = state.portfolio.findIndex(h=>h.code===code);
    if (existing>=0) {
      if (!confirm(`${code} å·²åœ¨æŒè‚¡ä¸­ï¼Œè¦è¦†è“‹å—ï¼Ÿ`)) return;
      state.portfolio[existing] = { code, lots, cost };
    } else {
      state.portfolio.push({ code, lots, cost });
    }
    localStorage.setItem('portfolio', JSON.stringify(state.portfolio));
    closeHoldingModal();
    renderPortfolio();
  }
}
function removeHolding(code) {
  state.portfolio = state.portfolio.filter(h => h.code !== code);
  localStorage.setItem('portfolio', JSON.stringify(state.portfolio));
  renderPortfolio();
}

// ============================================================
// AI RECS
// ============================================================
function renderAiRecs(filter) {
  aiRecFilter = filter || '';
  const recs = filter ? AI_RECS.filter(r => r.rec === filter) : AI_RECS;
  if (!recs.length) {
    document.getElementById('aiRecList').innerHTML =
      '<div style="text-align:center;padding:30px;color:var(--text-dim);font-size:13px;">æ­¤é¡åˆ¥æš«ç„¡çµæœ</div>';
    return;
  }
  document.getElementById('aiRecList').innerHTML = recs.map(r => {
    const sign    = r.rec === 'buy' ? 'è²·' : r.rec === 'sell' ? 'è³£' : 'ç•™';
    const tagCls  = r.rec === 'buy' ? 'tag-green' : r.rec === 'sell' ? 'tag-red' : 'tag-gold';
    const s       = state.stockCache[r.code];
    const priceInfo = s ? `${s.price.toFixed(1)} <span class="${s.changePct>=0?'up':'down'}" style="font-size:11px;">${s.changePct>=0?'+':''}${s.changePct.toFixed(2)}%</span>` : '';
    return `<div class="ai-score ${r.rec}">
      <div class="score-circle ${r.rec}">
        <div>${r.score}</div>
        <div class="ai-rec-label" style="font-size:9px;">${sign}</div>
      </div>
      <div class="ai-stock-info">
        <div class="ai-stock-name">
          ${r.name} <span class="stock-code">${r.code}</span>
          <span style="font-size:12px;font-family:'Space Mono',monospace;margin-left:6px;">${priceInfo}</span>
        </div>
        <div class="ai-reason">${r.reason}</div>
        <div class="ai-tags">${(r.tags||[]).map(t=>`<span class="tag ${tagCls}">${t}</span>`).join('')}</div>
      </div>
      <button class="btn-outline" onclick="quickChat('æ·±å…¥åˆ†æ ${r.name}(${r.code})ï¼Œè©•åˆ†${r.score}åˆ†ï¼Œå»ºè­°${sign}ï¼ŒåŸå› ï¼š${r.reason.slice(0,40)}')">æ·±å…¥</button>
    </div>`;
  }).join('');
}

function filterAiRec(type, el) {
  document.querySelectorAll('#page-ai-analysis .filter-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderAiRecs(type);
}

async function runAiAnalysis() {
  if (!WORKER_URL) {
    document.getElementById('aiNoticeBar').textContent = 'âš ï¸ éœ€å…ˆè¨­å®š Cloudflare Worker ç¶²å€ï¼Œä¸” Worker é ˆè¨­å®š CLAUDE_API_KEY Secret';
    document.getElementById('aiNoticeBar').style.background = 'rgba(239,68,68,.1)';
    document.getElementById('aiNoticeBar').style.borderColor = 'rgba(239,68,68,.3)';
    return;
  }
  document.getElementById('aiRecList').innerHTML = '<div class="loading"><div class="spinner"></div> AI åˆ†æä¸­ï¼Œè«‹ç¨å€™...</div>';
  document.getElementById('aiSummaryPanel').textContent = 'åˆ†æä¸­...';

  try {
    // æ±ºå®šåˆ†æå“ªäº›è‚¡ç¥¨
    const pool = document.getElementById('af-pool')?.value || 'watchlist';
    let codes;
    if (pool === 'watchlist')       codes = state.watchlist;
    else if (pool === 'sector_semi') codes = SECTOR_STOCKS['åŠå°é«”'] || [];
    else if (pool === 'sector_ai')   codes = SECTOR_STOCKS['AIä¼ºæœå™¨'] || [];
    else if (pool === 'sector_fin')  codes = SECTOR_STOCKS['é‡‘èä¿éšª'] || [];
    else codes = Object.keys(state.stockCache);
    codes = codes.filter(c => state.stockCache[c]?.price > 0).slice(0, 10);

    if (!codes.length) {
      document.getElementById('aiRecList').innerHTML = '<div style="color:var(--gold);padding:20px;text-align:center;">å°šç„¡è‚¡åƒ¹è³‡æ–™ï¼Œè«‹ç­‰å¸‚å ´è³‡æ–™è¼‰å…¥å¾Œå†è©¦ã€‚</div>';
      return;
    }

    // æ”¶é›†å„è‚¡è³‡æ–™
    const stockData = codes.map(code => {
      const s  = state.stockCache[code] || {};
      const st = STOCK_STATIC[code] || {};
      return {
        code, name: s.name || STOCK_NAMES[code] || code,
        price: s.price, changePct: s.changePct, volume: s.volume,
        pe: s.pe || st.pe || '-', yld: s.yield || st.yield || '-',
        sector: s.sector || st.sector || 'å…¶ä»–',
      };
    });

    // æ”¶é›†å¤–éƒ¨è³‡æ–™
    const sp  = state.yahooData['^GSPC']    || {};
    const sox = state.yahooData['^SOX']     || {};
    const vix = state.yahooData['^VIX']     || {};
    const twd = state.yahooData['USDTWD=X'] || {};
    const idx = state.twseIndex || {};
    const risk = document.getElementById('af-risk')?.value || 3;
    const riskLabel = ['','ä¿å®ˆ','ç•¥ä¿å®ˆ','ä¸­æ€§','ç•¥ç©æ¥µ','ç©æ¥µ'][risk];

    const factors = {
      price  : document.getElementById('af-price')?.checked,
      pe     : document.getElementById('af-pe')?.checked,
      us     : document.getElementById('af-us')?.checked,
      fx     : document.getElementById('af-fx')?.checked,
      sector : document.getElementById('af-sector')?.checked,
      news   : document.getElementById('af-news')?.checked,
      tariff : document.getElementById('af-tariff')?.checked,
      inst   : document.getElementById('af-inst')?.checked,
      macro  : document.getElementById('af-macro')?.checked,
    };

    const contextParts = [];
    if (factors.us && sp.changePct !== undefined)
      contextParts.push(`ç¾è‚¡: S&P500 ${sp.changePct>=0?'+':''}${sp.changePct}%, SOX ${sox.changePct>=0?'+':''}${sox.changePct}%`);
    if (factors.macro && vix.price)
      contextParts.push(`VIXææ…ŒæŒ‡æ•¸: ${vix.price} (${vix.price>25?'é«˜ææ…Œ':vix.price>18?'ä¸­ç­‰':'å¹³éœ'})`);
    if (factors.fx && twd.changePct !== undefined)
      contextParts.push(`USD/TWD: ${twd.price} (${twd.changePct>=0?'+':''}${twd.changePct}%)`);
    if (idx.changePct !== undefined)
      contextParts.push(`å°ç£åŠ æ¬ŠæŒ‡æ•¸: ${idx.changePct>=0?'+':''}${idx.changePct}%`);
    if (factors.news && state.rssNews.length)
      contextParts.push(`è¿‘æœŸæ–°èæ¨™é¡Œ: ${state.rssNews.slice(0,3).map(n=>n.title).join(' | ')}`);

    const prompt = `ä½ æ˜¯å°ç£è‚¡å¸‚é‡åŒ–åˆ†æå¸«ã€‚æ ¹æ“šä»¥ä¸‹ä»Šæ—¥çœŸå¯¦å¸‚å ´è³‡æ–™ï¼Œå°å„è‚¡ç¥¨é€²è¡Œå¤šå› å­è©•åˆ†ä¸¦çµ¦å‡ºè²·è³£å»ºè­°ã€‚

ã€å¸‚å ´ç’°å¢ƒã€‘
${contextParts.join('\n')}

ã€æŠ•è³‡äººé¢¨éšªåå¥½ã€‘${riskLabel}

ã€å¾…è©•è‚¡ç¥¨ï¼ˆä»Šæ—¥å³æ™‚è³‡æ–™ï¼‰ã€‘
${stockData.map(s => `${s.code} ${s.name}: ç¾åƒ¹${s.price} æ¼²è·Œ${s.changePct>=0?'+':''}${s.changePct}% PE=${s.pe} æ®–åˆ©ç‡=${s.yld}% é¡è‚¡=${s.sector}`).join('\n')}

ã€åˆ†æè¦æ±‚ã€‘
1. æ¯æ”¯è‚¡ç¥¨çµ¦å‡º 0-100 åˆ†ï¼ˆç¶œåˆè©•åˆ†ï¼‰
2. å»ºè­°åªèƒ½æ˜¯ï¼šbuyï¼ˆå¼·åŠ›è²·é€²ï¼‰ã€holdï¼ˆè§€å¯Ÿï¼‰ã€sellï¼ˆæ³¨æ„é¢¨éšªï¼‰
3. è©•åˆ†è¦æ ¹æ“šä¸Šæ–¹çœŸå¯¦æ•¸æ“šï¼Œä¸èƒ½æ¯æ¬¡éƒ½ä¸€æ¨£
4. reason è¦å¼•ç”¨å…·é«”æ•¸å­—
5. tags æœ€å¤š3å€‹ï¼Œè¦æœ‰å¯¦è³ªæ„ç¾©

å¿…é ˆå›å‚³ JSONï¼ˆä¸è¦å…¶ä»–æ–‡å­—ï¼‰ï¼š
{
  "recs": [
    {"code":"ä»£è™Ÿ","name":"åç¨±","rec":"buy/hold/sell","score":æ•¸å­—,"reason":"30-50å­—å…·é«”èªªæ˜","tags":["æ¨™ç±¤1","æ¨™ç±¤2"]}
  ],
  "summary": "æœ¬æ¬¡åˆ†æçš„æ•´é«”å¸‚å ´è§€é»ï¼Œ50å­—ä»¥å…§"
}`;

    trackApiUsage('ai-recs', 1500);
    const raw  = await callClaude([{ role:'user', content: prompt }], 1500);
    const json = raw.match(/\{[\s\S]*\}/)?.[0];
    if (!json) throw new Error('AI å›æ‡‰æ ¼å¼ç•°å¸¸');
    const result = JSON.parse(json);

    AI_RECS = result.recs || [];
    document.getElementById('aiCount').textContent = AI_RECS.length;
    trackAiUsage('recs');
    document.getElementById('aiSummaryPanel').innerHTML =
      `<div style="color:var(--text);line-height:1.7;">${result.summary || ''}</div>
       <div style="margin-top:8px;font-size:11px;color:var(--text-muted);">
         åˆ†æè‚¡ç¥¨ï¼š${codes.length} æ”¯ ï½œ æ™‚é–“ï¼š${new Date().toLocaleTimeString('zh-TW')}
       </div>`;
    renderAiRecs(aiRecFilter);
  } catch(e) {
    document.getElementById('aiRecList').innerHTML =
      `<div style="color:var(--red);padding:20px;text-align:center;font-size:13px;">âŒ åˆ†æå¤±æ•—ï¼š${e.message}</div>`;
    document.getElementById('aiSummaryPanel').textContent = 'åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦';
  }
}

// ============================================================
// NEWS
// ============================================================
function renderNews(filter) {
  const list = filter && filter !== 'all' ? NEWS_DATA.filter(n => n.tags.includes(filter)) : NEWS_DATA;
  document.getElementById('newsLoading').style.display = 'none';
  document.getElementById('newsList').innerHTML = list.map(n => {
    const impactCls = n.impact === 'high' ? 'tag-red' : n.impact === 'medium' ? 'tag-gold' : 'tag-blue';
    const impactLabel = n.impact === 'high' ? 'é«˜å½±éŸ¿' : n.impact === 'medium' ? 'ä¸­å½±éŸ¿' : 'ä½å½±éŸ¿';
    const stockTags = n.stocks.map(code => {
      const s = state.stockCache[code];
      const sName = s?.name || STOCK_NAMES[code] || code;
      return `<span class="tag ${n.positive?'tag-green':'tag-red'}">${sName}${n.positive?'â†‘':'â†“'}</span>`;
    }).join('');
    return `<div class="news-item">
      <div class="news-meta">
        <span class="news-source">${n.source}</span>
        <span class="news-time">${n.time}</span>
        <span class="tag ${impactCls} news-impact">${impactLabel}</span>
        ${n.positive ? '<span class="tag tag-green">æ­£é¢</span>' : '<span class="tag tag-red">è² é¢</span>'}
      </div>
      <div class="news-title">${n.title}</div>
      <div class="news-summary">${n.summary}</div>
      ${stockTags ? `<div class="ai-tags" style="margin-top:8px;">${stockTags}</div>` : ''}
    </div>`;
  }).join('');
}

function filterNews(type, el) {
  document.querySelectorAll('.filter-bar .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderNews(type === 'all' ? null : type);
}

function refreshNews() {
  document.getElementById('newsLoading').style.display = 'flex';
  document.getElementById('newsList').innerHTML = '';
  if (WORKER_URL) {
    fetchRSSNews().then(() => {
      document.getElementById('newsLoading').style.display = 'none';
    });
  } else {
    setTimeout(() => renderNews(), 800);
  }
}

function renderRealNews(items) {
  document.getElementById('newsLoading').style.display = 'none';
  const sourceLabel = { cnyes:'é‰…äº¨ç¶²', udn:'è¯åˆè²¡ç¶“', chinatimes:'ä¸­æ™‚', moneydj:'MoneyDJ' };
  const sourceSearch = {
    cnyes: (t) => `https://news.cnyes.com/search?q=${encodeURIComponent(t)}`,
    udn  : (t) => `https://udn.com/search/result/2/${encodeURIComponent(t)}`,
    chinatimes:(t)=>`https://www.chinatimes.com/search/${encodeURIComponent(t)}`,
    moneydj:(t)=>`https://www.moneydj.com/search?q=${encodeURIComponent(t)}`,
  };
  document.getElementById('newsList').innerHTML = items.map(n => {
    const src     = sourceLabel[n.source] || n.source;
    const tStr    = n.pubDate ? relativeTime(new Date(n.pubDate)) : '';
    // æœ‰åŸå§‹é€£çµç”¨åŸå§‹é€£çµï¼›å¦å‰‡ç”¢ç”Ÿæœå°‹é€£çµ
    const link    = (n.link && n.link.startsWith('http'))
      ? n.link
      : (sourceSearch[n.source]?.(n.title.slice(0,20)) || '');
    const isOriginal = n.link && n.link.startsWith('http');
    return `<div class="news-item" style="cursor:pointer;" onclick="window.open('${link}','_blank')">
      <div class="news-meta">
        <span class="news-source">${src}</span>
        <span class="news-time">${tStr}</span>
        <span class="tag tag-blue">å³æ™‚</span>
        <span class="tag" style="background:rgba(0,212,255,.08);color:var(--accent);font-size:10px;">
          ${isOriginal ? 'ğŸ”— åŸæ–‡' : 'ğŸ” æœå°‹'}
        </span>
      </div>
      <div class="news-title">${n.title}</div>
      ${n.desc ? `<div class="news-summary">${n.desc}</div>` : ''}
    </div>`;
  }).join('');
  state.rssNews = items;
}

function relativeTime(d) {
  const mins = Math.floor((Date.now() - d) / 60000);
  if (mins < 1)   return 'å‰›å‰›';
  if (mins < 60)  return `${mins}åˆ†é˜å‰`;
  if (mins < 1440) return `${Math.floor(mins/60)}å°æ™‚å‰`;
  return `${Math.floor(mins/1440)}å¤©å‰`;
}

function searchStockNews() {
  const q = document.getElementById('newsStockSearch').value.trim();
  const s = state.stockCache[q];
  const name = s?.name || STOCK_NAMES[q] || q;
  const related = NEWS_DATA.filter(n => n.stocks.includes(q) || n.title.includes(name));
  document.getElementById('stockNewsList').innerHTML = related.length ? related.map(n => `
    <div class="news-item">
      <div class="news-meta"><span class="news-source">${n.source}</span><span class="news-time">${n.time}</span></div>
      <div class="news-title">${n.title}</div>
    </div>`).join('') : `<div style="text-align:center;color:var(--text-dim);font-size:13px;padding:20px;">æ‰¾ä¸åˆ° ${q} ç›¸é—œæ–°è</div>`;
}

// ============================================================
// MACRO
// ============================================================
function renderMacro() {
  // å…ˆç”¨é è¨­å€¼ä½”ä½ï¼Œç­‰ Yahoo è³‡æ–™å›ä¾†å†æ›´æ–°
  const defaults = {
    'dji':['--','--',true],'ixic':['--','--',true],'spx':['--','--',true],'sox':['--','--',true],
    'usdtwd2':['--','--',false],'usdjpy':['--','--',true],
    'wti':['--','--',true],'gold':['--','--',false],
    'vix':['--','--',false],'ust10y':['--','--',true],'ust2y':['--','--',false],'dxy':['--','--',true],
  };
  Object.entries(defaults).forEach(([id,[val,ch,up]])=>{
    const el=document.getElementById(id);
    const ch_el=document.getElementById(id+'-ch');
    if(el) el.textContent=val;
    if(ch_el){ch_el.textContent=ch;ch_el.className=`change ${up?'up':'down'}`;}
  });
  if (Object.keys(state.yahooData).length) updateMacroCards();
}

// Yahoo è³‡æ–™æ˜ å°„åˆ°é é¢å…ƒç´ 
const YAHOO_MAP = {
  '^DJI'    :['dji','dji-ch'],
  '^IXIC'   :['ixic','ixic-ch'],
  '^SOX'    :['sox','sox-ch'],
  'USDTWD=X':['usdtwd2','usdtwd2-ch'],
  'USDJPY=X':['usdjpy','usdjpy-ch'],
  'CL=F'    :['wti','wti-ch'],
  'GC=F'    :['gold','gold-ch'],
  '^VIX'    :['vix','vix-ch'],
  '^TNX'    :['ust10y','ust10y-ch'],
  '^TYX'    :['ust2y','ust2y-ch'],
  'DX-Y.NYB':['dxy','dxy-ch'],
};

function updateMacroCards() {
  Object.entries(YAHOO_MAP).forEach(([sym,[valId,chId]])=>{
    const d = state.yahooData[sym];
    if (!d) return;
    const isUp = d.changePct >= 0;
    const sign = isUp ? '+' : '';
    const el   = document.getElementById(valId);
    const chEl = document.getElementById(chId);
    if(el)   el.textContent  = d.price.toLocaleString();
    if(chEl){chEl.textContent= `${sign}${d.changePct.toFixed(2)}%`;
             chEl.className  = `change ${isUp?'up':'down'}`;}
  });
}

function updateOverviewCards() {
  if (document.getElementById('mtrend-twse')) setTimeout(updateMarketTrendBanner, 100);
  // USD/TWD
  const twd = state.yahooData['USDTWD=X'];
  if(twd && twd.price > 0){
    const isUp=twd.changePct>=0; const sign=isUp?'+':'';
    document.getElementById('usdtwd-price').textContent = twd.price.toFixed(2);
    document.getElementById('usdtwd-change').innerHTML  =
      `<span class="${isUp?'up':'down'}">${sign}${twd.change.toFixed(2)} (${sign}${twd.changePct.toFixed(2)}%)</span>`;
    renderSparkline('usdtwd-spark', randomWalkData(20, twd.price*0.996, twd.price*1.004), isUp);
  }
  // VIX
  const vix = state.yahooData['^VIX'];
  if(vix && vix.price > 0){
    const isUp=vix.changePct>=0;
    const vixColor = vix.price>30?'var(--red)':vix.price>20?'var(--gold)':'var(--green)';
    document.getElementById('vix-price').textContent = vix.price.toFixed(2);
    document.getElementById('vix-price').style.color = vixColor;
    document.getElementById('vix-change').innerHTML  =
      `<span style="color:${vixColor};font-size:12px;">${isUp?'+':''}${vix.changePct.toFixed(2)}% Â· ${vix.price>30?'é«˜ææ…Œ':vix.price>20?'è¬¹æ…':'å¹³ç©©'}</span>`;
    renderSparkline('vix-spark', randomWalkData(20, vix.price*0.9, vix.price*1.1), !isUp);
  }
  // åœ‹éš›æŒ‡æ•¸ç¸®åœ–
  updateMiniGlobal();
  // æ›´æ–°åœ‹éš›è‚¡å¸‚é 
  if(document.getElementById('page-global')?.classList.contains('active')) renderGlobalPage();
}

function updateMiniGlobal() {
  const mini = document.getElementById('miniGlobalSummary');
  if(!mini) return;
  const indices = [
    ['^GSPC','S&P 500'],['^IXIC','NASDAQ'],['^DJI','é“ç“Š'],['^N225','æ—¥ç¶“225'],
  ];
  const rows = indices.map(([sym, label])=>{
    const d = state.yahooData[sym];
    if(!d||!d.price) return '';
    const up = d.changePct>=0;
    return `<div style="display:flex;justify-content:space-between;">
      <span style="color:var(--text-dim);">${label}</span>
      <span style="color:${up?'var(--green)':'var(--red)'};font-family:'Space Mono',monospace;font-size:11px;">${up?'+':''}${d.changePct.toFixed(2)}%</span>
    </div>`;
  }).filter(Boolean);
  mini.innerHTML = rows.length ? rows.join('') : '<div style="color:var(--text-dim);">é»æ“ŠæŸ¥çœ‹åœ‹éš›è‚¡å¸‚ â†’</div>';
}

function showMacroNote(msg) {
  const el = document.getElementById('macroNote');
  if (el) { el.textContent = msg; el.style.display = 'flex'; }
}

// ============================================================
// CALENDAR
// ============================================================
function renderCalendar() {
  const earnings = [
    { day:24, month:'äºŒæœˆ', name:'å°ç©é›»æ³•èªªæœƒ', desc:'Q4è²¡å ±èªªæ˜æš¨2025å±•æœ›', importance:3 },
    { day:25, month:'äºŒæœˆ', name:'é´»æµ·è‘£äº‹æœƒ', desc:'AIä¼ºæœå™¨æ¥­å‹™èªªæ˜', importance:2 },
    { day:26, month:'äºŒæœˆ', name:'å»£é”è²¡å ±', desc:'Q4 EPSé ä¼° 6.5å…ƒ', importance:2 },
    { day:28, month:'äºŒæœˆ', name:'è¯ç™¼ç§‘è²¡å ±', desc:'AIæ‰‹æ©Ÿæ™¶ç‰‡éœ€æ±‚èªªæ˜', importance:3 },
  ];
  const macroEvents = [
    { day:23, month:'äºŒæœˆ', name:'Fed æœƒè­°ç´€è¦', desc:'è§€å¯Ÿé™æ¯è·¯å¾‘ç·šç´¢', importance:3 },
    { day:24, month:'äºŒæœˆ', name:'å°ç£ CPI', desc:'1æœˆä»½æ¶ˆè²»è€…ç‰©åƒ¹æŒ‡æ•¸', importance:2 },
    { day:26, month:'äºŒæœˆ', name:'ç¾åœ‹ PCE', desc:'Fedæœ€é‡è¦–çš„é€šè†¨æŒ‡æ¨™', importance:3 },
    { day:28, month:'äºŒæœˆ', name:'ç¾åœ‹ GDP ä¿®è¨‚å€¼', desc:'Q4 GDP ç¬¬äºŒæ¬¡ä¼°è¨ˆ', importance:2 },
  ];

  const renderEvents = (events, containerId) => {
    document.getElementById(containerId).innerHTML = events.map(e => `
      <div class="event-item">
        <div class="event-date">
          <div class="event-day">${e.day}</div>
          <div class="event-month">${e.month}</div>
        </div>
        <div class="event-body">
          <div class="event-title">${e.name}</div>
          <div class="event-desc">${e.desc}</div>
          <div class="event-importance">
            ${Array.from({length:3}).map((_,i) => `<div class="dot-importance" style="background:${i<e.importance?'var(--gold)':'var(--text-muted)'}"></div>`).join('')}
          </div>
        </div>
      </div>
    `).join('');
  };
  renderEvents(earnings, 'earningsCalendar');
  renderEvents(macroEvents, 'macroCalendar');
}


// ============================================================
// SCREENER â€” applyPresetï¼ˆå¿«é€Ÿç¯©é¸ï¼‰
// ============================================================
function applyPreset(type) {
  resetScreener(false); // ä¸æ¸…é™¤çµæœï¼Œåªæ¸…æ¬„ä½
  const presets = {
    high_div  : () => { setVal('sc-yield-min', 5); },
    low_pe    : () => { setVal('sc-pe-max', 12); },
    ai        : () => { setVal('sc-sector', 'AIä¼ºæœå™¨'); },
    semicon   : () => { setVal('sc-sector', 'åŠå°é«”'); },
    finance   : () => { setVal('sc-sector', 'é‡‘èä¿éšª'); },
    up_today  : () => { setVal('sc-dir', 'up'); },
    down_today: () => { setVal('sc-dir', 'down'); },
    high_vol  : () => { setVal('sc-dir', 'strong'); },
  };
  const fn = presets[type];
  if (!fn) return;
  fn();
  // é«˜äº®ç›®å‰ä½¿ç”¨çš„å¿«é€Ÿç¯©é¸
  document.querySelectorAll('#page-screener .filter-bar .filter-chip').forEach(b => {
    b.classList.remove('active');
    if (b.getAttribute('onclick')?.includes(type)) b.classList.add('active');
  });
  runScreener();
}

function setVal(id, val) {
  const el = document.getElementById(id);
  if (el) el.value = val;
}

// ============================================================
// SCREENER
// ============================================================
function runScreener() {
  document.getElementById('screenerResults').innerHTML =
    '<div class="loading"><div class="spinner"></div> ç¯©é¸ä¸­...</div>';

  setTimeout(() => {
    // â”€â”€ è®€å–ç¯©é¸æ¢ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const sectorFilter = (document.getElementById('sc-sector')?.value || '').trim();
    const peMin        = parseFloat(document.getElementById('sc-pe-min')?.value)    || null;
    const peMax        = parseFloat(document.getElementById('sc-pe-max')?.value)    || null;
    const yldMin       = parseFloat(document.getElementById('sc-yield-min')?.value) || null;
    const yldMax       = parseFloat(document.getElementById('sc-yield-max')?.value) || null;
    const chgMin       = document.getElementById('sc-chg-min')?.value !== ''   ? parseFloat(document.getElementById('sc-chg-min').value)   : null;
    const chgMax       = document.getElementById('sc-chg-max')?.value !== ''   ? parseFloat(document.getElementById('sc-chg-max').value)   : null;
    const priceMin     = parseFloat(document.getElementById('sc-price-min')?.value) || null;
    const priceMax     = parseFloat(document.getElementById('sc-price-max')?.value) || null;
    const dir          = document.getElementById('sc-dir')?.value || '';

    // â”€â”€ å»ºç«‹è‚¡ç¥¨æ± ï¼šåˆä½µ cache + static â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // å…ˆå¾ cache å–
    const pool = {};
    Object.entries(state.stockCache).forEach(([code, s]) => {
      const st = STOCK_STATIC[code] || {};
      pool[code] = {
        name     : s.name || STOCK_NAMES[code] || code,
        price    : s.price    || 0,
        changePct: s.changePct|| 0,
        volume   : s.volume   || 0,
        pe       : s.pe       || st.pe    || '-',
        yield    : s.yield    || st.yield || '-',
        sector   : s.sector   || st.sector|| 'å…¶ä»–',
      };
    });
    // è£œå…… static è£¡æœ‰ä½† cache æ²’æœ‰çš„
    Object.entries(STOCK_STATIC).forEach(([code, st]) => {
      if (!pool[code]) {
        pool[code] = {
          name: STOCK_NAMES[code]||code, price:0, changePct:0, volume:0,
          pe: st.pe||'-', yield: st.yield||'-', sector: st.sector||'å…¶ä»–',
        };
      }
    });

    // â”€â”€ å¥—ç”¨ç¯©é¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const filtered = Object.entries(pool).filter(([code, s]) => {
      // 1. é¡è‚¡ç¯©é¸ï¼ˆé€™æ˜¯é—œéµï¼šç”¨ SECTOR_STOCKS æŸ¥æ‰¾ï¼Œç¢ºä¿æ­£ç¢ºï¼‰
      if (sectorFilter) {
        const sectorCodes = SECTOR_STOCKS[sectorFilter] || [];
        // åŒæ™‚æª¢æŸ¥ï¼šè‚¡ç¥¨ä»£ç¢¼åœ¨è©²é¡è‚¡æ¸…å–®ä¸­ï¼Œæˆ– STOCK_STATIC çš„ sector æ¬„ä½ç¬¦åˆ
        const inSectorList = sectorCodes.includes(code);
        const inStaticSector = (STOCK_STATIC[code]?.sector || '') === sectorFilter;
        if (!inSectorList && !inStaticSector) return false;
      }

      // 2. æœ¬ç›Šæ¯”
      const pe  = parseFloat(s.pe)    || null;
      const yld = parseFloat(s.yield) || null;
      if (peMin  !== null && (pe  === null || pe  < peMin))  return false;
      if (peMax  !== null && (pe  === null || pe  > peMax))  return false;

      // 3. æ®–åˆ©ç‡
      if (yldMin !== null && (yld === null || yld < yldMin)) return false;
      if (yldMax !== null && (yld === null || yld > yldMax)) return false;

      // 4. è‚¡åƒ¹
      if (priceMin !== null && s.price < priceMin) return false;
      if (priceMax !== null && s.price > priceMax) return false;

      // 5. æ¼²è·Œå¹…
      if (chgMin !== null && s.changePct < chgMin) return false;
      if (chgMax !== null && s.changePct > chgMax) return false;

      // 6. æ–¹å‘
      if (dir === 'up'     && s.changePct <= 0)   return false;
      if (dir === 'down'   && s.changePct >= 0)   return false;
      if (dir === 'strong' && s.changePct < 2)    return false;
      if (dir === 'weak'   && s.changePct > -2)   return false;

      // 7. åªé¡¯ç¤ºæœ‰åç¨±çš„è‚¡ç¥¨ï¼ˆéæ¿¾æ¸¬è©¦ä»£ç¢¼ï¼‰
      if (!s.name || s.name === code) return false;

      return true;
    });

    if (!filtered.length) {
      // è¨ºæ–·åŸå› 
      let reason = 'è«‹èª¿æ•´ç¯©é¸æ¢ä»¶å¾Œå†è©¦';
      const total = Object.keys(pool).length;
      const allZero = Object.values(pool).every(s=>s.changePct===0 && s.price===0);
      if (allZero) reason = 'å¸‚å ´è³‡æ–™å°šæœªè¼‰å…¥ï¼ˆè‹¥åœ¨éäº¤æ˜“æ™‚æ®µï¼Œæ¼²è·Œå¹…è³‡æ–™ç‚º 0ï¼Œä»Šæ—¥æ¼²è·Œç¯©é¸ç„¡æ•ˆï¼‰';
      else if (sectorFilter) reason = `é¡è‚¡ã€Œ${sectorFilter}ã€ç›®å‰è³‡æ–™ä¸è¶³ï¼Œè«‹ç­‰è³‡æ–™è¼‰å…¥å¾Œå†è©¦`;
      document.getElementById('screenerResults').innerHTML =
        `<div style="text-align:center;padding:40px;color:var(--text-dim);">
          <div style="font-size:24px;margin-bottom:12px;">ğŸ”</div>
          <div style="font-size:14px;margin-bottom:6px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</div>
          <div style="font-size:12px;max-width:300px;margin:0 auto;line-height:1.7;">${reason}</div>
          <div style="margin-top:16px;display:flex;gap:8px;justify-content:center;">
            <button class="btn-outline" onclick="resetScreener()">æ¸…é™¤æ¢ä»¶</button>
            <button class="btn-outline" onclick="loadAllData().then(runScreener)">é‡æ–°è¼‰å…¥è³‡æ–™</button>
          </div>
        </div>`;
      return;
    }

    // æ’åºï¼šæœ‰æ¼²è·Œè³‡æ–™çš„å„ªå…ˆï¼Œå†ä¾æ¼²å¹…æ’
    filtered.sort((a,b) => {
      if (b[1].price > 0 && a[1].price === 0) return 1;
      if (a[1].price > 0 && b[1].price === 0) return -1;
      return b[1].changePct - a[1].changePct;
    });

    document.getElementById('screenerResults').innerHTML = `
      <div class="section-header" style="margin-bottom:12px;">
        <div class="section-title">ç¯©é¸çµæœï¼ˆ${filtered.length} æª”${sectorFilter ? ' âˆ™ ' + sectorFilter : ''}ï¼‰</div>
      </div>
      <table class="stock-table">
        <thead><tr>
          <th>è‚¡ç¥¨</th><th>ç¾åƒ¹</th><th>æ¼²è·Œ%</th>
          <th>æœ¬ç›Šæ¯”</th><th>æ®–åˆ©ç‡</th><th>é¡è‚¡</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody>${filtered.map(([code, s]) => {
          const cls  = s.changePct >= 0 ? 'up' : 'down';
          const rec  = getSimpleRec(s);
          const hasPrice = s.price > 0;
          return `<tr>
            <td>
              <div class="stock-name">${s.name}</div>
              <div class="stock-code">${code}</div>
            </td>
            <td class="price">${hasPrice ? s.price.toFixed(1) : '--'}</td>
            <td class="change ${cls}">${hasPrice ? (s.changePct>=0?'+':'')+s.changePct.toFixed(2)+'%' : '--'}</td>
            <td>${s.pe !== '-' ? s.pe : '--'}</td>
            <td>${s.yield !== '-' ? s.yield+'%' : '--'}</td>
            <td style="font-size:11px;color:var(--text-dim);">${s.sector}</td>
            <td>
              <button class="btn-outline" style="font-size:11px;padding:3px 8px;"
                onclick="quickChat('åˆ†æ ${s.name}(${code}) çš„æŠ•è³‡åƒ¹å€¼')">åˆ†æ</button>
            </td>
          </tr>`;
        }).join('')}</tbody>
      </table>`;
  }, 300);
}

function resetScreener(showEmpty=true) {
  ['sc-sector','sc-dir'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  ['sc-pe-min','sc-pe-max','sc-yield-min','sc-yield-max',
   'sc-chg-min','sc-chg-max','sc-price-min','sc-price-max'].forEach(id => {
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.querySelectorAll('#page-screener .filter-bar .filter-chip').forEach(b=>b.classList.remove('active'));
  if (showEmpty) document.getElementById('screenerResults').innerHTML =
    '<div style="text-align:center;color:var(--text-dim);font-size:13px;padding:30px;">è¨­å®šæ¢ä»¶å¾Œé»é¸ã€Œé–‹å§‹ç¯©é¸ã€</div>';
}

// ============================================================
// AI CHAT
// ============================================================
function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  appendChat(msg, 'user');
  
  if (!WORKER_URL) {
    setTimeout(() => appendChat('âš ï¸ è«‹å…ˆè¨­å®š Cloudflare Worker ç¶²å€ï¼Œä¸¦åœ¨ Worker è¨­å®š CLAUDE_API_KEY Secretã€‚', 'ai'), 500);
    return;
  }
  
  appendChat('åˆ†æä¸­...', 'ai', 'thinking');
  callClaudeAPI(msg);
}

function quickChat(msg) {
  document.getElementById('chatInput').value = msg;
  switchTabById('chat');
  sendChat();
}

function switchTabById(id) {
  // é¿å…é›™é‡ click å°è‡´ç«¶çˆ­æ¢ä»¶
  const tabs = ['overview','watchlist','portfolio','ai-analysis','news','macro','calendar','screener','chat','institutional','potential','trend'];
  let found = false;
  document.querySelectorAll('.tab').forEach((t, i) => {
    if (!found && tabs[i] === id) { t.click(); found = true; }
  });
}

function appendChat(msg, role, id) {
  const container = document.getElementById('chatContainer');
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  if (id) div.id = id;
  div.innerHTML = msg;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}


// ============================================================
// DASHBOARD CUSTOMIZATION
// ============================================================
const DASH_CONFIG_KEY = 'dashConfig';

function toggleDashItem(id, cb) {
  const el = document.getElementById(id);
  if (el) el.style.display = cb.checked ? '' : 'none';
  const cfg = JSON.parse(localStorage.getItem(DASH_CONFIG_KEY) || '{}');
  cfg[id] = cb.checked;
  localStorage.setItem(DASH_CONFIG_KEY, JSON.stringify(cfg));
}

function loadDashConfig() {
  const cfg = JSON.parse(localStorage.getItem(DASH_CONFIG_KEY) || '{}');
  Object.entries(cfg).forEach(([id, visible]) => {
    const el = document.getElementById(id);
    if (el) el.style.display = visible ? '' : 'none';
    // åŒæ­¥ checkbox
    const cbId = {
      overviewSP500:'dash-sp500', overviewUSDTWD:'dash-usdtwd',
      overviewMovers:'dash-movers', overviewHeatmap:'dash-heatmap',
      overviewSectors:'dash-sectors', overviewAlerts:'dash-alerts',
    }[id];
    if (cbId) {
      const cb = document.getElementById(cbId);
      if (cb) cb.checked = visible;
    }
  });
}

// â”€â”€ API ä½¿ç”¨é‡è¿½è¹¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BUDGET_TOKENS = 200000;   // æ¯æ—¥è»Ÿä¸Šé™ï¼ˆç´„40 TWDï¼‰
const API_WARN_PCT      = 0.7;      // 70% æ™‚è­¦å‘Š

function trackApiUsage(type, estimatedTokens=1000) {
  const today = new Date().toISOString().slice(0,10);
  if (state.apiUsage.date !== today) {
    state.apiUsage = { date: today, calls: 0, estTokens: 0 };
  }
  state.apiUsage.calls++;
  state.apiUsage.estTokens += estimatedTokens;
  localStorage.setItem('apiUsage', JSON.stringify(state.apiUsage));
  updateApiCounter();
  if (state.apiUsage.estTokens > API_BUDGET_TOKENS * API_WARN_PCT) {
    showApiWarning();
  }
}

function updateApiCounter() {
  const el = document.getElementById('apiUsageCounter');
  if (!el) return;
  const pct  = Math.min(state.apiUsage.estTokens / API_BUDGET_TOKENS * 100, 100).toFixed(0);
  const cost = (state.apiUsage.estTokens * 0.000003 * 32).toFixed(1); // ä¼°ç®— TWD
  el.innerHTML = `ğŸ¤– ä»Šæ—¥ ${state.apiUsage.calls} æ¬¡ Â· ç´„ ${cost} å…ƒ`;
  el.style.color = state.apiUsage.estTokens > API_BUDGET_TOKENS * API_WARN_PCT
    ? 'var(--gold)' : 'var(--text-dim)';
}

function showApiWarning() {
  const existing = document.getElementById('apiWarningBanner');
  if (existing) return; // åªé¡¯ç¤ºä¸€æ¬¡
  const banner = document.createElement('div');
  banner.id = 'apiWarningBanner';
  banner.style.cssText = 'position:fixed;bottom:80px;right:20px;z-index:9999;background:rgba(251,191,36,.12);' +
    'border:1px solid rgba(251,191,36,.4);border-radius:10px;padding:12px 16px;font-size:12px;max-width:280px;' +
    'box-shadow:0 4px 20px rgba(0,0,0,.3);';
  banner.innerHTML = `<div style="font-weight:700;color:var(--gold);margin-bottom:4px;">âš ï¸ AI ç”¨é‡æé†’</div>
    <div style="color:var(--text-dim);line-height:1.6;">ä»Šæ—¥ AI å‘¼å«å·²é”é ç®— 70%ï¼Œ<br>è«‹ç•™æ„ä½¿ç”¨é‡ã€‚</div>
    <div style="margin-top:8px;display:flex;gap:8px;">
      <button onclick="document.getElementById('apiWarningBanner').remove()" 
        style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);
        padding:4px;border-radius:6px;cursor:pointer;font-size:11px;">çŸ¥é“äº†</button>
      <button onclick="openApiModal()" 
        style="flex:1;background:var(--gold);border:none;color:#000;
        padding:4px;border-radius:6px;cursor:pointer;font-size:11px;">æŸ¥çœ‹è¨­å®š</button>
    </div>`;
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 10000);
}

function showToast(msg, duration=3000) {
  let toast = document.getElementById('toastMsg');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toastMsg';
    toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);' +
      'background:var(--surface2);border:1px solid var(--border);border-radius:8px;' +
      'padding:10px 20px;font-size:13px;z-index:9999;transition:opacity .3s;white-space:nowrap;' +
      'box-shadow:0 4px 20px rgba(0,0,0,.3);';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => { toast.style.opacity = '0'; }, duration);
}

// â”€â”€ Claude é€šç”¨å‘¼å«ï¼ˆèµ° Worker Proxyï¼ŒKey å­˜åœ¨ Worker Secretï¼‰
async function callClaude(messages, maxTokens=1200) {
  if (!WORKER_URL) throw new Error('è«‹å…ˆè¨­å®š Cloudflare Worker ç¶²å€');
  const res = await fetch(`${WORKER_URL}?type=claude`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: maxTokens,
      messages,
    }),
    signal: AbortSignal.timeout(60000),
  });
  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    throw new Error(err.error || `Worker å›æ‡‰ ${res.status}`);
  }
  const data = await res.json();
  if (data.error) {
    // Anthropic error æ˜¯ { type, message } ç‰©ä»¶
    const errMsg = typeof data.error === 'string'
      ? data.error
      : (data.error?.message || JSON.stringify(data.error));
    throw new Error(errMsg);
  }
  return data.content?.[0]?.text || '';
}

async function callClaudeAPI(userMsg) {
  const idx = state.twseIndex || {};
  const sp  = state.yahooData['^GSPC']    || {};
  const twd = state.yahooData['USDTWD=X'] || {};
  const vix = state.yahooData['^VIX']     || {};

  const mkt = [
    idx.changePct !== undefined ? `å°è‚¡å¤§ç›¤ ${idx.changePct>=0?'+':''}${idx.changePct}%` : '',
    sp.changePct  !== undefined ? `S&P500 ${sp.changePct>=0?'+':''}${sp.changePct}%` : '',
    twd.price ? `USD/TWD ${twd.price.toFixed(2)}` : '',
    vix.price ? `VIX ${vix.price}` : '',
  ].filter(Boolean).join(' | ');

  const prompt = `ä½ æ˜¯å°ç£è‚¡å¸‚AIåˆ†æå¸«ï¼Œç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œ300å­—ä»¥å…§ï¼Œå«é‡åŒ–æŒ‡æ¨™+æ“ä½œå»ºè­°ã€‚
å¸‚å ´ç’°å¢ƒï¼š${mkt || 'è³‡æ–™è¼‰å…¥ä¸­'}
å•é¡Œï¼š${userMsg}`;

  trackApiUsage('chat', 800);
  try {
    const reply = await callClaude([{ role: 'user', content: prompt }], 800);
    const thinking = document.getElementById('thinking');
    if (thinking) thinking.remove();
    appendChat(reply.replace(/\n/g, '<br>'), 'ai');
    // æ›´æ–° AI ä½¿ç”¨è¨ˆæ•¸
    trackAiUsage('chat');
  } catch (err) {
    const thinking = document.getElementById('thinking');
    if (thinking) thinking.remove();
    appendChat(`âŒ é€£ç·šå¤±æ•—ï¼š${err.message}`, 'ai');
  }
}




// ============================================================
// TOP 10 æ½›åŠ›è‚¡
// ============================================================
async function runPotentialAnalysis() {
  if (!WORKER_URL) {
    document.getElementById('potentialList').innerHTML =
      '<div class="notice-bar">âš ï¸ éœ€è¨­å®š Cloudflare Worker ä¸¦åœ¨ Worker Secrets åŠ å…¥ CLAUDE_API_KEY</div>';
    return;
  }
  document.getElementById('potentialList').innerHTML =
    '<div class="loading"><div class="spinner"></div> AI åˆ†æä¸­ï¼Œè©•ä¼°æ‰€æœ‰è‚¡ç¥¨æ½›åŠ›...</div>';

  try {
    const ptPool   = document.getElementById('pt-pool')?.value || 'all';
    const useMom   = document.getElementById('pt-mom')?.checked;
    const useVal   = document.getElementById('pt-val')?.checked;
    const useSec   = document.getElementById('pt-sec')?.checked;
    const useUS    = document.getElementById('pt-us')?.checked;
    const useInst  = document.getElementById('pt-inst')?.checked;

    // æ±ºå®šå€™é¸è‚¡ç¥¨æ± 
    let poolCodes;
    if (ptPool === 'semi')    poolCodes = [...(SECTOR_STOCKS['åŠå°é«”']||[]), ...(SECTOR_STOCKS['AIä¼ºæœå™¨']||[])];
    else if (ptPool === 'finance') poolCodes = SECTOR_STOCKS['é‡‘èä¿éšª']||[];
    else if (ptPool === 'trad')    poolCodes = [...(SECTOR_STOCKS['å‚³ç”¢']||[]),...(SECTOR_STOCKS['é¢æ¿']||[])];
    else poolCodes = Object.keys({...state.stockCache, ...STOCK_STATIC});

    // æ•´åˆè³‡æ–™
    const allStocks = [...new Set(poolCodes)].map(code => {
      const s  = state.stockCache[code] || {};
      const st = STOCK_STATIC[code] || {};
      return {
        code, name: s.name || STOCK_NAMES[code] || code,
        price: s.price||0, changePct: s.changePct||0, volume: s.volume||0,
        pe: s.pe||st.pe||'-', yield: s.yield||st.yield||'-',
        sector: s.sector||st.sector||'å…¶ä»–',
      };
    }).filter(s => s.name && s.name !== s.code);

    if (allStocks.length < 3) {
      document.getElementById('potentialList').innerHTML =
        '<div style="color:var(--gold);padding:20px;text-align:center;">è³‡æ–™ä¸è¶³ï¼Œè«‹ç­‰å¸‚å ´è³‡æ–™è¼‰å…¥å¾Œå†è©¦</div>';
      return;
    }

    // å¤–éƒ¨å¸‚å ´ç’°å¢ƒ
    const sp  = state.yahooData['^GSPC']   || {};
    const sox = state.yahooData['^SOX']    || {};
    const vix = state.yahooData['^VIX']    || {};
    const twd = state.yahooData['USDTWD=X']|| {};
    const idx = state.twseIndex || {};

    const marketCtx = [];
    if (useUS && sp.changePct !== undefined)
      marketCtx.push(`S&P500 ${sp.changePct>=0?'+':''}${sp.changePct}%, SOX ${sox.changePct>=0?'+':''}${sox.changePct}%`);
    if (vix.price) marketCtx.push(`VIX ${vix.price}`);
    if (twd.price) marketCtx.push(`USD/TWD ${twd.price} (${twd.changePct>=0?'+':''}${twd.changePct}%)`);
    if (idx.changePct !== undefined) marketCtx.push(`å°è‚¡å¤§ç›¤ ${idx.changePct>=0?'+':''}${idx.changePct}%`);

    const prompt = `ä½ æ˜¯å°ç£è‚¡å¸‚é‡åŒ–åˆ†æå¸«ã€‚å¾ä»¥ä¸‹è‚¡ç¥¨ä¸­æŒ‘é¸ Top 10 æœ€å…·æŠ•è³‡æ½›åŠ›çš„è‚¡ç¥¨ï¼Œçµ¦å‡ºè©•åˆ†èˆ‡ç†ç”±ã€‚

ã€ä»Šæ—¥å¸‚å ´ç’°å¢ƒã€‘
${marketCtx.join(' | ') || 'è³‡æ–™å¾…æ›´æ–°'}

ã€å€™é¸è‚¡ç¥¨ï¼ˆå…± ${allStocks.length} æ”¯ï¼‰ã€‘
${allStocks.map(s =>
  `${s.code} ${s.name} ç¾åƒ¹${s.price} ä»Šæ—¥${s.changePct>=0?'+':''}${s.changePct}% PE=${s.pe} æ®–åˆ©ç‡=${s.yield}% é¡è‚¡=${s.sector}`
).join('\n')}

ã€è©•ä¼°æ¨™æº–ã€‘ï¼ˆä¾å‹¾é¸çš„ç¶­åº¦ï¼‰
${useVal ? '- ä¼°å€¼ï¼šPEä½ã€æ®–åˆ©ç‡é«˜è€…åŠ åˆ†' : ''}
${useMom ? '- å‹•èƒ½ï¼šé‡èƒ½æ”¾å¤§ã€ä»Šæ—¥æ¼²å¹…å¼·è€…åŠ åˆ†' : ''}
${useSec ? '- é¡è‚¡ï¼šç†±é–€é¡è‚¡ï¼ˆAIã€åŠå°é«”ï¼‰æ™¯æ°£åŠ åˆ†' : ''}
${useUS  ? '- ç¾è‚¡ï¼šèˆ‡è²»åŠé«˜ç›¸é—œä¸”ç¾è‚¡ä»Šæ—¥è¡¨ç¾åŠ åˆ†' : ''}

è¦å‰‡ï¼š
1. åªèƒ½å¾ä¸Šæ–¹åˆ—è¡¨é¸ 10 æ”¯
2. score è¦æœ‰çœŸå¯¦æ ¹æ“šï¼Œä¸èƒ½å…¨éƒ¨å·®ä¸å¤šåˆ†
3. potential æ˜¯æœªä¾†æˆé•·æ½›åŠ›æè¿°ï¼Œ30-50å­—
4. catalysts æ˜¯å‚¬åŒ–åŠ‘ï¼Œ2-3å€‹

å¿…é ˆå›å‚³ JSONï¼ˆä¸è¦å…¶ä»–æ–‡å­—ï¼‰ï¼š
{
  "top10": [
    {"code":"ä»£è™Ÿ","name":"åç¨±","score":æ•¸å­—,"rec":"buy/hold","potential":"æ½›åŠ›èªªæ˜","catalysts":["å‚¬åŒ–åŠ‘1","å‚¬åŒ–åŠ‘2"]}
  ],
  "marketView": "æ•´é«”å¸‚å ´çœ‹æ³•ï¼Œ40å­—ä»¥å…§"
}`;

    trackApiUsage('potential', 2000);
    trackAiUsage('potential');
    const raw    = await callClaude([{ role:'user', content: prompt }], 2000);
    const json   = raw.match(/\{[\s\S]*\}/)?.[0];
    if (!json) throw new Error('AI å›æ‡‰æ ¼å¼ç•°å¸¸');
    const result = JSON.parse(json);

    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ğŸ”Ÿ'];
    document.getElementById('potentialList').innerHTML = `
      <div style="background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.15);border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:13px;line-height:1.6;">
        ğŸ“Š å¸‚å ´è§€é»ï¼š${result.marketView || ''}
      </div>
      ${(result.top10||[]).map((s, i) => {
        const cached = state.stockCache[s.code];
        const pct    = cached?.changePct || 0;
        const price  = cached?.price     || 0;
        const cls    = pct >= 0 ? 'up' : 'down';
        const scoreColor = s.score>=80?'var(--green)':s.score>=60?'var(--accent)':'var(--gold)';
        return `<div class="ai-score ${s.rec||'hold'}" style="margin-bottom:10px;">
          <div style="font-size:24px;width:40px;text-align:center;flex-shrink:0;">${medals[i]}</div>
          <div class="score-circle ${s.rec||'hold'}" style="background:none;border:2px solid ${scoreColor};color:${scoreColor};">
            <div style="font-size:18px;font-weight:700;">${s.score}</div>
            <div style="font-size:9px;color:var(--text-dim);">åˆ†</div>
          </div>
          <div class="ai-stock-info" style="flex:1;">
            <div class="ai-stock-name">
              ${s.name} <span class="stock-code">${s.code}</span>
              ${price > 0 ? `<span class="${cls}" style="font-size:11px;font-family:'Space Mono',monospace;margin-left:6px;">${price.toFixed(1)} ${pct>=0?'+':''}${pct.toFixed(2)}%</span>` : ''}
            </div>
            <div class="ai-reason">${s.potential}</div>
            <div class="ai-tags">
              ${(s.catalysts||[]).map(c=>`<span class="tag tag-green">${c}</span>`).join('')}
            </div>
          </div>
          <button class="btn-outline" style="flex-shrink:0;"
            onclick="quickChat('æ·±å…¥åˆ†æ ${s.name}(${s.code}) çš„æŠ•è³‡æ½›åŠ›èˆ‡é¢¨éšª')">åˆ†æ</button>
        </div>`;
      }).join('')}
      <div style="font-size:11px;color:var(--text-muted);margin-top:12px;text-align:center;">
        åˆ†ææ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')} âˆ™ å€™é¸è‚¡ç¥¨ï¼š${allStocks.length} æ”¯ âˆ™ åƒ…ä¾›åƒè€ƒ
      </div>`;
  } catch(e) {
    document.getElementById('potentialList').innerHTML =
      `<div style="color:var(--red);padding:20px;text-align:center;">âŒ åˆ†æå¤±æ•—ï¼š${e.message}</div>`;
  }
}

// ============================================================
// æŒè‚¡åˆ†æï¼ˆå•9ï¼‰
// ============================================================
async function analyzeHolding(code) {
  if (!WORKER_URL) { alert('éœ€å…ˆè¨­å®š Cloudflare Worker ç¶²å€'); return; }
  const h = state.portfolio.find(p => p.code === code);
  if (!h) return;
  const s  = state.stockCache[code] || {};
  const st = STOCK_STATIC[code]     || {};
  const price     = s.price || 0;
  const costTotal = h.cost * h.lots;
  const curVal    = price   * h.lots;
  const pnl       = curVal  - costTotal;
  const pnlPct    = costTotal > 0 ? (pnl/costTotal*100).toFixed(2) : 0;

  // å¤–éƒ¨è³‡æ–™
  const sp  = state.yahooData['^GSPC']    || {};
  const sox = state.yahooData['^SOX']     || {};
  const twd = state.yahooData['USDTWD=X'] || {};
  const idx = state.twseIndex || {};

  const prompt = `ä½ æ˜¯å°ˆæ¥­å°ç£è‚¡å¸‚æŠ•è³‡é¡§å•ã€‚é‡å°ä»¥ä¸‹æŒè‚¡ç‹€æ³çµ¦å‡ºå…·é«”åˆ†æå»ºè­°ã€‚

ã€æŒè‚¡è³‡æ–™ã€‘
è‚¡ç¥¨ï¼š${s.name||STOCK_NAMES[code]||code}ï¼ˆ${code}ï¼‰
ç¾åƒ¹ï¼š${price} å…ƒ ï½œ æŒè‚¡ï¼š${h.lots.toLocaleString()} è‚¡
æˆæœ¬ï¼š${h.cost} å…ƒ ï½œ æœªå¯¦ç¾æç›Šï¼š${pnl>=0?'+':''}${pnl.toLocaleString()} å…ƒ (${pnlPct}%)
PEï¼š${s.pe||st.pe||'-'} ï½œ æ®–åˆ©ç‡ï¼š${s.yield||st.yield||'-'}% ï½œ é¡è‚¡ï¼š${s.sector||st.sector||'-'}
ä»Šæ—¥æ¼²è·Œï¼š${s.changePct>=0?'+':''}${s.changePct||0}%

ã€å¸‚å ´ç’°å¢ƒã€‘
å¤§ç›¤ï¼š${idx.changePct>=0?'+':''}${idx.changePct||0}%
ç¾è‚¡S&P500ï¼š${sp.changePct>=0?'+':''}${sp.changePct||0}%
è²»åŠSOXï¼š${sox.changePct>=0?'+':''}${sox.changePct||0}%
USD/TWDï¼š${twd.price||'--'}

è«‹çµ¦å‡ºä»¥ä¸‹åˆ†æï¼ˆJSONæ ¼å¼ï¼Œä¸è¦å…¶ä»–æ–‡å­—ï¼‰ï¼š
{
  "trend": "ä¸Šæ¼²|ä¸‹è·Œ|ç›¤æ•´",
  "trendReason": "è¶¨å‹¢åˆ¤æ–·ä¾æ“šï¼Œ40å­—",
  "confidence": æ•¸å­—0-100,
  "action": "åŠ ç¢¼è²·å…¥|æŒæœ‰ä¸å‹•|æ¸›ç¢¼|å»ºè­°è³£å‡º",
  "actionReason": "æ“ä½œå»ºè­°å…·é«”èªªæ˜ï¼Œ50å­—",
  "stopLoss": "å»ºè­°åœæåƒ¹ä½æˆ–å€é–“",
  "target": "åˆç†ç›®æ¨™åƒ¹æˆ–å€é–“",
  "risks": ["é¢¨éšª1","é¢¨éšª2"],
  "opportunities": ["æ©Ÿæœƒ1","æ©Ÿæœƒ2"]
}`;

  // é¡¯ç¤ºåˆ†æå½ˆçª—
  let modal = document.getElementById('holdingAnalysisModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'holdingAnalysisModal';
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.innerHTML = `<div class="modal" style="max-width:520px;width:95%;">
      <div class="modal-title">ğŸ“Š æŒè‚¡åˆ†æ</div>
      <div id="holdingAnalysisContent"><div class="loading"><div class="spinner"></div> AI åˆ†æä¸­...</div></div>
      <div class="modal-actions">
        <button class="btn-outline" onclick="document.getElementById('holdingAnalysisModal').style.display='none'">é—œé–‰</button>
        <button class="btn" onclick="quickChat('æ·±å…¥è¨è«– ${s.name||code} çš„æ“ä½œç­–ç•¥')">AI æ·±å…¥è¨è«–</button>
      </div>
    </div>`;
    document.body.appendChild(modal);
  } else {
    modal.style.display = 'flex';
    document.getElementById('holdingAnalysisContent').innerHTML =
      '<div class="loading"><div class="spinner"></div> AI åˆ†æä¸­...</div>';
  }

  try {
    trackApiUsage('holding', 800);
    trackAiUsage('holding');
    const raw    = await callClaude([{ role:'user', content: prompt }], 800);
    const json   = raw.match(/\{[\s\S]*\}/)?.[0];
    if (!json) throw new Error('æ ¼å¼ç•°å¸¸');
    const r      = JSON.parse(json);
    const trendIcon = r.trend==='ä¸Šæ¼²'?'â†‘':r.trend==='ä¸‹è·Œ'?'â†“':'â†’';
    const trendCls  = r.trend==='ä¸Šæ¼²'?'up':r.trend==='ä¸‹è·Œ'?'down':'';
    const actionCls = r.action.includes('è²·')?'var(--green)':r.action.includes('è³£')?'var(--red)':'var(--gold)';
    const confColor = r.confidence>=80?'var(--green)':r.confidence>=60?'var(--gold)':'var(--red)';

    document.getElementById('holdingAnalysisContent').innerHTML = `
      <div style="background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-weight:700;">${s.name||code}ï¼ˆ${code}ï¼‰</span>
          <span class="${pnl>=0?'up':'down'}" style="font-size:13px;font-family:'Space Mono',monospace;">
            ${pnl>=0?'+':''}${Math.round(pnl).toLocaleString()} å…ƒï¼ˆ${pnlPct}%ï¼‰
          </span>
        </div>
        <div style="font-size:12px;color:var(--text-dim);">æˆæœ¬ ${h.cost} ï½œç¾åƒ¹ ${price} ï½œæŒè‚¡ ${h.lots.toLocaleString()} è‚¡</div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
        <div style="background:var(--surface2);border-radius:8px;padding:12px;text-align:center;">
          <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">è¶¨å‹¢åˆ¤æ–·</div>
          <div class="${trendCls}" style="font-size:22px;font-weight:700;">${trendIcon} ${r.trend}</div>
          <div style="font-size:10px;color:${confColor};margin-top:2px;">ä¿¡å¿ƒåº¦ ${r.confidence}%</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:12px;text-align:center;">
          <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">æ“ä½œå»ºè­°</div>
          <div style="font-size:16px;font-weight:700;color:${actionCls};">${r.action}</div>
        </div>
      </div>

      <div style="font-size:12px;color:var(--text-dim);margin-bottom:4px;">è¶¨å‹¢ä¾æ“š</div>
      <div style="font-size:13px;margin-bottom:12px;">${r.trendReason}</div>

      <div style="font-size:12px;color:var(--text-dim);margin-bottom:4px;">æ“ä½œç†ç”±</div>
      <div style="font-size:13px;margin-bottom:12px;">${r.actionReason}</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
        <div style="background:rgba(239,68,68,.08);border-radius:8px;padding:10px;">
          <div style="font-size:11px;color:var(--red);margin-bottom:4px;">ğŸ›‘ åœæåƒè€ƒ</div>
          <div style="font-size:13px;font-weight:500;">${r.stopLoss}</div>
        </div>
        <div style="background:rgba(16,185,129,.08);border-radius:8px;padding:10px;">
          <div style="font-size:11px;color:var(--green);margin-bottom:4px;">ğŸ¯ ç›®æ¨™åƒ¹åƒè€ƒ</div>
          <div style="font-size:13px;font-weight:500;">${r.target}</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <div style="font-size:11px;color:var(--red);margin-bottom:4px;">âš ï¸ ä¸»è¦é¢¨éšª</div>
          ${(r.risks||[]).map(x=>`<div style="font-size:12px;margin-bottom:3px;">â€¢ ${x}</div>`).join('')}
        </div>
        <div>
          <div style="font-size:11px;color:var(--green);margin-bottom:4px;">âœ… æ½›åœ¨æ©Ÿæœƒ</div>
          ${(r.opportunities||[]).map(x=>`<div style="font-size:12px;margin-bottom:3px;">â€¢ ${x}</div>`).join('')}
        </div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:12px;text-align:center;">âš ï¸ ä»¥ä¸Šåˆ†æåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°</div>`;
  } catch(e) {
    document.getElementById('holdingAnalysisContent').innerHTML =
      `<div style="color:var(--red);padding:20px;text-align:center;">âŒ åˆ†æå¤±æ•—ï¼š${e.message}</div>`;
  }
}

// ============================================================
// INSTITUTIONAL â€” ä¸‰å¤§æ³•äººè²·è³£è¶…
// ============================================================
async function loadInstitutional() {
  if (!WORKER_URL) {
    document.getElementById('instNote').textContent =
      'âš ï¸ éœ€è¨­å®š Cloudflare Worker æ‰èƒ½è¼‰å…¥æ³•äººè³‡æ–™ï¼ˆWorker æœ‰ TWSE T86 endpointï¼‰';
    document.getElementById('instBuyTable').innerHTML =
      '<div class="notice-bar">è«‹å…ˆè¨­å®š Worker ç¶²å€</div>';
    document.getElementById('instSellTable').innerHTML = '';
    document.getElementById('instTotalTable').innerHTML = '';
    return;
  }
  try {
    const today = getTWSEDateStr();
    const res   = await fetch(`${WORKER_URL}?type=institutional&date=${today}`,
      { signal: AbortSignal.timeout(12000) });
    if (!res.ok) throw new Error(`Worker å›æ‡‰ ${res.status}`);
    const data  = await res.json();
    if (data.error) throw new Error(data.error);
    renderInstitutional(data);
  } catch(e) {
    const msg = `<div style="color:var(--gold);padding:20px;text-align:center;font-size:13px;">âš ï¸ è¼‰å…¥å¤±æ•—ï¼š${e.message}<br><button class="btn-outline" style="margin-top:8px;" onclick="loadInstitutional()">é‡è©¦</button></div>`;
    document.getElementById('instBuyTable').innerHTML  = msg;
    document.getElementById('instSellTable').innerHTML = '';
    document.getElementById('instTotalTable').innerHTML= '';
  }
}

function renderInstitutional(data) {
  // ç¸½è¨ˆ
  const buySum  = (data.totalNetBuy  / 1000).toFixed(0);
  const sellSum = (data.totalNetSell / 1000).toFixed(0);
  document.getElementById('inst-total-buy').textContent  = `+${Number(buySum).toLocaleString()} åƒå¼µ`;
  document.getElementById('inst-total-sell').textContent = `${Number(sellSum).toLocaleString()} åƒå¼µ`;
  document.getElementById('inst-date').textContent =
    data.date ? `${data.date.slice(0,4)}/${data.date.slice(4,6)}/${data.date.slice(6,8)}` : '--';

  // è¡¨æ ¼æ¸²æŸ“
  const makeTable = (rows, isPositive) => {
    if (!rows?.length) return '<div style="color:var(--text-dim);padding:20px;text-align:center;">ç„¡è³‡æ–™</div>';
    const max = Math.abs(rows[0]?.foreignNet || 1);
    return `<table class="data-table" style="width:100%;">
      <thead><tr>
        <th style="text-align:left;">è‚¡ç¥¨</th>
        <th style="text-align:right;">å¤–è³‡æ·¨è²·è¶…(å¼µ)</th>
        <th style="text-align:right;">æŠ•ä¿¡</th>
        <th style="text-align:right;">ä¸‰å¤§åˆè¨ˆ</th>
        <th style="width:100px;"></th>
      </tr></thead>
      <tbody>
      ${rows.map((s,i) => {
        const fNet  = s.foreignNet;
        const cls   = fNet >= 0 ? 'up' : 'down';
        const barW  = Math.min(Math.abs(fNet) / max * 100, 100).toFixed(0);
        const barC  = fNet >= 0 ? 'var(--green)' : 'var(--red)';
        const cached= state.stockCache[s.code];
        const price = cached ? `<span style="font-size:11px;color:var(--text-dim);">${cached.price.toFixed(1)}</span>` : '';
        return `<tr onclick="showStockDetail('${s.code}')" style="cursor:pointer;">
          <td>
            <div style="font-weight:500;">${s.name}</div>
            <div style="font-size:11px;color:var(--text-dim);">${s.code} ${price}</div>
          </td>
          <td class="${cls}" style="text-align:right;font-family:'Space Mono',monospace;font-size:13px;">
            ${fNet >= 0 ? '+' : ''}${fNet.toLocaleString()}
          </td>
          <td style="text-align:right;font-size:12px;color:var(--text-dim);">
            ${s.trustNet >= 0 ? '+' : ''}${s.trustNet.toLocaleString()}
          </td>
          <td style="text-align:right;font-size:12px;color:${s.totalNet>=0?'var(--green)':'var(--red)'};">
            ${s.totalNet >= 0 ? '+' : ''}${s.totalNet.toLocaleString()}
          </td>
          <td>
            <div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;">
              <div style="height:100%;width:${barW}%;background:${barC};border-radius:3px;"></div>
            </div>
          </td>
        </tr>`;
      }).join('')}
      </tbody>
    </table>`;
  };

  document.getElementById('instBuyTable').innerHTML   = makeTable(data.topBuy,   true);
  document.getElementById('instSellTable').innerHTML  = makeTable(data.topSell,  false);
  document.getElementById('instTotalTable').innerHTML = makeTable(data.topTotal,  true);
}

// ============================================================
// TREND ANALYSIS â€” æ ¸å¿ƒå¼•æ“
// ============================================================

// è¶¨å‹¢åˆ†æç‹€æ…‹
const trendState = {
  currentCode: null,
  analyzing: false,
  lastResult: null,
};

// åˆå§‹åŒ–è¶¨å‹¢é é¢ï¼ˆåœ¨ loadAllData å®Œæˆå¾Œå‘¼å«ï¼‰
function initTrendPage() {
  // ç”¨è‡ªé¸è‚¡ç”Ÿæˆå¿«é€Ÿé¸æ“‡æ™¶ç‰‡
  const picker = document.getElementById('trendStockPicker');
  if (!picker) return;
  const codes = state.watchlist.slice(0, 8);
  picker.innerHTML = codes.map(code => {
    const name = state.stockCache[code]?.name || STOCK_NAMES[code] || code;
    return `<div class="stock-pick-chip" onclick="selectTrendStock('${code}', this)">
      ${code} Â· ${name}
    </div>`;
  }).join('');
  // æ›´æ–°å¸‚å ´æ©«å¹…
  updateMarketTrendBanner();
}

// æ›´æ–°å¸‚å ´ç¸½é«”è¶¨å‹¢æ©«å¹…
function updateMarketTrendBanner() {
  const idx = state.twseIndex;
  if (idx) {
    const isUp = idx.changePct >= 0;
    const el = document.getElementById('mtrend-twse');
    el.textContent = (isUp ? 'â†‘ åå¤š' : 'â†“ åç©º');
    el.className = `mtrend-value ${isUp ? 'up' : 'down'}`;
    document.getElementById('mtrend-twse-sub').textContent =
      `${isUp ? '+' : ''}${idx.changePct.toFixed(2)}% ä»Šæ—¥`;
  }
  const sp = state.yahooData['^GSPC'];
  const sox = state.yahooData['^SOX'];
  if (sp) {
    const isUp = sp.changePct >= 0;
    const el = document.getElementById('mtrend-us');
    el.textContent = (isUp ? 'â†‘ æ­£é¢' : 'â†“ è² é¢');
    el.className = `mtrend-value ${isUp ? 'up' : 'down'}`;
    const soxStr = sox ? ` / SOX ${sox.changePct >= 0 ? '+' : ''}${sox.changePct.toFixed(1)}%` : '';
    document.getElementById('mtrend-us-sub').textContent = `S&P ${sp.changePct >= 0 ? '+' : ''}${sp.changePct.toFixed(2)}%${soxStr}`;
  }
}

function selectTrendStock(code, el) {
  document.querySelectorAll('.stock-pick-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  analyzeTrend(code);
}

// â”€â”€ ä¸»åˆ†æå‡½å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyzeTrend(code) {
  code = code.trim().replace(/\D/g, '');
  if (!code) return;
  if (trendState.analyzing) return;

  if (!WORKER_URL) {
    document.getElementById('trendResult').innerHTML = `
      <div class="notice-bar" style="margin:0;">
        âš ï¸ éœ€å…ˆè¨­å®š Cloudflare Worker ç¶²å€ï¼ˆä¸¦åœ¨ Worker çš„ Secrets åŠ å…¥ CLAUDE_API_KEYï¼‰ã€‚
        <button class="btn-outline" style="margin-left:12px;" onclick="openApiModal()">ç«‹å³è¨­å®š</button>
      </div>`;
    return;
  }

  trendState.analyzing = true;
  trendState.currentCode = code;

  // ç¢ºä¿æœ‰è©²è‚¡ç¥¨è³‡æ–™
  if (!state.stockCache[code]) {
    await fetchStockPrices([code]);
  }

  showTrendLoading(code);

  try {
    // â‘  çµ„è£å¸‚å ´äº‹å¯¦è³‡æ–™
    const facts = buildFactSheet(code);
    // â‘¡ å»ºæ§‹åš´è¬¹ prompt
    const prompt = buildTrendPrompt(code, facts);
    // â‘¢ å‘¼å« Claude API
    const raw = await callClaudeForTrend(prompt);
    // â‘£ è§£æçµæ§‹åŒ–å›æ‡‰
    const result = parseTrendResponse(raw);
    // â‘¤ æ¸²æŸ“
    renderTrendResult(code, result, facts);
    trendState.lastResult = result;
  } catch(e) {
    document.getElementById('trendResult').innerHTML = `
      <div class="card">
        <div style="color:var(--red);font-size:13px;">âŒ åˆ†æå¤±æ•—ï¼š${e.message}</div>
      </div>`;
  }
  trendState.analyzing = false;
}

// â”€â”€ çµ„è£äº‹å¯¦è³‡æ–™è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFactSheet(code) {
  const s       = state.stockCache[code] || {};
  const st      = STOCK_STATIC[code] || {};
  const idx     = state.twseIndex || {};
  const sp500   = state.yahooData['^GSPC']   || {};
  const nasdaq  = state.yahooData['^IXIC']   || {};
  const sox     = state.yahooData['^SOX']    || {};
  const vix     = state.yahooData['^VIX']    || {};
  const twd     = state.yahooData['USDTWD=X']|| {};
  const tnx     = state.yahooData['^TNX']    || {};

  // äº¤æ˜“ç‹€æ…‹åˆ¤æ–·
  const now         = new Date();
  const hh          = now.getHours() + now.getMinutes()/60;
  const isTradingHr = hh >= 9 && hh <= 13.5;
  const isWeekend   = now.getDay() === 0 || now.getDay() === 6;
  const marketOpen  = isTradingHr && !isWeekend;
  const dataStatus  = s.price > 0 ? (marketOpen ? 'ç›¤ä¸­å³æ™‚' : 'ç›¤å¾Œæ”¶ç›¤') : 'éäº¤æ˜“æ™‚æ®µ/è³‡æ–™å¾…è¼‰å…¥';

  // é¡è‚¡åŒä¼´å¹³å‡
  const sectorStocks = Object.entries(SECTOR_STOCKS)
    .find(([, codes]) => codes.includes(code))?.[1] || [];
  const peers = sectorStocks
    .filter(c2 => c2 !== code && state.stockCache[c2]?.price > 0)
    .map(c2 => ({ code:c2, name:state.stockCache[c2].name, changePct:state.stockCache[c2].changePct }));
  const sectorAvg = peers.length
    ? peers.reduce((a,b) => a + b.changePct, 0) / peers.length : null;

  // æˆäº¤é‡
  const volumeNote = s.volume > 0
    ? (s.volume > 50000 ? 'æˆäº¤é‡é¡¯è‘—æ”¾å¤§' : s.volume < 5000 ? 'æˆäº¤é‡èç¸®' : 'æˆäº¤é‡æ­£å¸¸')
    : 'ï¼ˆéäº¤æ˜“æ™‚æ®µï¼Œç„¡æˆäº¤é‡è³‡æ–™ï¼‰';

  // è¿‘æœŸæ–°è
  const stockName = s.name || STOCK_NAMES[code] || code;
  const relNews   = (state.rssNews || [])
    .filter(n => n.title && (n.title.includes(stockName) || n.title.includes(code)))
    .slice(0, 3).map(n => n.title);

  return {
    code,
    name         : stockName,
    price        : s.price || 0,
    change       : s.change || 0,
    changePct    : s.changePct || 0,
    open         : s.open  || 0,
    high         : s.high  || 0,
    low          : s.low   || 0,
    prev         : s.prev  || s.price || 0,
    volume       : s.volume || 0,
    volumeNote,
    pe           : s.pe || st.pe || '-',
    dividendYield: s.yield || st.yield || '-',
    sector       : s.sector || st.sector || 'æœªåˆ†é¡',
    dataStatus,
    marketOpen,
    twseChangePct: idx.changePct || 0,
    twseChange   : idx.change || 0,
    sp500Pct     : sp500.changePct || 0,
    nasdaqPct    : nasdaq.changePct || 0,
    soxPct       : sox.changePct || 0,
    vix          : vix.price || 0,
    usdtwd       : twd.price || 0,
    usdtwdPct    : twd.changePct || 0,
    tnx          : tnx.price || 0,
    sectorAvg,
    peers        : peers.slice(0, 4),
    relatedNews  : relNews,
    analysisTime : now.toLocaleString('zh-TW', { timeZone:'Asia/Taipei' }),
  };
}

// â”€â”€ å»ºæ§‹ Promptï¼ˆæ ¸å¿ƒï¼šè¦æ±‚çµæ§‹åŒ– JSON + 90% ä¿¡å¿ƒæ¨™æº–ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€
function buildTrendPrompt(code, f) {
  const usePrice   = document.getElementById('ta-price')?.checked;
  const useVolume  = document.getElementById('ta-volume')?.checked;
  const useUS      = document.getElementById('ta-us')?.checked;
  const useFX      = document.getElementById('ta-fx')?.checked;
  const useNews    = document.getElementById('ta-news')?.checked;
  const useSector  = document.getElementById('ta-sector')?.checked;
  const usePE      = document.getElementById('ta-pe')?.checked;

  const dataBlocks = [];

  if (usePrice) dataBlocks.push(`ã€å€‹è‚¡å³æ™‚è³‡æ–™ - ä¾†æºï¼šå°ç£è­‰äº¤æ‰€å®˜æ–¹APIã€‘
è‚¡ç¥¨ï¼š${f.name}ï¼ˆ${f.code}ï¼‰
è³‡æ–™ç‹€æ…‹ï¼š${f.dataStatus}
ç¾åƒ¹ï¼š${f.price > 0 ? f.price + ' å…ƒ' : 'å°šæœªè¼‰å…¥ï¼ˆå¯èƒ½ç‚ºéäº¤æ˜“æ™‚æ®µï¼‰'}
${f.price > 0 ? `ä»Šæ—¥æ¼²è·Œï¼š${f.change >= 0 ? '+' : ''}${f.change} å…ƒ (${f.changePct >= 0 ? '+' : ''}${f.changePct}%)
é–‹ç›¤ï¼š${f.open || '--'} / æœ€é«˜ï¼š${f.high || '--'} / æœ€ä½ï¼š${f.low || '--'} / æ˜¨æ”¶ï¼š${f.prev || '--'}` : 'ï¼ˆè«‹åœ¨äº¤æ˜“æ—¥ 09:00-13:30 æœŸé–“æŸ¥çœ‹å³æ™‚è³‡æ–™ï¼‰'}
PEï¼š${f.pe} | æ®–åˆ©ç‡ï¼š${f.dividendYield}% | é¡è‚¡ï¼š${f.sector}`);

  if (useVolume) dataBlocks.push(`ã€æˆäº¤é‡è³‡æ–™ - ä¾†æºï¼šå°ç£è­‰äº¤æ‰€å®˜æ–¹APIã€‘
ä»Šæ—¥æˆäº¤å¼µæ•¸ï¼š${f.volume.toLocaleString()}
é‡èƒ½è©•ä¼°ï¼š${f.volumeNote}`);

  if (useUS) dataBlocks.push(`ã€ç¾è‚¡æŒ‡æ•¸ - ä¾†æºï¼šYahoo Financeã€‘
S&P 500ï¼š${f.sp500Pct >= 0 ? '+' : ''}${f.sp500Pct}%
NASDAQï¼š${f.nasdaqPct >= 0 ? '+' : ''}${f.nasdaqPct}%
è²»åŸåŠå°é«”æŒ‡æ•¸(SOX)ï¼š${f.soxPct >= 0 ? '+' : ''}${f.soxPct}%
VIX ææ…ŒæŒ‡æ•¸ï¼š${f.vix}ï¼ˆ${f.vix > 25 ? 'é«˜ææ…Œ' : f.vix > 18 ? 'ä¸­ç­‰' : 'å¸‚å ´å¹³éœ'}ï¼‰
ç¾åœ‹10å¹´æœŸå…¬å‚µæ®–åˆ©ç‡ï¼š${f.tnx}%`);

  if (useFX) dataBlocks.push(`ã€åŒ¯ç‡ - ä¾†æºï¼šYahoo Financeã€‘
USD/TWDï¼š${f.usdtwd}ï¼ˆä»Šæ—¥${f.usdtwdPct >= 0 ? '+' : ''}${f.usdtwdPct}%ï¼‰
åŒ¯ç‡èµ°å‹¢å°å‡ºå£å» å½±éŸ¿ï¼š${f.usdtwdPct > 0.3 ? 'å°å¹£è²¶å€¼ï¼Œæœ‰åˆ©å‡ºå£' : f.usdtwdPct < -0.3 ? 'å°å¹£å‡å€¼ï¼Œä¸åˆ©å‡ºå£' : 'åŒ¯ç‡å½±éŸ¿ä¸­æ€§'}`);

  if (useSector) {
    let sectorTxt = `æœ¬è‚¡é¡åˆ¥ï¼š${f.sector}
å¤§ç›¤åŠ æ¬ŠæŒ‡æ•¸ä»Šæ—¥ï¼š${f.twseChangePct >= 0 ? '+' : ''}${f.twseChangePct}%
`;
    if (f.sectorAvg !== null) sectorTxt += `${f.sector}é¡è‚¡å¹³å‡ï¼š${f.sectorAvg >= 0 ? '+' : ''}${f.sectorAvg.toFixed(2)}%
`;
    if (f.peers.length) sectorTxt += `åŒé¡è‚¡è¡¨ç¾ï¼š${f.peers.map(p => `${p.name}${p.changePct >= 0 ? '+' : ''}${p.changePct}%`).join('ã€')}`;
    dataBlocks.push(`ã€é¡è‚¡è³‡æ–™ - ä¾†æºï¼šå°ç£è­‰äº¤æ‰€å®˜æ–¹APIã€‘
` + sectorTxt);
  }

  if (usePE && f.pe !== '-') dataBlocks.push(`ã€åŸºæœ¬é¢è³‡æ–™ï¼ˆéœæ…‹åƒè€ƒå€¼ï¼‰ã€‘
æœ¬ç›Šæ¯”ï¼š${f.pe}
æ®–åˆ©ç‡ï¼š${f.dividendYield}%`);

  if (useNews && f.relatedNews.length) dataBlocks.push(`ã€è¿‘æœŸç›¸é—œæ–°è - ä¾†æºï¼šRSSå³æ™‚Feedã€‘
${f.relatedNews.map((n,i) => `${i+1}. ${n}`).join('\n')}`);

  return `ä½ æ˜¯ä¸€ä½åš´è¬¹çš„å°è‚¡é‡åŒ–åˆ†æå¸«ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šä»¥ä¸‹ã€Œå¯é©—è­‰çš„å¸‚å ´äº‹å¯¦è³‡æ–™ã€ï¼Œå° ${f.name}ï¼ˆ${f.code}ï¼‰çš„çŸ­æœŸè¶¨å‹¢åšå‡ºåˆ¤æ–·ã€‚

åˆ†ææ™‚é–“ï¼š${f.analysisTime}

=== å¯é©—è­‰çš„å¸‚å ´äº‹å¯¦è³‡æ–™ ===
${dataBlocks.join('\n\n')}
=== è³‡æ–™çµæŸ ===

ã€åˆ†æè¦æ±‚èˆ‡ä¿¡å¿ƒåº¦æ¨™æº–ã€‘
1. ã€Œä¿¡å¿ƒåº¦ã€ä»£è¡¨ä½ æ ¹æ“šä»¥ä¸Šäº‹å¯¦è³‡æ–™ï¼Œå°è¶¨å‹¢æ–¹å‘åˆ¤æ–·çš„ç¢ºä¿¡ç¨‹åº¦ï¼ˆ0â€“100%ï¼‰
2. åªæœ‰ç•¶ã€Œå¤šå€‹ç¨ç«‹è³‡æ–™ä¾†æºæŒ‡å‘åŒä¸€æ–¹å‘ï¼Œä¸”ç„¡æ˜é¡¯åå‘è¨Šè™Ÿã€æ™‚ï¼Œæ‰èƒ½çµ¦å‡º â‰¥90% çš„ä¿¡å¿ƒåº¦
3. å¦‚æœè³‡æ–™ä¸è¶³ã€äº’ç›¸çŸ›ç›¾ã€æˆ–å­˜åœ¨é‡å¤§ä¸ç¢ºå®šå› ç´ ï¼Œä¿¡å¿ƒåº¦æ‡‰ä½æ–¼ 70%ï¼Œä¸¦èªªæ˜åŸå› 
4. æ‰€æœ‰åˆ¤æ–·åŸå› å¿…é ˆç›´æ¥å¼•ç”¨ä¸Šæ–¹æä¾›çš„å…·é«”æ•¸å­—è³‡æ–™ï¼Œç¦æ­¢æ†‘ç©ºæ¨æ¸¬
5. è¶¨å‹¢æ–¹å‘åªèƒ½æ˜¯ï¼šã€Œä¸Šæ¼²ã€ã€ã€Œä¸‹è·Œã€æˆ–ã€Œç›¤æ•´ã€

ã€å›æ‡‰æ ¼å¼ã€‘
å¿…é ˆåš´æ ¼ä»¥ä»¥ä¸‹ JSON æ ¼å¼å›æ‡‰ï¼Œä¸è¦æœ‰ä»»ä½•é¡å¤–æ–‡å­—ï¼š

{
  "direction": "ä¸Šæ¼²|ä¸‹è·Œ|ç›¤æ•´",
  "confidence": æ•¸å­—(0-100),
  "verdict": "ä¸€å¥è©±ç¸½çµï¼ˆ20å­—ä»¥å…§ï¼‰",
  "timeframe": "åˆ†æé©ç”¨çš„æ™‚é–“æ¡†æ¶ï¼Œå¦‚ï¼šä»Šæ—¥ç›¤ä¸­ã€æœ¬é€±ã€çŸ­æœŸ1-3æ—¥",
  "reasons": [
    {
      "type": "supporting|opposing|uncertain",
      "weight": "é«˜|ä¸­|ä½",
      "title": "åŸå› æ¨™é¡Œï¼ˆ10å­—ä»¥å…§ï¼‰",
      "content": "å…·é«”èªªæ˜ï¼Œå¿…é ˆå¼•ç”¨å¯¦éš›æ•¸å­—ï¼ˆ30-60å­—ï¼‰",
      "evidence": "å¼•ç”¨çš„å…·é«”æ•¸æ“šæˆ–è³‡æ–™ä¾†æº"
    }
  ],
  "keyRisk": "æœ€ä¸»è¦çš„é¢¨éšªå› ç´ ï¼ˆ30å­—ä»¥å…§ï¼‰",
  "dataSources": ["åˆ—å‡ºå¯¦éš›ä½¿ç”¨çš„è³‡æ–™ä¾†æº"],
  "insufficientDataNote": "å¦‚æœè³‡æ–™ä¸è¶³å°è‡´ä¿¡å¿ƒåº¦ä½ï¼Œåœ¨æ­¤èªªæ˜ç¼ºå°‘å“ªäº›è³‡æ–™ï¼ˆå¦å‰‡å¡«nullï¼‰"
}`;
}

// â”€â”€ å‘¼å« Claude API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// ============================================================
// é…æ¯/é™¤æ¬Šæ¯ åŸºæœ¬é¢è³‡æ–™
// ============================================================

let _currentTrendCode = '';
function switchTrendTab(tab) { /* è¶¨å‹¢åˆ†æå·²ä¸å«é…æ¯tabï¼Œæ­¤å‡½å¼ä¿ç•™ç›¸å®¹æ€§ */ }


// ============================================================
// è‚¡åƒ¹è­¦ç¤º
// ============================================================
function setStockAlert(code, currentPrice) {
  const s = state.stockCache[code] || {};
  const name = s.name || STOCK_NAMES[code] || code;
  const alertDiv = document.createElement('div');
  alertDiv.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;display:flex;align-items:center;justify-content:center;';
  alertDiv.innerHTML = `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:24px;width:320px;max-width:90%;">
    <div style="font-size:16px;font-weight:700;margin-bottom:6px;">ğŸ”” è¨­å®š ${name}(${code}) è­¦ç¤º</div>
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:16px;">ç¾åƒ¹ï¼š${currentPrice} å…ƒ</div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div>
        <label style="font-size:12px;color:var(--green);">ğŸ“ˆ çªç ´ä¸Šæ–¹ç›®æ¨™åƒ¹æ™‚é€šçŸ¥</label>
        <input type="number" id="_alertAbove" value="${(currentPrice*1.05).toFixed(1)}" 
          style="width:100%;margin-top:4px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--red);">ğŸ“‰ è·Œç ´ä¸‹æ–¹è­¦æˆ’åƒ¹æ™‚é€šçŸ¥</label>
        <input type="number" id="_alertBelow" value="${(currentPrice*0.95).toFixed(1)}"
          style="width:100%;margin-top:4px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;">
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button onclick="this.closest('[style]').remove()" 
        style="flex:1;padding:8px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;cursor:pointer;">å–æ¶ˆ</button>
      <button onclick="saveAlert('${code}','${name}',document.getElementById('_alertAbove').value,document.getElementById('_alertBelow').value);this.closest('[style*=inset]').remove()"
        style="flex:1;padding:8px;background:var(--accent);border:none;color:#000;border-radius:8px;cursor:pointer;font-weight:600;">å„²å­˜è­¦ç¤º</button>
    </div>
  </div>`;
  document.body.appendChild(alertDiv);
}

function saveAlert(code, name, above, below) {
  const alerts = JSON.parse(localStorage.getItem('priceAlerts') || '{}');
  alerts[code] = { name, above: parseFloat(above)||null, below: parseFloat(below)||null };
  localStorage.setItem('priceAlerts', JSON.stringify(alerts));
  showToast(`âœ… ${name} è­¦ç¤ºå·²å„²å­˜ï¼šä¸Š ${above} / ä¸‹ ${below}`);
}

function checkPriceAlerts() {
  const alerts = JSON.parse(localStorage.getItem('priceAlerts') || '{}');
  Object.entries(alerts).forEach(([code, al]) => {
    const s = state.stockCache[code];
    if (!s || s.price <= 0) return;
    if (al.above && s.price >= al.above) {
      showAlertNotification(code, al.name, `çªç ´ç›®æ¨™åƒ¹ ${al.above}å…ƒ`, 'up', s.price);
    }
    if (al.below && s.price <= al.below) {
      showAlertNotification(code, al.name, `è·Œç ´è­¦æˆ’åƒ¹ ${al.below}å…ƒ`, 'down', s.price);
    }
  });
}

function showAlertNotification(code, name, msg, dir, price) {
  const existing = document.getElementById(`alert-${code}`);
  if (existing) return;
  const el = document.createElement('div');
  el.id = `alert-${code}`;
  el.style.cssText = `position:fixed;top:${60 + Object.keys(JSON.parse(localStorage.getItem('priceAlerts')||'{}')).indexOf(code)*70}px;right:20px;z-index:9998;background:${dir==='up'?'rgba(16,185,129,.15)':'rgba(239,68,68,.15)'};border:1px solid ${dir==='up'?'var(--green)':'var(--red)'};border-radius:10px;padding:12px 16px;max-width:260px;box-shadow:0 4px 20px rgba(0,0,0,.3);cursor:pointer;`;
  el.innerHTML = `<div style="font-weight:700;font-size:13px;">${dir==='up'?'ğŸ“ˆ':'ğŸ“‰'} ${name} (${code})</div>
    <div style="font-size:12px;margin-top:2px;">${msg}</div>
    <div style="font-size:14px;font-weight:700;font-family:'Space Mono',monospace;margin-top:4px;color:${dir==='up'?'var(--green)':'var(--red)'};">ç¾åƒ¹ ${price} å…ƒ</div>`;
  el.onclick = () => el.remove();
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 15000);
}



// ============================================================
// åŸºæœ¬é¢ & é…æ¯é é¢ (å…¨æ–°ç‰ˆ v2)
// è³‡æ–™ä¾†æºï¼šWorker?type=dividend (Yahoo Finance TW + TWSE)
// ============================================================

async function loadFundamentals(inputCode) {
  const code = (inputCode || document.getElementById('fundStockInput')?.value || '').trim().replace(/\D/g, '');
  if (!code) { showToast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼'); return; }

  const input = document.getElementById('fundStockInput');
  if (input) input.value = code;

  const container = document.getElementById('fundResult');
  if (!container) return;

  container.innerHTML = `<div class="loading"><div class="spinner"></div> è¼‰å…¥ ${code} åŸºæœ¬é¢è³‡æ–™...</div>`;

  try {
    // 1. å³æ™‚å¿«å–è³‡æ–™
    const cached = state.stockCache[code] || {};
    const name   = cached.name || STOCK_NAMES[code] || code;
    const price  = cached.price || 0;
    const changePct = cached.changePct || 0;

    // 2. å‘¼å« Worker dividend API
    if (!WORKER_URL) throw new Error('è«‹å…ˆè¨­å®š Cloudflare Worker ç¶²å€');
    const res  = await fetch(`${WORKER_URL}?type=dividend&code=${code}`, {
      signal: AbortSignal.timeout(15000),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    renderFundamentals(code, name, price, changePct, data);
  } catch(e) {
    const container = document.getElementById('fundResult');
    if (container) container.innerHTML = `
      <div class="card" style="text-align:center;padding:40px;color:var(--gold);">
        <div style="font-size:32px;margin-bottom:12px;">âš ï¸</div>
        <div style="font-size:14px;font-weight:600;">è¼‰å…¥å¤±æ•—</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:8px;">${e.message}</div>
        <button class="btn-outline" style="margin-top:16px;" onclick="loadFundamentals('${document.getElementById('fundStockInput')?.value}')">é‡è©¦</button>
      </div>`;
  }
}

// ============================================================
// åŸºæœ¬é¢é é¢å®Œæ•´æ¸²æŸ“ (v4 WantGooé¢¨æ ¼ - åœ–è¡¨ + å®Œæ•´æ•¸æ“š)
// ============================================================
function renderFundamentals(code, name, price, changePct, data) {
  const container = document.getElementById('fundResult');
  if (!container) return;

  const d  = data.quote   || {};
  const bw = data.bwibbu  || {};   // TWSE BWIBBU_d è£œå……
  // æ¨™æº–åŒ–é…æ¯æ­·å²ï¼šworker v8 è¿”å› TWSE æ ¼å¼ {year, cashDiv, stockDiv, total, exDivDate}
  // æˆ– Yahoo æ ¼å¼ {year, cashDiv, total, exDivDate}ï¼›çµ±ä¸€ç‚ºå‰ç«¯æ ¼å¼
  const rawHy = data.history || [];
  const hy = rawHy.map(h => ({
    year:   h.year,
    amount: h.cashDiv || h.amount || 0,   // ç¾é‡‘è‚¡åˆ©
    stock:  h.stockDiv || 0,              // è‚¡ç¥¨è‚¡åˆ©
    total:  h.total || h.cashDiv || h.amount || 0,
    date:   h.exDivDate || h.date || '--',
    type:   (h.stockDiv > 0 && (h.cashDiv || 0) === 0) ? 'stock' : 'cash',
    src:    h.src || 'twse',
  })).sort((a, b) => b.year - a.year);

  // â”€â”€ ä¼°å€¼æ•¸æ“šå–å€¼é‚è¼¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PE: Yahoo é€šå¸¸æ­£ç¢ºï¼›TWSE å‚™æ´
  const pe   = (d.pe  != null && d.pe  > 0 && d.pe  < 500) ? +d.pe.toFixed(2)  : (bw.pe  || null);
  // PB: Yahoo çš„ priceToBook å°å°è‚¡å¸¸è¿”å›æ¯è‚¡å¸³é¢å€¼è€Œéæ¯”ç‡
  //     Worker å·²éæ¿¾ >20 çš„ç•°å¸¸å€¼ï¼›TWSE BWIBBU_d çš„ pb æœ€å¯é 
  const pb   = (bw.pb != null && bw.pb > 0 && bw.pb < 30)  ? +bw.pb.toFixed(2)
             : (d.pb  != null && d.pb  > 0 && d.pb  < 20)  ? +d.pb.toFixed(2)  : null;
  // Yield: Yahoo (å·²ä¹˜100) or TWSE
  const yld  = (d.yield != null && d.yield > 0) ? +d.yield.toFixed(2) : (bw.yield || null);
  const eps    = (d.eps  != null) ? +d.eps.toFixed(2)  : null;
  const roe    = (d.roe  != null) ? +d.roe.toFixed(1)  : null;
  const mktCap = d.mktCap || null;
  const beta   = (d.beta != null) ? +d.beta.toFixed(2) : null;
  const h52w   = d.high52w || null;
  const l52w   = d.low52w  || null;
  const nextEx = d.nextExDiv || null;

  // â”€â”€ é¡è‰²èˆ‡è©•ä¼°æ¨™ç±¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const peNum  = pe   != null ? pe   : NaN;
  const pbNum  = pb   != null ? pb   : NaN;
  const yldNum = yld  != null ? yld  : NaN;

  const peColor  = !isNaN(peNum)  ? (peNum<12?'var(--green)':peNum<20?'var(--gold)':'var(--red)')  : 'var(--text-dim)';
  const pbColor  = !isNaN(pbNum)  ? (pbNum<1.5?'var(--green)':pbNum<3?'var(--gold)':'var(--red)')  : 'var(--text-dim)';
  const yldColor = !isNaN(yldNum) ? (yldNum>=5?'var(--green)':yldNum>=3?'var(--gold)':'var(--text-dim)') : 'var(--text-dim)';
  const roeColor = roe != null    ? (roe>=15?'var(--green)':roe>=10?'var(--gold)':'var(--text-dim)') : 'var(--text-dim)';

  const peLabel  = !isNaN(peNum)  ? (peNum<12?'ä½ä¼°':peNum<20?'åˆç†':peNum<30?'ç•¥é«˜':'åè²´')   : null;
  const pbLabel  = !isNaN(pbNum)  ? (pbNum<1?'æŠ˜åƒ¹':pbNum<2?'åˆç†':pbNum<4?'æº¢åƒ¹':'é«˜æº¢åƒ¹')    : null;
  const yldLabel = !isNaN(yldNum) ? (yldNum>=5?'é«˜æ¯':yldNum>=3?'æ™®é€š':'ä½æ¯')                  : null;
  const roeLabel = roe != null    ? (roe>=15?'å„ªç•°':roe>=10?'è‰¯å¥½':roe>=6?'æ™®é€š':'åä½')         : null;

  // â”€â”€ é…æ¯çµ±è¨ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const recent5  = hy.slice(0, 5);
  const avgDiv   = recent5.length ? (recent5.reduce((s,h)=>s+(h.amount||0),0)/recent5.length) : null;
  const maxDiv   = hy.length ? Math.max(...hy.map(h=>h.amount||0)) : 1;
  const divCount = hy.length;

  // â”€â”€ 52é€±ä½ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const pct52w = (h52w && l52w && price > 0 && h52w > l52w)
    ? ((price - l52w) / (h52w - l52w) * 100).toFixed(0) : null;

  // â”€â”€ å¸‚å€¼æ ¼å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const mktCapStr = mktCap
    ? (mktCap >= 1e12 ? (mktCap/1e12).toFixed(2)+'å…†' : mktCap >= 1e8 ? (mktCap/1e8).toFixed(0)+'å„„' : (mktCap/1e6).toFixed(0)+'ç™¾è¬')
    : null;

  const pc    = price > 0 ? changePct : 0;
  const pCls  = pc >= 0 ? 'up' : 'down';
  const pSign = pc >= 0 ? '+' : '';

  container.innerHTML = `
    <!-- â‘  è‚¡ç¥¨æ¨™é ­ -->
    <div class="card mb-4" style="background:linear-gradient(135deg,var(--surface) 0%,var(--surface2) 100%);border-color:rgba(0,212,255,0.2);">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:16px;">
        <div>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:6px;">
            <span style="font-size:26px;font-weight:700;letter-spacing:-0.5px;">${name}</span>
            <span style="font-size:13px;font-family:'Space Mono',monospace;background:var(--surface2);
              border:1px solid var(--border);padding:2px 10px;border-radius:20px;color:var(--text-dim);">${code}</span>
          </div>
          <div style="display:flex;align-items:baseline;gap:12px;">
            <span style="font-size:30px;font-weight:700;font-family:'Space Mono',monospace;
              color:${pc>=0?'var(--green)':'var(--red)'};">${price > 0 ? price.toFixed(2) : '--'}</span>
            ${price > 0 ? `<span class="${pCls}" style="font-size:16px;font-weight:600;">${pSign}${pc.toFixed(2)}%</span>` : ''}
          </div>
          ${pct52w !== null ? `
          <div style="margin-top:14px;max-width:280px;">
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim);margin-bottom:4px;">
              <span>52é€±ä½ ${l52w?.toFixed(2)}</span>
              <span>52é€±é«˜ ${h52w?.toFixed(2)}</span>
            </div>
            <div class="week52-bar">
              <div class="week52-fill" style="width:${pct52w}%;"></div>
              <div class="week52-dot" style="left:${pct52w}%;"></div>
            </div>
            <div style="font-size:10px;color:var(--accent);text-align:center;">
              ç¾åƒ¹ä½æ–¼ 52é€±å€é–“ ${pct52w}% ä½ç½®
            </div>
          </div>` : ''}
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-self:flex-start;">
          <button class="btn-outline" onclick="quickChat('æ·±å…¥åˆ†æ${name}(${code})ï¼Œæœ¬ç›Šæ¯”${pe||'--'}ã€æ®–åˆ©ç‡${yld||'--'}%ï¼Œç¾åœ¨å€¼å¾—æŠ•è³‡å—ï¼Ÿ')">ğŸ¤– AIæ·±æ</button>
          <button class="btn-outline" onclick="switchTab('trend');setTimeout(()=>analyzeTrend('${code}'),300)">ğŸ”¬ è¶¨å‹¢</button>
          <button class="btn-outline" onclick="setStockAlert('${code}',${price>0?price.toFixed(1):0})">ğŸ”” è­¦ç¤º</button>
        </div>
      </div>
    </div>

    <!-- â‘¡ æ ¸å¿ƒä¼°å€¼ 6æ ¼ (WantGoo-inspired) -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;">
      ${[
        {label:'æœ¬ç›Šæ¯” P/E', val:pe!=null?pe.toFixed(1):'--', color:peColor, tag:peLabel, tip:'æ¯è‚¡å¸‚åƒ¹Ã·æ¯è‚¡ç›ˆé¤˜ è¶Šä½è¶Šä¾¿å®œ'},
        {label:'è‚¡åƒ¹æ·¨å€¼æ¯” P/B', val:pb!=null?pb.toFixed(2):'--', color:pbColor, tag:pbLabel, tip:'å¸‚åƒ¹Ã·æ¯è‚¡æ·¨å€¼ï¼ˆTWSEè³‡æ–™ï¼‰'},
        {label:'æ®–åˆ©ç‡ Yield', val:yld!=null?yld.toFixed(2)+'%':'--', color:yldColor, tag:yldLabel, tip:'å¹´é…æ¯Ã·ç¾è‚¡åƒ¹'},
        {label:'EPSï¼ˆå…ƒï¼‰', val:eps!=null?eps.toFixed(2):'--', color:'var(--text)', tag:null, tip:'æ¯è‚¡ç¨…å¾Œç›ˆé¤˜'},
        {label:'å¸‚å€¼', val:mktCapStr||'--', color:'var(--text)', tag:null, tip:'è‚¡æœ¬Ã—ç¾è‚¡åƒ¹'},
        {label:'ROE (%)', val:roe!=null?roe.toFixed(1)+'%':'--', color:roeColor, tag:roeLabel, tip:'è‚¡æ±æ¬Šç›Šå ±é…¬ç‡'},
      ].map(v=>`
        <div class="fund-val-card" title="${v.tip}">
          <div class="fund-val-label">${v.label}</div>
          <div class="fund-val-number" style="color:${v.color};">${v.val}</div>
          ${v.tag?`<div class="fund-val-tag" style="color:${v.color};">${v.tag}</div>`:''}
        </div>`).join('')}
    </div>

    <!-- â‘¢ è£œå……æŒ‡æ¨™åˆ— -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;">
      ${[
        ['Betaå€¼', beta!=null?beta:'--', 'ç³»çµ±æ€§é¢¨éšªï¼Œ<1ä½æ³¢å‹•'],
        ['ä¸‹æ¬¡é™¤æ¯', nextEx||'--', ''],
        ['è¿‘5å¹´å‡é…', avgDiv!=null?avgDiv.toFixed(2)+'å…ƒ':'--', ''],
        ['é…æ¯æ¬¡æ•¸', divCount>0?divCount+'ç­†(æ­·å²)':'--', ''],
      ].map(([l,v,t])=>`
        <div style="background:var(--surface2);border-radius:10px;padding:12px;" title="${t}">
          <div style="font-size:10px;color:var(--text-dim);">${l}</div>
          <div style="font-size:15px;font-weight:600;margin-top:4px;font-family:'Space Mono',monospace;">${v}</div>
        </div>`).join('')}
    </div>

    <!-- â‘£ æ­·å¹´é…æ¯åœ– + è¡¨ -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div style="font-size:14px;font-weight:700;">
          <span class="icon">ğŸ’°</span> æ­·å¹´é…æ¯ç´€éŒ„
          ${avgDiv ? `<span style="color:var(--gold);font-size:12px;margin-left:8px;">è¿‘${Math.min(5,hy.length)}å¹´å‡ ${avgDiv.toFixed(2)}å…ƒ</span>` : ''}
        </div>
        <div style="display:flex;gap:10px;font-size:11px;color:var(--text-dim);">
          <span><span style="display:inline-block;width:10px;height:10px;background:var(--accent);border-radius:2px;margin-right:3px;"></span>ç¾é‡‘è‚¡åˆ©</span>
          <span><span style="display:inline-block;width:10px;height:10px;background:var(--gold);border-radius:2px;margin-right:3px;"></span>è‚¡ç¥¨è‚¡åˆ©</span>
        </div>
      </div>

      ${hy.length > 0 ? `
      <!-- æ©«æ¢åœ– (WantGooé¢¨æ ¼) -->
      <div style="overflow-x:auto;margin-bottom:20px;">
        <div class="div-bar-wrap" style="min-width:${Math.min(hy.length,16)*40}px;">
          ${hy.slice(0,16).reverse().map(h=>{
            const pct = maxDiv > 0 ? Math.max((h.amount||0)/maxDiv*90, 4) : 4;
            const barColor = h.type==='stock' ? 'var(--gold)' : 'var(--accent)';
            return `<div class="div-bar-col">
              <div class="div-bar-amt">${(h.amount||0).toFixed(2)}</div>
              <div class="div-bar-body" style="height:${pct}%;background:${barColor};opacity:0.85;"></div>
              <div class="div-bar-year">${h.year}</div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <!-- è©³ç´°è¡¨æ ¼ -->
      <div style="overflow-x:auto;">
        <table class="stock-table" style="font-size:12px;">
          <thead>
            <tr>
              <th style="text-align:left;">é™¤æ¯å¹´åº¦</th>
              <th>ç¾é‡‘è‚¡åˆ©ï¼ˆå…ƒï¼‰</th>
              <th>é™¤æ¯æ—¥</th>
              <th>é¡å‹</th>
            </tr>
          </thead>
          <tbody>
            ${hy.slice(0,16).map(h=>`
              <tr>
                <td style="font-weight:700;">${h.year}</td>
                <td style="font-family:'Space Mono',monospace;font-weight:700;color:var(--gold);text-align:right;">
                  ${typeof h.amount==='number'?h.amount.toFixed(4):'--'}
                  ${h.stock>0?`<span style="font-size:9px;color:var(--gold);opacity:0.7;margin-left:3px;">(+${h.stock.toFixed(4)}è‚¡)</span>`:''}
                </td>
                <td style="font-size:11px;color:var(--text-dim);">${h.date||'--'}</td>
                <td><span class="tag ${h.type==='stock'?'tag-gold':'tag-green'}" style="font-size:10px;">${h.type==='stock'?'è‚¡ç¥¨':'ç¾é‡‘'}</span></td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
      ` : `
      <div style="text-align:center;padding:40px;color:var(--text-dim);">
        <div style="font-size:32px;margin-bottom:8px;">ğŸ“­</div>
        <div>æ­¤è‚¡ç¥¨ç›®å‰ç„¡é…æ¯ç´€éŒ„ï¼ˆæˆé•·å‹æˆ–è³‡æ–™å¾…æ›´æ–°ï¼‰</div>
      </div>`}

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;padding-top:10px;border-top:1px solid var(--border);">
        <div style="font-size:10px;color:var(--text-muted);">è³‡æ–™ä¾†æºï¼šYahoo Finance (${code}.TW) ï½œ å°ç£è­‰äº¤æ‰€ ï½œ ${new Date().toLocaleDateString('zh-TW')}</div>
        <button class="btn-outline" style="font-size:11px;padding:3px 10px;"
          onclick="quickChat('åˆ†æ${name}(${code})çš„é…æ¯æ”¿ç­–ï¼Œè¿‘å¹´æ®–åˆ©ç‡${yld||'--'}%ï¼Œæ­·å¹´é…æ¯è¶¨å‹¢å¦‚ä½•ï¼Ÿå€¼å¾—é•·æœŸæŒæœ‰å—ï¼Ÿ')">
          ğŸ¤– AI é…æ¯åˆ†æ
        </button>
      </div>
    </div>`;
}


async function callClaudeForTrend(prompt) {
  trackApiUsage('trend', 1400);
  trackAiUsage('trend');
  return callClaude([{ role: 'user', content: prompt }], 1400);
}

// â”€â”€ è§£æ Claude å›æ‡‰ JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseTrendResponse(raw) {
  // å˜—è©¦æå– JSON
  const jsonMatch = raw.match(/\{[\s\S]*\}/);
  if (!jsonMatch) throw new Error('AI å›æ‡‰æ ¼å¼ç•°å¸¸ï¼Œç„¡æ³•è§£æ');
  try {
    return JSON.parse(jsonMatch[0]);
  } catch(e) {
    throw new Error('JSON è§£æå¤±æ•—ï¼š' + e.message);
  }
}

// â”€â”€ æ¸²æŸ“çµæœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTrendResult(code, r, facts) {
  const dirMap = {
    'ä¸Šæ¼²': { cls:'up',      arrow:'â†‘', color:'var(--green)', label:'çœ‹æ¼²' },
    'ä¸‹è·Œ': { cls:'down',    arrow:'â†“', color:'var(--red)',   label:'çœ‹è·Œ' },
    'ç›¤æ•´': { cls:'neutral', arrow:'â†’', color:'var(--gold)',  label:'ç›¤æ•´' },
  };
  const dir = dirMap[r.direction] || dirMap['ç›¤æ•´'];

  const conf = r.confidence || 0;
  const confCls  = conf >= 90 ? 'high' : conf >= 70 ? 'medium' : 'low';
  const confLabel= conf >= 90 ? 'é«˜ä¿¡å¿ƒ Â· å¤šæŒ‡æ¨™ä¸€è‡´' : conf >= 70 ? 'ä¸­ä¿¡å¿ƒ Â· éƒ¨åˆ†ä¸ç¢ºå®š' : 'ä½ä¿¡å¿ƒ Â· è³‡æ–™ä¸è¶³';
  const confColor= conf >= 90 ? 'var(--green)' : conf >= 70 ? 'var(--gold)' : 'var(--red)';
  const fillWidth= Math.min(conf, 100);

  const supporting = (r.reasons || []).filter(r => r.type === 'supporting');
  const opposing   = (r.reasons || []).filter(r => r.type === 'opposing');
  const uncertain  = (r.reasons || []).filter(r => r.type === 'uncertain');

  const renderReasons = (arr) => arr.map(reason => `
    <div class="reason-card ${reason.type}">
      <div class="reason-header">
        <span class="reason-type ${reason.type}">${
          reason.type === 'supporting' ? 'âœ… æ”¯æŒå› ç´ ' :
          reason.type === 'opposing'   ? 'âš ï¸ åå‘è¨Šè™Ÿ' : 'â“ ä¸ç¢ºå®šå› ç´ '
        } Â· ${reason.title}</span>
        <span class="reason-weight">${reason.weight || 'ä¸­'} æ¬Šé‡</span>
      </div>
      <div class="reason-text">${reason.content}</div>
      ${reason.evidence ? `<div class="reason-evidence">ğŸ“Š è³‡æ–™ä¾æ“šï¼š${reason.evidence}</div>` : ''}
    </div>`).join('');

  const sourceBadges = (r.dataSources || []).map(s =>
    `<span class="data-badge">${s}</span>`).join('');

  document.getElementById('trendResult').innerHTML = `
    <!-- æ–¹å‘ + ä¿¡å¿ƒåº¦ é›™æ¬„ -->
    <div class="trend-hero mb-4">
      <div class="trend-direction-card ${dir.cls}">
        <div class="trend-arrow">${dir.arrow}</div>
        <div class="trend-label">è¶¨å‹¢æ–¹å‘åˆ¤æ–·</div>
        <div class="trend-verdict" style="color:${dir.color}">${r.direction}è¶¨å‹¢</div>
        <div class="trend-stock-name">${facts.name}ï¼ˆ${code}ï¼‰Â· ${r.timeframe || 'çŸ­æœŸ'}</div>
        <div style="font-size:12px;color:var(--text-dim);margin-top:8px;">${r.verdict || ''}</div>
        <div class="data-source-row">${sourceBadges}</div>
      </div>

      <div class="card" style="margin:0;">
        <div class="confidence-label">AI ä¿¡å¿ƒåº¦</div>
        <div class="confidence-pct" style="color:${confColor};margin:8px 0 4px;">
          ${conf}%
        </div>
        <div class="confidence-badge ${confCls}">${confLabel}</div>
        <div class="confidence-meter" style="margin-top:16px;">
          <div class="confidence-track">
            <div class="confidence-fill"
              style="width:${fillWidth}%;background:${confColor};"
              id="confFill"></div>
            <div class="confidence-90-marker"></div>
          </div>
        </div>
        ${conf < 70 && r.insufficientDataNote ? `
        <div style="font-size:11px;color:var(--gold);margin-top:10px;line-height:1.6;">
          âš ï¸ è³‡æ–™ä¸è¶³èªªæ˜ï¼š${r.insufficientDataNote}
        </div>` : ''}
        <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border);">
          <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">ä¸»è¦é¢¨éšª</div>
          <div style="font-size:12px;color:var(--red);">âš ï¸ ${r.keyRisk || 'è³‡æ–™ä¸è¶³ï¼Œè«‹è¬¹æ…'}</div>
        </div>
      </div>
    </div>

    <!-- æ”¯æŒå› ç´  -->
    ${supporting.length ? `
    <div class="card mb-4">
      <div class="section-title" style="margin-bottom:14px;color:var(--green);">
        âœ… æ”¯æŒã€Œ${r.direction}ã€çš„åŸå› ï¼ˆ${supporting.length} é …ï¼‰
      </div>
      ${renderReasons(supporting)}
    </div>` : ''}

    <!-- åå‘è¨Šè™Ÿ -->
    ${opposing.length ? `
    <div class="card mb-4">
      <div class="section-title" style="margin-bottom:14px;color:var(--red);">
        âš ï¸ åå‘è¨Šè™Ÿï¼ˆ${opposing.length} é …ï¼‰
      </div>
      ${renderReasons(opposing)}
    </div>` : ''}

    <!-- ä¸ç¢ºå®šå› ç´  -->
    ${uncertain.length ? `
    <div class="card mb-4">
      <div class="section-title" style="margin-bottom:14px;color:var(--gold);">
        â“ ä¸ç¢ºå®šå› ç´ ï¼ˆ${uncertain.length} é …ï¼‰
      </div>
      ${renderReasons(uncertain)}
    </div>` : ''}

    <!-- é‡æ–°åˆ†ææŒ‰éˆ• -->
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn" onclick="analyzeTrend('${code}')">ğŸ”„ é‡æ–°åˆ†æ</button>
      <button class="btn-outline" onclick="quickChat('æ ¹æ“šä»¥ä¸‹è¶¨å‹¢åˆ†æçµæœï¼Œè«‹çµ¦æˆ‘æ›´è©³ç´°çš„æ“ä½œå»ºè­°ï¼š${facts.name}(${code}) ${r.direction}è¶¨å‹¢ï¼Œä¿¡å¿ƒåº¦${conf}%ã€‚æ”¯æŒåŸå› ï¼š${supporting.map(s=>s.title).join('ã€')}')">ğŸ’¬ æ·±å…¥è¨è«–</button>
    </div>
  `;

  // å‹•ç•«ä¿¡å¿ƒæ¢
  setTimeout(() => {
    const fill = document.getElementById('confFill');
    if (fill) fill.style.width = fillWidth + '%';
  }, 100);
}

// è¼‰å…¥æç¤º
function showTrendLoading(code) {
  const name = state.stockCache[code]?.name || STOCK_NAMES[code] || code;
  document.getElementById('trendResult').innerHTML = `
    <div class="card">
      <div style="text-align:center;padding:40px 20px;">
        <div class="spinner" style="width:32px;height:32px;border-width:3px;margin:0 auto 20px;"></div>
        <div style="font-size:14px;font-weight:500;margin-bottom:8px;">æ­£åœ¨åˆ†æ ${name}ï¼ˆ${code}ï¼‰</div>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.8;">
          â‘  æ”¶é›† TWSE å³æ™‚åƒ¹æ ¼èˆ‡æˆäº¤é‡è³‡æ–™<br>
          â‘¡ æ•´åˆç¾è‚¡ã€åŒ¯ç‡ã€é¡è‚¡èµ°å‹¢<br>
          â‘¢ é€äº¤ Claude AI é€²è¡Œå¤šç¶­åº¦åˆ¤æ–·<br>
          â‘£ ä¾ 90% ä¿¡å¿ƒé–€æª»åš´æ ¼è©•ä¼°
        </div>
      </div>
    </div>`;
}


// ============================================================
// MODALS
// ============================================================
function openApiModal() {
  // apiKey now in Worker Secret
  document.getElementById('workerUrlInput').value = localStorage.getItem('workerUrl') || '';
  document.getElementById('apiModal').classList.add('open');
}
function closeApiModal() { document.getElementById('apiModal').classList.remove('open'); }

function toggleWorkerVis() {
  const inp = document.getElementById('workerUrlInput');
  const btn = document.getElementById('workerVisBtn');
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'ğŸ™ˆ'; }
  else { inp.type = 'password'; btn.textContent = 'ğŸ‘'; }
}

function saveApiKey() {
  const key       = document.getElementById('apiKeyInput').value.trim();
  const workerUrl = document.getElementById('workerUrlInput').value.trim().replace(/\/$/, '');
  // apiKey now stored in Worker Secret only
  localStorage.setItem('claudeApiKey', key);
  if (workerUrl) {
    localStorage.setItem('workerUrl', workerUrl);
    // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥ç”¨æ–°çš„ Worker
    location.reload();
  } else {
    localStorage.removeItem('workerUrl');
    closeApiModal();
    if (key) alert('âœ… Claude API Key å·²å„²å­˜ï¼');
  }
}

function openWorkerGuide() {
  closeApiModal();
  const guide = `ğŸ“‹ Cloudflare Worker éƒ¨ç½²æ­¥é©Ÿï¼ˆå…è²»ï¼‰ï¼š

1. å‰å¾€ https://workers.cloudflare.com è¨»å†Šå¸³è™Ÿ
2. é»é¸ã€ŒCreate Workerã€
3. å°‡ worker.js çš„ç¨‹å¼ç¢¼å®Œæ•´è²¼å…¥ç·¨è¼¯å™¨
4. é»é¸ã€ŒSave and Deployã€
5. è¤‡è£½ä½ çš„ Worker ç¶²å€ï¼ˆæ ¼å¼ï¼šhttps://xxx.workers.devï¼‰
6. è²¼å›é€™è£¡çš„ã€ŒCloudflare Worker ç¶²å€ã€æ¬„ä½

âœ… å…è²»é¡åº¦ï¼šæ¯å¤© 100,000 æ¬¡è«‹æ±‚ï¼Œå€‹äººä½¿ç”¨å®Œå…¨å¤ ç”¨
âœ… å•Ÿç”¨å¾Œå¯ç²å¾—ï¼šç¾è‚¡æŒ‡æ•¸ã€USD/TWD åŒ¯ç‡ã€RSS å³æ™‚æ–°è`;
  alert(guide);
  setTimeout(openApiModal, 100);
}

function addAlert() {
  const code = prompt('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ï¼š2330ï¼‰');
  const price = prompt('è«‹è¼¸å…¥æé†’åƒ¹æ ¼');
  if (!code || !price) return;
  const s = state.stockCache[code];
  const dir = parseFloat(price) > (s?.price || 0) ? 'çªç ´' : 'è·Œç ´';
  document.getElementById('alertsList').insertAdjacentHTML('beforeend', `
    <div class="alert-item">
      <div class="alert-icon">ğŸ””</div>
      <div class="alert-text">
        <div style="font-weight:500;">${s?.name || STOCK_NAMES[code] || code} (${code})</div>
        <div class="text-xs text-dim">${dir} ${price} å…ƒæé†’</div>
      </div>
      <button class="btn-danger" onclick="this.parentElement.remove()">âœ•</button>
    </div>`);
}

function updateRisk(val) {
  const labels = ['','ä¿å®ˆ','åä¿å®ˆ','ä¸­æ€§','åç©æ¥µ','ç©æ¥µ'];
  document.getElementById('riskLabel').textContent = labels[val];
}

function showStockDetail(code) {
  const s = state.stockCache[code];
  if (!s) return;
  quickChat(`è«‹å¹«æˆ‘åˆ†æ ${s.name} (${code}) è‚¡ç¥¨ï¼ŒåŒ…å«æŠ€è¡“é¢ã€åŸºæœ¬é¢ã€è¿‘æœŸæ–°èã€æ˜¯å¦å€¼å¾—è²·é€²ï¼Ÿ`);
  document.querySelectorAll('.tab').forEach(t => { if (t.textContent.includes('ğŸ’¬')) t.click(); });
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('open');
  });
});

// ============================================================

// ============================================================
// ğŸ”® AI è‡ªç„¶èªè¨€é¸è‚¡
// ============================================================
function setNLScreener(text) {
  const el = document.getElementById('nlScreenerInput');
  if (el) { el.value = text; runNLScreener(); }
}

async function runNLScreener(preset) {
  const input = preset || document.getElementById('nlScreenerInput')?.value?.trim();
  if (!input) { showToast('è«‹è¼¸å…¥é¸è‚¡æ¢ä»¶'); return; }
  if (preset) document.getElementById('nlScreenerInput').value = preset;

  const resultEl = document.getElementById('nlScreenerResult');
  resultEl.style.display = '';
  resultEl.innerHTML = '<div class="loading"><div class="spinner"></div> AI ç¯©é¸ä¸­...</div>';

  trackApiUsage('screener', 1000);
  trackAiUsage('screener');

  // æ”¶é›†æ‰€æœ‰å·²çŸ¥è‚¡ç¥¨è³‡æ–™
  const stocks = Object.entries(state.stockCache).map(([code, s]) => ({
    code, name: s.name || STOCK_NAMES[code] || code,
    price: s.price || 0, changePct: s.changePct || 0,
    pe: s.pe || '--', yield: s.yield || '--',
    sector: s.sector || '',
  })).filter(s => s.price > 0).slice(0, 80);

  const stockList = stocks.map(s =>
    `${s.code} ${s.name} | ç¾åƒ¹:${s.price} | æ¼²è·Œ:${s.changePct}% | PE:${s.pe} | æ®–åˆ©ç‡:${s.yield}% | é¡è‚¡:${s.sector}`
  ).join('\n');

  const prompt = `ä½ æ˜¯å°è‚¡é¸è‚¡åŠ©ç†ã€‚ç”¨æˆ¶æ¢ä»¶ï¼šã€Œ${input}ã€
å·²çŸ¥è‚¡ç¥¨æ¸…å–®ï¼š
${stockList}

è«‹å¾ä»¥ä¸Šè‚¡ç¥¨ä¸­ç¯©é¸ç¬¦åˆæ¢ä»¶çš„ï¼Œä¸¦ä¾ç¬¦åˆåº¦æ’åºï¼Œæœ€å¤š10æ”¯ã€‚
å›å‚³ JSONï¼š{"stocks":[{"code":"ä»£è™Ÿ","name":"åç¨±","reason":"ç¬¦åˆåŸå› ä¸€å¥è©±","score":90}],"summary":"ç¯©é¸èªªæ˜30å­—"}
ä¸ç¬¦åˆçš„å°±ä¸åˆ—ã€‚JSONå¤–ä¸è¦ä»»ä½•æ–‡å­—ã€‚`;

  try {
    const raw = await callClaude([{ role:'user', content: prompt }], 1000);
    const json = raw.match(/\{[\s\S]*\}/)?.[0];
    if (!json) throw new Error('æ ¼å¼ç•°å¸¸');
    const result = JSON.parse(json);

    const items = (result.stocks || []);
    resultEl.innerHTML = `
      <div style="background:rgba(124,58,237,.08);border:1px solid rgba(124,58,237,.2);border-radius:8px;padding:10px;margin-bottom:10px;font-size:12px;">
        ğŸ”® ${result.summary || ''}ã€€å…±æ‰¾åˆ° <strong>${items.length}</strong> æ”¯ç¬¦åˆæ¢ä»¶
      </div>
      ${items.map(s => {
        const cached = state.stockCache[s.code] || {};
        const pc = cached.changePct || 0;
        return `<div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--surface2);border-radius:8px;margin-bottom:6px;">
          <div style="font-family:'Space Mono',monospace;font-weight:700;min-width:44px;">${s.code}</div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:600;">${s.name}</div>
            <div style="font-size:11px;color:var(--text-dim);">${s.reason}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:14px;font-weight:700;font-family:'Space Mono',monospace;">${cached.price?.toFixed(2)||'--'}</div>
            <div style="font-size:11px;" class="${pc>=0?'up':'down'}">${pc>=0?'+':''}${pc.toFixed(2)}%</div>
          </div>
          <div style="background:rgba(124,58,237,.2);color:var(--accent2);font-size:11px;padding:2px 7px;border-radius:10px;font-weight:700;">${s.score}åˆ†</div>
        </div>`;
      }).join('')}`;
  } catch(e) {
    resultEl.innerHTML = `<div style="color:var(--red);font-size:12px;">âŒ ${e.message}</div>`;
  }
}

// ============================================================
// ğŸ¯ æƒ…å¢ƒæ¨¡æ“¬
// ============================================================
async function runScenario() {
  const sel = document.getElementById('scenarioSelect');
  const scenario = sel?.value;
  if (!scenario) { showToast('è«‹é¸æ“‡æƒ…å¢ƒ'); return; }

  const resultEl = document.getElementById('scenarioResult');
  resultEl.style.display = '';
  resultEl.innerHTML = '<div class="loading"><div class="spinner"></div> æƒ…å¢ƒæ¨¡æ“¬ä¸­...</div>';

  trackApiUsage('scenario', 800);
  trackAiUsage('scenario');

  const scenarioLabels = {
    fed_cut: 'Fedé™æ¯1ç¢¼ï¼ˆè¯é‚¦åŸºé‡‘åˆ©ç‡ä¸‹é™0.25%ï¼‰',
    usd_drop: 'ç¾å…ƒèµ°å¼±5%ï¼ˆDXYæŒ‡æ•¸ä¸‹è·Œ5%ï¼‰',
    china_risk: 'ä¸­åœ‹åœ°ç·£é¢¨éšªå‡æº«ï¼ˆå°æµ·ç·Šå¼µå±€å‹¢ï¼‰',
    ai_boom: 'AIéœ€æ±‚è¶…é æœŸçˆ†ç™¼ï¼ˆå¤§å‹AIæ¡è³¼éœ€æ±‚æ¿€å¢ï¼‰',
    recession: 'å…¨çƒè¡°é€€ç–‘æ…®å‡æº«ï¼ˆPMIè·Œç ´50ï¼‰',
    tariff: 'ç¾åœ‹å°å°ç£è£½å“åŠ å¾µé—œç¨…15%',
  };

  const holdings = state.portfolio || [];
  if (!holdings.length) {
    resultEl.innerHTML = '<div style="color:var(--text-dim);font-size:12px;">è«‹å…ˆåœ¨æŒè‚¡ç®¡ç†é æ–°å¢æŒè‚¡</div>';
    return;
  }

  const holdList = holdings.map(h => {
    const s = state.stockCache[h.code] || {};
    return `${h.code} ${s.name||h.code} | ç¾åƒ¹:${s.price||h.cost} | æŒè‚¡:${h.lots}è‚¡ | é¡è‚¡:${s.sector||'--'}`;
  }).join('\n');

  const prompt = `æƒ…å¢ƒï¼š${scenarioLabels[scenario]}
æˆ‘çš„å°è‚¡æŒè‚¡ï¼š
${holdList}

è«‹é€æ”¯åˆ†ææ­¤æƒ…å¢ƒå°æ¯æ”¯æŒè‚¡çš„å½±éŸ¿ï¼ˆæ­£é¢/ä¸­æ€§/è² é¢ï¼‰ï¼Œä¸¦é ä¼°æ¼²è·Œå¹…å½±éŸ¿ç¯„åœï¼ˆ%ï¼‰ï¼Œä»¥åŠæ•´é«”çµ„åˆè©•ä¼°ã€‚
å›å‚³JSONï¼š{"stocks":[{"code":"ä»£è™Ÿ","impact":"positive/neutral/negative","change":"é ä¼°å½±éŸ¿","reason":"åŸå› 20å­—"}],"overall":"æ•´é«”çµ„åˆå½±éŸ¿ï¼Œ50å­—"}`;

  try {
    const raw = await callClaude([{ role:'user', content: prompt }], 800);
    const json = raw.match(/\{[\s\S]*\}/)?.[0];
    if (!json) throw new Error('æ ¼å¼ç•°å¸¸');
    const result = JSON.parse(json);

    const impactColor = { positive:'var(--green)', neutral:'var(--text-dim)', negative:'var(--red)' };
    const impactLabel = { positive:'âœ… æ­£é¢', neutral:'âšª ä¸­æ€§', negative:'âŒ è² é¢' };

    resultEl.innerHTML = `
      <div style="background:rgba(124,58,237,.08);border:1px solid rgba(124,58,237,.2);border-radius:8px;padding:10px;margin-bottom:10px;font-size:12px;line-height:1.6;">
        <strong>ğŸ“Š æ•´é«”çµ„åˆï¼š</strong>${result.overall}
      </div>
      ${(result.stocks||[]).map(s => `
        <div style="display:flex;align-items:center;gap:8px;padding:7px;background:var(--surface2);border-radius:8px;margin-bottom:5px;font-size:12px;">
          <span style="font-family:'Space Mono',monospace;font-weight:700;min-width:44px;">${s.code}</span>
          <span style="flex:1;color:var(--text-dim);">${s.reason}</span>
          <span style="color:${impactColor[s.impact]||'var(--text-dim)'};font-weight:700;white-space:nowrap;">${impactLabel[s.impact]||s.impact} ${s.change}</span>
        </div>`).join('')}`;
  } catch(e) {
    resultEl.innerHTML = `<div style="color:var(--red);font-size:12px;">âŒ ${e.message}</div>`;
  }
}

// ============================================================
// ğŸ”— AI é—œè¯è‚¡ç¥¨åˆ†æ
// ============================================================
async function runCorrelationAnalysis() {
  const code = _currentTrendCode;
  if (!code) { showToast('è«‹å…ˆé¸æ“‡è¦åˆ†æçš„è‚¡ç¥¨'); return; }

  const resultEl = document.getElementById('correlationResult');
  if (!resultEl) return;
  resultEl.innerHTML = '<div class="loading"><div class="spinner"></div> åˆ†æé—œè¯ä¸­...</div>';

  trackApiUsage('correlation', 800);
  trackAiUsage('correlation');

  const s = state.stockCache[code] || {};
  const prompt = `åˆ†æå°è‚¡ ${s.name||code}(${code}) åœ¨${s.sector||''}ç”¢æ¥­ï¼Œç”¨ç¹é«”ä¸­æ–‡å›å‚³JSONï¼š
{"tw_stocks":[{"code":"ä»£è™Ÿ","name":"åç¨±","relation":"é—œè¯é¡å‹","reason":"åŸå› 15å­—"}],"us_stocks":[{"symbol":"ä»£è™Ÿ","name":"åç¨±","relation":"é—œè¯é¡å‹","reason":"åŸå› 15å­—"}],"summary":"ç¸½çµ30å­—"}
tw_stocks 3æ”¯æœ€ç›¸é—œå°è‚¡ï¼Œus_stocks 3æ”¯ç›¸é—œç¾è‚¡ETFæˆ–å€‹è‚¡ï¼Œrelation å¡«ã€Œä¸Šæ¸¸/ä¸‹æ¸¸/ç«¶çˆ­/å—ç›Šã€å…¶ä¸­ä¸€å€‹ã€‚`;

  try {
    const raw = await callClaude([{ role:'user', content: prompt }], 800);
    const json = raw.match(/\{[\s\S]*\}/)?.[0];
    if (!json) throw new Error('æ ¼å¼ç•°å¸¸');
    const r = JSON.parse(json);

    resultEl.innerHTML = `
      <div style="font-size:11px;color:var(--text-dim);line-height:1.6;margin-bottom:8px;">${r.summary}</div>
      <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:5px;">ğŸ‡¹ğŸ‡¼ ç›¸é—œå°è‚¡</div>
      ${(r.tw_stocks||[]).map(s=>`
        <div style="display:flex;align-items:center;gap:6px;padding:6px;background:var(--surface2);border-radius:6px;margin-bottom:4px;cursor:pointer;"
             onclick="analyzeTrend('${s.code}')">
          <span style="font-family:'Space Mono',monospace;font-size:11px;font-weight:700;">${s.code}</span>
          <span style="flex:1;font-size:11px;">${s.name}</span>
          <span style="font-size:10px;background:rgba(0,212,255,.15);color:var(--accent);padding:1px 6px;border-radius:8px;">${s.relation}</span>
        </div>`).join('')}
      <div style="font-size:11px;font-weight:700;color:var(--gold);margin:8px 0 5px;">ğŸ‡ºğŸ‡¸ ç›¸é—œç¾è‚¡/ETF</div>
      ${(r.us_stocks||[]).map(s=>`
        <div style="display:flex;align-items:center;gap:6px;padding:6px;background:var(--surface2);border-radius:6px;margin-bottom:4px;">
          <span style="font-family:'Space Mono',monospace;font-size:11px;font-weight:700;color:var(--gold);">${s.symbol}</span>
          <span style="flex:1;font-size:11px;">${s.name}</span>
          <span style="font-size:10px;background:rgba(245,158,11,.15);color:var(--gold);padding:1px 6px;border-radius:8px;">${s.relation}</span>
        </div>`).join('')}`;
  } catch(e) {
    resultEl.innerHTML = `<div style="color:var(--red);font-size:12px;">âŒ ${e.message}</div>`;
  }
}

// ğŸŒ Global markets JS (see renderGlobalPage / ensureGlobalData above)

// AI ä½¿ç”¨é‡è¿½è¹¤ & è²»ç”¨è­¦å‘Š
// ============================================================
const AI_COST = {
  chat      : { tokens: 1200, costTWD: 1.2, label: 'AI å•ç­”' },
  trend     : { tokens: 1400, costTWD: 1.5, label: 'è¶¨å‹¢åˆ†æ' },
  recs      : { tokens: 1500, costTWD: 1.6, label: 'AI æ¨è–¦' },
  holding   : { tokens:  800, costTWD: 0.8, label: 'æŒè‚¡åˆ†æ' },
  potential : { tokens: 2000, costTWD: 2.1, label: 'æ½›åŠ›è‚¡åˆ†æ' },
  global    : { tokens:  800, costTWD: 0.8, label: 'åœ‹éš›å¸‚å ´åˆ†æ' },
  screener  : { tokens: 1000, costTWD: 1.0, label: 'AIé¸è‚¡' },
  scenario  : { tokens:  800, costTWD: 0.8, label: 'æƒ…å¢ƒæ¨¡æ“¬' },
  correlation:{ tokens:  800, costTWD: 0.8, label: 'é—œè¯åˆ†æ' },
};

// å¾ localStorage æ¢å¾©ä»Šæ—¥ç”¨é‡ï¼ˆæ¯æ—¥è‡ªå‹•é‡ç½®ï¼‰
function getAiUsage() {
  const today = new Date().toDateString();
  const raw   = JSON.parse(localStorage.getItem('aiUsage') || '{}');
  if (raw.date !== today) return { date: today, calls: {}, totalCost: 0, totalCalls: 0 };
  return raw;
}

function trackAiUsage(type) {
  const usage = getAiUsage();
  const cost  = AI_COST[type] || { costTWD: 1, label: type };
  usage.calls[type]  = (usage.calls[type] || 0) + 1;
  usage.totalCalls   = (usage.totalCalls || 0) + 1;
  usage.totalCost    = +((usage.totalCost || 0) + cost.costTWD).toFixed(1);
  localStorage.setItem('aiUsage', JSON.stringify(usage));
  updateAiUsageBadge();
  // è²»ç”¨è­¦å‘Š
  if (usage.totalCalls % 5 === 0 || usage.totalCost >= 10) {
    showAiCostAlert(usage);
  }
}

function updateAiUsageBadge() {
  const usage = getAiUsage();
  const badge = document.getElementById('aiUsageBadge');
  const detail= document.getElementById('aiUsageDetail');
  if (badge) badge.textContent = `ğŸ“Š ä»Šæ—¥ ${usage.totalCalls} æ¬¡ï½œâ‰ˆ${usage.totalCost} TWD`;
  if (detail) {
    detail.innerHTML = Object.entries(usage.calls).map(([t, n]) => {
      const info = AI_COST[t] || { label: t, costTWD: 1 };
      return `<div style="display:flex;justify-content:space-between;margin-bottom:3px;">
        <span>${info.label}</span>
        <span style="color:var(--accent);">${n}æ¬¡ / â‰ˆ${(n*info.costTWD).toFixed(1)} TWD</span>
      </div>`;
    }).join('') + `<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border);
      display:flex;justify-content:space-between;font-weight:600;">
      <span>ä»Šæ—¥åˆè¨ˆ</span>
      <span style="color:var(--gold);">${usage.totalCalls}æ¬¡ / â‰ˆ${usage.totalCost} TWD</span>
    </div>`;
  }
}

function showAiUsage() {
  const usage = getAiUsage();
  showAiCostAlert(usage, true);
}

function showAiCostAlert(usage, manual=false) {
  const limit = parseInt(localStorage.getItem('aiDailyLimit') || '50');
  const isOver = usage.totalCost >= limit;
  let modal = document.getElementById('aiCostModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'aiCostModal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `<div class="modal" style="max-width:400px;">
      <div class="modal-title" id="aiCostModalTitle">ğŸ“Š AI ä½¿ç”¨é‡</div>
      <div id="aiCostModalBody"></div>
      <div style="margin-top:14px;">
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:6px;">æ¯æ—¥è²»ç”¨è­¦å‘Šä¸Šé™ï¼ˆTWDï¼‰</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="number" id="aiLimitInput" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px;" value="${limit}">
          <button class="btn" onclick="saveAiLimit()">å„²å­˜</button>
        </div>
      </div>
      <div class="modal-actions" style="margin-top:12px;">
        <button class="btn-outline" onclick="document.getElementById('aiCostModal').style.display='none'">é—œé–‰</button>
        <button class="btn-outline" onclick="resetAiUsage()">é‡ç½®ä»Šæ—¥è¨ˆæ•¸</button>
      </div>
    </div>`;
    document.body.appendChild(modal);
  }
  modal.style.display = 'flex';
  document.getElementById('aiCostModalTitle').textContent = isOver && !manual ? 'âš ï¸ AI è²»ç”¨è­¦å‘Š' : 'ğŸ“Š AI ä½¿ç”¨é‡';
  document.getElementById('aiCostModalBody').innerHTML = `
    <div style="background:${isOver?'rgba(239,68,68,.1)':'var(--surface2)'};border-radius:8px;padding:12px;margin-bottom:12px;${isOver?'border:1px solid rgba(239,68,68,.3);':''}">
      ${isOver && !manual ? '<div style="color:var(--red);font-weight:700;margin-bottom:8px;">âš ï¸ ä»Šæ—¥ AI è²»ç”¨å·²é”ä¸Šé™ï¼</div>' : ''}
      <div style="font-size:14px;font-weight:700;">ä»Šæ—¥åˆè¨ˆï¼š${usage.totalCalls} æ¬¡ ï¼ â‰ˆ ${usage.totalCost} TWD</div>
      <div style="font-size:11px;color:var(--text-dim);margin-top:4px;">ï¼ˆ1 TWD â‰ˆ 0.03 USDï¼Œä¾å¯¦éš› token ç”¨é‡ç•¥æœ‰å·®ç•°ï¼‰</div>
    </div>
    ${Object.entries(usage.calls).map(([t, n]) => {
      const info = AI_COST[t] || { label: t, costTWD: 1 };
      return `<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;">
        <span>${info.label}</span>
        <span>${n} æ¬¡ â‰ˆ ${(n*info.costTWD).toFixed(1)} TWD</span>
      </div>`;
    }).join('')}`;
}

function saveAiLimit() {
  const v = parseInt(document.getElementById('aiLimitInput').value) || 50;
  localStorage.setItem('aiDailyLimit', v);
  document.getElementById('aiCostModal').style.display = 'none';
  alert(`å·²è¨­å®šæ¯æ—¥è­¦å‘Šä¸Šé™ï¼š${v} TWD`);
}

function resetAiUsage() {
  localStorage.removeItem('aiUsage');
  document.getElementById('aiCostModal').style.display = 'none';
  updateAiUsageBadge();
}

// AI ä½¿ç”¨è¿½è¹¤å·²æ•´åˆåœ¨å„åŠŸèƒ½å‡½å¼å…§



// ============================================================
// å¸‚å ´ç¸½è¦½è‡ªè¨‚ç¾©
// ============================================================
const DASHBOARD_WIDGETS = [
  { id:'widget-indices',   label:'ğŸ“ˆ å¤§ç›¤æŒ‡æ•¸',   default:true },
  { id:'widget-heatmap',   label:'ğŸ—ºï¸ é¡è‚¡ç†±åŠ›åœ–', default:true },
  { id:'widget-sentiment', label:'ğŸŒ¡ï¸ å¸‚å ´æƒ…ç·’',   default:true },
  { id:'widget-alerts',    label:'âš¡ å¿«è¨Š',        default:true },
  { id:'widget-movers',    label:'ğŸ”¥ æ¼²è·Œæ’è¡Œ',    default:true },
  { id:'widget-sectors',   label:'ğŸ“Š é¡è‚¡æ¦‚æ³',    default:true },
];

// å°æ‡‰ DOM id â€” çµ±ä¸€åŒ…è£ overview ä¸­å„ card çš„çˆ¶å…ƒç´ 
const WIDGET_DOM = {
  'widget-indices'  : '.stats-grid',
  'widget-heatmap'  : '#heatmapGrid',
  'widget-sentiment': null,   // ç”¨ CSS class æ§åˆ¶
  'widget-alerts'   : '#quickAlerts',
  'widget-movers'   : '#moversTable',
  'widget-sectors'  : '#sectorsGrid',
};

function getDashConfig() {
  return JSON.parse(localStorage.getItem('dashConfig') || '{}');
}
function saveDashConfig(cfg) {
  localStorage.setItem('dashConfig', JSON.stringify(cfg));
}
function getHiddenSectors() {
  return JSON.parse(localStorage.getItem('hiddenSectors') || '[]');
}
function saveHiddenSectors(arr) {
  localStorage.setItem('hiddenSectors', JSON.stringify(arr));
}

function openDashboardSettings() {
  const panel = document.getElementById('dashboardSettingsPanel');
  if (!panel) return;
  panel.style.display = 'flex';
  renderDashWidgetToggles();
  renderHeatmapSectorToggles();
}
function closeDashboardSettings() {
  const panel = document.getElementById('dashboardSettingsPanel');
  if (panel) panel.style.display = 'none';
  applyDashConfig();
  setTimeout(renderHeatmap, 100);
}

function renderDashWidgetToggles() {
  const cfg = getDashConfig();
  document.getElementById('dashWidgetToggles').innerHTML = DASHBOARD_WIDGETS.map(w => {
    const on = cfg[w.id] !== undefined ? cfg[w.id] : w.default;
    return `<label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;background:var(--surface2);border-radius:8px;">
      <input type="checkbox" ${on?'checked':''} style="accent-color:var(--accent);"
        onchange="toggleWidget('${w.id}', this.checked)">
      <span style="font-size:13px;">${w.label}</span>
    </label>`;
  }).join('');
}

function renderHeatmapSectorToggles() {
  const hidden = getHiddenSectors();
  document.getElementById('heatmapSectorToggles').innerHTML = Object.keys(SECTOR_STOCKS).map(name => {
    const icon = (typeof SECTOR_ICONS !== 'undefined' ? SECTOR_ICONS[name] : '') || 'ğŸ“Š';
    const on   = !hidden.includes(name);
    return `<label style="display:flex;align-items:center;gap:5px;cursor:pointer;padding:4px 8px;background:var(--surface2);border-radius:16px;font-size:12px;">
      <input type="checkbox" ${on?'checked':''} style="accent-color:var(--accent);"
        onchange="toggleSector('${name}', this.checked)">
      <span>${icon} ${name}</span>
    </label>`;
  }).join('');
}

function toggleWidget(id, on) {
  const cfg = getDashConfig();
  cfg[id] = on;
  saveDashConfig(cfg);
}

function toggleSector(name, on) {
  const hidden = getHiddenSectors();
  if (on) {
    const idx = hidden.indexOf(name);
    if (idx !== -1) hidden.splice(idx, 1);
  } else {
    if (!hidden.includes(name)) hidden.push(name);
  }
  saveHiddenSectors(hidden);
}

function applyDashConfig() {
  const cfg = getDashConfig();
  const statsGrid  = document.querySelector('#page-overview .stats-grid');
  if (statsGrid)   statsGrid.style.display   = (cfg['widget-indices'] === false) ? 'none' : '';
  const heatmapCard= document.getElementById('overviewHeatmap') || document.getElementById('heatmapGrid')?.closest('.card');
  if (heatmapCard) heatmapCard.style.display = (cfg['widget-heatmap'] === false) ? 'none' : '';
  const sentCard   = document.querySelector('#page-overview .progress-ring')?.closest('.card');
  if (sentCard)    sentCard.style.display    = (cfg['widget-sentiment'] === false) ? 'none' : '';
  const alertCard  = document.getElementById('overviewAlerts') || document.getElementById('quickAlerts')?.closest('.card');
  if (alertCard)   alertCard.style.display   = (cfg['widget-alerts'] === false) ? 'none' : '';
  const moversCard = document.getElementById('overviewMovers');
  if (moversCard)  moversCard.style.display  = (cfg['widget-movers'] === false) ? 'none' : '';
  const secCard    = document.getElementById('overviewSectors');
  if (secCard)     secCard.style.display     = (cfg['widget-sectors'] === false) ? 'none' : '';
}

function resetDashConfig() {
  localStorage.removeItem('dashConfig');
  localStorage.removeItem('hiddenSectors');
  applyDashConfig();
  renderDashWidgetToggles();
  renderHeatmapSectorToggles();
  renderHeatmap();
  showToast('âœ… å·²æ¢å¾©é è¨­è¨­å®š');
}

function renderHeatmap() {
  const hidden = getHiddenSectors();
  const container = document.getElementById('heatmapGrid');
  if (!container) return;
  const sectorPcts = Object.entries(SECTOR_STOCKS)
    .filter(([name]) => !hidden.includes(name))
    .map(([name, stocks]) => {
      const cached = stocks.map(c => state.stockCache[c]).filter(Boolean);
      const avg = cached.length ? cached.reduce((a,b) => a + b.changePct, 0) / cached.length : 0;
      return { name, pct: parseFloat(avg.toFixed(2)), dataCount: cached.length };
    });

  container.innerHTML = sectorPcts
    .filter(s => s.dataCount > 0)
    .map(s => {
      const abs     = Math.abs(s.pct);
      const opacity = 0.2 + Math.min(abs * 0.2, 0.6);
      const bg   = s.pct >= 0 ? `rgba(16,185,129,${opacity})` : `rgba(239,68,68,${opacity})`;
      const txt  = s.pct >= 0 ? 'var(--green)' : 'var(--red)';
      const sign = s.pct >= 0 ? '+' : '';
      const icon = (typeof SECTOR_ICONS !== 'undefined' ? SECTOR_ICONS[s.name] : '') || 'ğŸ“Š';
      return `<div class="heatmap-cell" style="background:${bg};" onclick="quickChat('åˆ†æå°ç£${s.name}é¡è‚¡ä»Šæ—¥èµ°å‹¢åŸå› ')">
        <div class="cell-name">${icon} ${s.name}</div>
        <div class="cell-pct" style="color:${txt}">${sign}${s.pct}%</div>
        <div style="font-size:10px;color:rgba(255,255,255,.35);">${s.dataCount}æ”¯</div>
      </div>`;
    }).join('') || '<div style="color:var(--text-dim);padding:20px;text-align:center;font-size:12px;">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>';
}

// é é¢åˆå§‹åŒ–å¾Œå¥—ç”¨è¨­å®š
document.addEventListener('DOMContentLoaded', () => { setTimeout(applyDashConfig, 800); });


// åˆå§‹åŒ–ç”¨é‡ badge
document.addEventListener("DOMContentLoaded", updateAiUsageBadge);
</script>
</body>
</html>
